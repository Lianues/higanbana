import{i as ve}from"./hbHtmlRuntime.Bjd8jUGb.chunk.js";const Be="st-higanbana-vfs-",R=new Set;async function F(){try{const e=await caches.keys();R.clear();for(const t of e)t.startsWith(Be)&&R.add(t.slice(Be.length))}catch(e){console.warn("[Higanbana] caches.keys failed",e)}}function je(e){return!!e&&R.has(e)}function E(){const e=globalThis.SillyTavern;return e?.getContext?e.getContext():null}function x(){const e=E();if(!e)return null;const t=Number(e.characterId);if(!Number.isFinite(t)||t<0)return null;const r=e.characters?.[t];return r?{chid:t,character:r}:null}function ct(e){return String(e?.name??e?.data?.name??"").trim()||"(未命名角色)"}function M(e){return String(e?.avatar??"").trim()}function st(e){return e?{projects:(Array.isArray(e.projects)?e.projects:[]).map(r=>({...r}))}:null}function B(e){const t={projects:[]},r=e?.data?.extensions?.higanbana;if(!r||typeof r!="object")return t;const o=r.projects;if(!Array.isArray(o))return t;const a=[];for(const n of o){if(!n||typeof n!="object")continue;const i=String(n.source??"").trim(),c=String(n.id??"").trim(),h=String(n.title??"").trim()||void 0,d=String(n.placeholder??"").trim(),s=String(n.homePage??"").trim(),l=typeof n.showTitleInChat=="boolean"?!!n.showTitleInChat:!1,p=!!n.fixRootRelativeUrls,f=String(n.zipName??"").trim(),u=String(n.zipSha256??"").trim();if(!(!c||!d||!s||!f)){if(i==="embedded"){const m=String(n.zipBase64??"").trim();if(!m||!u)continue;a.push({source:"embedded",id:c,title:h,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:f,zipSha256:u,zipBase64:m});continue}if(i==="local"){if(!u)continue;a.push({source:"local",id:c,title:h,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:f,zipSha256:u});continue}if(i==="url"){const m=String(n.zipUrl??"").trim();if(!m)continue;a.push({source:"url",id:c,title:h,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:f,zipSha256:u||"",zipUrl:m})}}}return{projects:a}}async function T(e,t){const r=E();if(!r?.writeExtensionField)throw new Error("writeExtensionField 不可用（酒馆版本过旧或上下文缺失）");const a=st(t)??{projects:[]};await r.writeExtensionField(e,"higanbana",a);try{const n=r?.characters?.[Number(e)];if(!n||typeof n!="object")return;(!n.data||typeof n.data!="object")&&(n.data={}),(!n.data.extensions||typeof n.data.extensions!="object")&&(n.data.extensions={});const c={projects:(Array.isArray(a.projects)?a.projects:[]).map(h=>({...h}))};n.data.extensions.higanbana=c}catch{}}const lt="st-higanbana-vfs-";function dt(e){return String(e).split("/").map(t=>encodeURIComponent(t)).join("/")}function de(e,t,r){return`${e}vfs/${encodeURIComponent(t)}/${dt(r)}`}function ut(e,t){return`${new URL(e).pathname}vfs/${encodeURIComponent(t)}/`}function ht(e){return`${lt}${e}`}function De(e){const t=String(e).toLowerCase();return t.endsWith(".html")||t.endsWith(".htm")?"text/html; charset=utf-8":t.endsWith(".css")?"text/css; charset=utf-8":t.endsWith(".js")||t.endsWith(".mjs")||t.endsWith(".cjs")?"application/javascript; charset=utf-8":t.endsWith(".json")||t.endsWith(".map")?"application/json; charset=utf-8":t.endsWith(".txt")?"text/plain; charset=utf-8":t.endsWith(".svg")?"image/svg+xml":t.endsWith(".png")?"image/png":t.endsWith(".jpg")||t.endsWith(".jpeg")?"image/jpeg":t.endsWith(".gif")?"image/gif":t.endsWith(".webp")?"image/webp":t.endsWith(".avif")?"image/avif":t.endsWith(".ico")?"image/x-icon":t.endsWith(".woff2")?"font/woff2":t.endsWith(".woff")?"font/woff":t.endsWith(".ttf")?"font/ttf":t.endsWith(".otf")?"font/otf":t.endsWith(".eot")?"application/vnd.ms-fontobject":t.endsWith(".wasm")?"application/wasm":"application/octet-stream"}function pt(e){const t=De(e);return t.startsWith("text/")||t.includes("javascript")||t.includes("json")||t.includes("svg+xml")}function ft(e){return new Promise((t,r)=>{const o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>t(),o.onerror=()=>r(new Error(`加载脚本失败: ${e}`)),document.head.appendChild(o)})}async function mt(){const e=globalThis;if(e.JSZip)return e.JSZip;if(await ft("/lib/jszip.min.js"),!e.JSZip)throw new Error("JSZip 未能加载（/lib/jszip.min.js）");return e.JSZip}function bt(e){const t=e.filter(Boolean);if(t.length===0)return{prefix:"",stripped:[]};const r=new Set(t.map(i=>i.split("/")[0]).filter(Boolean));if(r.size!==1)return{prefix:"",stripped:t};const a=`${[...r][0]}/`;return t.some(i=>i.startsWith(a))?{prefix:a,stripped:t.map(i=>i.startsWith(a)?i.slice(a.length):i)}:{prefix:"",stripped:t}}function gt(e){let t=String(e??"").replace(/\\/g,"/").replace(/^\.\//,"").replace(/^\/+/,"");const r=t.split("/").filter(Boolean);return r.some(o=>o==="..")?null:(t=r.join("/"),t||null)}function Fe(e){return String(e).split(/[?#]/,1)[0]}function wt(e){const t=new Set,r=new Set;for(const o of e){t.add(o);const a=o.split("/").filter(Boolean);for(let n=1;n<a.length;n++)r.add(a.slice(0,n).join("/")+"/")}return{fileSet:t,dirSet:r}}function Q(e,t){const r=Fe(e);return r?!!(t.fileSet.has(r)||t.dirSet.has(r.endsWith("/")?r:`${r}/`)):!1}function yt(e,t,r,o){let a=e;return r&&(a=a.replace(/<base\b([^>]*?)\bhref\s*=\s*(["'])\/\2([^>]*?)>/gi,(n,i,c,h)=>`<base${i}href=${c}${t}${c}${h}>`),a=a.replace(/(<\s*(?:script|img|source|video|audio)\b[^>]*\bsrc\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(n,i,c,h)=>Q(h,o)?`${i}${t}${h}${c}`:n),a=a.replace(/(<\s*link\b[^>]*\bhref\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(n,i,c,h)=>Q(h,o)?`${i}${t}${h}${c}`:n)),a}function _t(e,t,r,o){if(!r)return e;let a=String(e);return a=a.replace(/url\(\s*(["'])?\/(?!\/)([^"')]+)\1\s*\)/gi,(n,i="",c)=>Q(c,o)?`url(${i}${t}${c}${i})`:n),a=a.replace(/@import\s+(?:url\(\s*)?(["'])?\/(?!\/)([^"')\s]+)\1\s*\)?/gi,(n,i="",c)=>Q(c,o)?n.toLowerCase().includes("url(")?`@import url(${i}${t}${c}${i})`:`@import ${i}${t}${c}${i}`:n),a}function vt(e){return!e||/\s/.test(e)?!1:e.endsWith("/")?!0:(e.split("/").filter(Boolean).pop()||"").includes(".")}function jt(e,t,r,o){if(!r)return e;let a=String(e);return a=a.replace(/(["'`])\/(?!\/)([^"'`]*?)\1/g,(n,i,c)=>{const h=Fe(c);return!vt(h)||!Q(c,o)?n:`${i}${t}${c}${i}`}),a=a.replace(/(__webpack_require__\.p\s*=\s*)(["'])\/\2/g,(n,i,c)=>`${i}${c}${t}${c}`),a=a.replace(/(__webpack_public_path__\s*=\s*)(["'])\/\2/g,(n,i,c)=>`${i}${c}${t}${c}`),a}async function Me(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(r=>r.toString(16).padStart(2,"0")).join("")}function Ct(e){const t=new Uint8Array(e),r=32768,o=[];for(let a=0;a<t.length;a+=r){const n=t.subarray(a,a+r);o.push(String.fromCharCode(...n))}return btoa(o.join(""))}function St(e){const t=atob(e),r=new Uint8Array(t.length);for(let o=0;o<t.length;o++)r[o]=t.charCodeAt(o);return r.buffer}async function Se(e){return Ct(e)}async function q(e){return St(e)}function K(e){const t=Number(e);if(!Number.isFinite(t)||t<0)return"0 B";const r=["B","KB","MB","GB","TB"];let o=t,a=0;for(;o>=1024&&a<r.length-1;)o/=1024,a++;const n=o>=100?0:o>=10?1:2;return`${o.toFixed(n)} ${r[a]}`}function $t(e){if(e===null)return"—";const t=Number(e);return!Number.isFinite(t)||t<=0?"—":`${K(t)}/s`}function xt(e){if(e===null)return"—";const t=Number(e);return Number.isFinite(t)?`${Math.max(0,Math.min(t,100)).toFixed(1)}%`:"—"}function pe(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}async function ee(e,t={}){const r=Math.max(30,Number(t.progressThrottleMs??120)),o=t.onProgress,a=pe(),n=await fetch(e,{method:"GET",signal:t.signal});if(!n.ok)throw new Error(`下载失败: ${n.status} ${n.statusText}`);const i=n.headers.get("content-type"),c=n.url||e,h=n.headers.get("content-length"),d=h?Number(h):NaN,s=Number.isFinite(d)&&d>0?d:null,p=n.body?.getReader?.();if(!p){const b=await n.arrayBuffer(),_=Math.max(0,pe()-a),v=b.byteLength,S=s??v,P=S?v/S*100:null,k=_>0?v/_*1e3:null;return o?.({loadedBytes:v,totalBytes:S,percent:P,speedBps:k,elapsedMs:_}),{arrayBuffer:b,totalBytes:S,contentType:i,finalUrl:c}}const f=[];let u=0,m=0,w=0,g=null;const y=(b=!1)=>{if(!o)return;const _=pe(),v=Math.max(0,_-a);if(!b&&m&&_-m<r)return;if(m){const P=_-m;P>0&&(g=(u-w)/P*1e3)}m=_,w=u;const S=s?u/s*100:null;o({loadedBytes:u,totalBytes:s,percent:S,speedBps:g,elapsedMs:v})};y(!0);try{for(;;){const{done:b,value:_}=await p.read();if(b)break;_&&(f.push(_),u+=_.byteLength,y(!1))}}finally{try{p.releaseLock()}catch{}}y(!0);const C=new Uint8Array(u);let j=0;for(const b of f)C.set(b,j),j+=b.byteLength;return{arrayBuffer:C.buffer,totalBytes:s??u,contentType:i,finalUrl:c}}async function O(e,t,r){const o=await mt(),a=await Me(t),n=ht(a),i=await caches.open(n),c=ut(e,a),h=await o.loadAsync(t),l=Object.values(h.files||{}).filter(b=>b&&!b.dir).map(b=>({entry:b,path:gt(b.name)})).filter(b=>!!b.path);if(l.length===0)throw new Error("zip 内没有可导入的文件");const{stripped:p}=bt(l.map(b=>b.path)),f=l.map((b,_)=>({entry:b.entry,path:p[_]})).filter(b=>!!b.path),u=f.map(b=>String(b.path)),m=wt(u),w=f.map(b=>b.path).filter(b=>/\.(html?|HTML?)$/i.test(b)).sort((b,_)=>b.localeCompare(_)),g=r.preferredHomePage?.trim(),y=g?w.includes(g):!1,C=w.some(b=>b.toLowerCase()==="index.html");let j=g&&y?g:"";j||(C?j=w.find(b=>b.toLowerCase()==="index.html"):w.length>0?j=w[0]:j="index.html");for(let b=0;b<f.length;b++){const{entry:_,path:v}=f[b],S=De(v);let P;if(pt(v)){let U=await _.async("string");S.startsWith("text/html")?(U=yt(U,c,r.fixRootRelativeUrls,m),P=U):S.startsWith("text/css")?P=_t(U,c,r.fixRootRelativeUrls,m):S.includes("javascript")?P=jt(U,c,r.fixRootRelativeUrls,m):P=U}else{const U=await _.async("uint8array"),N=new Uint8Array(U.byteLength);N.set(U),P=new Blob([N],{type:S})}const k=de(e,a,v);await i.put(new Request(k,{method:"GET"}),new Response(P,{headers:{"Content-Type":S}})),b%75===0&&await new Promise(U=>setTimeout(U,0))}return{projectId:a,homePage:j,htmlFiles:w,fileCount:f.length,cacheName:n}}const I=String(import.meta.url).replace(/[^/]*$/,""),Bt=`${I}sw.js`,fe="higanbana",V=Object.freeze({placeholder:"{{WEB_HOME}}",defaultFixRootRelativeUrls:!0,renderHtmlCodeBlocks:!1,renderHtmlCodeBlocksUseBlobUrl:!1,renderHtmlCodeBlocksShowTitleBar:!1,allowedCharacterAvatars:[]});function L(){const e=E();if(!e)return structuredClone(V);e.extensionSettings[fe]=e.extensionSettings[fe]||{};const t=e.extensionSettings[fe];return(typeof t.placeholder!="string"||!t.placeholder.trim())&&(t.placeholder=V.placeholder),typeof t.defaultFixRootRelativeUrls!="boolean"&&(t.defaultFixRootRelativeUrls=V.defaultFixRootRelativeUrls),typeof t.renderHtmlCodeBlocks!="boolean"&&(t.renderHtmlCodeBlocks=V.renderHtmlCodeBlocks),typeof t.renderHtmlCodeBlocksUseBlobUrl!="boolean"&&(t.renderHtmlCodeBlocksUseBlobUrl=V.renderHtmlCodeBlocksUseBlobUrl),typeof t.renderHtmlCodeBlocksShowTitleBar!="boolean"&&(t.renderHtmlCodeBlocksShowTitleBar=V.renderHtmlCodeBlocksShowTitleBar),Array.isArray(t.allowedCharacterAvatars)?t.allowedCharacterAvatars=t.allowedCharacterAvatars.map(r=>String(r).trim()).filter(r=>r.length>0):t.allowedCharacterAvatars=[],t}function G(){E()?.saveSettingsDebounced?.()}function We(e){return L().allowedCharacterAvatars.includes(e)}function Z(e){const t=L();t.allowedCharacterAvatars.includes(e)||(t.allowedCharacterAvatars.push(e),G())}const Ee=new WeakMap;function Et(e){try{const t=e.contentDocument;if(!t)return null;const r=t.body,o=t.documentElement;if(!r||!o)return null;const a=r.scrollHeight||0,n=o.scrollHeight||0,i=r.offsetHeight||0,c=o.offsetHeight||0,h=Math.max(a,n,i,c);return!Number.isFinite(h)||h<=0?null:h}catch{return null}}function ie(e){const t=Et(e);if(!t)return;const r=Math.max(80,Math.min(t,1e4));e.style.height=`${r}px`}function Oe(e){Ee.get(e)?.ro?.disconnect?.();const r={};Ee.set(e,r);const o=()=>{ie(e),setTimeout(()=>ie(e),50),setTimeout(()=>ie(e),250);try{const a=e.contentDocument;if(!a?.documentElement)return;const n=new ResizeObserver(()=>ie(e));n.observe(a.documentElement),a.body&&n.observe(a.body),r.ro=n}catch{}};o(),e.addEventListener("load",o)}function zt(e){const t=x();if(!t)return{kind:"stub",title:"彼岸花：无法渲染",reason:"当前不在单角色聊天/未选中角色。"};const r=e.title||e.zipName,o=M(t.character);if(o&&!We(o))return{kind:"stub",title:`彼岸花：未启用（${r}）`,reason:e.source==="url"?"该角色卡绑定了 WebZip URL，但尚未允许/下载。切换到该角色时会弹窗询问，或在面板/弹窗中下载并导入缓存。":e.source==="embedded"?"该角色卡包含嵌入 WebZip，但尚未允许/导入。切换到该角色时会弹窗询问，或在面板点“导入所有嵌入项目到本地缓存”。":"该角色卡绑定了本地缓存项目。请先允许该角色，并确保当前浏览器已导入对应 zip。"};const a=e.zipSha256;return a?je(a)?{kind:"iframe",src:de(I,a,e.homePage),title:`彼岸花：${r} · ${e.homePage}`}:{kind:"stub",title:`彼岸花：未导入缓存（${r}）`,reason:e.source==="url"?"请下载并导入缓存后即可渲染。":e.source==="embedded"?"请先导入到本地缓存（面板中可操作），再刷新聊天即可渲染。":"这是“本地缓存模式”项目，当前浏览器未找到缓存。请在扩展面板重新导入本地 zip 并绑定。"}:{kind:"stub",title:`彼岸花：未下载（${r}）`,reason:e.source==="url"?"请在面板/弹窗中下载并导入缓存后即可渲染。":"缺少 projectId，无法渲染。"}}function Ze(e,t,r,o={}){const a=document.createElement("div");a.className="hb-embed",a.dataset.hbEmbed="1",a.classList.add(r.kind==="stub"?"hb-embed-stub":"hb-embed-iframe"),o.projectId&&(a.dataset.hbProjectId=o.projectId),o.showTitleInChat===!0||a.classList.add("hb-embed-no-title");const i=document.createElement("div");i.className="hb-embed-header";const c=document.createElement("div");c.className="hb-embed-title",c.textContent=r.title;const h=document.createElement("div");if(h.className="hb-embed-actions",r.kind==="iframe"){const p=document.createElement("a");p.href=o.openInNewTabUrl||r.src,p.target="_blank",p.rel="noopener noreferrer",p.textContent="新标签页打开",h.appendChild(p)}i.appendChild(c),i.appendChild(h),a.appendChild(i);const d=document.createElement("div");if(d.className="hb-embed-body",r.kind==="stub"){const p=document.createElement("div");return p.style.padding="10px",p.style.opacity="0.9",p.textContent=r.reason,d.appendChild(p),a.appendChild(d),a}const s=document.createElement("iframe");s.className="hb-iframe",s.loading="lazy",s.referrerPolicy="no-referrer",s.name=`hb-${e}-${t}`,s.setAttribute("sandbox","allow-scripts allow-same-origin");const l=!!o.projectId||o.useBlobUrlInChat===!0;try{s.dataset?s.dataset.hbVfsHomeUrl=r.src:s.setAttribute("data-hb-vfs-home-url",r.src),s.dataset?s.dataset.hbUseBlobUrl=l?"1":"0":s.setAttribute("data-hb-use-blob-url",l?"1":"0")}catch{}return l?(s.removeAttribute("src"),s.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',Ge(s,r.src)):(s.removeAttribute("srcdoc"),s.src=r.src),Oe(s),d.appendChild(s),a.appendChild(d),a}const ze=new Map;function Pt(e){const t=String(e??"").trim();return`<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      *{box-sizing:border-box}
      html,body{margin:0;padding:0;width:100%}
      #inner{display:block;width:100%;border:0;height:260px}
      .loading{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:12px;opacity:.85}
    </style>
  </head>
  <body>
    <div class="loading" id="loading">正在加载…</div>
    <iframe id="inner" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer"></iframe>
    <script>
      const VFS_URL = ${JSON.stringify(t)};
      const inner = document.getElementById('inner');
      const loading = document.getElementById('loading');
      const OUTER_TYPE = 'HB_IFRAME_HEIGHT';
      const iframeName = String(window.name || '');
      const clamp = (h) => Math.max(80, Math.min(Number(h) || 0, 10000));
      const setHeight = (h) => {
        const px = clamp(h);
        if (!px) return;
        inner.style.height = px + 'px';
        try {
          if (iframeName) {
            window.parent?.postMessage?.({ type: OUTER_TYPE, iframeName, height: px }, '*');
          }
        } catch {}
      };

      const measureInnerDocHeight = () => {
        try {
          const doc = inner.contentDocument;
          if (!doc) return 0;
          const body = doc.body;
          const html = doc.documentElement;
          if (!body || !html) return 0;
          const h = Math.max(body.scrollHeight || 0, html.scrollHeight || 0, body.offsetHeight || 0, html.offsetHeight || 0);
          return Number.isFinite(h) ? h : 0;
        } catch {
          return 0;
        }
      };
      const syncHeightFromInnerDirect = () => {
        const h = measureInnerDocHeight();
        if (h > 0) setHeight(h);
      };

      try { inner.name = String(window.name || ''); } catch {}
      try { inner.src = VFS_URL; } catch {}

      inner.addEventListener('load', () => {
        try { if (loading) loading.style.display = 'none'; } catch {}
        // 直接测高兜底（同源场景），避免仅依赖 postMessage
        syncHeightFromInnerDirect();
        setTimeout(syncHeightFromInnerDirect, 80);
        setTimeout(syncHeightFromInnerDirect, 260);

        try {
          const doc = inner.contentDocument;
          if (doc?.documentElement && 'ResizeObserver' in window) {
            const ro = new ResizeObserver(() => syncHeightFromInnerDirect());
            ro.observe(doc.documentElement);
            if (doc.body) ro.observe(doc.body);
          }
        } catch {}
      });

      window.addEventListener('message', (ev) => {
        const data = ev && ev.data;
        if (!data || typeof data !== 'object') return;

        // Height message from inner（跨域/无法直读时也能工作）
        if (ev.source === inner.contentWindow && data.type === 'HB_IFRAME_HEIGHT') {
          setHeight(data.height);
          return;
        }
      });

      // 轮询兜底：应对某些页面不触发 ResizeObserver/不主动 postMessage
      setInterval(() => {
        syncHeightFromInnerDirect();
      }, 500);
    <\/script>
  </body>
</html>`}async function At(e){const t=String(e??"").trim();if(!t)throw new Error("vfsHomeUrl is required");const r=ze.get(t);if(r)return await r.promise;const a={promise:(async()=>{const n=Pt(t);return URL.createObjectURL(new Blob([n],{type:"text/html"}))})()};return ze.set(t,a),await a.promise}async function Ge(e,t){try{const r=String(t??"").trim();if(!r)return;e.dataset?e.dataset.hbVfsHomeUrl=r:e.setAttribute("data-hb-vfs-home-url",r),e.dataset?e.dataset.hbUseBlobUrl="1":e.setAttribute("data-hb-use-blob-url","1");const o=await At(r);if(!e.isConnected)return;const a=String(e.dataset?.hbVfsHomeUrl??"");if(!(String(e.dataset?.hbUseBlobUrl??"")==="1")||a!==r)return;e.removeAttribute("srcdoc"),e.src=o}catch(r){console.warn("[Higanbana] blob render failed, fallback to VFS",{vfsHomeUrl:t,err:r});try{if(!e.isConnected)return;e.removeAttribute("srcdoc"),e.src=String(t??"")}catch{}}}function It(e,t){if(!e)return;const r=document.querySelectorAll(".hb-embed[data-hb-project-id]");for(const o of r)String(o.dataset?.hbProjectId??"")===e&&(t?o.classList.remove("hb-embed-no-title"):o.classList.add("hb-embed-no-title"))}function qe(){const e=document.querySelectorAll(".hb-embed.hb-embed-iframe[data-hb-project-id]");for(const t of e){const r=t.querySelector("iframe.hb-iframe");if(!r)continue;const o=String(r.src||"");if(o.startsWith("blob:"))continue;const a=t.querySelector(".hb-embed-actions a"),n=String(a?.href||r.dataset?.hbVfsHomeUrl||o||"").trim();n&&(r.removeAttribute("src"),r.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',Ge(r,n))}}function Ut(e){const t=String(e??"").toLowerCase();return t.includes("<html")||t.includes("<head")||t.includes("<body")||t.includes("<!doctype html")}function Ce(e){const r=String(e??"").trim(),o=r.toLowerCase();return r?o.includes("<!doctype")||o.includes("<html")?r:`<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><body>${r}</body>`:'<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'}function Rt(e){let t=2166136261;for(let r=0;r<e.length;r++)t^=e.charCodeAt(r),t=Math.imul(t,16777619);return(t>>>0).toString(16)}function Pe(e,t){const r=ve(Ce(t),{origin:window.location.origin,forceBaseHref:!0}),o=Rt(r),a=String(e.dataset?.hbHtmlHash??""),n=String(e.dataset?.hbHtmlBlobUrl??"");if(n&&a===o)return n;if(n)try{URL.revokeObjectURL(n)}catch{}const i=URL.createObjectURL(new Blob([r],{type:"text/html"}));return e.dataset.hbHtmlHash=o,e.dataset.hbHtmlBlobUrl=i,i}function Ve(e,t){const r=L(),o=!!r.renderHtmlCodeBlocks,a=!!r.renderHtmlCodeBlocksUseBlobUrl,n=!!r.renderHtmlCodeBlocksShowTitleBar,i=a||n,c=Array.from(e.querySelectorAll(".hb-html-render"));if(!o){for(const s of c){const l=String(s.dataset?.hbHtmlBlobUrl??"");if(l)try{URL.revokeObjectURL(l)}catch{}const p=s.querySelector("pre");p&&s.parentNode&&(p.classList.remove("hb-html-code-hidden"),s.parentNode.insertBefore(p,s)),s.remove()}return}const h=Array.from(e.querySelectorAll("pre > code"));if(h.length===0)return;for(const s of c)s.querySelectorAll(".hb-embed").forEach(l=>l.remove()),s.querySelectorAll("iframe.hb-html-iframe").forEach(l=>l.remove());let d=e.querySelectorAll(".hb-embed").length;for(const s of h){const l=s.closest("pre");if(!l)continue;const p=s.textContent||"";if(!Ut(p))continue;const f=l.closest(".hb-html-render"),u=f||document.createElement("div");if(!f){u.className="hb-html-render",u.dataset.hbHtmlRender="1";const y=l.parentNode;if(!y)continue;y.insertBefore(u,l),u.appendChild(l)}if(l.classList.add("hb-html-code-hidden"),!i){const y=String(u.dataset?.hbHtmlBlobUrl??"");if(y)try{URL.revokeObjectURL(y)}catch{}try{delete u.dataset.hbHtmlBlobUrl,delete u.dataset.hbHtmlHash}catch{}}const m=a?Pe(u,p):"";if(n){const y=ve(Ce(p),{origin:window.location.origin,forceBaseHref:!1}),C={kind:"iframe",src:a&&m?m:"about:blank",title:"HTML 代码块"},j=Ze(t,d++,C,{showTitleInChat:!0,openInNewTabUrl:a&&m?m:"#"}),b=u.querySelector(".hb-embed");if(b&&b.remove(),u.appendChild(j),!a){const _=j.querySelector("iframe.hb-iframe");_&&(_.removeAttribute("src"),_.srcdoc=y);const v=j.querySelector(".hb-embed-actions a");v&&String(v.dataset?.hbHtmlLazyOpenBound??"")!=="1"&&(v.dataset.hbHtmlLazyOpenBound="1",v.href="#",v.addEventListener("click",S=>{try{S.preventDefault();const P=Pe(u,p);window.open(P,"_blank","noopener,noreferrer")}catch{}}))}continue}const w=u.querySelector(".hb-embed");w&&w.remove();let g=u.querySelector("iframe.hb-html-iframe");g||(g=document.createElement("iframe"),g.className="hb-html-iframe",g.loading="lazy",g.referrerPolicy="no-referrer",g.name=`hb-html-${t}`,g.setAttribute("sandbox","allow-scripts allow-same-origin"),Oe(g),u.appendChild(g)),a&&m?(g.removeAttribute("srcdoc"),g.src=m):(g.removeAttribute("src"),g.srcdoc=ve(Ce(p),{origin:window.location.origin,forceBaseHref:!1}))}}function Tt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ye(e,t){const r=x();if(!r)return;const o=B(r.character);if(o.projects.length===0)return;const a=new Map;for(const m of o.projects){const w=String(m.placeholder??"").trim();w&&(a.has(w)||a.set(w,m))}const n=Array.from(a.keys());if(n.length===0)return;const i=e.textContent||"";let c=!1;for(const m of n)if(i.includes(m)){c=!0;break}if(!c)return;n.sort((m,w)=>w.length-m.length);const h=n.map(Tt).join("|"),d=new RegExp(h,"g"),s=new RegExp(h),l=new Map;for(const m of n){const w=a.get(m);w&&l.set(m,zt(w))}let p=0;const f=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode(m){const w=m?.nodeValue||"";if(!w||!s.test(w))return NodeFilter.FILTER_REJECT;let g=m.parentNode;for(;g&&g!==e;){if(g.nodeType===1){const y=g.tagName;if(y==="CODE"||y==="PRE"||y==="TEXTAREA")return NodeFilter.FILTER_REJECT}g=g.parentNode}return NodeFilter.FILTER_ACCEPT}}),u=[];for(;f.nextNode();)u.push(f.currentNode);for(const m of u){const w=m.nodeValue||"";if(!s.test(w))continue;d.lastIndex=0;let g=0;const y=document.createDocumentFragment();for(const C of w.matchAll(d)){const j=Number(C.index??0),b=String(C[0]??"");j>g&&y.appendChild(document.createTextNode(w.slice(g,j)));const _=a.get(b),v=l.get(b);v?y.appendChild(Ze(t,p++,v,{projectId:_?.id,showTitleInChat:_?.showTitleInChat,useBlobUrlInChat:!0,openInNewTabUrl:v.kind==="iframe"?v.src:void 0})):y.appendChild(document.createTextNode(b)),g=j+b.length}g<w.length&&y.appendChild(document.createTextNode(w.slice(g))),m.parentNode?.replaceChild(y,m)}}function me(e){const t=Number(e);if(!Number.isFinite(t))return;const r=$(`#chat .mes[mesid="${t}"]`);if(r.length===0)return;const o=r.find(".mes_text").get(0);o&&(Ye(o,t),Ve(o,t),qe())}function Je(){const e=document.querySelectorAll("#chat .mes[mesid]");for(const t of e){const r=t.getAttribute("mesid"),o=Number(r);if(!Number.isFinite(o))continue;const a=t.querySelector(".mes_text");a&&(Ye(a,o),Ve(a,o))}qe()}let be=!1;function H(){be||(be=!0,setTimeout(()=>{be=!1,Je()},0))}let Ae=!1;function kt(){if(Ae)return;const e=E();if(!e?.eventSource||!e?.event_types)return;Ae=!0;const{eventSource:t,event_types:r}=e,o=(...n)=>me(n?.[0]),a=(...n)=>{const i=Number(n?.[0]);Number.isFinite(i)&&(setTimeout(()=>me(i),0),setTimeout(()=>me(i),50))};t.on(r.USER_MESSAGE_RENDERED,o),t.on(r.CHARACTER_MESSAGE_RENDERED,o),r.MESSAGE_EDITED&&t.on(r.MESSAGE_EDITED,a),r.MESSAGE_UPDATED&&t.on(r.MESSAGE_UPDATED,a),r.MORE_MESSAGES_LOADED&&t.on(r.MORE_MESSAGES_LOADED,()=>H()),r.CHAT_CHANGED&&t.on(r.CHAT_CHANGED,()=>H())}function Ht(e,t=15e3){return new Promise((r,o)=>{let a=!1;const n=f=>{a||(a=!0,h(),f?o(f):r())},i=setTimeout(()=>{n(new Error("Service Worker 激活超时（可能是非安全上下文或被浏览器策略禁止）"))},t),c=[],h=()=>{clearTimeout(i);for(const f of c)try{f()}catch{}},d=()=>{try{e.waiting?.postMessage?.({type:"HB_SKIP_WAITING"})}catch{}},s=()=>{try{e.active?.state==="activated"&&n()}catch{}},l=f=>{if(!f)return;if(f.state==="activated"){n();return}const u=()=>{d(),f.state==="activated"&&n()};f.addEventListener("statechange",u),c.push(()=>f.removeEventListener("statechange",u))},p=()=>{d(),l(e.installing),s()};e.addEventListener("updatefound",p),c.push(()=>e.removeEventListener("updatefound",p)),d(),l(e.installing||e.waiting||e.active),s()})}async function Nt(){if(!("serviceWorker"in navigator))return console.warn("[Higanbana] Service Worker not supported"),null;try{const e=await navigator.serviceWorker.register(Bt,{scope:I,type:"module"});return e.update().catch(()=>{}),await Ht(e),e}catch(e){return console.warn("[Higanbana] sw register failed",e),null}}const J={urlDownloadPopupInFlight:!1};function $e(e){const t=K(e.loadedBytes),r=e.totalBytes?K(e.totalBytes):"?",o=e.totalBytes?xt(e.percent):"—",a=$t(e.speedBps);return`下载：${t} / ${r}（${o}） | 速度：${a}`}function te(){try{if(typeof crypto<"u"&&"randomUUID"in crypto&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}const e=E();try{const t=e?.uuidv4;if(typeof t=="function")return String(t())}catch{}return`hb_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,10)}`}function oe(e){return String(e??"").trim()}function ne(e,t){const r=new Set(e.map(a=>a.placeholder));let o=oe(t);if(o||(o=`{{WEB_${e.length+1}}}`),!r.has(o))return o;for(let a=2;a<1e3;a++){const n=`_${a}`,i=o.endsWith("}}")?o.slice(0,-2)+n+"}}":o+n;if(!r.has(i))return i}return o}function Xe(e,t){const r=document.createElement("a");r.href=URL.createObjectURL(e),r.setAttribute("download",t),document.body.appendChild(r),r.click(),URL.revokeObjectURL(r.href),document.body.removeChild(r)}function Lt(e){const t=String(e??"").trim();if(!t)return null;try{const r=new URL(t);return r.protocol!=="http:"&&r.protocol!=="https:"?null:r.toString()}catch{return null}}function Ke(e){try{const r=new URL(e).pathname.split("/").filter(Boolean).pop()||"webzip.zip";return r.endsWith(".zip")?r:`${r}.zip`}catch{return"webzip.zip"}}function Dt(e){const t=e?.projects??[];if(t.length===0)return"（无）";const r=t.slice(0,3).map(a=>a.title||a.zipName).filter(Boolean),o=t.length>r.length?` +${t.length-r.length}`:"";return`项目数：${t.length}${r.length?` | ${r.join(" / ")}${o}`:""}`}function Ft(e,t){try{const r=localStorage.getItem(e);return r===null?t:r==="1"}catch{return t}}function Mt(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Qe(){const e=document.getElementById("higanbana_settings");if(!e)return;const t=Array.from(e.querySelectorAll(".hb-subpanel"));for(const r of t){const o=String(r.dataset.id??"").trim();if(!o)continue;const a=r.querySelector(".hb-subpanel-header"),n=r.querySelector(".hb-subpanel-indicator"),i=r.querySelector(".hb-subpanel-body");if(!a||!n||!i||a.dataset?.hbBound==="1")continue;a.dataset.hbBound="1";const c=`higanbana.subpanel.open.${o}`,h=a.getAttribute("aria-expanded")==="true",d=s=>{a.setAttribute("aria-expanded",s?"true":"false"),n.textContent=s?"−":"+",i.style.display=s?"block":"none"};d(Ft(c,h)),a.addEventListener("click",()=>{const l=!(a.getAttribute("aria-expanded")==="true");d(l),Mt(c,l)})}}function Ie(e){const t=document.getElementById("hb_projects_list");if(!t)return;if(t.innerHTML="",e.length===0){const o=document.createElement("div");o.className="hb-subhint",o.textContent="（暂无项目）",t.appendChild(o);return}const r=document.createDocumentFragment();for(const o of e){const a=document.createElement("section");a.className="hb-subpanel hb-project",a.dataset.id=`project_${o.id}`,a.dataset.projectId=o.id;const n=document.createElement("button");n.className="hb-subpanel-header",n.type="button",n.setAttribute("aria-expanded","false");const i=document.createElement("div");i.className="hb-subpanel-title",i.textContent=`${o.title||o.zipName}  ${o.placeholder}`;const c=document.createElement("div");c.className="hb-subpanel-indicator",c.textContent="+",n.appendChild(i),n.appendChild(c),a.appendChild(n);const h=document.createElement("div");h.className="hb-subpanel-body",h.style.display="none";const d=s=>{const l=document.createElement("div");l.className="hb-row";const p=document.createElement("label");return p.className="hb-label",p.textContent=s,l.appendChild(p),l};{const s=d("标题"),l=document.createElement("input");l.className="text_pole hb-proj-title",l.type="text",l.spellcheck=!1,l.value=o.title||"",l.dataset.projectId=o.id,s.appendChild(l),h.appendChild(s)}{const s=d("项目 ID"),l=document.createElement("input");l.className="text_pole hb-proj-id",l.type="text",l.readOnly=!0,l.spellcheck=!1,l.value=o.id,l.dataset.projectId=o.id,s.appendChild(l);const p=document.createElement("div");p.className="hb-actions";const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="copy_project_id",f.dataset.projectId=o.id,f.textContent="复制 ID",p.appendChild(f),s.appendChild(p),h.appendChild(s)}{const s=d("占位符"),l=document.createElement("input");l.className="text_pole hb-proj-placeholder",l.type="text",l.spellcheck=!1,l.value=o.placeholder,l.dataset.projectId=o.id,s.appendChild(l);const p=document.createElement("div");p.className="hb-actions";const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="copy_placeholder",f.dataset.projectId=o.id,f.textContent="复制";const u=document.createElement("button");u.className="menu_button",u.type="button",u.dataset.hbAction="insert_placeholder",u.dataset.projectId=o.id,u.textContent="插入到输入框",p.appendChild(f),p.appendChild(u),s.appendChild(p),h.appendChild(s)}{const s=d("入口 HTML"),l=document.createElement("input");l.className="text_pole hb-proj-home",l.type="text",l.spellcheck=!1,l.value=o.homePage,l.dataset.projectId=o.id,s.appendChild(l),h.appendChild(s)}if(o.source==="url"){const s=d("Zip URL"),l=document.createElement("input");l.className="text_pole hb-proj-zip-url",l.type="text",l.spellcheck=!1,l.value=o.zipUrl,l.dataset.projectId=o.id,l.placeholder="https://example.com/your.zip",s.appendChild(l),h.appendChild(s)}{const s=d("修复 root 相对路径（/xxx）"),l=document.createElement("input");l.className="hb-proj-fix",l.type="checkbox",l.checked=!!o.fixRootRelativeUrls,l.dataset.projectId=o.id,s.appendChild(l),h.appendChild(s)}{const s=d("消息列表显示标题"),l=document.createElement("input");l.className="hb-proj-show-title",l.type="checkbox",l.checked=!!o.showTitleInChat,l.dataset.projectId=o.id,s.appendChild(l),h.appendChild(s)}{const s=d("操作"),l=document.createElement("div");if(l.className="hb-actions",o.source==="embedded"){const u=document.createElement("button");u.className="menu_button",u.type="button",u.dataset.hbAction="import_cache",u.dataset.projectId=o.id,u.textContent="导入到缓存",l.appendChild(u);const m=document.createElement("button");m.className="menu_button",m.type="button",m.dataset.hbAction="export_zip",m.dataset.projectId=o.id,m.textContent="导出 zip",l.appendChild(m)}else if(o.source==="url"){const u=document.createElement("button");u.className="menu_button",u.type="button",u.dataset.hbAction="download_apply",u.dataset.projectId=o.id,u.textContent="下载并应用",l.appendChild(u)}else{const u=document.createElement("button");u.className="menu_button",u.type="button",u.disabled=!0,u.title="仅使用本地缓存。若缓存被清理，请在“新增项目”中重新导入 zip。",u.textContent="本地缓存模式",l.appendChild(u)}const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="open_home",p.dataset.projectId=o.id,p.textContent="打开首页",l.appendChild(p);const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="delete_project",f.dataset.projectId=o.id,f.textContent="删除项目",l.appendChild(f),s.appendChild(l),h.appendChild(s)}a.appendChild(h),r.appendChild(a)}t.appendChild(r),Qe()}async function Wt(){$("#higanbana_settings").remove();const e=await fetch(`${I}settings.html`,{cache:"no-store"});if(!e.ok)throw new Error(`加载 settings.html 失败: ${e.status}`);const t=await e.text();$("#extensions_settings").append(t)}function Ot(){const e=L();$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_render_html_blocks").prop("checked",!!e.renderHtmlCodeBlocks),$("#hb_render_html_blocks_blob").prop("checked",!!e.renderHtmlCodeBlocksUseBlobUrl),$("#hb_render_html_blocks_titlebar").prop("checked",!!e.renderHtmlCodeBlocksShowTitleBar);const t=$("#hb_homepage");t.length&&!String(t.val()??"").trim()&&t.val("index.html")}function A(){const e=L(),t=x();if(!t){$("#hb_char_info").text("（未选中角色）"),$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_homepage").val(String($("#hb_homepage").val()??"").trim()||"index.html"),Ie([]),$("#hb_import_from_card").prop("disabled",!0),$("#hb_migrate_embedded_to_local").prop("disabled",!0),$("#hb_unbind").prop("disabled",!0),$("#hb_pick_zip_btn").prop("disabled",!0),$("#hb_bind_zip").prop("disabled",!0),$("#hb_bind_zip_btn").prop("disabled",!0),$("#hb_bind_zip_local_btn").prop("disabled",!0),$("#hb_bind_url").prop("disabled",!0),$("#hb_bind_url_btn").prop("disabled",!0);return}const{chid:r,character:o}=t,a=ct(o),n=M(o);$("#hb_char_info").text([`名称：${a}`,`chid：${r}`,n?`avatar：${n}`:""].filter(Boolean).join(`
`));const i=B(o);Ie(i.projects);const c=i.projects.length>0;$("#hb_import_from_card").prop("disabled",!i.projects.some(l=>l.source==="embedded")),$("#hb_migrate_embedded_to_local").prop("disabled",!i.projects.some(l=>l.source==="embedded")),$("#hb_unbind").prop("disabled",!c),$("#hb_pick_zip_btn").prop("disabled",!1),$("#hb_bind_zip").prop("disabled",!1),$("#hb_bind_zip_btn").prop("disabled",!1),$("#hb_bind_zip_local_btn").prop("disabled",!1),$("#hb_bind_url").prop("disabled",!1),$("#hb_bind_url_btn").prop("disabled",!1);const h=$("#hb_fix_root_relative");h.length&&document.activeElement!==h.get(0)&&h.prop("checked",!!e.defaultFixRootRelativeUrls);const d=$("#hb_homepage");d.length&&document.activeElement!==d.get(0)&&!String(d.val()??"").trim()&&d.val("index.html");const s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&!String(s.val()??"").trim()&&s.val(ne(i.projects,`{{WEB_${i.projects.length+1}}}`))}function z(e){$("#hb_status").text(e)}function ue(e){return e.source==="url"?e.zipSha256?!je(e.zipSha256):!0:!je(e.zipSha256)}function et(e){const t=document.createElement("div"),r=document.createElement("h3");r.textContent=e,t.appendChild(r);const o=document.createElement("progress");o.max=100,o.value=0,o.style.width="100%",o.style.height="12px",t.appendChild(o);const a=document.createElement("div");return a.style.marginTop="8px",a.style.opacity="0.9",a.style.whiteSpace="nowrap",a.style.overflowX="auto",a.style.overflowY="hidden",t.appendChild(a),{root:t,titleEl:r,progress:o,text:a}}async function xe(e,t){const r=E();if(!r)throw new Error("上下文缺失");const o=t.filter(f=>ue(f));if(o.length===0)return{importedCount:0,cancelled:!1};if(!r.callGenericPopup||!r.POPUP_TYPE){let f=0;for(const u of o){const m=x();if(!m||Number(m.chid)!==Number(e))break;const w=u.title||u.zipName;z(`正在导入：${w} ...`);let g;if(u.source==="url")g=(await ee(u.zipUrl)).arrayBuffer;else if(u.source==="embedded")g=await q(u.zipBase64);else{z(`项目“${w}”为本地缓存模式，无法自动恢复缓存，请在面板重新导入本地 zip。`);continue}const y=await O(I,g,{fixRootRelativeUrls:u.fixRootRelativeUrls,preferredHomePage:u.homePage});R.add(y.projectId),await F();const C=B(m.character);if(!C.projects.some(_=>_.id===u.id)){console.warn("[Higanbana] skip card write: target project not found in latest card state",{chid:e,projectId:u.id});continue}const b=C.projects.map(_=>_.id===u.id?{..._,zipSha256:y.projectId,homePage:y.homePage}:_);await T(e,{projects:b}),f++}return{importedCount:f,cancelled:!1}}if(J.urlDownloadPopupInFlight)throw new Error("当前已有下载弹窗进行中，请稍后再试");J.urlDownloadPopupInFlight=!0;const a=new AbortController;let n=!1,i=!1,c=0;const{root:h,titleEl:d,progress:s,text:l}=et("彼岸花：准备导入...");l.style.whiteSpace="pre-wrap",l.style.overflowX="hidden";const p=f=>{try{l.textContent=$e(f)}catch{l.textContent="正在下载..."}if(f?.totalBytes){const u=Number(f?.percent);Number.isFinite(u)&&(s.max=100,s.value=Math.max(0,Math.min(100,u)))}else s.removeAttribute("value")};try{await r.callGenericPopup(h,r.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消",onClosing:()=>(n||(i=!0,a.abort()),!0),onOpen:async f=>{try{for(let u=0;u<o.length;u++){const m=o[u];if(a.signal.aborted)break;const w=x();if(!w||Number(w.chid)!==Number(e))break;const g=m.title||m.zipName;d.textContent=`彼岸花：正在导入（${u+1}/${o.length}）${g}`;let y;if(m.source==="url")l.textContent=`准备下载：${m.zipName}
${m.zipUrl}`,s.max=100,s.value=0,y=(await ee(m.zipUrl,{signal:a.signal,onProgress:p})).arrayBuffer,s.value=100,l.textContent=`下载完成（${K(y.byteLength)}），正在解压并写入缓存...`;else if(m.source==="embedded")s.removeAttribute("value"),l.textContent=`正在从角色卡导入并解压：${m.zipName}`,y=await q(m.zipBase64);else{l.textContent=`项目“${g}”为本地缓存模式，无法自动恢复缓存。请在面板重新导入本地 zip。`;continue}const C=await O(I,y,{fixRootRelativeUrls:m.fixRootRelativeUrls,preferredHomePage:m.homePage});R.add(C.projectId),await F();const j=B(w.character);if(!j.projects.some(v=>v.id===m.id)){console.warn("[Higanbana] skip card write: target project not found in latest card state",{chid:e,projectId:m.id});continue}const _=j.projects.map(v=>v.id===m.id?{...v,zipSha256:C.projectId,homePage:C.homePage}:v);await T(e,{projects:_}),c++}n=!0;try{await f.completeAffirmative?.()}catch{}}catch(u){n=!0;try{await f.completeCancelled?.()}catch{}throw u}}})}finally{J.urlDownloadPopupInFlight=!1}return{importedCount:c,cancelled:i}}async function Zt(e){const t=E();if(!t)return null;if(!t.callGenericPopup||!t.POPUP_TYPE){const d=await ee(e.zipUrl),s=await O(I,d.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});return R.add(s.projectId),await F(),{projectId:s.projectId,homePage:s.homePage,fileCount:s.fileCount}}if(J.urlDownloadPopupInFlight)return null;J.urlDownloadPopupInFlight=!0;const r=new AbortController;let o=!1,a=null;const{root:n,progress:i,text:c}=et("彼岸花：正在下载 WebZip...");c.textContent=`准备下载：${e.zipName} | ${e.zipUrl}`;const h=d=>{if(c.textContent=$e(d),d.totalBytes){const s=Number(d.percent);Number.isFinite(s)&&(i.max=100,i.value=Math.max(0,Math.min(100,s)))}else i.removeAttribute("value")};try{await t.callGenericPopup(n,t.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消下载",onClosing:()=>(o||r.abort(),!0),onOpen:async d=>{try{const s=await ee(e.zipUrl,{signal:r.signal,onProgress:h});i.max=100,i.value=100,c.textContent=`下载完成（${K(s.arrayBuffer.byteLength)}），正在解压并写入缓存...`;const l=await O(I,s.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});R.add(l.projectId),await F(),a={projectId:l.projectId,homePage:l.homePage,fileCount:l.fileCount},o=!0;try{await d.completeAffirmative()}catch{}}catch(s){r.signal.aborted||s?.name==="AbortError"?toastr.info("已取消下载"):(console.error("[Higanbana] url download failed",s),toastr.error(`下载失败：${s?.message??s}`)),o=!0;try{await d.completeCancelled?.()}catch{}}}})}finally{J.urlDownloadPopupInFlight=!1}return a}let Y=null;const Ue=20*1024*1024;function re(e){const t=Number(e?.byteLength??0);if(!Number.isFinite(t)||t<=Ue)return;const r=Math.round(Ue/1024/1024);throw new Error(`当前 zip 大小为 ${K(t)}，超过嵌入上限（${r} MB）。请改用“添加本地缓存项目（不嵌入）”或 URL 模式。`)}function Re(e){const t=$("#hb_url_download_wrap"),r=$("#hb_cancel_url_download_btn");e?(t.show(),r.show()):(t.hide(),r.hide())}function Gt(e){const t=$("#hb_url_download_wrap"),r=$("#hb_url_progress"),o=$("#hb_url_progress_text");t.length&&t.show();try{o.text($e(e))}catch{o.text("正在下载...")}if(e?.totalBytes){const a=Number(e?.percent);Number.isFinite(a)&&(r.attr("max","100"),r.get(0)?.removeAttribute?.("value"),r.val(Math.max(0,Math.min(100,a))))}else r.get(0)?.removeAttribute?.("value")}function qt(){try{Y?.abort()}catch{}}async function Vt(){const e=E(),t=x();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const r=B(t.character),o=r.projects.find(h=>h.source==="url");if(!o)throw new Error("当前角色卡没有 URL 项目");if(J.urlDownloadPopupInFlight)throw new Error("当前已有自动下载弹窗进行中，请稍后再试");Y&&!Y.signal.aborted&&Y.abort();const a=M(t.character);a&&Z(a);const n=o.fixRootRelativeUrls,i=o.homePage,c=new AbortController;Y=c,Re(!0),$("#hb_url_progress").attr("max","100"),$("#hb_url_progress").val(0),$("#hb_url_progress_text").text(`准备下载：${o.zipName} | ${o.zipUrl}`),$("#hb_bind_url_btn").prop("disabled",!0),$("#hb_download_url_btn").prop("disabled",!0);try{const h=await ee(o.zipUrl,{signal:c.signal,onProgress:Gt});if(c.signal.aborted)throw new Error("已取消下载");z("下载完成，正在解压并写入 VFS 缓存...");const d=await O(I,h.arrayBuffer,{fixRootRelativeUrls:n,preferredHomePage:i});R.add(d.projectId),await F();const s={projects:r.projects.map(l=>l.source==="url"?{...l,zipSha256:d.projectId,homePage:d.homePage}:l)};await T(t.chid,s),z(`已下载并导入缓存。
projectId(sha256)：${d.projectId}
入口：${d.homePage}
文件数：${d.fileCount}

提示：在消息中插入占位符即可渲染`),e?.reloadCurrentChat&&await e.reloadCurrentChat()}finally{Y===c&&(Y=null),Re(!1),$("#hb_bind_url_btn").prop("disabled",!1),$("#hb_download_url_btn").prop("disabled",!1),A()}}async function Yt(e,t){const r=x();if(!r)throw new Error("当前不在单角色聊天/未选中角色");re(t);const o=M(r.character);o&&Z(o);const a=L(),n=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=n,G();const i=String($("#hb_homepage").val()??"").trim()||void 0;z("正在解压并写入 VFS 缓存...");const c=await O(I,t,{fixRootRelativeUrls:n,preferredHomePage:i});R.add(c.projectId),await F(),z("正在编码 base64 并写入角色卡扩展字段...");const h=await Se(t),d=B(r.character),s=oe($("#hb_placeholder").val()),l=ne(d.projects,s),p=String($("#hb_new_title").val()??"").trim(),f=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,u={source:"embedded",id:te(),title:p||void 0,placeholder:l,homePage:c.homePage,showTitleInChat:f,fixRootRelativeUrls:n,zipName:e,zipSha256:c.projectId,zipBase64:h},m={projects:[...d.projects,u]};await T(r.chid,m);const w=$("#hb_placeholder");w.length&&document.activeElement!==w.get(0)&&w.val(""),A(),$("#hb_new_title").val(""),z(`已添加项目（嵌入模式）。
占位符：${l}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}

提示：导出该角色卡(json/png)会包含该项目的 zipBase64`)}async function Jt(e,t){const r=x();if(!r)throw new Error("当前不在单角色聊天/未选中角色");const o=M(r.character);o&&Z(o);const a=L(),n=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=n,G();const i=String($("#hb_homepage").val()??"").trim()||void 0;z("正在解压并写入 VFS 缓存...");const c=await O(I,t,{fixRootRelativeUrls:n,preferredHomePage:i});R.add(c.projectId),await F();const h=B(r.character),d=oe($("#hb_placeholder").val()),s=ne(h.projects,d),l=String($("#hb_new_title").val()??"").trim(),p=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,f={source:"local",id:te(),title:l||void 0,placeholder:s,homePage:c.homePage,showTitleInChat:p,fixRootRelativeUrls:n,zipName:e,zipSha256:c.projectId},u={projects:[...h.projects,f]};await T(r.chid,u);const m=$("#hb_placeholder");m.length&&document.activeElement!==m.get(0)&&m.val(""),A(),$("#hb_new_title").val(""),z(`已添加项目（本地缓存模式，不嵌入角色卡）。
占位符：${s}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}

提示：导出角色卡时不会包含该 zip；若浏览器缓存被清理，需要在本机重新导入 zip。`)}async function Xt({allow:e=!0,ensureCached:t=!0,reloadChat:r=!0}={}){const o=E(),a=x();if(!a)throw new Error("当前不在单角色聊天/未选中角色");const n=M(a.character);e&&n&&Z(n);const c=B(a.character).projects.filter(u=>u.source==="embedded"),h=c.length;if(h===0)return{totalEmbedded:0,migrated:0,importedCount:0,cancelled:!1};let d=0,s=!1;if(t){const u=c.filter(m=>ue(m));if(u.length>0){z(`发现 ${u.length} 个嵌入项目未缓存，正在导入缓存...`);const m=await xe(a.chid,u);if(d=m.importedCount,s=m.cancelled,s)return z("已取消迁移（未修改角色卡）"),{totalEmbedded:h,migrated:0,importedCount:d,cancelled:!0}}}const l=B(a.character);let p=0;const f=l.projects.map(u=>u.source!=="embedded"?u:(p++,{source:"local",id:u.id,title:u.title,placeholder:u.placeholder,homePage:u.homePage,showTitleInChat:u.showTitleInChat,fixRootRelativeUrls:u.fixRootRelativeUrls,zipName:u.zipName,zipSha256:u.zipSha256}));return await T(a.chid,{projects:f}),r&&o?.reloadCurrentChat&&await o.reloadCurrentChat(),A(),{totalEmbedded:h,migrated:p,importedCount:d,cancelled:!1}}function he(e,t,r){const o=String(t??"").trim(),a=String(r??"").trim();if(o){const n=e.findIndex(i=>i.id===o);if(n<0)throw new Error(`找不到目标项目：${o}`);return n}if(a){const n=[];for(let i=0;i<e.length;i++)e[i]?.zipSha256===a&&n.push(i);if(n.length===0)throw new Error(`找不到使用该 zipSha256 的项目：${a}`);if(n.length>1)throw new Error("存在多个项目使用相同 zipSha256，请传入 targetProjectId 精确指定目标项目");return n[0]}throw new Error("缺少目标项目标识，请提供 targetProjectId 或 targetZipSha256")}async function tt(e){const t=E(),{active:r,card:o}=W(),a=he(o.projects,e?.targetProjectId,e?.targetZipSha256),n=o.projects[a],i=String(e?.source??n.source).trim(),c=i==="embedded"||i==="url"||i==="local"?i:"";if(!c)throw new Error(`非法 source：${i}`);const h=e?.title!==void 0?String(e.title??"").trim()||void 0:n.title,d=e?.placeholder!==void 0?String(e.placeholder??"").trim():n.placeholder,s=e?.homePage!==void 0?String(e.homePage??"").trim():n.homePage,l=typeof e?.showTitleInChat=="boolean"?!!e.showTitleInChat:!!n.showTitleInChat,p=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!n.fixRootRelativeUrls,f=e?.zipName!==void 0?String(e.zipName??"").trim():n.zipName,u=e?.zipSha256!==void 0?String(e.zipSha256??"").trim():String(n.zipSha256??"").trim();if(!d)throw new Error("placeholder 不能为空");if(!s)throw new Error("homePage 不能为空");if(!f)throw new Error("zipName 不能为空");if(o.projects.some((y,C)=>C!==a&&y.placeholder===d))throw new Error(`占位符已被其它项目占用：${d}`);let w;if(c==="url"){const y=e?.zipUrl!==void 0?String(e.zipUrl??"").trim():n.source==="url"?n.zipUrl:"";if(!y)throw new Error("source=url 时 zipUrl 不能为空");w={source:"url",id:n.id,title:h,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:f,zipSha256:u||"",zipUrl:y}}else if(c==="embedded"){const y=e?.zipBase64!==void 0?String(e.zipBase64??"").trim():n.source==="embedded"?n.zipBase64:"";if(!y)throw new Error("source=embedded 时 zipBase64 不能为空");if(!u)throw new Error("source=embedded 时 zipSha256 不能为空");if(e?.zipBase64!==void 0){const C=await q(y);re(C)}w={source:"embedded",id:n.id,title:h,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:f,zipSha256:u,zipBase64:y}}else{if(!u)throw new Error("source=local 时 zipSha256 不能为空");w={source:"local",id:n.id,title:h,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:f,zipSha256:u}}const g=[...o.projects];return g[a]=w,await T(r.chid,{projects:g}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),A(),H(),{targetProjectId:n.id,project:w}}function Kt(e){if(!e||typeof e!="object")return!1;if(e instanceof ArrayBuffer)return!0;try{return Object.prototype.toString.call(e)==="[object ArrayBuffer]"}catch{return!1}}function Te(e){if(ArrayBuffer.isView(e)){const o=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a=new Uint8Array(o.byteLength);return a.set(o),a.buffer}if(e instanceof Uint8Array){const o=new Uint8Array(e.byteLength);return o.set(e),o.buffer}const t=new Uint8Array(e),r=new Uint8Array(t.byteLength);return r.set(t),r.buffer}async function rt(e){const t=e?.zipArrayBuffer;if(t){if(Kt(t)||ArrayBuffer.isView(t))return Te(t);if(typeof Blob<"u"&&Object.prototype.toString.call(t)==="[object Blob]"&&typeof t.arrayBuffer=="function")return Te(new Uint8Array(await t.arrayBuffer()))}const r=String(e?.importZipBase64??e?.zipBase64??"").trim();if(r)return await q(r);throw new Error("缺少 zip 数据，请提供 zipArrayBuffer 或 zipBase64")}async function Qt(e){const{card:t}=W(),r=he(t.projects,e?.targetProjectId,e?.targetZipSha256),o=t.projects[r],a=await rt(e),n=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!o.fixRootRelativeUrls,i=String(e?.preferredHomePage??e?.homePage??o.homePage??"").trim()||void 0;z("正在导入新 zip 并写入 VFS 缓存...");const c=await O(I,a,{fixRootRelativeUrls:n,preferredHomePage:i});R.add(c.projectId),await F();const h=String(e?.source??o.source).trim(),d=h==="embedded"||h==="url"||h==="local"?h:"";if(!d)throw new Error(`非法 source：${h}`);const s={targetProjectId:o.id,source:d,zipName:e?.zipName!==void 0?String(e.zipName??"").trim():o.zipName,homePage:c.homePage,zipSha256:c.projectId,fixRootRelativeUrls:n,reloadChat:e?.reloadChat};if(d==="url"&&e?.zipUrl!==void 0&&(s.zipUrl=String(e.zipUrl??"").trim()),d==="embedded"){if(!(e?.persistEmbeddedToCard!==!1))throw new Error("source=embedded 时必须写入 zipBase64；若不希望写入角色卡，请将 source 设为 local");re(a),s.zipBase64=e?.zipBase64!==void 0?String(e.zipBase64??"").trim():await Se(a)}const l=await tt(s);return z(`已覆盖项目 zip。
项目：${l.project.title||l.project.zipName}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}`),{targetProjectId:l.targetProjectId,project:l.project,imported:c}}async function er(e){const t=e?.zipArrayBuffer instanceof ArrayBuffer||e?.zipArrayBuffer instanceof Uint8Array,r=String(e?.importZipBase64??"").trim().length>0;return t||r?await Qt({...e,zipBase64:void 0}):await tt(e)}function le(e){return e.source==="embedded"?{...e,source:"embedded",zipBase64:String(e.zipBase64??"")}:e.source==="url"?{...e,source:"url",zipUrl:String(e.zipUrl??"")}:{...e,source:"local"}}function tr(e={}){const{card:t}=W(),r=t.projects.map(le),o=!!e?.includeAll,a=String(e?.targetProjectId??"").trim(),n=String(e?.targetZipSha256??"").trim();if(o||!a&&!n)return{projects:r};const i=he(t.projects,a,n);return{projects:r,project:le(t.projects[i])}}async function rr(e){const t=E(),{active:r,card:o}=W(),a=he(o.projects,e?.targetProjectId,e?.targetZipSha256),n=o.projects[a],i=o.projects.filter((c,h)=>h!==a);return await T(r.chid,{projects:i}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),A(),H(),z(`已删除项目：${n.title||n.zipName}`),{deletedProjectId:n.id,deletedProject:le(n),remainingCount:i.length}}async function or(e){const t=E(),{active:r,card:o}=W(),a=L(),n=e?.zipArrayBuffer instanceof ArrayBuffer||e?.zipArrayBuffer instanceof Uint8Array,i=String(e?.importZipBase64??"").trim().length>0,c=n||i,h=c?"local":String(e?.zipUrl??"").trim()?"url":String(e?.zipBase64??"").trim()?"embedded":"local",d=String(e?.source??h).trim(),s=d==="embedded"||d==="url"||d==="local"?d:"";if(!s)throw new Error(`非法 source：${d}`);const p=oe(e?.placeholder??"")||a.placeholder,f=ne(o.projects,p);let u=te();for(;o.projects.some(k=>k.id===u);)u=te();const m=String(e?.title??"").trim()||void 0,w=typeof e?.showTitleInChat=="boolean"?!!e.showTitleInChat:!1,g=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!a.defaultFixRootRelativeUrls,y=String(e?.zipUrl??"").trim();let C=String(e?.zipName??"").trim(),j=String(e?.homePage??"").trim(),b=String(e?.zipSha256??"").trim(),_=String(e?.zipBase64??"").trim(),v;if(c){const k=await rt(e),U=String(e?.preferredHomePage??e?.homePage??"").trim()||void 0;z("正在导入新 zip 并创建项目...");const N=await O(I,k,{fixRootRelativeUrls:g,preferredHomePage:U});if(R.add(N.projectId),await F(),v={projectId:N.projectId,homePage:N.homePage,fileCount:N.fileCount,cacheName:N.cacheName},b=N.projectId,j=N.homePage,s==="embedded"){if(!(e?.persistEmbeddedToCard!==!1))throw new Error("source=embedded 时必须写入 zipBase64；若不希望写入角色卡，请将 source 设为 local");re(k),_||(_=await Se(k))}}if(s==="url"&&!y)throw new Error("source=url 时 zipUrl 不能为空");C||(s==="url"?C=y?Ke(y):"webzip.zip":C="webzip.zip"),j||(j="index.html");let S;if(s==="embedded"){if(!_)throw new Error("source=embedded 时 zipBase64 不能为空（可改传 zipArrayBuffer/importZipBase64 自动导入）");if(!b)throw new Error("source=embedded 时 zipSha256 不能为空（可改传 zipArrayBuffer/importZipBase64 自动生成）");if(!c){const k=await q(_);re(k)}S={source:"embedded",id:u,title:m,placeholder:f,homePage:j,showTitleInChat:w,fixRootRelativeUrls:g,zipName:C,zipSha256:b,zipBase64:_}}else if(s==="url")S={source:"url",id:u,title:m,placeholder:f,homePage:j,showTitleInChat:w,fixRootRelativeUrls:g,zipName:C,zipSha256:b||"",zipUrl:y};else{if(!b)throw new Error("source=local 时 zipSha256 不能为空（可改传 zipArrayBuffer/importZipBase64 自动导入）");S={source:"local",id:u,title:m,placeholder:f,homePage:j,showTitleInChat:w,fixRootRelativeUrls:g,zipName:C,zipSha256:b}}const P=[...o.projects,S];return await T(r.chid,{projects:P}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),A(),H(),z(`已创建项目：${S.title||S.zipName}
项目ID：${S.id}
占位符：${S.placeholder}`),{project:le(S),imported:v}}async function nr({allow:e=!0,reloadChat:t=!0}={}){const r=E(),o=x();if(!o)throw new Error("当前不在单角色聊天/未选中角色");const a=B(o.character),n=a.projects.filter(d=>d.source==="embedded");if(n.length===0)throw new Error("当前角色卡没有可导入的嵌入项目");const i=M(o.character);e&&i&&Z(i);const c=[...a.projects];let h=!1;for(const d of n){if(d.zipSha256&&R.has(d.zipSha256))continue;z(`正在从角色卡导入：${d.title||d.zipName} ...`);const s=await q(d.zipBase64),l=await O(I,s,{fixRootRelativeUrls:d.fixRootRelativeUrls,preferredHomePage:d.homePage});if(R.add(l.projectId),await F(),l.projectId!==d.zipSha256){console.warn("[Higanbana] zipSha256 mismatch",{embedded:d.zipSha256,computed:l.projectId});const p=c.findIndex(f=>f.id===d.id);if(p>=0){const f=c[p];f&&f.source==="embedded"&&(c[p]={...f,zipSha256:l.projectId,homePage:l.homePage},h=!0)}}}h&&await T(o.chid,{projects:c}),z(`已导入到缓存。
已导入项目数：${n.length}`),t&&r?.reloadCurrentChat&&await r.reloadCurrentChat()}function W(){const e=x();if(!e)throw new Error("当前不在单角色聊天/未选中角色");const t=B(e.character);return{active:e,card:t}}function ae(e,t){const r=String(t??"").trim();if(!r)throw new Error("项目 id 为空");const o=e.projects.find(a=>a.id===r);if(!o)throw new Error("找不到项目（可能已被删除）");return o}function ar(e){const{card:t}=W(),r=ae(t,e);if(!r.zipSha256)throw new Error("尚未下载/导入到本地缓存");if(!R.has(r.zipSha256))throw new Error("尚未导入到本地缓存");const o=de(I,r.zipSha256,r.homePage);window.open(o,"_blank","noopener,noreferrer")}async function ir(e){const{card:t}=W(),r=ae(t,e);if(r.source!=="embedded")throw new Error("当前项目不是嵌入模式，无法导出 zip");const o=await q(r.zipBase64),a=new Blob([o],{type:"application/zip"});Xe(a,r.zipName||"webzip.zip")}async function cr(e){const{active:t,card:r}=W(),o=ae(r,e);if(o.source!=="embedded")throw new Error("当前项目不是嵌入模式");if(!ue(o))return{importedCount:0,cancelled:!1};const a=M(t.character);a&&Z(a);const n=await xe(t.chid,[o]);return n.cancelled||(await E()?.reloadCurrentChat?.(),A()),n}async function sr(e){const{active:t,card:r}=W(),o=ae(r,e);if(o.source!=="url")throw new Error("当前项目不是 URL 模式");const a=M(t.character);a&&Z(a);const n=await Zt(o);if(!n)return!1;const c={projects:B(t.character).projects.map(h=>h.id===o.id?{...h,zipSha256:n.projectId,homePage:n.homePage}:h)};return await T(t.chid,c),await E()?.reloadCurrentChat?.(),A(),!0}async function lr(e){const t=E(),{active:r,card:o}=W(),a=ae(o,e),n=o.projects.filter(i=>i.id!==a.id);await T(r.chid,n.length?{projects:n}:null),await t?.reloadCurrentChat?.(),A()}async function dr(){const{active:e}=W();await T(e.chid,null),A()}async function ur(e){const t=x();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const r=Lt(e);if(!r)throw new Error("请输入合法的 http/https zip URL");const o=M(t.character);o&&Z(o);const a=!!$("#hb_fix_root_relative").prop("checked"),n=String($("#hb_homepage").val()??"").trim()||"index.html",i=Ke(r),c=B(t.character),h=oe($("#hb_placeholder").val()),d=ne(c.projects,h),s=String($("#hb_new_title").val()??"").trim(),l=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,p={source:"url",id:te(),title:s||void 0,placeholder:d,homePage:n,showTitleInChat:l,fixRootRelativeUrls:a,zipName:i,zipSha256:"",zipUrl:r},f={projects:[...c.projects,p]};return await T(t.chid,f),{zipUrl:r,placeholder:d,homePage:n}}function hr(){Qe();const e=E();$("#hb_pick_zip_btn").on("click",()=>{document.getElementById("hb_bind_zip")?.click()}),$("#hb_bind_zip").on("change",()=>{const n=document.getElementById("hb_bind_zip")?.files?.[0];$("#hb_bind_zip_name").text(n?n.name:"（未选择文件）")}),$("#hb_fix_root_relative").on("change",()=>{const n=L();n.defaultFixRootRelativeUrls=!!$("#hb_fix_root_relative").prop("checked"),G()}),$("#hb_render_html_blocks").on("change",()=>{const n=L();n.renderHtmlCodeBlocks=!!$("#hb_render_html_blocks").prop("checked"),G(),H()}),$("#hb_render_html_blocks_blob").on("change",()=>{const n=L();n.renderHtmlCodeBlocksUseBlobUrl=!!$("#hb_render_html_blocks_blob").prop("checked"),G(),H()}),$("#hb_render_html_blocks_titlebar").on("change",()=>{const n=L();n.renderHtmlCodeBlocksShowTitleBar=!!$("#hb_render_html_blocks_titlebar").prop("checked"),G(),H()}),$("#hb_placeholder").on("input",()=>{const n=L();n.placeholder=String($("#hb_placeholder").val()??"").trim()||V.placeholder,G()}),$("#hb_copy_placeholder").on("click",async()=>{const n=String($("#hb_placeholder").val()??"").trim();if(!n){toastr.error("占位符为空");return}try{await navigator.clipboard.writeText(n),toastr.success("已复制占位符")}catch(i){console.warn("[Higanbana] copy failed",i),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_insert_placeholder").on("click",()=>{const n=String($("#hb_placeholder").val()??"").trim();if(!n){toastr.error("占位符为空");return}const i=$("#send_textarea");if(i.length===0){toastr.error("找不到输入框");return}const c=String(i.val()??"");i.val(c?`${c}
${n}`:n),i.trigger("input"),toastr.success("已插入占位符")});const t=new Map,r=new Set,o=(n,i=400)=>{const c=t.get(n);c&&clearTimeout(c);const h=window.setTimeout(()=>{t.delete(n),a(n).catch(d=>console.warn("[Higanbana] project auto save failed",d))},Math.max(0,i));t.set(n,h)},a=async n=>{if(!r.has(n)){r.add(n);try{const i=x();if(!i)return;const c=B(i.character),h=c.projects.findIndex(D=>D.id===n);if(h<0)return;const d=document.getElementById("hb_projects_list");if(!d)return;const s=String(n).replace(/\\/g,"\\\\").replace(/"/g,'\\"'),l=d.querySelector(`.hb-proj-title[data-project-id="${s}"]`),p=d.querySelector(`.hb-proj-placeholder[data-project-id="${s}"]`),f=d.querySelector(`.hb-proj-home[data-project-id="${s}"]`),u=d.querySelector(`.hb-proj-zip-url[data-project-id="${s}"]`),m=d.querySelector(`.hb-proj-fix[data-project-id="${s}"]`),w=d.querySelector(`.hb-proj-show-title[data-project-id="${s}"]`),g=c.projects[h],y=String(l?.value??"").trim(),C=y||void 0,j=String(p?.value??"").trim(),b=String(f?.value??"").trim(),_=!!m?.checked,v=w?!!w.checked:!!g.showTitleInChat,S=String(u?.value??"").trim();if(!j||!b||g.source==="url"&&!S)return;if(c.projects.some(D=>D.id!==n&&D.placeholder===j)){toastr.error("占位符重复，请为每个项目设置不同的占位符"),p&&(p.value=g.placeholder);return}if(!(g.title!==C||g.placeholder!==j||g.homePage!==b||g.fixRootRelativeUrls!==_||g.showTitleInChat!==v||g.source==="url"&&g.zipUrl!==S))return;const U=c.projects.map(D=>D.id!==n?D:D.source==="url"?{...D,title:C,placeholder:j,homePage:b,fixRootRelativeUrls:_,showTitleInChat:v,zipUrl:S}:{...D,title:C,placeholder:j,homePage:b,fixRootRelativeUrls:_,showTitleInChat:v});await T(i.chid,{projects:U}),g.showTitleInChat!==v&&It(n,v);const N=d.querySelector(`.hb-project[data-project-id="${s}"] .hb-subpanel-title`);N&&(N.textContent=`${C||g.zipName}  ${j}`),z(`已保存项目设置：${C||g.zipName}`),H()}finally{r.delete(n)}}};$("#hb_projects_list").on("input",".hb-proj-title, .hb-proj-placeholder, .hb-proj-home, .hb-proj-zip-url",n=>{const i=String(n.target?.getAttribute?.("data-project-id")??"").trim();i&&o(i,500)}),$("#hb_projects_list").on("change",".hb-proj-fix, .hb-proj-show-title",n=>{const i=String(n.target?.getAttribute?.("data-project-id")??"").trim();i&&o(i,0)}),$("#hb_projects_list").on("click",'[data-hb-action="copy_placeholder"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=B(c.character).projects.find(s=>s.id===i);if(d)try{await navigator.clipboard.writeText(d.placeholder),toastr.success("已复制占位符")}catch(s){console.warn("[Higanbana] copy placeholder failed",s),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="copy_project_id"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{await navigator.clipboard.writeText(i),toastr.success("已复制项目 ID")}catch(c){console.warn("[Higanbana] copy project id failed",c);try{window.prompt("复制失败，请手动复制项目 ID：",i)}catch{}toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="insert_placeholder"]',n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=B(c.character).projects.find(p=>p.id===i);if(!d)return;const s=$("#send_textarea");if(s.length===0){toastr.error("找不到输入框");return}const l=String(s.val()??"");s.val(l?`${l}
${d.placeholder}`:d.placeholder),s.trigger("input"),toastr.success("已插入占位符")}),$("#hb_projects_list").on("click",'[data-hb-action="open_home"]',n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{ar(i)}catch(c){toastr.error(c?.message??c)}}),$("#hb_projects_list").on("click",'[data-hb-action="export_zip"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{await ir(i)}catch(c){console.error("[Higanbana] export zip failed",c),toastr.error(`导出失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="import_cache"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{const c=await cr(i);if(c.cancelled){toastr.info("已取消导入");return}c.importedCount>0?toastr.success("已导入到本地缓存"):toastr.info("该项目已在本地缓存"),H()}catch(c){console.error("[Higanbana] import cache failed",c),toastr.error(`导入失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="download_apply"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{if(!await sr(i))return;H(),toastr.success("已下载并应用")}catch(c){console.error("[Higanbana] download apply failed",c),toastr.error(`操作失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="delete_project"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=B(c.character).projects.find(p=>p.id===i);if(!d)return;const s=d.title||d.zipName;let l=!1;try{e?.Popup?.show?.confirm?l=await e.Popup.show.confirm("彼岸花",`确定删除项目：${s}？`):l=window.confirm(`确定删除项目：${s}？`)}catch{l=window.confirm(`确定删除项目：${s}？`)}if(l)try{await lr(i),H(),toastr.success("已删除项目")}catch(p){console.error("[Higanbana] delete project failed",p),toastr.error(`删除失败：${p?.message??p}`)}}),$("#hb_import_from_card").on("click",async()=>{try{toastr.info("开始导入，请稍候..."),await nr({allow:!0,reloadChat:!0}),toastr.success("已导入并启用（可在消息中渲染占位符）"),A()}catch(n){console.error("[Higanbana] import from card failed",n),toastr.error(`导入失败：${n?.message??n}`)}}),$("#hb_migrate_embedded_to_local").on("click",async()=>{const n=x();if(!n)return;const c=B(n.character).projects.filter(s=>s.source==="embedded").length;if(c===0){toastr.info("当前角色卡没有可迁移的嵌入项目");return}const h=`确定将当前角色卡中的 ${c} 个“嵌入项目”迁移为“本地缓存模式”吗？

迁移后：
1) 角色卡将不再保存 zipBase64（体积会明显下降）
2) 若当前浏览器缓存被清理，需要在本机重新导入 zip
3) 迁移前会先尝试把未缓存项目导入到本地缓存
`;let d=!1;try{e?.Popup?.show?.confirm?d=await e.Popup.show.confirm("彼岸花",h):d=window.confirm(h)}catch{d=window.confirm(h)}if(d)try{const s=await Xt({allow:!0,ensureCached:!0,reloadChat:!0});if(s.cancelled){toastr.info("已取消迁移（未修改角色卡）");return}toastr.success(`迁移完成：${s.migrated}/${s.totalEmbedded}，预导入缓存：${s.importedCount}`)}catch(s){console.error("[Higanbana] migrate embedded->local failed",s),toastr.error(`迁移失败：${s?.message??s}`)}}),$("#hb_open_home").on("click",()=>{const n=x();if(!n)return;const c=B(n.character).projects[0];if(!c){toastr.error("当前角色卡未绑定任何 WebZip 项目");return}if(!c.zipSha256){toastr.error("尚未下载/导入 WebZip 到本地缓存");return}const h=de(I,c.zipSha256,c.homePage);window.open(h,"_blank","noopener,noreferrer")}),$("#hb_export_zip").on("click",async()=>{const n=x();if(!n)return;const c=B(n.character).projects.find(h=>h.source==="embedded");if(!c){toastr.error("当前角色卡没有可导出的嵌入项目");return}try{const h=await q(c.zipBase64),d=new Blob([h],{type:"application/zip"});Xe(d,c.zipName||"webzip.zip")}catch(h){console.error("[Higanbana] export zip failed",h),toastr.error(`导出失败：${h?.message??h}`)}}),$("#hb_unbind").on("click",async()=>{const n=E(),i=x();if(!i)return;const c=B(i.character);if(c.projects.length===0)return;const h=`确定解绑当前角色的所有 WebZip 项目？

${Dt(c)}`;let d=!1;try{n?.Popup?.show?.confirm?d=await n.Popup.show.confirm("彼岸花",h):d=window.confirm(h)}catch{d=window.confirm(h)}if(d)try{await dr(),toastr.success("已解绑"),A()}catch(s){console.error("[Higanbana] unbind failed",s),toastr.error(`解绑失败：${s?.message??s}`)}}),$("#hb_bind_zip_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=$("#hb_bind_zip").get(0)?.files?.[0];if(!i){toastr.error("请先选择 zip 文件");return}try{await Yt(i.name,await i.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(c){console.error("[Higanbana] bind zip failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_bind_zip_local_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=$("#hb_bind_zip").get(0)?.files?.[0];if(!i){toastr.error("请先选择 zip 文件");return}try{await Jt(i.name,await i.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(c){console.error("[Higanbana] bind local zip failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_bind_url_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=String($("#hb_bind_url").val()??"").trim();try{const{zipUrl:c,placeholder:h,homePage:d}=await ur(i),s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&s.val(""),A(),$("#hb_new_title").val(""),z(`已添加项目（URL 模式）。
占位符：${h}
URL：${c}
入口：${d}
提示：进入聊天时会提示下载并导入缓存`),toastr.success("已添加 URL 项目")}catch(c){console.error("[Higanbana] bind url failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_download_url_btn").on("click",async()=>{try{await Vt()}catch(n){console.error("[Higanbana] download url apply failed",n),toastr.error(`操作失败：${n?.message??n}`)}}),$("#hb_cancel_url_download_btn").on("click",()=>{try{qt()}catch{}})}let ge=!1;async function pr(e,t){const r=t.map(o=>{const a=o.source==="url"?o.zipSha256||o.zipUrl:o.zipSha256;return`${o.id}:${o.source}:${a}`}).join("|");try{const o=await Me(new TextEncoder().encode(r).buffer);return`AlertHiganbana_${e}_projects_${o}`}catch{return`AlertHiganbana_${e}_projects_${r.slice(0,80)}`}}function fr(e){const r=(String(e??"").trim()||"x").replace(/[^a-zA-Z0-9_-]/g,"_");return r.startsWith("hb_")?r:`hb_${r}`}async function ot(){const e=E(),t=x();if(!e||!t)return;const r=B(t.character);if(r.projects.length===0)return;const o=M(t.character);if(o&&!ge){ge=!0;try{const a=We(o),n=r.projects.filter(p=>ue(p)),i=n.filter(p=>p.source!=="local"),c=n.filter(p=>p.source==="local");if(!(!a||n.length>0))return;const d=await pr(o,r.projects);try{if(e.accountStorage?.getItem?.(d))return;e.accountStorage?.setItem?.(d,"true")}catch{}let s=0,l=[];if(e.callGenericPopup&&e.POPUP_TYPE?.CONFIRM){const p=document.createElement("div"),f=document.createElement("h3");f.textContent="此角色卡包含 WebZip 前端项目。",p.appendChild(f);const u=document.createElement("h3");i.length>0?u.textContent=`发现 ${i.length} 个未缓存项目，是否下载并启用？`:c.length>0?u.textContent=`发现 ${c.length} 个“本地缓存模式”项目未命中缓存。`:u.textContent="是否启用它们？",p.appendChild(u);const m=document.createElement("div");if(m.className="m-b-1",m.style.opacity="0.85",m.textContent="你可以稍后在扩展栏的“彼岸花”面板里管理这些项目。",p.appendChild(m),c.length>0){const b=document.createElement("div");b.className="m-b-1",b.style.opacity="0.85",b.textContent="本地缓存模式不会把 zip 写入角色卡，因此无法自动下载恢复。请在本机重新导入本地 zip（可用“添加本地缓存项目（不嵌入）”）。",p.appendChild(b)}const w=new Map,g=i.length>0?i.map(b=>{const _=fr(`miss_${b.id}`);w.set(_,b.id);const v=b.title||b.zipName,S=b.source==="embedded"?"嵌入":b.source==="url"?"URL":"本地缓存",P=`${v}  |  ${S}  |  ${b.placeholder}`,k=b.source==="url"?b.zipUrl:b.source==="embedded"?"嵌入于角色卡":"仅本地缓存（不嵌入角色卡）";return{id:_,label:P,type:"checkbox",defaultState:!0,tooltip:k}}):null,y=i.length>0?"下载选中并启用":"启用",C=a?"取消":"否",j=i.length>0?["下载全部"]:null;if(s=await e.callGenericPopup(p,e.POPUP_TYPE.CONFIRM,"",{okButton:y,cancelButton:C,customButtons:j,customInputs:g,wide:!0}),!s)return;if(i.length>0)if(Number(s)>=2)l=[...i];else{const b=e.Popup?.util?.lastResult?.inputResults,_=new Set;for(const[v,S]of w)b?.get?.(v)&&_.add(S);l=i.filter(v=>_.has(v.id))}}else{if(!window.confirm(n.length>0?i.length>0?`此角色卡包含 WebZip 项目，且有 ${i.length} 个可自动下载的未缓存项目。是否启用并下载？`:"此角色卡包含本地缓存模式项目，但当前浏览器未命中缓存。是否先启用（稍后可在面板重新导入本地 zip）？":"此角色卡包含 WebZip 项目，是否启用？"))return;l=[...i]}Z(o);try{if(l.length>0){toastr.info("开始下载/导入项目，请稍候...");const p=await xe(t.chid,l);if(p.cancelled){toastr.info("已取消导入");return}p.importedCount>0&&toastr.success(`已导入 ${p.importedCount} 个项目`)}c.length>0&&toastr.info(`检测到 ${c.length} 个本地缓存模式项目未命中缓存，请在“彼岸花”面板重新导入本地 zip。`),await e.reloadCurrentChat?.(),A(),H()}catch(p){console.error("[Higanbana] import queue failed",p),toastr.error(`导入失败：${p?.message??p}`)}}finally{ge=!1}}}function mr(){try{const t=String(location.pathname||"").match(/\/vfs\/([^/]+)\//);return!t||!t[1]?"":decodeURIComponent(t[1])}catch{return""}}function ce(e){return e&&typeof e=="object"?{...e}:{}}function we(e){if(!e.targetProjectId&&!e.targetZipSha256){const t=mr();t&&(e.targetZipSha256=t)}return e}function br(e){if(!e||typeof e!="object")return!1;if(e instanceof ArrayBuffer)return!0;try{return Object.prototype.toString.call(e)==="[object ArrayBuffer]"}catch{return!1}}function gr(e){return!e||typeof e!="object"?!1:Object.prototype.toString.call(e)==="[object Blob]"&&typeof e.arrayBuffer=="function"}async function ke(e){if(!e)return null;if(br(e)){const t=new Uint8Array(e),r=new Uint8Array(t.byteLength);return r.set(t),r.buffer}if(ArrayBuffer.isView(e)){const t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=new Uint8Array(t.byteLength);return r.set(t),r.buffer}if(typeof Blob<"u"&&gr(e)){const t=await e.arrayBuffer(),r=new Uint8Array(t),o=new Uint8Array(r.byteLength);return o.set(r),o.buffer}return null}async function He(e){if(!e.zipArrayBuffer&&e.zipBlob){e.zipArrayBuffer=await ke(e.zipBlob);try{delete e.zipBlob}catch{}return}e.zipArrayBuffer&&(e.zipArrayBuffer=await ke(e.zipArrayBuffer))}function nt(){const e=globalThis;e.__HB_GLOBAL_API__||(e.__HB_GLOBAL_API__={v:1});const t=e.Higanbana&&typeof e.Higanbana=="object"?e.Higanbana:{};t.getProject=async(r={})=>{const o=ce(r);return o.includeAll||we(o),tr(o)},t.createProject=async(r={})=>{const o=ce(r);return await He(o),await or(o)},t.updateProject=async(r={})=>{const o=ce(r);return await He(o),we(o),await er(o)},t.deleteProject=async(r={})=>{const o=ce(r);return we(o),await rr(o)},t.getProjectConfig=t.getProject,e.Higanbana=t,e.higanbana=t;try{e.SillyTavern&&typeof e.SillyTavern=="object"&&((!e.SillyTavern.libs||typeof e.SillyTavern.libs!="object")&&(e.SillyTavern.libs={}),e.SillyTavern.libs.higanbana=t)}catch{}}const wr="hb_higanbana_rpc_v1",yr="HB_BRIDGE_RPC_REQ",se="HB_BRIDGE_RPC_RES";let ye=!1,X=null;function _r(e){if(!Array.isArray(e))return!1;for(const t of e)if(typeof t!="string"||!t||t==="__proto__"||t==="prototype"||t==="constructor")return!1;return!0}function vr(){const e=globalThis,t=new Set;try{for(const r of Object.getOwnPropertyNames(e))typeof r=="string"&&r.trim()&&t.add(r)}catch{}try{const r=Object.getPrototypeOf(e);if(r)for(const o of Object.getOwnPropertyNames(r))typeof o=="string"&&o.trim()&&t.add(o)}catch{}return[...t]}function jr(){return{listGlobals:()=>vr(),hasGlobal:e=>{const t=globalThis,r=String(e??"").trim();return r?r in t:!1}}}function Cr(e){const t=globalThis;if(e==="ST_API")return t.ST_API;if(e==="Higanbana")return t.Higanbana??t.higanbana;if(e==="higanbana")return t.higanbana??t.Higanbana;if(e==="SillyTavern")return t.SillyTavern;if(e==="__HB_GLOBAL__")return t;if(e==="__HB_INTERNAL__")return jr()}function Sr(e){if(e==null)return!0;const t=typeof e;return!!(t==="string"||t==="number"||t==="boolean"||t==="bigint"||t==="object"&&(Array.isArray(e)||Object.prototype.toString.call(e)==="[object Object]"))}async function $r(e,t,r){const o=Cr(e);if(o==null)throw new Error(`RPC root 不存在：${e}`);let a=null,n=o;for(const i of t){if(a=n,n==null)throw new Error(`RPC 路径不存在：${e}.${t.join(".")}`);n=n[i]}if(typeof n=="function")return await n.apply(a,r);if(r.length>0)throw new Error(`RPC 目标不是函数：${e}.${t.join(".")}`);return n}function xr(e,t,r){return Sr(r)?r:typeof r=="function"?{__hb_rpc_function__:!0,root:e,path:t}:{__hb_rpc_object__:!0,root:e,path:t}}function at(e){return e instanceof Error?e.message:String(e??"Unknown error")}function _e(e){if(X)try{X.postMessage(e)}catch(t){const r={type:se,id:e.id,clientId:e.clientId,ok:!1,error:`RPC 响应序列化失败：${at(t)}`};try{X.postMessage(r)}catch{}}}async function Br(e){const t=e?.data;if(!t||t.type!==yr)return;const r=String(t.id||"").trim(),o=String(t.root||"").trim(),a=t.path,n=Array.isArray(t.args)?t.args:[];if(!r||!o||!_r(a)){_e({type:se,id:r||"invalid",clientId:t.clientId,ok:!1,error:"RPC 请求参数非法"});return}try{const i=await $r(o,a,n);_e({type:se,id:r,clientId:t.clientId,ok:!0,result:xr(o,a,i)})}catch(i){_e({type:se,id:r,clientId:t.clientId,ok:!1,error:at(i)})}}function it(){if(!ye){ye=!0;try{X=new BroadcastChannel(wr),X.addEventListener("message",e=>{Br(e)})}catch(e){ye=!1,X=null,console.warn("[Higanbana] RPC 桥接主端初始化失败",e)}}}let Ne=!1;function Er(){if(Ne)return;const e=E();if(!e?.eventSource||!e?.event_types)return;Ne=!0;const t=()=>setTimeout(()=>{A(),H(),ot().catch(r=>console.warn("[Higanbana] webzip check failed",r))},0);e.event_types.CHAT_CHANGED&&e.eventSource.on(e.event_types.CHAT_CHANGED,t),e.event_types.CHARACTER_DELETED&&e.eventSource.on(e.event_types.CHARACTER_DELETED,t)}async function zr(){nt(),it();const e=await Nt();await F(),await Wt(),Ot(),hr(),kt(),Er(),A(),Je(),ot().catch(t=>console.warn("[Higanbana] webzip check failed",t)),z(`彼岸花：已加载。
Service Worker：${e?"已注册":"不可用（将无法渲染 WebZip）"}
提示：在本面板可把 zip 绑定到当前角色卡，导出角色卡时会一并导出。`)}function Le(){const e=E();return e?.eventSource&&e?.event_types?.APP_READY?(e.eventSource.on(e.event_types.APP_READY,()=>{zr().catch(t=>{console.error("[Higanbana] init failed",t),toastr.error(`彼岸花初始化失败：${t?.message??t}`)})}),!0):!1}function Pr(){jQuery(()=>{if(nt(),it(),Le())return;const e=setInterval(()=>{Le()&&clearInterval(e)},250)})}Pr();
