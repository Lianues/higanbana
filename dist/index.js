const he="st-higanbana-vfs-",U=new Set;async function L(){try{const e=await caches.keys();U.clear();for(const t of e)t.startsWith(he)&&U.add(t.slice(he.length))}catch(e){console.warn("[Higanbana] caches.keys failed",e)}}function ie(e){return!!e&&U.has(e)}function E(){const e=globalThis.SillyTavern;return e?.getContext?e.getContext():null}function S(){const e=E();if(!e)return null;const t=Number(e.characterId);if(!Number.isFinite(t)||t<0)return null;const r=e.characters?.[t];return r?{chid:t,character:r}:null}function ze(e){return String(e?.name??e?.data?.name??"").trim()||"(未命名角色)"}function H(e){return String(e?.avatar??"").trim()}function j(e){const t={projects:[]},r=e?.data?.extensions?.higanbana;if(!r||typeof r!="object")return t;const o=r.projects;if(!Array.isArray(o))return t;const a=[];for(const n of o){if(!n||typeof n!="object")continue;const c=String(n.source??"").trim(),i=String(n.id??"").trim(),u=String(n.title??"").trim()||void 0,d=String(n.placeholder??"").trim(),s=String(n.homePage??"").trim(),l=typeof n.showTitleInChat=="boolean"?!!n.showTitleInChat:!1,m=!!n.fixRootRelativeUrls,p=String(n.zipName??"").trim(),h=String(n.zipSha256??"").trim();if(!(!i||!d||!s||!p)){if(c==="embedded"){const f=String(n.zipBase64??"").trim();if(!f||!h)continue;a.push({source:"embedded",id:i,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:m,zipName:p,zipSha256:h,zipBase64:f});continue}if(c==="url"){const f=String(n.zipUrl??"").trim();if(!f)continue;a.push({source:"url",id:i,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:m,zipName:p,zipSha256:h||"",zipUrl:f})}}}return{projects:a}}async function N(e,t){const r=E();if(!r?.writeExtensionField)throw new Error("writeExtensionField 不可用（酒馆版本过旧或上下文缺失）");await r.writeExtensionField(e,"higanbana",t)}const Ie="st-higanbana-vfs-";function Ne(e){return String(e).split("/").map(t=>encodeURIComponent(t)).join("/")}function ee(e,t,r){return`${e}vfs/${encodeURIComponent(t)}/${Ne(r)}`}function He(e,t){return`${new URL(e).pathname}vfs/${encodeURIComponent(t)}/`}function Le(e){return`${Ie}${e}`}function _e(e){const t=String(e).toLowerCase();return t.endsWith(".html")||t.endsWith(".htm")?"text/html; charset=utf-8":t.endsWith(".css")?"text/css; charset=utf-8":t.endsWith(".js")||t.endsWith(".mjs")||t.endsWith(".cjs")?"application/javascript; charset=utf-8":t.endsWith(".json")||t.endsWith(".map")?"application/json; charset=utf-8":t.endsWith(".txt")?"text/plain; charset=utf-8":t.endsWith(".svg")?"image/svg+xml":t.endsWith(".png")?"image/png":t.endsWith(".jpg")||t.endsWith(".jpeg")?"image/jpeg":t.endsWith(".gif")?"image/gif":t.endsWith(".webp")?"image/webp":t.endsWith(".avif")?"image/avif":t.endsWith(".ico")?"image/x-icon":t.endsWith(".woff2")?"font/woff2":t.endsWith(".woff")?"font/woff":t.endsWith(".ttf")?"font/ttf":t.endsWith(".otf")?"font/otf":t.endsWith(".eot")?"application/vnd.ms-fontobject":t.endsWith(".wasm")?"application/wasm":"application/octet-stream"}function We(e){const t=_e(e);return t.startsWith("text/")||t.includes("javascript")||t.includes("json")||t.includes("svg+xml")}function Fe(e){return new Promise((t,r)=>{const o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>t(),o.onerror=()=>r(new Error(`加载脚本失败: ${e}`)),document.head.appendChild(o)})}async function De(){const e=globalThis;if(e.JSZip)return e.JSZip;if(await Fe("/lib/jszip.min.js"),!e.JSZip)throw new Error("JSZip 未能加载（/lib/jszip.min.js）");return e.JSZip}function Me(e){const t=e.filter(Boolean);if(t.length===0)return{prefix:"",stripped:[]};const r=new Set(t.map(c=>c.split("/")[0]).filter(Boolean));if(r.size!==1)return{prefix:"",stripped:t};const a=`${[...r][0]}/`;return t.some(c=>c.startsWith(a))?{prefix:a,stripped:t.map(c=>c.startsWith(a)?c.slice(a.length):c)}:{prefix:"",stripped:t}}function Oe(e){let t=String(e??"").replace(/\\/g,"/").replace(/^\.\//,"").replace(/^\/+/,"");const r=t.split("/").filter(Boolean);return r.some(o=>o==="..")?null:(t=r.join("/"),t||null)}function ye(e){return String(e).split(/[?#]/,1)[0]}function Ze(e){const t=new Set,r=new Set;for(const o of e){t.add(o);const a=o.split("/").filter(Boolean);for(let n=1;n<a.length;n++)r.add(a.slice(0,n).join("/")+"/")}return{fileSet:t,dirSet:r}}function J(e,t){const r=ye(e);return r?!!(t.fileSet.has(r)||t.dirSet.has(r.endsWith("/")?r:`${r}/`)):!1}function Ge(e,t,r,o){let a=e;return r&&(a=a.replace(/<base\b([^>]*?)\bhref\s*=\s*(["'])\/\2([^>]*?)>/gi,(n,c,i,u)=>`<base${c}href=${i}${t}${i}${u}>`),a=a.replace(/(<\s*(?:script|img|source|video|audio)\b[^>]*\bsrc\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(n,c,i,u)=>J(u,o)?`${c}${t}${u}${i}`:n),a=a.replace(/(<\s*link\b[^>]*\bhref\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(n,c,i,u)=>J(u,o)?`${c}${t}${u}${i}`:n)),a}function qe(e,t,r,o){if(!r)return e;let a=String(e);return a=a.replace(/url\(\s*(["'])?\/(?!\/)([^"')]+)\1\s*\)/gi,(n,c="",i)=>J(i,o)?`url(${c}${t}${i}${c})`:n),a=a.replace(/@import\s+(?:url\(\s*)?(["'])?\/(?!\/)([^"')\s]+)\1\s*\)?/gi,(n,c="",i)=>J(i,o)?n.toLowerCase().includes("url(")?`@import url(${c}${t}${i}${c})`:`@import ${c}${t}${i}${c}`:n),a}function Je(e){return!e||/\s/.test(e)?!1:e.endsWith("/")?!0:(e.split("/").filter(Boolean).pop()||"").includes(".")}function Ve(e,t,r,o){if(!r)return e;let a=String(e);return a=a.replace(/(["'`])\/(?!\/)([^"'`]*?)\1/g,(n,c,i)=>{const u=ye(i);return!Je(u)||!J(i,o)?n:`${c}${t}${i}${c}`}),a=a.replace(/(__webpack_require__\.p\s*=\s*)(["'])\/\2/g,(n,c,i)=>`${c}${i}${t}${i}`),a=a.replace(/(__webpack_public_path__\s*=\s*)(["'])\/\2/g,(n,c,i)=>`${c}${i}${t}${i}`),a}async function ve(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(r=>r.toString(16).padStart(2,"0")).join("")}function Ye(e){const t=new Uint8Array(e),r=32768;let o="";for(let a=0;a<t.length;a+=r){const n=t.subarray(a,a+r);o+=String.fromCharCode(...n)}return btoa(o)}function V(e){const t=atob(e),r=new Uint8Array(t.length);for(let o=0;o<t.length;o++)r[o]=t.charCodeAt(o);return r.buffer}function Y(e){const t=Number(e);if(!Number.isFinite(t)||t<0)return"0 B";const r=["B","KB","MB","GB","TB"];let o=t,a=0;for(;o>=1024&&a<r.length-1;)o/=1024,a++;const n=o>=100?0:o>=10?1:2;return`${o.toFixed(n)} ${r[a]}`}function Xe(e){if(e===null)return"—";const t=Number(e);return!Number.isFinite(t)||t<=0?"—":`${Y(t)}/s`}function Ke(e){if(e===null)return"—";const t=Number(e);return Number.isFinite(t)?`${Math.max(0,Math.min(t,100)).toFixed(1)}%`:"—"}function te(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}async function X(e,t={}){const r=Math.max(30,Number(t.progressThrottleMs??120)),o=t.onProgress,a=te(),n=await fetch(e,{method:"GET",signal:t.signal});if(!n.ok)throw new Error(`下载失败: ${n.status} ${n.statusText}`);const c=n.headers.get("content-type"),i=n.url||e,u=n.headers.get("content-length"),d=u?Number(u):NaN,s=Number.isFinite(d)&&d>0?d:null,m=n.body?.getReader?.();if(!m){const b=await n.arrayBuffer(),y=Math.max(0,te()-a),P=b.byteLength,k=s??P,B=k?P/k*100:null,G=y>0?P/y*1e3:null;return o?.({loadedBytes:P,totalBytes:k,percent:B,speedBps:G,elapsedMs:y}),{arrayBuffer:b,totalBytes:k,contentType:c,finalUrl:i}}const p=[];let h=0,f=0,g=0,w=null;const _=(b=!1)=>{if(!o)return;const y=te(),P=Math.max(0,y-a);if(!b&&f&&y-f<r)return;if(f){const B=y-f;B>0&&(w=(h-g)/B*1e3)}f=y,g=h;const k=s?h/s*100:null;o({loadedBytes:h,totalBytes:s,percent:k,speedBps:w,elapsedMs:P})};_(!0);try{for(;;){const{done:b,value:y}=await m.read();if(b)break;y&&(p.push(y),h+=y.byteLength,_(!1))}}finally{try{m.releaseLock()}catch{}}_(!0);const v=new Uint8Array(h);let C=0;for(const b of p)v.set(b,C),C+=b.byteLength;return{arrayBuffer:v.buffer,totalBytes:s??h,contentType:c,finalUrl:i}}async function O(e,t,r){const o=await De(),a=await ve(t),n=Le(a),c=await caches.open(n),i=He(e,a),u=await o.loadAsync(t),l=Object.values(u.files||{}).filter(b=>b&&!b.dir).map(b=>({entry:b,path:Oe(b.name)})).filter(b=>!!b.path);if(l.length===0)throw new Error("zip 内没有可导入的文件");const{stripped:m}=Me(l.map(b=>b.path)),p=l.map((b,y)=>({entry:b.entry,path:m[y]})).filter(b=>!!b.path),h=p.map(b=>String(b.path)),f=Ze(h),g=p.map(b=>b.path).filter(b=>/\.(html?|HTML?)$/i.test(b)).sort((b,y)=>b.localeCompare(y)),w=r.preferredHomePage?.trim(),_=w?g.includes(w):!1,v=g.some(b=>b.toLowerCase()==="index.html");let C=w&&_?w:"";C||(v?C=g.find(b=>b.toLowerCase()==="index.html"):g.length>0?C=g[0]:C="index.html");for(let b=0;b<p.length;b++){const{entry:y,path:P}=p[b],k=_e(P);let B;if(We(P)){let x=await y.async("string");k.startsWith("text/html")?(x=Ge(x,i,r.fixRootRelativeUrls,f),B=x):k.startsWith("text/css")?B=qe(x,i,r.fixRootRelativeUrls,f):k.includes("javascript")?B=Ve(x,i,r.fixRootRelativeUrls,f):B=x}else{const x=await y.async("uint8array"),ue=new Uint8Array(x.byteLength);ue.set(x),B=new Blob([ue],{type:k})}const G=ee(e,a,P);await c.put(new Request(G,{method:"GET"}),new Response(B,{headers:{"Content-Type":k}})),b%75===0&&await new Promise(x=>setTimeout(x,0))}return{projectId:a,homePage:C,htmlFiles:g,fileCount:p.length,cacheName:n}}const A=String(import.meta.url).replace(/[^/]*$/,""),Qe=`${A}sw.js`,re="higanbana",W=Object.freeze({placeholder:"{{WEB_HOME}}",defaultFixRootRelativeUrls:!0,renderHtmlCodeBlocks:!1,renderHtmlCodeBlocksUseBlobUrl:!1,renderHtmlCodeBlocksShowTitleBar:!1,allowedCharacterAvatars:[]});function z(){const e=E();if(!e)return structuredClone(W);e.extensionSettings[re]=e.extensionSettings[re]||{};const t=e.extensionSettings[re];return(typeof t.placeholder!="string"||!t.placeholder.trim())&&(t.placeholder=W.placeholder),typeof t.defaultFixRootRelativeUrls!="boolean"&&(t.defaultFixRootRelativeUrls=W.defaultFixRootRelativeUrls),typeof t.renderHtmlCodeBlocks!="boolean"&&(t.renderHtmlCodeBlocks=W.renderHtmlCodeBlocks),typeof t.renderHtmlCodeBlocksUseBlobUrl!="boolean"&&(t.renderHtmlCodeBlocksUseBlobUrl=W.renderHtmlCodeBlocksUseBlobUrl),typeof t.renderHtmlCodeBlocksShowTitleBar!="boolean"&&(t.renderHtmlCodeBlocksShowTitleBar=W.renderHtmlCodeBlocksShowTitleBar),Array.isArray(t.allowedCharacterAvatars)?t.allowedCharacterAvatars=t.allowedCharacterAvatars.map(r=>String(r).trim()).filter(r=>r.length>0):t.allowedCharacterAvatars=[],t}function D(){E()?.saveSettingsDebounced?.()}function $e(e){return z().allowedCharacterAvatars.includes(e)}function Z(e){const t=z();t.allowedCharacterAvatars.includes(e)||(t.allowedCharacterAvatars.push(e),D())}const pe=new WeakMap;function et(e){try{const t=e.contentDocument;if(!t)return null;const r=t.body,o=t.documentElement;if(!r||!o)return null;const a=r.scrollHeight||0,n=o.scrollHeight||0,c=r.offsetHeight||0,i=o.offsetHeight||0,u=Math.max(a,n,c,i);return!Number.isFinite(u)||u<=0?null:u}catch{return null}}function Q(e){const t=et(e);if(!t)return;const r=Math.max(80,Math.min(t,1e4));e.style.height=`${r}px`}function Ce(e){pe.get(e)?.ro?.disconnect?.();const r={};pe.set(e,r);const o=()=>{Q(e),setTimeout(()=>Q(e),50),setTimeout(()=>Q(e),250);try{const a=e.contentDocument;if(!a?.documentElement)return;const n=new ResizeObserver(()=>Q(e));n.observe(a.documentElement),a.body&&n.observe(a.body),r.ro=n}catch{}};o(),e.addEventListener("load",o)}function tt(e){const t=S();if(!t)return{kind:"stub",title:"彼岸花：无法渲染",reason:"当前不在单角色聊天/未选中角色。"};const r=e.title||e.zipName,o=H(t.character);if(o&&!$e(o))return{kind:"stub",title:`彼岸花：未启用（${r}）`,reason:e.source==="url"?"该角色卡绑定了 WebZip URL，但尚未允许/下载。切换到该角色时会弹窗询问，或在面板/弹窗中下载并导入缓存。":"该角色卡包含嵌入 WebZip，但尚未允许/导入。切换到该角色时会弹窗询问，或在面板点“导入所有嵌入项目到本地缓存”。"};const a=e.zipSha256;return a?ie(a)?{kind:"iframe",src:ee(A,a,e.homePage),title:`彼岸花：${r} · ${e.homePage}`}:{kind:"stub",title:`彼岸花：未导入缓存（${r}）`,reason:e.source==="url"?"请下载并导入缓存后即可渲染。":"请先导入到本地缓存（面板中可操作），再刷新聊天即可渲染。"}:{kind:"stub",title:`彼岸花：未下载（${r}）`,reason:e.source==="url"?"请在面板/弹窗中下载并导入缓存后即可渲染。":"缺少 projectId，无法渲染。"}}function xe(e,t,r,o={}){const a=document.createElement("div");a.className="hb-embed",a.dataset.hbEmbed="1",a.classList.add(r.kind==="stub"?"hb-embed-stub":"hb-embed-iframe"),o.projectId&&(a.dataset.hbProjectId=o.projectId),o.showTitleInChat===!0||a.classList.add("hb-embed-no-title");const c=document.createElement("div");c.className="hb-embed-header";const i=document.createElement("div");i.className="hb-embed-title",i.textContent=r.title;const u=document.createElement("div");if(u.className="hb-embed-actions",r.kind==="iframe"){const l=document.createElement("a");l.href=r.src,l.target="_blank",l.rel="noopener noreferrer",l.textContent="新标签页打开",u.appendChild(l)}c.appendChild(i),c.appendChild(u),a.appendChild(c);const d=document.createElement("div");if(d.className="hb-embed-body",r.kind==="stub"){const l=document.createElement("div");return l.style.padding="10px",l.style.opacity="0.9",l.textContent=r.reason,d.appendChild(l),a.appendChild(d),a}const s=document.createElement("iframe");return s.className="hb-iframe",s.loading="lazy",s.referrerPolicy="no-referrer",s.name=`hb-${e}-${t}`,s.setAttribute("sandbox","allow-scripts allow-same-origin"),s.src=r.src,Ce(s),d.appendChild(s),a.appendChild(d),a}function rt(e,t){if(!e)return;const r=document.querySelectorAll(".hb-embed[data-hb-project-id]");for(const o of r)String(o.dataset?.hbProjectId??"")===e&&(t?o.classList.remove("hb-embed-no-title"):o.classList.add("hb-embed-no-title"))}function nt(e){const t=String(e??"").toLowerCase();return t.includes("<html")||t.includes("<head")||t.includes("<body")||t.includes("<!doctype html")}function Se(e){const r=String(e??"").trim(),o=r.toLowerCase();return r?o.includes("<!doctype")||o.includes("<html")?r:`<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><body>${r}</body>`:'<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'}function ot(e){let t=2166136261;for(let r=0;r<e.length;r++)t^=e.charCodeAt(r),t=Math.imul(t,16777619);return(t>>>0).toString(16)}function at(e,t){const r=Se(t),o=ot(r),a=String(e.dataset?.hbHtmlHash??""),n=String(e.dataset?.hbHtmlBlobUrl??"");if(n&&a===o)return n;if(n)try{URL.revokeObjectURL(n)}catch{}const c=URL.createObjectURL(new Blob([r],{type:"text/html"}));return e.dataset.hbHtmlHash=o,e.dataset.hbHtmlBlobUrl=c,c}function je(e,t){const r=z(),o=!!r.renderHtmlCodeBlocks,a=!!r.renderHtmlCodeBlocksUseBlobUrl,n=!!r.renderHtmlCodeBlocksShowTitleBar,c=a||n,i=Array.from(e.querySelectorAll(".hb-html-render"));if(!o){for(const s of i){const l=String(s.dataset?.hbHtmlBlobUrl??"");if(l)try{URL.revokeObjectURL(l)}catch{}const m=s.querySelector("pre");m&&s.parentNode&&(m.classList.remove("hb-html-code-hidden"),s.parentNode.insertBefore(m,s)),s.remove()}return}const u=Array.from(e.querySelectorAll("pre > code"));if(u.length===0)return;for(const s of i)s.querySelectorAll(".hb-embed").forEach(l=>l.remove()),s.querySelectorAll("iframe.hb-html-iframe").forEach(l=>l.remove());let d=e.querySelectorAll(".hb-embed").length;for(const s of u){const l=s.closest("pre");if(!l)continue;const m=s.textContent||"";if(!nt(m))continue;const p=l.closest(".hb-html-render"),h=p||document.createElement("div");if(!p){h.className="hb-html-render",h.dataset.hbHtmlRender="1";const _=l.parentNode;if(!_)continue;_.insertBefore(h,l),h.appendChild(l)}if(l.classList.add("hb-html-code-hidden"),!c){const _=String(h.dataset?.hbHtmlBlobUrl??"");if(_)try{URL.revokeObjectURL(_)}catch{}try{delete h.dataset.hbHtmlBlobUrl,delete h.dataset.hbHtmlHash}catch{}}const f=c?at(h,m):"";if(n){const _={kind:"iframe",src:f||"about:blank",title:"HTML 代码块"},v=xe(t,d++,_,{showTitleInChat:!0}),C=h.querySelector(".hb-embed");C&&C.remove(),h.appendChild(v);continue}const g=h.querySelector(".hb-embed");g&&g.remove();let w=h.querySelector("iframe.hb-html-iframe");w||(w=document.createElement("iframe"),w.className="hb-html-iframe",w.loading="lazy",w.referrerPolicy="no-referrer",w.name=`hb-html-${t}`,w.setAttribute("sandbox","allow-scripts allow-same-origin"),Ce(w),h.appendChild(w)),a&&f?(w.removeAttribute("srcdoc"),w.src=f):(w.removeAttribute("src"),w.srcdoc=Se(m))}}function it(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ee(e,t){const r=S();if(!r)return;const o=j(r.character);if(o.projects.length===0)return;const a=new Map;for(const f of o.projects){const g=String(f.placeholder??"").trim();g&&(a.has(g)||a.set(g,f))}const n=Array.from(a.keys());if(n.length===0)return;const c=e.textContent||"";let i=!1;for(const f of n)if(c.includes(f)){i=!0;break}if(!i)return;n.sort((f,g)=>g.length-f.length);const u=n.map(it).join("|"),d=new RegExp(u,"g"),s=new RegExp(u),l=new Map;for(const f of n){const g=a.get(f);g&&l.set(f,tt(g))}let m=0;const p=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode(f){const g=f?.nodeValue||"";if(!g||!s.test(g))return NodeFilter.FILTER_REJECT;let w=f.parentNode;for(;w&&w!==e;){if(w.nodeType===1){const _=w.tagName;if(_==="CODE"||_==="PRE"||_==="TEXTAREA")return NodeFilter.FILTER_REJECT}w=w.parentNode}return NodeFilter.FILTER_ACCEPT}}),h=[];for(;p.nextNode();)h.push(p.currentNode);for(const f of h){const g=f.nodeValue||"";if(!s.test(g))continue;d.lastIndex=0;let w=0;const _=document.createDocumentFragment();for(const v of g.matchAll(d)){const C=Number(v.index??0),b=String(v[0]??"");C>w&&_.appendChild(document.createTextNode(g.slice(w,C)));const y=a.get(b),P=l.get(b);P?_.appendChild(xe(t,m++,P,{projectId:y?.id,showTitleInChat:y?.showTitleInChat})):_.appendChild(document.createTextNode(b)),w=C+b.length}w<g.length&&_.appendChild(document.createTextNode(g.slice(w))),f.parentNode?.replaceChild(_,f)}}function ne(e){const t=Number(e);if(!Number.isFinite(t))return;const r=$(`#chat .mes[mesid="${t}"]`);if(r.length===0)return;const o=r.find(".mes_text").get(0);o&&(Ee(o,t),je(o,t))}function Pe(){const e=document.querySelectorAll("#chat .mes[mesid]");for(const t of e){const r=t.getAttribute("mesid"),o=Number(r);if(!Number.isFinite(o))continue;const a=t.querySelector(".mes_text");a&&(Ee(a,o),je(a,o))}}let oe=!1;function T(){oe||(oe=!0,setTimeout(()=>{oe=!1,Pe()},0))}let fe=!1;function ct(){if(fe)return;const e=E();if(!e?.eventSource||!e?.event_types)return;fe=!0;const{eventSource:t,event_types:r}=e,o=(...n)=>ne(n?.[0]),a=(...n)=>{const c=Number(n?.[0]);Number.isFinite(c)&&(setTimeout(()=>ne(c),0),setTimeout(()=>ne(c),50))};t.on(r.USER_MESSAGE_RENDERED,o),t.on(r.CHARACTER_MESSAGE_RENDERED,o),r.MESSAGE_EDITED&&t.on(r.MESSAGE_EDITED,a),r.MESSAGE_UPDATED&&t.on(r.MESSAGE_UPDATED,a),r.MORE_MESSAGES_LOADED&&t.on(r.MORE_MESSAGES_LOADED,()=>T()),r.CHAT_CHANGED&&t.on(r.CHAT_CHANGED,()=>T())}function st(e,t=15e3){return new Promise((r,o)=>{let a=!1;const n=p=>{a||(a=!0,u(),p?o(p):r())},c=setTimeout(()=>{n(new Error("Service Worker 激活超时（可能是非安全上下文或被浏览器策略禁止）"))},t),i=[],u=()=>{clearTimeout(c);for(const p of i)try{p()}catch{}},d=()=>{try{e.waiting?.postMessage?.({type:"HB_SKIP_WAITING"})}catch{}},s=()=>{try{e.active?.state==="activated"&&n()}catch{}},l=p=>{if(!p)return;if(p.state==="activated"){n();return}const h=()=>{d(),p.state==="activated"&&n()};p.addEventListener("statechange",h),i.push(()=>p.removeEventListener("statechange",h))},m=()=>{d(),l(e.installing),s()};e.addEventListener("updatefound",m),i.push(()=>e.removeEventListener("updatefound",m)),d(),l(e.installing||e.waiting||e.active),s()})}async function lt(){if(!("serviceWorker"in navigator))return console.warn("[Higanbana] Service Worker not supported"),null;try{const e=await navigator.serviceWorker.register(Qe,{scope:A});return e.update().catch(()=>{}),await st(e),e}catch(e){return console.warn("[Higanbana] sw register failed",e),null}}const M={urlDownloadPopupInFlight:!1};function ce(e){const t=Y(e.loadedBytes),r=e.totalBytes?Y(e.totalBytes):"?",o=e.totalBytes?Ke(e.percent):"—",a=Xe(e.speedBps);return`下载：${t} / ${r}（${o}） | 速度：${a}`}function ke(){try{if(typeof crypto<"u"&&"randomUUID"in crypto&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}const e=E();try{const t=e?.uuidv4;if(typeof t=="function")return String(t())}catch{}return`hb_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,10)}`}function se(e){return String(e??"").trim()}function le(e,t){const r=new Set(e.map(a=>a.placeholder));let o=se(t);if(o||(o=`{{WEB_${e.length+1}}}`),!r.has(o))return o;for(let a=2;a<1e3;a++){const n=`_${a}`,c=o.endsWith("}}")?o.slice(0,-2)+n+"}}":o+n;if(!r.has(c))return c}return o}function Be(e,t){const r=document.createElement("a");r.href=URL.createObjectURL(e),r.setAttribute("download",t),document.body.appendChild(r),r.click(),URL.revokeObjectURL(r.href),document.body.removeChild(r)}function dt(e){const t=String(e??"").trim();if(!t)return null;try{const r=new URL(t);return r.protocol!=="http:"&&r.protocol!=="https:"?null:r.toString()}catch{return null}}function ut(e){try{const r=new URL(e).pathname.split("/").filter(Boolean).pop()||"webzip.zip";return r.endsWith(".zip")?r:`${r}.zip`}catch{return"webzip.zip"}}function ht(e){const t=e?.projects??[];if(t.length===0)return"（无）";const r=t.slice(0,3).map(a=>a.title||a.zipName).filter(Boolean),o=t.length>r.length?` +${t.length-r.length}`:"";return`项目数：${t.length}${r.length?` | ${r.join(" / ")}${o}`:""}`}function pt(e,t){try{const r=localStorage.getItem(e);return r===null?t:r==="1"}catch{return t}}function ft(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Ae(){const e=document.getElementById("higanbana_settings");if(!e)return;const t=Array.from(e.querySelectorAll(".hb-subpanel"));for(const r of t){const o=String(r.dataset.id??"").trim();if(!o)continue;const a=r.querySelector(".hb-subpanel-header"),n=r.querySelector(".hb-subpanel-indicator"),c=r.querySelector(".hb-subpanel-body");if(!a||!n||!c||a.dataset?.hbBound==="1")continue;a.dataset.hbBound="1";const i=`higanbana.subpanel.open.${o}`,u=a.getAttribute("aria-expanded")==="true",d=s=>{a.setAttribute("aria-expanded",s?"true":"false"),n.textContent=s?"−":"+",c.style.display=s?"block":"none"};d(pt(i,u)),a.addEventListener("click",()=>{const l=!(a.getAttribute("aria-expanded")==="true");d(l),ft(i,l)})}}function me(e){const t=document.getElementById("hb_projects_list");if(!t)return;if(t.innerHTML="",e.length===0){const o=document.createElement("div");o.className="hb-subhint",o.textContent="（暂无项目）",t.appendChild(o);return}const r=document.createDocumentFragment();for(const o of e){const a=document.createElement("section");a.className="hb-subpanel hb-project",a.dataset.id=`project_${o.id}`,a.dataset.projectId=o.id;const n=document.createElement("button");n.className="hb-subpanel-header",n.type="button",n.setAttribute("aria-expanded","false");const c=document.createElement("div");c.className="hb-subpanel-title",c.textContent=`${o.title||o.zipName}  ${o.placeholder}`;const i=document.createElement("div");i.className="hb-subpanel-indicator",i.textContent="+",n.appendChild(c),n.appendChild(i),a.appendChild(n);const u=document.createElement("div");u.className="hb-subpanel-body",u.style.display="none";const d=s=>{const l=document.createElement("div");l.className="hb-row";const m=document.createElement("label");return m.className="hb-label",m.textContent=s,l.appendChild(m),l};{const s=d("标题"),l=document.createElement("input");l.className="text_pole hb-proj-title",l.type="text",l.spellcheck=!1,l.value=o.title||"",l.dataset.projectId=o.id,s.appendChild(l),u.appendChild(s)}{const s=d("占位符"),l=document.createElement("input");l.className="text_pole hb-proj-placeholder",l.type="text",l.spellcheck=!1,l.value=o.placeholder,l.dataset.projectId=o.id,s.appendChild(l);const m=document.createElement("div");m.className="hb-actions";const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="copy_placeholder",p.dataset.projectId=o.id,p.textContent="复制";const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="insert_placeholder",h.dataset.projectId=o.id,h.textContent="插入到输入框",m.appendChild(p),m.appendChild(h),s.appendChild(m),u.appendChild(s)}{const s=d("入口 HTML"),l=document.createElement("input");l.className="text_pole hb-proj-home",l.type="text",l.spellcheck=!1,l.value=o.homePage,l.dataset.projectId=o.id,s.appendChild(l),u.appendChild(s)}{const s=d("修复 root 相对路径（/xxx）"),l=document.createElement("input");l.className="hb-proj-fix",l.type="checkbox",l.checked=!!o.fixRootRelativeUrls,l.dataset.projectId=o.id,s.appendChild(l),u.appendChild(s)}{const s=d("消息列表显示标题"),l=document.createElement("input");l.className="hb-proj-show-title",l.type="checkbox",l.checked=!!o.showTitleInChat,l.dataset.projectId=o.id,s.appendChild(l),u.appendChild(s)}{const s=d("操作"),l=document.createElement("div");if(l.className="hb-actions",o.source==="embedded"){const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="import_cache",h.dataset.projectId=o.id,h.textContent="导入到缓存",l.appendChild(h);const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="export_zip",f.dataset.projectId=o.id,f.textContent="导出 zip",l.appendChild(f)}else{const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="download_apply",h.dataset.projectId=o.id,h.textContent="下载并应用",l.appendChild(h)}const m=document.createElement("button");m.className="menu_button",m.type="button",m.dataset.hbAction="open_home",m.dataset.projectId=o.id,m.textContent="打开首页",l.appendChild(m);const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="delete_project",p.dataset.projectId=o.id,p.textContent="删除项目",l.appendChild(p),s.appendChild(l),u.appendChild(s)}a.appendChild(u),r.appendChild(a)}t.appendChild(r),Ae()}async function mt(){$("#higanbana_settings").remove();const e=await fetch(`${A}settings.html`,{cache:"no-store"});if(!e.ok)throw new Error(`加载 settings.html 失败: ${e.status}`);const t=await e.text();$("#extensions_settings").append(t)}function bt(){const e=z();$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_render_html_blocks").prop("checked",!!e.renderHtmlCodeBlocks),$("#hb_render_html_blocks_blob").prop("checked",!!e.renderHtmlCodeBlocksUseBlobUrl),$("#hb_render_html_blocks_titlebar").prop("checked",!!e.renderHtmlCodeBlocksShowTitleBar);const t=$("#hb_homepage");t.length&&!String(t.val()??"").trim()&&t.val("index.html")}function R(){const e=z(),t=S();if(!t){$("#hb_char_info").text("（未选中角色）"),$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_homepage").val(String($("#hb_homepage").val()??"").trim()||"index.html"),me([]),$("#hb_import_from_card").prop("disabled",!0),$("#hb_unbind").prop("disabled",!0),$("#hb_pick_zip_btn").prop("disabled",!0),$("#hb_bind_zip").prop("disabled",!0),$("#hb_bind_zip_btn").prop("disabled",!0),$("#hb_bind_url").prop("disabled",!0),$("#hb_bind_url_btn").prop("disabled",!0);return}const{chid:r,character:o}=t,a=ze(o),n=H(o);$("#hb_char_info").text([`名称：${a}`,`chid：${r}`,n?`avatar：${n}`:""].filter(Boolean).join(`
`));const c=j(o);me(c.projects);const i=c.projects.length>0;$("#hb_import_from_card").prop("disabled",!c.projects.some(l=>l.source==="embedded")),$("#hb_unbind").prop("disabled",!i),$("#hb_pick_zip_btn").prop("disabled",!1),$("#hb_bind_zip").prop("disabled",!1),$("#hb_bind_zip_btn").prop("disabled",!1),$("#hb_bind_url").prop("disabled",!1),$("#hb_bind_url_btn").prop("disabled",!1);const u=$("#hb_fix_root_relative");u.length&&document.activeElement!==u.get(0)&&u.prop("checked",!!e.defaultFixRootRelativeUrls);const d=$("#hb_homepage");d.length&&document.activeElement!==d.get(0)&&!String(d.val()??"").trim()&&d.val("index.html");const s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&!String(s.val()??"").trim()&&s.val(le(c.projects,`{{WEB_${c.projects.length+1}}}`))}function I(e){$("#hb_status").text(e)}function de(e){return e.source==="url"?e.zipSha256?!ie(e.zipSha256):!0:!ie(e.zipSha256)}function Re(e){const t=document.createElement("div"),r=document.createElement("h3");r.textContent=e,t.appendChild(r);const o=document.createElement("progress");o.max=100,o.value=0,o.style.width="100%",o.style.height="12px",t.appendChild(o);const a=document.createElement("div");return a.style.marginTop="8px",a.style.opacity="0.9",a.style.whiteSpace="nowrap",a.style.overflowX="auto",a.style.overflowY="hidden",t.appendChild(a),{root:t,titleEl:r,progress:o,text:a}}async function Ue(e,t){const r=E();if(!r)throw new Error("上下文缺失");const o=t.filter(p=>de(p));if(o.length===0)return{importedCount:0,cancelled:!1};if(!r.callGenericPopup||!r.POPUP_TYPE){let p=0;for(const h of o){const f=S();if(!f||Number(f.chid)!==Number(e))break;const g=h.title||h.zipName;I(`正在导入：${g} ...`);let w;h.source==="url"?w=(await X(h.zipUrl)).arrayBuffer:w=V(h.zipBase64);const _=await O(A,w,{fixRootRelativeUrls:h.fixRootRelativeUrls,preferredHomePage:h.homePage});U.add(_.projectId),await L();const C=j(f.character).projects.map(b=>b.id===h.id?{...b,zipSha256:_.projectId,homePage:_.homePage}:b);await N(e,{projects:C}),p++}return{importedCount:p,cancelled:!1}}if(M.urlDownloadPopupInFlight)throw new Error("当前已有下载弹窗进行中，请稍后再试");M.urlDownloadPopupInFlight=!0;const a=new AbortController;let n=!1,c=!1,i=0;const{root:u,titleEl:d,progress:s,text:l}=Re("彼岸花：准备导入...");l.style.whiteSpace="pre-wrap",l.style.overflowX="hidden";const m=p=>{try{l.textContent=ce(p)}catch{l.textContent="正在下载..."}if(p?.totalBytes){const h=Number(p?.percent);Number.isFinite(h)&&(s.max=100,s.value=Math.max(0,Math.min(100,h)))}else s.removeAttribute("value")};try{await r.callGenericPopup(u,r.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消",onClosing:()=>(n||(c=!0,a.abort()),!0),onOpen:async p=>{try{for(let h=0;h<o.length;h++){const f=o[h];if(a.signal.aborted)break;const g=S();if(!g||Number(g.chid)!==Number(e))break;const w=f.title||f.zipName;d.textContent=`彼岸花：正在导入（${h+1}/${o.length}）${w}`;let _;f.source==="url"?(l.textContent=`准备下载：${f.zipName}
${f.zipUrl}`,s.max=100,s.value=0,_=(await X(f.zipUrl,{signal:a.signal,onProgress:m})).arrayBuffer,s.value=100,l.textContent=`下载完成（${Y(_.byteLength)}），正在解压并写入缓存...`):(s.removeAttribute("value"),l.textContent=`正在从角色卡导入并解压：${f.zipName}`,_=V(f.zipBase64));const v=await O(A,_,{fixRootRelativeUrls:f.fixRootRelativeUrls,preferredHomePage:f.homePage});U.add(v.projectId),await L();const b=j(g.character).projects.map(y=>y.id===f.id?{...y,zipSha256:v.projectId,homePage:v.homePage}:y);await N(e,{projects:b}),i++}n=!0;try{await p.completeAffirmative?.()}catch{}}catch(h){n=!0;try{await p.completeCancelled?.()}catch{}throw h}}})}finally{M.urlDownloadPopupInFlight=!1}return{importedCount:i,cancelled:c}}async function gt(e){const t=E();if(!t)return null;if(!t.callGenericPopup||!t.POPUP_TYPE){const d=await X(e.zipUrl),s=await O(A,d.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});return U.add(s.projectId),await L(),{projectId:s.projectId,homePage:s.homePage,fileCount:s.fileCount}}if(M.urlDownloadPopupInFlight)return null;M.urlDownloadPopupInFlight=!0;const r=new AbortController;let o=!1,a=null;const{root:n,progress:c,text:i}=Re("彼岸花：正在下载 WebZip...");i.textContent=`准备下载：${e.zipName} | ${e.zipUrl}`;const u=d=>{if(i.textContent=ce(d),d.totalBytes){const s=Number(d.percent);Number.isFinite(s)&&(c.max=100,c.value=Math.max(0,Math.min(100,s)))}else c.removeAttribute("value")};try{await t.callGenericPopup(n,t.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消下载",onClosing:()=>(o||r.abort(),!0),onOpen:async d=>{try{const s=await X(e.zipUrl,{signal:r.signal,onProgress:u});c.max=100,c.value=100,i.textContent=`下载完成（${Y(s.arrayBuffer.byteLength)}），正在解压并写入缓存...`;const l=await O(A,s.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});U.add(l.projectId),await L(),a={projectId:l.projectId,homePage:l.homePage,fileCount:l.fileCount},o=!0;try{await d.completeAffirmative()}catch{}}catch(s){r.signal.aborted||s?.name==="AbortError"?toastr.info("已取消下载"):(console.error("[Higanbana] url download failed",s),toastr.error(`下载失败：${s?.message??s}`)),o=!0;try{await d.completeCancelled?.()}catch{}}}})}finally{M.urlDownloadPopupInFlight=!1}return a}let F=null;function be(e){const t=$("#hb_url_download_wrap"),r=$("#hb_cancel_url_download_btn");e?(t.show(),r.show()):(t.hide(),r.hide())}function wt(e){const t=$("#hb_url_download_wrap"),r=$("#hb_url_progress"),o=$("#hb_url_progress_text");t.length&&t.show();try{o.text(ce(e))}catch{o.text("正在下载...")}if(e?.totalBytes){const a=Number(e?.percent);Number.isFinite(a)&&(r.attr("max","100"),r.get(0)?.removeAttribute?.("value"),r.val(Math.max(0,Math.min(100,a))))}else r.get(0)?.removeAttribute?.("value")}function _t(){try{F?.abort()}catch{}}async function yt(){const e=E(),t=S();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const r=j(t.character),o=r.projects.find(u=>u.source==="url");if(!o)throw new Error("当前角色卡没有 URL 项目");if(M.urlDownloadPopupInFlight)throw new Error("当前已有自动下载弹窗进行中，请稍后再试");F&&!F.signal.aborted&&F.abort();const a=H(t.character);a&&Z(a);const n=o.fixRootRelativeUrls,c=o.homePage,i=new AbortController;F=i,be(!0),$("#hb_url_progress").attr("max","100"),$("#hb_url_progress").val(0),$("#hb_url_progress_text").text(`准备下载：${o.zipName} | ${o.zipUrl}`),$("#hb_bind_url_btn").prop("disabled",!0),$("#hb_download_url_btn").prop("disabled",!0);try{const u=await X(o.zipUrl,{signal:i.signal,onProgress:wt});if(i.signal.aborted)throw new Error("已取消下载");I("下载完成，正在解压并写入 VFS 缓存...");const d=await O(A,u.arrayBuffer,{fixRootRelativeUrls:n,preferredHomePage:c});U.add(d.projectId),await L();const s={projects:r.projects.map(l=>l.source==="url"?{...l,zipSha256:d.projectId,homePage:d.homePage}:l)};await N(t.chid,s),I(`已下载并导入缓存。
projectId(sha256)：${d.projectId}
入口：${d.homePage}
文件数：${d.fileCount}

提示：在消息中插入占位符即可渲染`),e?.reloadCurrentChat&&await e.reloadCurrentChat()}finally{F===i&&(F=null),be(!1),$("#hb_bind_url_btn").prop("disabled",!1),$("#hb_download_url_btn").prop("disabled",!1),R()}}async function vt(e,t){const r=S();if(!r)throw new Error("当前不在单角色聊天/未选中角色");const o=H(r.character);o&&Z(o);const a=z(),n=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=n,D();const c=String($("#hb_homepage").val()??"").trim()||void 0;I("正在解压并写入 VFS 缓存...");const i=await O(A,t,{fixRootRelativeUrls:n,preferredHomePage:c});U.add(i.projectId),await L(),I("正在编码 base64 并写入角色卡扩展字段...");const u=Ye(t),d=j(r.character),s=se($("#hb_placeholder").val()),l=le(d.projects,s),m=String($("#hb_new_title").val()??"").trim(),p=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,h={source:"embedded",id:ke(),title:m||void 0,placeholder:l,homePage:i.homePage,showTitleInChat:p,fixRootRelativeUrls:n,zipName:e,zipSha256:i.projectId,zipBase64:u},f={projects:[...d.projects,h]};await N(r.chid,f);const g=$("#hb_placeholder");g.length&&document.activeElement!==g.get(0)&&g.val(""),R(),$("#hb_new_title").val(""),I(`已添加项目（嵌入模式）。
占位符：${l}
projectId(sha256)：${i.projectId}
入口：${i.homePage}
文件数：${i.fileCount}

提示：导出该角色卡(json/png)会包含该项目的 zipBase64`)}async function $t({allow:e=!0,reloadChat:t=!0}={}){const r=E(),o=S();if(!o)throw new Error("当前不在单角色聊天/未选中角色");const a=j(o.character),n=a.projects.filter(d=>d.source==="embedded");if(n.length===0)throw new Error("当前角色卡没有可导入的嵌入项目");const c=H(o.character);e&&c&&Z(c);const i=[...a.projects];let u=!1;for(const d of n){if(d.zipSha256&&U.has(d.zipSha256))continue;I(`正在从角色卡导入：${d.title||d.zipName} ...`);const s=V(d.zipBase64),l=await O(A,s,{fixRootRelativeUrls:d.fixRootRelativeUrls,preferredHomePage:d.homePage});if(U.add(l.projectId),await L(),l.projectId!==d.zipSha256){console.warn("[Higanbana] zipSha256 mismatch",{embedded:d.zipSha256,computed:l.projectId});const m=i.findIndex(p=>p.id===d.id);if(m>=0){const p=i[m];p&&p.source==="embedded"&&(i[m]={...p,zipSha256:l.projectId,homePage:l.homePage},u=!0)}}}u&&await N(o.chid,{projects:i}),I(`已导入到缓存。
已导入项目数：${n.length}`),t&&r?.reloadCurrentChat&&await r.reloadCurrentChat()}function q(){const e=S();if(!e)throw new Error("当前不在单角色聊天/未选中角色");const t=j(e.character);return{active:e,card:t}}function K(e,t){const r=String(t??"").trim();if(!r)throw new Error("项目 id 为空");const o=e.projects.find(a=>a.id===r);if(!o)throw new Error("找不到项目（可能已被删除）");return o}function Ct(e){const{card:t}=q(),r=K(t,e);if(!r.zipSha256)throw new Error("尚未下载/导入到本地缓存");if(!U.has(r.zipSha256))throw new Error("尚未导入到本地缓存");const o=ee(A,r.zipSha256,r.homePage);window.open(o,"_blank","noopener,noreferrer")}function xt(e){const{card:t}=q(),r=K(t,e);if(r.source!=="embedded")throw new Error("当前项目不是嵌入模式，无法导出 zip");const o=V(r.zipBase64),a=new Blob([o],{type:"application/zip"});Be(a,r.zipName||"webzip.zip")}async function St(e){const{active:t,card:r}=q(),o=K(r,e);if(o.source!=="embedded")throw new Error("当前项目不是嵌入模式");if(!de(o))return{importedCount:0,cancelled:!1};const a=H(t.character);a&&Z(a);const n=await Ue(t.chid,[o]);return n.cancelled||(await E()?.reloadCurrentChat?.(),R()),n}async function jt(e){const{active:t,card:r}=q(),o=K(r,e);if(o.source!=="url")throw new Error("当前项目不是 URL 模式");const a=H(t.character);a&&Z(a);const n=await gt(o);if(!n)return!1;const i={projects:j(t.character).projects.map(u=>u.id===o.id?{...u,zipSha256:n.projectId,homePage:n.homePage}:u)};return await N(t.chid,i),await E()?.reloadCurrentChat?.(),R(),!0}async function Et(e){const t=E(),{active:r,card:o}=q(),a=K(o,e),n=o.projects.filter(c=>c.id!==a.id);await N(r.chid,n.length?{projects:n}:null),await t?.reloadCurrentChat?.(),R()}async function Pt(){const{active:e}=q();await N(e.chid,null),R()}async function kt(e){const t=S();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const r=dt(e);if(!r)throw new Error("请输入合法的 http/https zip URL");const o=H(t.character);o&&Z(o);const a=!!$("#hb_fix_root_relative").prop("checked"),n=String($("#hb_homepage").val()??"").trim()||"index.html",c=ut(r),i=j(t.character),u=se($("#hb_placeholder").val()),d=le(i.projects,u),s=String($("#hb_new_title").val()??"").trim(),l=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,m={source:"url",id:ke(),title:s||void 0,placeholder:d,homePage:n,showTitleInChat:l,fixRootRelativeUrls:a,zipName:c,zipSha256:"",zipUrl:r},p={projects:[...i.projects,m]};return await N(t.chid,p),{zipUrl:r,placeholder:d,homePage:n}}function Bt(){Ae();const e=E();$("#hb_pick_zip_btn").on("click",()=>{document.getElementById("hb_bind_zip")?.click()}),$("#hb_bind_zip").on("change",()=>{const n=document.getElementById("hb_bind_zip")?.files?.[0];$("#hb_bind_zip_name").text(n?n.name:"（未选择文件）")}),$("#hb_fix_root_relative").on("change",()=>{const n=z();n.defaultFixRootRelativeUrls=!!$("#hb_fix_root_relative").prop("checked"),D()}),$("#hb_render_html_blocks").on("change",()=>{const n=z();n.renderHtmlCodeBlocks=!!$("#hb_render_html_blocks").prop("checked"),D(),T()}),$("#hb_render_html_blocks_blob").on("change",()=>{const n=z();n.renderHtmlCodeBlocksUseBlobUrl=!!$("#hb_render_html_blocks_blob").prop("checked"),D(),T()}),$("#hb_render_html_blocks_titlebar").on("change",()=>{const n=z();n.renderHtmlCodeBlocksShowTitleBar=!!$("#hb_render_html_blocks_titlebar").prop("checked"),D(),T()}),$("#hb_placeholder").on("input",()=>{const n=z();n.placeholder=String($("#hb_placeholder").val()??"").trim()||W.placeholder,D()}),$("#hb_copy_placeholder").on("click",async()=>{const n=String($("#hb_placeholder").val()??"").trim();if(!n){toastr.error("占位符为空");return}try{await navigator.clipboard.writeText(n),toastr.success("已复制占位符")}catch(c){console.warn("[Higanbana] copy failed",c),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_insert_placeholder").on("click",()=>{const n=String($("#hb_placeholder").val()??"").trim();if(!n){toastr.error("占位符为空");return}const c=$("#send_textarea");if(c.length===0){toastr.error("找不到输入框");return}const i=String(c.val()??"");c.val(i?`${i}
${n}`:n),c.trigger("input"),toastr.success("已插入占位符")});const t=new Map,r=new Set,o=(n,c=400)=>{const i=t.get(n);i&&clearTimeout(i);const u=window.setTimeout(()=>{t.delete(n),a(n).catch(d=>console.warn("[Higanbana] project auto save failed",d))},Math.max(0,c));t.set(n,u)},a=async n=>{if(!r.has(n)){r.add(n);try{const c=S();if(!c)return;const i=j(c.character),u=i.projects.findIndex(x=>x.id===n);if(u<0)return;const d=document.getElementById("hb_projects_list");if(!d)return;const s=globalThis.CSS?.escape?globalThis.CSS.escape(n):n,l=d.querySelector(`.hb-proj-title[data-project-id="${s}"]`),m=d.querySelector(`.hb-proj-placeholder[data-project-id="${s}"]`),p=d.querySelector(`.hb-proj-home[data-project-id="${s}"]`),h=d.querySelector(`.hb-proj-fix[data-project-id="${s}"]`),f=d.querySelector(`.hb-proj-show-title[data-project-id="${s}"]`),g=i.projects[u],w=String(l?.value??"").trim(),_=w||void 0,v=String(m?.value??"").trim(),C=String(p?.value??"").trim(),b=!!h?.checked,y=f?!!f.checked:!!g.showTitleInChat;if(!v||!C)return;if(i.projects.some(x=>x.id!==n&&x.placeholder===v)){toastr.error("占位符重复，请为每个项目设置不同的占位符"),m&&(m.value=g.placeholder);return}if(!(g.title!==_||g.placeholder!==v||g.homePage!==C||g.fixRootRelativeUrls!==b||g.showTitleInChat!==y))return;const B=i.projects.map(x=>x.id===n?{...x,title:_,placeholder:v,homePage:C,fixRootRelativeUrls:b,showTitleInChat:y}:x);await N(c.chid,{projects:B}),g.showTitleInChat!==y&&rt(n,y);const G=d.querySelector(`.hb-project[data-project-id="${s}"] .hb-subpanel-title`);G&&(G.textContent=`${_||g.zipName}  ${v}`),I(`已保存项目设置：${_||g.zipName}`),T()}finally{r.delete(n)}}};$("#hb_projects_list").on("input",".hb-proj-title, .hb-proj-placeholder, .hb-proj-home",n=>{const c=String(n.target?.getAttribute?.("data-project-id")??"").trim();c&&o(c,500)}),$("#hb_projects_list").on("change",".hb-proj-fix, .hb-proj-show-title",n=>{const c=String(n.target?.getAttribute?.("data-project-id")??"").trim();c&&o(c,0)}),$("#hb_projects_list").on("click",'[data-hb-action="copy_placeholder"]',async n=>{const c=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!c)return;const i=S();if(!i)return;const d=j(i.character).projects.find(s=>s.id===c);if(d)try{await navigator.clipboard.writeText(d.placeholder),toastr.success("已复制占位符")}catch(s){console.warn("[Higanbana] copy placeholder failed",s),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="insert_placeholder"]',n=>{const c=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!c)return;const i=S();if(!i)return;const d=j(i.character).projects.find(m=>m.id===c);if(!d)return;const s=$("#send_textarea");if(s.length===0){toastr.error("找不到输入框");return}const l=String(s.val()??"");s.val(l?`${l}
${d.placeholder}`:d.placeholder),s.trigger("input"),toastr.success("已插入占位符")}),$("#hb_projects_list").on("click",'[data-hb-action="open_home"]',n=>{const c=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(c)try{Ct(c)}catch(i){toastr.error(i?.message??i)}}),$("#hb_projects_list").on("click",'[data-hb-action="export_zip"]',n=>{const c=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(c)try{xt(c)}catch(i){console.error("[Higanbana] export zip failed",i),toastr.error(`导出失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="import_cache"]',async n=>{const c=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(c)try{const i=await St(c);if(i.cancelled){toastr.info("已取消导入");return}i.importedCount>0?toastr.success("已导入到本地缓存"):toastr.info("该项目已在本地缓存"),T()}catch(i){console.error("[Higanbana] import cache failed",i),toastr.error(`导入失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="download_apply"]',async n=>{const c=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(c)try{if(!await jt(c))return;T(),toastr.success("已下载并应用")}catch(i){console.error("[Higanbana] download apply failed",i),toastr.error(`操作失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="delete_project"]',async n=>{const c=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!c)return;const i=S();if(!i)return;const d=j(i.character).projects.find(m=>m.id===c);if(!d)return;const s=d.title||d.zipName;let l=!1;try{e?.Popup?.show?.confirm?l=await e.Popup.show.confirm("彼岸花",`确定删除项目：${s}？`):l=window.confirm(`确定删除项目：${s}？`)}catch{l=window.confirm(`确定删除项目：${s}？`)}if(l)try{await Et(c),T(),toastr.success("已删除项目")}catch(m){console.error("[Higanbana] delete project failed",m),toastr.error(`删除失败：${m?.message??m}`)}}),$("#hb_import_from_card").on("click",async()=>{try{toastr.info("开始导入，请稍候..."),await $t({allow:!0,reloadChat:!0}),toastr.success("已导入并启用（可在消息中渲染占位符）"),R()}catch(n){console.error("[Higanbana] import from card failed",n),toastr.error(`导入失败：${n?.message??n}`)}}),$("#hb_open_home").on("click",()=>{const n=S();if(!n)return;const i=j(n.character).projects[0];if(!i){toastr.error("当前角色卡未绑定任何 WebZip 项目");return}if(!i.zipSha256){toastr.error("尚未下载/导入 WebZip 到本地缓存");return}const u=ee(A,i.zipSha256,i.homePage);window.open(u,"_blank","noopener,noreferrer")}),$("#hb_export_zip").on("click",()=>{const n=S();if(!n)return;const i=j(n.character).projects.find(u=>u.source==="embedded");if(!i){toastr.error("当前角色卡没有可导出的嵌入项目");return}try{const u=V(i.zipBase64),d=new Blob([u],{type:"application/zip"});Be(d,i.zipName||"webzip.zip")}catch(u){console.error("[Higanbana] export zip failed",u),toastr.error(`导出失败：${u?.message??u}`)}}),$("#hb_unbind").on("click",async()=>{const n=E(),c=S();if(!c)return;const i=j(c.character);if(i.projects.length===0)return;const u=`确定解绑当前角色的所有 WebZip 项目？

${ht(i)}`;let d=!1;try{n?.Popup?.show?.confirm?d=await n.Popup.show.confirm("彼岸花",u):d=window.confirm(u)}catch{d=window.confirm(u)}if(d)try{await Pt(),toastr.success("已解绑"),R()}catch(s){console.error("[Higanbana] unbind failed",s),toastr.error(`解绑失败：${s?.message??s}`)}}),$("#hb_bind_zip_btn").on("click",async()=>{if(!S()){toastr.error("当前不在单角色聊天/未选中角色");return}const c=$("#hb_bind_zip").get(0)?.files?.[0];if(!c){toastr.error("请先选择 zip 文件");return}try{await vt(c.name,await c.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(i){console.error("[Higanbana] bind zip failed",i),toastr.error(`绑定失败：${i?.message??i}`)}}),$("#hb_bind_url_btn").on("click",async()=>{if(!S()){toastr.error("当前不在单角色聊天/未选中角色");return}const c=String($("#hb_bind_url").val()??"").trim();try{const{zipUrl:i,placeholder:u,homePage:d}=await kt(c),s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&s.val(""),R(),$("#hb_new_title").val(""),I(`已添加项目（URL 模式）。
占位符：${u}
URL：${i}
入口：${d}
提示：进入聊天时会提示下载并导入缓存`),toastr.success("已添加 URL 项目")}catch(i){console.error("[Higanbana] bind url failed",i),toastr.error(`绑定失败：${i?.message??i}`)}}),$("#hb_download_url_btn").on("click",async()=>{try{await yt()}catch(n){console.error("[Higanbana] download url apply failed",n),toastr.error(`操作失败：${n?.message??n}`)}}),$("#hb_cancel_url_download_btn").on("click",()=>{try{_t()}catch{}})}let ae=!1;async function At(e,t){const r=t.map(o=>{const a=o.source==="url"?o.zipSha256||o.zipUrl:o.zipSha256;return`${o.id}:${o.source}:${a}`}).join("|");try{const o=await ve(new TextEncoder().encode(r).buffer);return`AlertHiganbana_${e}_projects_${o}`}catch{return`AlertHiganbana_${e}_projects_${r.slice(0,80)}`}}function Rt(e){const r=(String(e??"").trim()||"x").replace(/[^a-zA-Z0-9_-]/g,"_");return r.startsWith("hb_")?r:`hb_${r}`}async function Te(){const e=E(),t=S();if(!e||!t)return;const r=j(t.character);if(r.projects.length===0)return;const o=H(t.character);if(o&&!ae){ae=!0;try{const a=$e(o),n=r.projects.filter(s=>de(s));if(!(!a||n.length>0))return;const i=await At(o,r.projects);try{if(e.accountStorage?.getItem?.(i))return;e.accountStorage?.setItem?.(i,"true")}catch{}let u=0,d=[];if(e.callGenericPopup&&e.POPUP_TYPE?.CONFIRM){const s=document.createElement("div"),l=document.createElement("h3");l.textContent="此角色卡包含 WebZip 前端项目。",s.appendChild(l);const m=document.createElement("h3");m.textContent=n.length>0?`发现 ${n.length} 个未缓存项目，是否下载并启用？`:"是否启用它们？",s.appendChild(m);const p=document.createElement("div");p.className="m-b-1",p.style.opacity="0.85",p.textContent="你可以稍后在扩展栏的“彼岸花”面板里管理这些项目。",s.appendChild(p);const h=new Map,f=n.length>0?n.map(v=>{const C=Rt(`miss_${v.id}`);h.set(C,v.id);const y=`${v.title||v.zipName}  |  ${v.source==="embedded"?"嵌入":"URL"}  |  ${v.placeholder}`,P=v.source==="url"?v.zipUrl:"嵌入于角色卡";return{id:C,label:y,type:"checkbox",defaultState:!0,tooltip:P}}):null,g=n.length>0?"下载选中并启用":"启用",w=a?"取消":"否",_=n.length>0?["下载全部"]:null;if(u=await e.callGenericPopup(s,e.POPUP_TYPE.CONFIRM,"",{okButton:g,cancelButton:w,customButtons:_,customInputs:f,wide:!0}),!u)return;if(n.length>0)if(Number(u)>=2)d=[...n];else{const v=e.Popup?.util?.lastResult?.inputResults,C=new Set;for(const[b,y]of h)v?.get?.(b)&&C.add(y);d=n.filter(b=>C.has(b.id))}}else{if(!window.confirm(n.length>0?`此角色卡包含 WebZip 项目，且有 ${n.length} 个未缓存项目。是否启用并下载全部？`:"此角色卡包含 WebZip 项目，是否启用？"))return;d=[...n]}Z(o);try{if(d.length>0){toastr.info("开始下载/导入项目，请稍候...");const s=await Ue(t.chid,d);if(s.cancelled){toastr.info("已取消导入");return}s.importedCount>0&&toastr.success(`已导入 ${s.importedCount} 个项目`)}await e.reloadCurrentChat?.(),R(),T()}catch(s){console.error("[Higanbana] import queue failed",s),toastr.error(`导入失败：${s?.message??s}`)}}finally{ae=!1}}}let ge=!1;function Ut(){if(ge)return;const e=E();if(!e?.eventSource||!e?.event_types)return;ge=!0;const t=()=>setTimeout(()=>{R(),T(),Te().catch(r=>console.warn("[Higanbana] webzip check failed",r))},0);e.event_types.CHAT_CHANGED&&e.eventSource.on(e.event_types.CHAT_CHANGED,t),e.event_types.CHARACTER_DELETED&&e.eventSource.on(e.event_types.CHARACTER_DELETED,t)}async function Tt(){const e=await lt();await L(),await mt(),bt(),Bt(),ct(),Ut(),R(),Pe(),Te().catch(t=>console.warn("[Higanbana] webzip check failed",t)),I(`彼岸花：已加载。
Service Worker：${e?"已注册":"不可用（将无法渲染 WebZip）"}
提示：在本面板可把 zip 绑定到当前角色卡，导出角色卡时会一并导出。`)}function we(){const e=E();return e?.eventSource&&e?.event_types?.APP_READY?(e.eventSource.on(e.event_types.APP_READY,()=>{Tt().catch(t=>{console.error("[Higanbana] init failed",t),toastr.error(`彼岸花初始化失败：${t?.message??t}`)})}),!0):!1}function zt(){jQuery(()=>{if(we())return;const e=setInterval(()=>{we()&&clearInterval(e)},250)})}zt();
