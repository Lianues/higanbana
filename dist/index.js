import{i as ye,H as tt}from"./hbHtmlRuntime.aTxSbyDU.chunk.js";const $e="st-higanbana-vfs-",A=new Set;async function M(){try{const e=await caches.keys();A.clear();for(const t of e)t.startsWith($e)&&A.add(t.slice($e.length))}catch(e){console.warn("[Higanbana] caches.keys failed",e)}}function _e(e){return!!e&&A.has(e)}function B(){const e=globalThis.SillyTavern;return e?.getContext?e.getContext():null}function x(){const e=B();if(!e)return null;const t=Number(e.characterId);if(!Number.isFinite(t)||t<0)return null;const o=e.characters?.[t];return o?{chid:t,character:o}:null}function rt(e){return String(e?.name??e?.data?.name??"").trim()||"(未命名角色)"}function F(e){return String(e?.avatar??"").trim()}function E(e){const t={projects:[]},o=e?.data?.extensions?.higanbana;if(!o||typeof o!="object")return t;const r=o.projects;if(!Array.isArray(r))return t;const a=[];for(const n of r){if(!n||typeof n!="object")continue;const i=String(n.source??"").trim(),c=String(n.id??"").trim(),u=String(n.title??"").trim()||void 0,d=String(n.placeholder??"").trim(),s=String(n.homePage??"").trim(),l=typeof n.showTitleInChat=="boolean"?!!n.showTitleInChat:!1,h=!!n.fixRootRelativeUrls,f=String(n.zipName??"").trim(),p=String(n.zipSha256??"").trim();if(!(!c||!d||!s||!f)){if(i==="embedded"){const m=String(n.zipBase64??"").trim();if(!m||!p)continue;a.push({source:"embedded",id:c,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p,zipBase64:m});continue}if(i==="local"){if(!p)continue;a.push({source:"local",id:c,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p});continue}if(i==="url"){const m=String(n.zipUrl??"").trim();if(!m)continue;a.push({source:"url",id:c,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p||"",zipUrl:m})}}}return{projects:a}}async function k(e,t){const o=B();if(!o?.writeExtensionField)throw new Error("writeExtensionField 不可用（酒馆版本过旧或上下文缺失）");await o.writeExtensionField(e,"higanbana",t)}const U=String(import.meta.url).replace(/[^/]*$/,""),ot=`${U}sw.js`,Y={urlDownloadPopupInFlight:!1},nt="st-higanbana-vfs-";function at(e){return String(e).split("/").map(t=>encodeURIComponent(t)).join("/")}function de(e,t,o){return`${e}vfs/${encodeURIComponent(t)}/${at(o)}`}function it(e,t){return`${new URL(e).pathname}vfs/${encodeURIComponent(t)}/`}function ct(e){return`${nt}${e}`}function Te(e){const t=String(e).toLowerCase();return t.endsWith(".html")||t.endsWith(".htm")?"text/html; charset=utf-8":t.endsWith(".css")?"text/css; charset=utf-8":t.endsWith(".js")||t.endsWith(".mjs")||t.endsWith(".cjs")?"application/javascript; charset=utf-8":t.endsWith(".json")||t.endsWith(".map")?"application/json; charset=utf-8":t.endsWith(".txt")?"text/plain; charset=utf-8":t.endsWith(".svg")?"image/svg+xml":t.endsWith(".png")?"image/png":t.endsWith(".jpg")||t.endsWith(".jpeg")?"image/jpeg":t.endsWith(".gif")?"image/gif":t.endsWith(".webp")?"image/webp":t.endsWith(".avif")?"image/avif":t.endsWith(".ico")?"image/x-icon":t.endsWith(".woff2")?"font/woff2":t.endsWith(".woff")?"font/woff":t.endsWith(".ttf")?"font/ttf":t.endsWith(".otf")?"font/otf":t.endsWith(".eot")?"application/vnd.ms-fontobject":t.endsWith(".wasm")?"application/wasm":"application/octet-stream"}function st(e){const t=Te(e);return t.startsWith("text/")||t.includes("javascript")||t.includes("json")||t.includes("svg+xml")}function lt(e){return new Promise((t,o)=>{const r=document.createElement("script");r.src=e,r.async=!0,r.onload=()=>t(),r.onerror=()=>o(new Error(`加载脚本失败: ${e}`)),document.head.appendChild(r)})}async function dt(){const e=globalThis;if(e.JSZip)return e.JSZip;if(await lt("/lib/jszip.min.js"),!e.JSZip)throw new Error("JSZip 未能加载（/lib/jszip.min.js）");return e.JSZip}function ut(e){const t=e.filter(Boolean);if(t.length===0)return{prefix:"",stripped:[]};const o=new Set(t.map(i=>i.split("/")[0]).filter(Boolean));if(o.size!==1)return{prefix:"",stripped:t};const a=`${[...o][0]}/`;return t.some(i=>i.startsWith(a))?{prefix:a,stripped:t.map(i=>i.startsWith(a)?i.slice(a.length):i)}:{prefix:"",stripped:t}}function pt(e){let t=String(e??"").replace(/\\/g,"/").replace(/^\.\//,"").replace(/^\/+/,"");const o=t.split("/").filter(Boolean);return o.some(r=>r==="..")?null:(t=o.join("/"),t||null)}function He(e){return String(e).split(/[?#]/,1)[0]}function ht(e){const t=new Set,o=new Set;for(const r of e){t.add(r);const a=r.split("/").filter(Boolean);for(let n=1;n<a.length;n++)o.add(a.slice(0,n).join("/")+"/")}return{fileSet:t,dirSet:o}}function Q(e,t){const o=He(e);return o?!!(t.fileSet.has(o)||t.dirSet.has(o.endsWith("/")?o:`${o}/`)):!1}function ft(e,t,o,r){let a=e;return o&&(a=a.replace(/<base\b([^>]*?)\bhref\s*=\s*(["'])\/\2([^>]*?)>/gi,(n,i,c,u)=>`<base${i}href=${c}${t}${c}${u}>`),a=a.replace(/(<\s*(?:script|img|source|video|audio)\b[^>]*\bsrc\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(n,i,c,u)=>Q(u,r)?`${i}${t}${u}${c}`:n),a=a.replace(/(<\s*link\b[^>]*\bhref\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(n,i,c,u)=>Q(u,r)?`${i}${t}${u}${c}`:n)),a}function mt(e,t,o,r){if(!o)return e;let a=String(e);return a=a.replace(/url\(\s*(["'])?\/(?!\/)([^"')]+)\1\s*\)/gi,(n,i="",c)=>Q(c,r)?`url(${i}${t}${c}${i})`:n),a=a.replace(/@import\s+(?:url\(\s*)?(["'])?\/(?!\/)([^"')\s]+)\1\s*\)?/gi,(n,i="",c)=>Q(c,r)?n.toLowerCase().includes("url(")?`@import url(${i}${t}${c}${i})`:`@import ${i}${t}${c}${i}`:n),a}function bt(e){return!e||/\s/.test(e)?!1:e.endsWith("/")?!0:(e.split("/").filter(Boolean).pop()||"").includes(".")}function gt(e,t,o,r){if(!o)return e;let a=String(e);return a=a.replace(/(["'`])\/(?!\/)([^"'`]*?)\1/g,(n,i,c)=>{const u=He(c);return!bt(u)||!Q(c,r)?n:`${i}${t}${c}${i}`}),a=a.replace(/(__webpack_require__\.p\s*=\s*)(["'])\/\2/g,(n,i,c)=>`${i}${c}${t}${c}`),a=a.replace(/(__webpack_public_path__\s*=\s*)(["'])\/\2/g,(n,i,c)=>`${i}${c}${t}${c}`),a}async function Ne(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(o=>o.toString(16).padStart(2,"0")).join("")}let K=null,ce=!1,wt=0;const ee=new Map;function yt(e){const t=[...ee.values()];ee.clear();for(const o of t)o.reject(e)}function _t(){if(ce)return null;if(K)return K;if(typeof Worker>"u")return ce=!0,null;try{const e=new Worker(new URL("/assets/base64.worker-D8NWWtcD.js",import.meta.url),{type:"module"});e.onmessage=o=>{const r=o.data;if(!r||typeof r!="object")return;const a=Number(r.id);if(!Number.isFinite(a))return;const n=ee.get(a);if(n){if(ee.delete(a),r.ok){"base64"in r?n.resolve(r.base64):"arrayBuffer"in r?n.resolve(r.arrayBuffer):n.reject(new Error("Base64 worker 返回了无效结果"));return}n.reject(new Error(r.error||"Base64 worker 执行失败"))}};const t=o=>{console.warn("[Higanbana] Base64 Worker 不可用，回退到主线程编解码",o),ce=!0;try{e.terminate()}catch{}K===e&&(K=null),yt(new Error("Base64 Worker 已失效"))};return e.onerror=t,e.onmessageerror=t,K=e,e}catch(e){return console.warn("[Higanbana] 创建 Base64 Worker 失败，回退到主线程编解码",e),ce=!0,null}}function Le(e){const t=_t();return t?new Promise((o,r)=>{const a=++wt;ee.set(a,{resolve:o,reject:r}),t.postMessage({...e,id:a})}):Promise.reject(new Error("Base64 Worker 不可用"))}function vt(e){const t=new Uint8Array(e),o=32768,r=[];for(let a=0;a<t.length;a+=o){const n=t.subarray(a,a+o);r.push(String.fromCharCode(...n))}return btoa(r.join(""))}function St(e){const t=atob(e),o=new Uint8Array(t.length);for(let r=0;r<t.length;r++)o[r]=t.charCodeAt(r);return o.buffer}async function Se(e){try{return await Le({type:"arrayBufferToBase64",arrayBuffer:e})}catch{return vt(e)}}async function V(e){try{return await Le({type:"base64ToArrayBuffer",base64:e})}catch{return St(e)}}function X(e){const t=Number(e);if(!Number.isFinite(t)||t<0)return"0 B";const o=["B","KB","MB","GB","TB"];let r=t,a=0;for(;r>=1024&&a<o.length-1;)r/=1024,a++;const n=r>=100?0:r>=10?1:2;return`${r.toFixed(n)} ${o[a]}`}function jt(e){if(e===null)return"—";const t=Number(e);return!Number.isFinite(t)||t<=0?"—":`${X(t)}/s`}function Ct(e){if(e===null)return"—";const t=Number(e);return Number.isFinite(t)?`${Math.max(0,Math.min(t,100)).toFixed(1)}%`:"—"}function he(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}async function te(e,t={}){const o=Math.max(30,Number(t.progressThrottleMs??120)),r=t.onProgress,a=he(),n=await fetch(e,{method:"GET",signal:t.signal});if(!n.ok)throw new Error(`下载失败: ${n.status} ${n.statusText}`);const i=n.headers.get("content-type"),c=n.url||e,u=n.headers.get("content-length"),d=u?Number(u):NaN,s=Number.isFinite(d)&&d>0?d:null,h=n.body?.getReader?.();if(!h){const b=await n.arrayBuffer(),_=Math.max(0,he()-a),v=b.byteLength,C=s??v,z=C?v/C*100:null,T=_>0?v/_*1e3:null;return r?.({loadedBytes:v,totalBytes:C,percent:z,speedBps:T,elapsedMs:_}),{arrayBuffer:b,totalBytes:C,contentType:i,finalUrl:c}}const f=[];let p=0,m=0,w=0,g=null;const y=(b=!1)=>{if(!r)return;const _=he(),v=Math.max(0,_-a);if(!b&&m&&_-m<o)return;if(m){const z=_-m;z>0&&(g=(p-w)/z*1e3)}m=_,w=p;const C=s?p/s*100:null;r({loadedBytes:p,totalBytes:s,percent:C,speedBps:g,elapsedMs:v})};y(!0);try{for(;;){const{done:b,value:_}=await h.read();if(b)break;_&&(f.push(_),p+=_.byteLength,y(!1))}}finally{try{h.releaseLock()}catch{}}y(!0);const j=new Uint8Array(p);let S=0;for(const b of f)j.set(b,S),S+=b.byteLength;return{arrayBuffer:j.buffer,totalBytes:s??p,contentType:i,finalUrl:c}}async function Z(e,t,o){const r=await dt(),a=await Ne(t),n=ct(a),i=await caches.open(n),c=it(e,a),u=await r.loadAsync(t),l=Object.values(u.files||{}).filter(b=>b&&!b.dir).map(b=>({entry:b,path:pt(b.name)})).filter(b=>!!b.path);if(l.length===0)throw new Error("zip 内没有可导入的文件");const{stripped:h}=ut(l.map(b=>b.path)),f=l.map((b,_)=>({entry:b.entry,path:h[_]})).filter(b=>!!b.path),p=f.map(b=>String(b.path)),m=ht(p),w=f.map(b=>b.path).filter(b=>/\.(html?|HTML?)$/i.test(b)).sort((b,_)=>b.localeCompare(_)),g=o.preferredHomePage?.trim(),y=g?w.includes(g):!1,j=w.some(b=>b.toLowerCase()==="index.html");let S=g&&y?g:"";S||(j?S=w.find(b=>b.toLowerCase()==="index.html"):w.length>0?S=w[0]:S="index.html");for(let b=0;b<f.length;b++){const{entry:_,path:v}=f[b],C=Te(v);let z;if(st(v)){let R=await _.async("string");C.startsWith("text/html")?(R=ft(R,c,o.fixRootRelativeUrls,m),z=R):C.startsWith("text/css")?z=mt(R,c,o.fixRootRelativeUrls,m):C.includes("javascript")?z=gt(R,c,o.fixRootRelativeUrls,m):z=R}else{const R=await _.async("uint8array"),N=new Uint8Array(R.byteLength);N.set(R),z=new Blob([N],{type:C})}const T=de(e,a,v);await i.put(new Request(T,{method:"GET"}),new Response(z,{headers:{"Content-Type":C}})),b%75===0&&await new Promise(R=>setTimeout(R,0))}return{projectId:a,homePage:S,htmlFiles:w,fileCount:f.length,cacheName:n}}function je(e){const t=X(e.loadedBytes),o=e.totalBytes?X(e.totalBytes):"?",r=e.totalBytes?Ct(e.percent):"—",a=jt(e.speedBps);return`下载：${t} / ${o}（${r}） | 速度：${a}`}const fe="higanbana",q=Object.freeze({placeholder:"{{WEB_HOME}}",defaultFixRootRelativeUrls:!0,renderHtmlCodeBlocks:!1,renderHtmlCodeBlocksUseBlobUrl:!1,renderHtmlCodeBlocksShowTitleBar:!1,allowedCharacterAvatars:[]});function L(){const e=B();if(!e)return structuredClone(q);e.extensionSettings[fe]=e.extensionSettings[fe]||{};const t=e.extensionSettings[fe];return(typeof t.placeholder!="string"||!t.placeholder.trim())&&(t.placeholder=q.placeholder),typeof t.defaultFixRootRelativeUrls!="boolean"&&(t.defaultFixRootRelativeUrls=q.defaultFixRootRelativeUrls),typeof t.renderHtmlCodeBlocks!="boolean"&&(t.renderHtmlCodeBlocks=q.renderHtmlCodeBlocks),typeof t.renderHtmlCodeBlocksUseBlobUrl!="boolean"&&(t.renderHtmlCodeBlocksUseBlobUrl=q.renderHtmlCodeBlocksUseBlobUrl),typeof t.renderHtmlCodeBlocksShowTitleBar!="boolean"&&(t.renderHtmlCodeBlocksShowTitleBar=q.renderHtmlCodeBlocksShowTitleBar),Array.isArray(t.allowedCharacterAvatars)?t.allowedCharacterAvatars=t.allowedCharacterAvatars.map(o=>String(o).trim()).filter(o=>o.length>0):t.allowedCharacterAvatars=[],t}function G(){B()?.saveSettingsDebounced?.()}function re(){try{if(typeof crypto<"u"&&"randomUUID"in crypto&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}const e=B();try{const t=e?.uuidv4;if(typeof t=="function")return String(t())}catch{}return`hb_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,10)}`}function ne(e){return String(e??"").trim()}function ae(e,t){const o=new Set(e.map(a=>a.placeholder));let r=ne(t);if(r||(r=`{{WEB_${e.length+1}}}`),!o.has(r))return r;for(let a=2;a<1e3;a++){const n=`_${a}`,i=r.endsWith("}}")?r.slice(0,-2)+n+"}}":r+n;if(!o.has(i))return i}return r}function We(e,t){const o=document.createElement("a");o.href=URL.createObjectURL(e),o.setAttribute("download",t),document.body.appendChild(o),o.click(),URL.revokeObjectURL(o.href),document.body.removeChild(o)}function $t(e){const t=String(e??"").trim();if(!t)return null;try{const o=new URL(t);return o.protocol!=="http:"&&o.protocol!=="https:"?null:o.toString()}catch{return null}}function Me(e){try{const o=new URL(e).pathname.split("/").filter(Boolean).pop()||"webzip.zip";return o.endsWith(".zip")?o:`${o}.zip`}catch{return"webzip.zip"}}function xt(e){const t=e?.projects??[];if(t.length===0)return"（无）";const o=t.slice(0,3).map(a=>a.title||a.zipName).filter(Boolean),r=t.length>o.length?` +${t.length-o.length}`:"";return`项目数：${t.length}${o.length?` | ${o.join(" / ")}${r}`:""}`}function Bt(e,t){try{const o=localStorage.getItem(e);return o===null?t:o==="1"}catch{return t}}function Et(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Fe(){const e=document.getElementById("higanbana_settings");if(!e)return;const t=Array.from(e.querySelectorAll(".hb-subpanel"));for(const o of t){const r=String(o.dataset.id??"").trim();if(!r)continue;const a=o.querySelector(".hb-subpanel-header"),n=o.querySelector(".hb-subpanel-indicator"),i=o.querySelector(".hb-subpanel-body");if(!a||!n||!i||a.dataset?.hbBound==="1")continue;a.dataset.hbBound="1";const c=`higanbana.subpanel.open.${r}`,u=a.getAttribute("aria-expanded")==="true",d=s=>{a.setAttribute("aria-expanded",s?"true":"false"),n.textContent=s?"−":"+",i.style.display=s?"block":"none"};d(Bt(c,u)),a.addEventListener("click",()=>{const l=!(a.getAttribute("aria-expanded")==="true");d(l),Et(c,l)})}}function xe(e){const t=document.getElementById("hb_projects_list");if(!t)return;if(t.innerHTML="",e.length===0){const r=document.createElement("div");r.className="hb-subhint",r.textContent="（暂无项目）",t.appendChild(r);return}const o=document.createDocumentFragment();for(const r of e){const a=document.createElement("section");a.className="hb-subpanel hb-project",a.dataset.id=`project_${r.id}`,a.dataset.projectId=r.id;const n=document.createElement("button");n.className="hb-subpanel-header",n.type="button",n.setAttribute("aria-expanded","false");const i=document.createElement("div");i.className="hb-subpanel-title",i.textContent=`${r.title||r.zipName}  ${r.placeholder}`;const c=document.createElement("div");c.className="hb-subpanel-indicator",c.textContent="+",n.appendChild(i),n.appendChild(c),a.appendChild(n);const u=document.createElement("div");u.className="hb-subpanel-body",u.style.display="none";const d=s=>{const l=document.createElement("div");l.className="hb-row";const h=document.createElement("label");return h.className="hb-label",h.textContent=s,l.appendChild(h),l};{const s=d("标题"),l=document.createElement("input");l.className="text_pole hb-proj-title",l.type="text",l.spellcheck=!1,l.value=r.title||"",l.dataset.projectId=r.id,s.appendChild(l),u.appendChild(s)}{const s=d("项目 ID"),l=document.createElement("input");l.className="text_pole hb-proj-id",l.type="text",l.readOnly=!0,l.spellcheck=!1,l.value=r.id,l.dataset.projectId=r.id,s.appendChild(l);const h=document.createElement("div");h.className="hb-actions";const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="copy_project_id",f.dataset.projectId=r.id,f.textContent="复制 ID",h.appendChild(f),s.appendChild(h),u.appendChild(s)}{const s=d("占位符"),l=document.createElement("input");l.className="text_pole hb-proj-placeholder",l.type="text",l.spellcheck=!1,l.value=r.placeholder,l.dataset.projectId=r.id,s.appendChild(l);const h=document.createElement("div");h.className="hb-actions";const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="copy_placeholder",f.dataset.projectId=r.id,f.textContent="复制";const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="insert_placeholder",p.dataset.projectId=r.id,p.textContent="插入到输入框",h.appendChild(f),h.appendChild(p),s.appendChild(h),u.appendChild(s)}{const s=d("入口 HTML"),l=document.createElement("input");l.className="text_pole hb-proj-home",l.type="text",l.spellcheck=!1,l.value=r.homePage,l.dataset.projectId=r.id,s.appendChild(l),u.appendChild(s)}if(r.source==="url"){const s=d("Zip URL"),l=document.createElement("input");l.className="text_pole hb-proj-zip-url",l.type="text",l.spellcheck=!1,l.value=r.zipUrl,l.dataset.projectId=r.id,l.placeholder="https://example.com/your.zip",s.appendChild(l),u.appendChild(s)}{const s=d("修复 root 相对路径（/xxx）"),l=document.createElement("input");l.className="hb-proj-fix",l.type="checkbox",l.checked=!!r.fixRootRelativeUrls,l.dataset.projectId=r.id,s.appendChild(l),u.appendChild(s)}{const s=d("消息列表显示标题"),l=document.createElement("input");l.className="hb-proj-show-title",l.type="checkbox",l.checked=!!r.showTitleInChat,l.dataset.projectId=r.id,s.appendChild(l),u.appendChild(s)}{const s=d("操作"),l=document.createElement("div");if(l.className="hb-actions",r.source==="embedded"){const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="import_cache",p.dataset.projectId=r.id,p.textContent="导入到缓存",l.appendChild(p);const m=document.createElement("button");m.className="menu_button",m.type="button",m.dataset.hbAction="export_zip",m.dataset.projectId=r.id,m.textContent="导出 zip",l.appendChild(m)}else if(r.source==="url"){const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="download_apply",p.dataset.projectId=r.id,p.textContent="下载并应用",l.appendChild(p)}else{const p=document.createElement("button");p.className="menu_button",p.type="button",p.disabled=!0,p.title="仅使用本地缓存。若缓存被清理，请在“新增项目”中重新导入 zip。",p.textContent="本地缓存模式",l.appendChild(p)}const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="open_home",h.dataset.projectId=r.id,h.textContent="打开首页",l.appendChild(h);const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="delete_project",f.dataset.projectId=r.id,f.textContent="删除项目",l.appendChild(f),s.appendChild(l),u.appendChild(s)}a.appendChild(u),o.appendChild(a)}t.appendChild(o),Fe()}async function Pt(){$("#higanbana_settings").remove();const e=await fetch(`${U}settings.html`,{cache:"no-store"});if(!e.ok)throw new Error(`加载 settings.html 失败: ${e.status}`);const t=await e.text();$("#extensions_settings").append(t)}function zt(){const e=L();$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_render_html_blocks").prop("checked",!!e.renderHtmlCodeBlocks),$("#hb_render_html_blocks_blob").prop("checked",!!e.renderHtmlCodeBlocksUseBlobUrl),$("#hb_render_html_blocks_titlebar").prop("checked",!!e.renderHtmlCodeBlocksShowTitleBar);const t=$("#hb_homepage");t.length&&!String(t.val()??"").trim()&&t.val("index.html")}function I(){const e=L(),t=x();if(!t){$("#hb_char_info").text("（未选中角色）"),$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_homepage").val(String($("#hb_homepage").val()??"").trim()||"index.html"),xe([]),$("#hb_import_from_card").prop("disabled",!0),$("#hb_migrate_embedded_to_local").prop("disabled",!0),$("#hb_unbind").prop("disabled",!0),$("#hb_pick_zip_btn").prop("disabled",!0),$("#hb_bind_zip").prop("disabled",!0),$("#hb_bind_zip_btn").prop("disabled",!0),$("#hb_bind_zip_local_btn").prop("disabled",!0),$("#hb_bind_url").prop("disabled",!0),$("#hb_bind_url_btn").prop("disabled",!0);return}const{chid:o,character:r}=t,a=rt(r),n=F(r);$("#hb_char_info").text([`名称：${a}`,`chid：${o}`,n?`avatar：${n}`:""].filter(Boolean).join(`
`));const i=E(r);xe(i.projects);const c=i.projects.length>0;$("#hb_import_from_card").prop("disabled",!i.projects.some(l=>l.source==="embedded")),$("#hb_migrate_embedded_to_local").prop("disabled",!i.projects.some(l=>l.source==="embedded")),$("#hb_unbind").prop("disabled",!c),$("#hb_pick_zip_btn").prop("disabled",!1),$("#hb_bind_zip").prop("disabled",!1),$("#hb_bind_zip_btn").prop("disabled",!1),$("#hb_bind_zip_local_btn").prop("disabled",!1),$("#hb_bind_url").prop("disabled",!1),$("#hb_bind_url_btn").prop("disabled",!1);const u=$("#hb_fix_root_relative");u.length&&document.activeElement!==u.get(0)&&u.prop("checked",!!e.defaultFixRootRelativeUrls);const d=$("#hb_homepage");d.length&&document.activeElement!==d.get(0)&&!String(d.val()??"").trim()&&d.val("index.html");const s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&!String(s.val()??"").trim()&&s.val(ae(i.projects,`{{WEB_${i.projects.length+1}}}`))}function De(e){return L().allowedCharacterAvatars.includes(e)}function O(e){const t=L();t.allowedCharacterAvatars.includes(e)||(t.allowedCharacterAvatars.push(e),G())}const Be=new WeakMap;function It(e){try{const t=e.contentDocument;if(!t)return null;const o=t.body,r=t.documentElement;if(!o||!r)return null;const a=o.scrollHeight||0,n=r.scrollHeight||0,i=o.offsetHeight||0,c=r.offsetHeight||0,u=Math.max(a,n,i,c);return!Number.isFinite(u)||u<=0?null:u}catch{return null}}function se(e){const t=It(e);if(!t)return;const o=Math.max(80,Math.min(t,1e4));e.style.height=`${o}px`}function Ze(e){Be.get(e)?.ro?.disconnect?.();const o={};Be.set(e,o);const r=()=>{se(e),setTimeout(()=>se(e),50),setTimeout(()=>se(e),250);try{const a=e.contentDocument;if(!a?.documentElement)return;const n=new ResizeObserver(()=>se(e));n.observe(a.documentElement),a.body&&n.observe(a.body),o.ro=n}catch{}};r(),e.addEventListener("load",r)}function Ut(e){const t=x();if(!t)return{kind:"stub",title:"彼岸花：无法渲染",reason:"当前不在单角色聊天/未选中角色。"};const o=e.title||e.zipName,r=F(t.character);if(r&&!De(r))return{kind:"stub",title:`彼岸花：未启用（${o}）`,reason:e.source==="url"?"该角色卡绑定了 WebZip URL，但尚未允许/下载。切换到该角色时会弹窗询问，或在面板/弹窗中下载并导入缓存。":e.source==="embedded"?"该角色卡包含嵌入 WebZip，但尚未允许/导入。切换到该角色时会弹窗询问，或在面板点“导入所有嵌入项目到本地缓存”。":"该角色卡绑定了本地缓存项目。请先允许该角色，并确保当前浏览器已导入对应 zip。"};const a=e.zipSha256;return a?_e(a)?{kind:"iframe",src:de(U,a,e.homePage),title:`彼岸花：${o} · ${e.homePage}`}:{kind:"stub",title:`彼岸花：未导入缓存（${o}）`,reason:e.source==="url"?"请下载并导入缓存后即可渲染。":e.source==="embedded"?"请先导入到本地缓存（面板中可操作），再刷新聊天即可渲染。":"这是“本地缓存模式”项目，当前浏览器未找到缓存。请在扩展面板重新导入本地 zip 并绑定。"}:{kind:"stub",title:`彼岸花：未下载（${o}）`,reason:e.source==="url"?"请在面板/弹窗中下载并导入缓存后即可渲染。":"缺少 projectId，无法渲染。"}}function Oe(e,t,o,r={}){const a=document.createElement("div");a.className="hb-embed",a.dataset.hbEmbed="1",a.classList.add(o.kind==="stub"?"hb-embed-stub":"hb-embed-iframe"),r.projectId&&(a.dataset.hbProjectId=r.projectId),r.showTitleInChat===!0||a.classList.add("hb-embed-no-title");const i=document.createElement("div");i.className="hb-embed-header";const c=document.createElement("div");c.className="hb-embed-title",c.textContent=o.title;const u=document.createElement("div");if(u.className="hb-embed-actions",o.kind==="iframe"){const h=document.createElement("a");h.href=r.openInNewTabUrl||o.src,h.target="_blank",h.rel="noopener noreferrer",h.textContent="新标签页打开",u.appendChild(h)}i.appendChild(c),i.appendChild(u),a.appendChild(i);const d=document.createElement("div");if(d.className="hb-embed-body",o.kind==="stub"){const h=document.createElement("div");return h.style.padding="10px",h.style.opacity="0.9",h.textContent=o.reason,d.appendChild(h),a.appendChild(d),a}const s=document.createElement("iframe");s.className="hb-iframe",s.loading="lazy",s.referrerPolicy="no-referrer",s.name=`hb-${e}-${t}`,s.setAttribute("sandbox","allow-scripts allow-same-origin");const l=!!r.projectId||r.useBlobUrlInChat===!0;try{s.dataset=s.dataset||{},s.dataset.hbVfsHomeUrl=o.src,s.dataset.hbUseBlobUrl=l?"1":"0"}catch{}return l?(s.removeAttribute("src"),s.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',Ge(s,o.src)):(s.removeAttribute("srcdoc"),s.src=o.src),Ze(s),d.appendChild(s),a.appendChild(d),a}const Ee=new Map;function Rt(e){const t=String(e??"").trim();return`<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      *{box-sizing:border-box}
      html,body{margin:0;padding:0;width:100%}
      #inner{display:block;width:100%;border:0;height:260px}
      .loading{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:12px;opacity:.85}
    </style>
  </head>
  <body>
    <div class="loading" id="loading">正在加载…</div>
    <iframe id="inner" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer"></iframe>
    <script>
      const VFS_URL = ${JSON.stringify(t)};
      const inner = document.getElementById('inner');
      const loading = document.getElementById('loading');
      const clamp = (h) => Math.max(80, Math.min(Number(h) || 0, 10000));
      const setHeight = (h) => {
        const px = clamp(h);
        if (!px) return;
        inner.style.height = px + 'px';
      };

      try { inner.name = String(window.name || ''); } catch {}
      try { inner.src = VFS_URL; } catch {}

      inner.addEventListener('load', () => {
        try { if (loading) loading.style.display = 'none'; } catch {}
      });

      window.addEventListener('message', (ev) => {
        const data = ev && ev.data;
        if (!data || typeof data !== 'object') return;

        // Height message from inner
        if (ev.source === inner.contentWindow && data.type === 'HB_IFRAME_HEIGHT') {
          setHeight(data.height);
          return;
        }

        // Bridge messages between inner <-> parent (for ST_API / CSRF proxy)
        if (data.__hb === 'higanbana' && data.v === 1) {
          try {
            if (ev.source === inner.contentWindow) {
              window.parent && window.parent.postMessage(data, '*');
              return;
            }
            if (ev.source === window.parent) {
              inner.contentWindow && inner.contentWindow.postMessage(data, '*');
            }
          } catch {
            // ignore
          }
        }
      });
    <\/script>
  </body>
</html>`}async function At(e){const t=String(e??"").trim();if(!t)throw new Error("vfsHomeUrl is required");const o=Ee.get(t);if(o)return await o.promise;const r={promise:(async()=>{const a=Rt(t),n=URL.createObjectURL(new Blob([a],{type:"text/html"}));return r.url=n,n})()};return Ee.set(t,r),await r.promise}async function Ge(e,t){try{const o=String(t??"").trim();if(!o)return;e.dataset=e.dataset||{},e.dataset.hbVfsHomeUrl=o,e.dataset.hbUseBlobUrl="1";const r=await At(o);if(!e.isConnected)return;const a=String(e.dataset?.hbVfsHomeUrl??"");if(!(String(e.dataset?.hbUseBlobUrl??"")==="1")||a!==o)return;e.removeAttribute("srcdoc"),e.src=r}catch(o){console.warn("[Higanbana] blob render failed, fallback to VFS",{vfsHomeUrl:t,err:o});try{if(!e.isConnected)return;e.removeAttribute("srcdoc"),e.src=String(t??"")}catch{}}}function kt(e,t){if(!e)return;const o=document.querySelectorAll(".hb-embed[data-hb-project-id]");for(const r of o)String(r.dataset?.hbProjectId??"")===e&&(t?r.classList.remove("hb-embed-no-title"):r.classList.add("hb-embed-no-title"))}function Ve(){const e=document.querySelectorAll(".hb-embed.hb-embed-iframe[data-hb-project-id]");for(const t of e){const o=t.querySelector("iframe.hb-iframe");if(!o)continue;const r=String(o.src||"");if(r.startsWith("blob:"))continue;const a=t.querySelector(".hb-embed-actions a"),n=String(a?.href||o.dataset?.hbVfsHomeUrl||r||"").trim();n&&(o.removeAttribute("src"),o.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',Ge(o,n))}}function Tt(e){const t=String(e??"").toLowerCase();return t.includes("<html")||t.includes("<head")||t.includes("<body")||t.includes("<!doctype html")}function ve(e){const o=String(e??"").trim(),r=o.toLowerCase();return o?r.includes("<!doctype")||r.includes("<html")?o:`<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><body>${o}</body>`:'<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'}function Ht(e){let t=2166136261;for(let o=0;o<e.length;o++)t^=e.charCodeAt(o),t=Math.imul(t,16777619);return(t>>>0).toString(16)}function Pe(e,t){const o=ye(ve(t),{origin:window.location.origin,forceBaseHref:!0}),r=Ht(o),a=String(e.dataset?.hbHtmlHash??""),n=String(e.dataset?.hbHtmlBlobUrl??"");if(n&&a===r)return n;if(n)try{URL.revokeObjectURL(n)}catch{}const i=URL.createObjectURL(new Blob([o],{type:"text/html"}));return e.dataset.hbHtmlHash=r,e.dataset.hbHtmlBlobUrl=i,i}function qe(e,t){const o=L(),r=!!o.renderHtmlCodeBlocks,a=!!o.renderHtmlCodeBlocksUseBlobUrl,n=!!o.renderHtmlCodeBlocksShowTitleBar,i=a||n,c=Array.from(e.querySelectorAll(".hb-html-render"));if(!r){for(const s of c){const l=String(s.dataset?.hbHtmlBlobUrl??"");if(l)try{URL.revokeObjectURL(l)}catch{}const h=s.querySelector("pre");h&&s.parentNode&&(h.classList.remove("hb-html-code-hidden"),s.parentNode.insertBefore(h,s)),s.remove()}return}const u=Array.from(e.querySelectorAll("pre > code"));if(u.length===0)return;for(const s of c)s.querySelectorAll(".hb-embed").forEach(l=>l.remove()),s.querySelectorAll("iframe.hb-html-iframe").forEach(l=>l.remove());let d=e.querySelectorAll(".hb-embed").length;for(const s of u){const l=s.closest("pre");if(!l)continue;const h=s.textContent||"";if(!Tt(h))continue;const f=l.closest(".hb-html-render"),p=f||document.createElement("div");if(!f){p.className="hb-html-render",p.dataset.hbHtmlRender="1";const y=l.parentNode;if(!y)continue;y.insertBefore(p,l),p.appendChild(l)}if(l.classList.add("hb-html-code-hidden"),!i){const y=String(p.dataset?.hbHtmlBlobUrl??"");if(y)try{URL.revokeObjectURL(y)}catch{}try{delete p.dataset.hbHtmlBlobUrl,delete p.dataset.hbHtmlHash}catch{}}const m=a?Pe(p,h):"";if(n){const y=ye(ve(h),{origin:window.location.origin,forceBaseHref:!1}),j={kind:"iframe",src:a&&m?m:"about:blank",title:"HTML 代码块"},S=Oe(t,d++,j,{showTitleInChat:!0,openInNewTabUrl:a&&m?m:"#"}),b=p.querySelector(".hb-embed");if(b&&b.remove(),p.appendChild(S),!a){const _=S.querySelector("iframe.hb-iframe");_&&(_.removeAttribute("src"),_.srcdoc=y);const v=S.querySelector(".hb-embed-actions a");v&&String(v.dataset?.hbHtmlLazyOpenBound??"")!=="1"&&(v.dataset.hbHtmlLazyOpenBound="1",v.href="#",v.addEventListener("click",C=>{try{C.preventDefault();const z=Pe(p,h);window.open(z,"_blank","noopener,noreferrer")}catch{}}))}continue}const w=p.querySelector(".hb-embed");w&&w.remove();let g=p.querySelector("iframe.hb-html-iframe");g||(g=document.createElement("iframe"),g.className="hb-html-iframe",g.loading="lazy",g.referrerPolicy="no-referrer",g.name=`hb-html-${t}`,g.setAttribute("sandbox","allow-scripts allow-same-origin"),Ze(g),p.appendChild(g)),a&&m?(g.removeAttribute("srcdoc"),g.src=m):(g.removeAttribute("src"),g.srcdoc=ye(ve(h),{origin:window.location.origin,forceBaseHref:!1}))}}function Nt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Je(e,t){const o=x();if(!o)return;const r=E(o.character);if(r.projects.length===0)return;const a=new Map;for(const m of r.projects){const w=String(m.placeholder??"").trim();w&&(a.has(w)||a.set(w,m))}const n=Array.from(a.keys());if(n.length===0)return;const i=e.textContent||"";let c=!1;for(const m of n)if(i.includes(m)){c=!0;break}if(!c)return;n.sort((m,w)=>w.length-m.length);const u=n.map(Nt).join("|"),d=new RegExp(u,"g"),s=new RegExp(u),l=new Map;for(const m of n){const w=a.get(m);w&&l.set(m,Ut(w))}let h=0;const f=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode(m){const w=m?.nodeValue||"";if(!w||!s.test(w))return NodeFilter.FILTER_REJECT;let g=m.parentNode;for(;g&&g!==e;){if(g.nodeType===1){const y=g.tagName;if(y==="CODE"||y==="PRE"||y==="TEXTAREA")return NodeFilter.FILTER_REJECT}g=g.parentNode}return NodeFilter.FILTER_ACCEPT}}),p=[];for(;f.nextNode();)p.push(f.currentNode);for(const m of p){const w=m.nodeValue||"";if(!s.test(w))continue;d.lastIndex=0;let g=0;const y=document.createDocumentFragment();for(const j of w.matchAll(d)){const S=Number(j.index??0),b=String(j[0]??"");S>g&&y.appendChild(document.createTextNode(w.slice(g,S)));const _=a.get(b),v=l.get(b);v?y.appendChild(Oe(t,h++,v,{projectId:_?.id,showTitleInChat:_?.showTitleInChat,useBlobUrlInChat:!0,openInNewTabUrl:v.kind==="iframe"?v.src:void 0})):y.appendChild(document.createTextNode(b)),g=S+b.length}g<w.length&&y.appendChild(document.createTextNode(w.slice(g))),m.parentNode?.replaceChild(y,m)}}function me(e){const t=Number(e);if(!Number.isFinite(t))return;const o=$(`#chat .mes[mesid="${t}"]`);if(o.length===0)return;const r=o.find(".mes_text").get(0);r&&(Je(r,t),qe(r,t),Ve())}function Ye(){const e=document.querySelectorAll("#chat .mes[mesid]");for(const t of e){const o=t.getAttribute("mesid"),r=Number(o);if(!Number.isFinite(r))continue;const a=t.querySelector(".mes_text");a&&(Je(a,r),qe(a,r))}Ve()}let be=!1;function H(){be||(be=!0,setTimeout(()=>{be=!1,Ye()},0))}let ze=!1;function Lt(){if(ze)return;const e=B();if(!e?.eventSource||!e?.event_types)return;ze=!0;const{eventSource:t,event_types:o}=e,r=(...n)=>me(n?.[0]),a=(...n)=>{const i=Number(n?.[0]);Number.isFinite(i)&&(setTimeout(()=>me(i),0),setTimeout(()=>me(i),50))};t.on(o.USER_MESSAGE_RENDERED,r),t.on(o.CHARACTER_MESSAGE_RENDERED,r),o.MESSAGE_EDITED&&t.on(o.MESSAGE_EDITED,a),o.MESSAGE_UPDATED&&t.on(o.MESSAGE_UPDATED,a),o.MORE_MESSAGES_LOADED&&t.on(o.MORE_MESSAGES_LOADED,()=>H()),o.CHAT_CHANGED&&t.on(o.CHAT_CHANGED,()=>H())}function P(e){$("#hb_status").text(e)}function ue(e){return e.source==="url"?e.zipSha256?!_e(e.zipSha256):!0:!_e(e.zipSha256)}function Xe(e){const t=document.createElement("div"),o=document.createElement("h3");o.textContent=e,t.appendChild(o);const r=document.createElement("progress");r.max=100,r.value=0,r.style.width="100%",r.style.height="12px",t.appendChild(r);const a=document.createElement("div");return a.style.marginTop="8px",a.style.opacity="0.9",a.style.whiteSpace="nowrap",a.style.overflowX="auto",a.style.overflowY="hidden",t.appendChild(a),{root:t,titleEl:o,progress:r,text:a}}async function Ce(e,t){const o=B();if(!o)throw new Error("上下文缺失");const r=t.filter(f=>ue(f));if(r.length===0)return{importedCount:0,cancelled:!1};if(!o.callGenericPopup||!o.POPUP_TYPE){let f=0;for(const p of r){const m=x();if(!m||Number(m.chid)!==Number(e))break;const w=p.title||p.zipName;P(`正在导入：${w} ...`);let g;if(p.source==="url")g=(await te(p.zipUrl)).arrayBuffer;else if(p.source==="embedded")g=await V(p.zipBase64);else{P(`项目“${w}”为本地缓存模式，无法自动恢复缓存，请在面板重新导入本地 zip。`);continue}const y=await Z(U,g,{fixRootRelativeUrls:p.fixRootRelativeUrls,preferredHomePage:p.homePage});A.add(y.projectId),await M();const S=E(m.character).projects.map(b=>b.id===p.id?{...b,zipSha256:y.projectId,homePage:y.homePage}:b);await k(e,{projects:S}),f++}return{importedCount:f,cancelled:!1}}if(Y.urlDownloadPopupInFlight)throw new Error("当前已有下载弹窗进行中，请稍后再试");Y.urlDownloadPopupInFlight=!0;const a=new AbortController;let n=!1,i=!1,c=0;const{root:u,titleEl:d,progress:s,text:l}=Xe("彼岸花：准备导入...");l.style.whiteSpace="pre-wrap",l.style.overflowX="hidden";const h=f=>{try{l.textContent=je(f)}catch{l.textContent="正在下载..."}if(f?.totalBytes){const p=Number(f?.percent);Number.isFinite(p)&&(s.max=100,s.value=Math.max(0,Math.min(100,p)))}else s.removeAttribute("value")};try{await o.callGenericPopup(u,o.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消",onClosing:()=>(n||(i=!0,a.abort()),!0),onOpen:async f=>{try{for(let p=0;p<r.length;p++){const m=r[p];if(a.signal.aborted)break;const w=x();if(!w||Number(w.chid)!==Number(e))break;const g=m.title||m.zipName;d.textContent=`彼岸花：正在导入（${p+1}/${r.length}）${g}`;let y;if(m.source==="url")l.textContent=`准备下载：${m.zipName}
${m.zipUrl}`,s.max=100,s.value=0,y=(await te(m.zipUrl,{signal:a.signal,onProgress:h})).arrayBuffer,s.value=100,l.textContent=`下载完成（${X(y.byteLength)}），正在解压并写入缓存...`;else if(m.source==="embedded")s.removeAttribute("value"),l.textContent=`正在从角色卡导入并解压：${m.zipName}`,y=await V(m.zipBase64);else{l.textContent=`项目“${g}”为本地缓存模式，无法自动恢复缓存。请在面板重新导入本地 zip。`;continue}const j=await Z(U,y,{fixRootRelativeUrls:m.fixRootRelativeUrls,preferredHomePage:m.homePage});A.add(j.projectId),await M();const b=E(w.character).projects.map(_=>_.id===m.id?{..._,zipSha256:j.projectId,homePage:j.homePage}:_);await k(e,{projects:b}),c++}n=!0;try{await f.completeAffirmative?.()}catch{}}catch(p){n=!0;try{await f.completeCancelled?.()}catch{}throw p}}})}finally{Y.urlDownloadPopupInFlight=!1}return{importedCount:c,cancelled:i}}async function Wt(e){const t=B();if(!t)return null;if(!t.callGenericPopup||!t.POPUP_TYPE){const d=await te(e.zipUrl),s=await Z(U,d.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});return A.add(s.projectId),await M(),{projectId:s.projectId,homePage:s.homePage,fileCount:s.fileCount}}if(Y.urlDownloadPopupInFlight)return null;Y.urlDownloadPopupInFlight=!0;const o=new AbortController;let r=!1,a=null;const{root:n,progress:i,text:c}=Xe("彼岸花：正在下载 WebZip...");c.textContent=`准备下载：${e.zipName} | ${e.zipUrl}`;const u=d=>{if(c.textContent=je(d),d.totalBytes){const s=Number(d.percent);Number.isFinite(s)&&(i.max=100,i.value=Math.max(0,Math.min(100,s)))}else i.removeAttribute("value")};try{await t.callGenericPopup(n,t.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消下载",onClosing:()=>(r||o.abort(),!0),onOpen:async d=>{try{const s=await te(e.zipUrl,{signal:o.signal,onProgress:u});i.max=100,i.value=100,c.textContent=`下载完成（${X(s.arrayBuffer.byteLength)}），正在解压并写入缓存...`;const l=await Z(U,s.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});A.add(l.projectId),await M(),a={projectId:l.projectId,homePage:l.homePage,fileCount:l.fileCount},r=!0;try{await d.completeAffirmative()}catch{}}catch(s){o.signal.aborted||s?.name==="AbortError"?toastr.info("已取消下载"):(console.error("[Higanbana] url download failed",s),toastr.error(`下载失败：${s?.message??s}`)),r=!0;try{await d.completeCancelled?.()}catch{}}}})}finally{Y.urlDownloadPopupInFlight=!1}return a}let J=null;const Ie=20*1024*1024;function oe(e){const t=Number(e?.byteLength??0);if(!Number.isFinite(t)||t<=Ie)return;const o=Math.round(Ie/1024/1024);throw new Error(`当前 zip 大小为 ${X(t)}，超过嵌入上限（${o} MB）。请改用“添加本地缓存项目（不嵌入）”或 URL 模式。`)}function Ue(e){const t=$("#hb_url_download_wrap"),o=$("#hb_cancel_url_download_btn");e?(t.show(),o.show()):(t.hide(),o.hide())}function Mt(e){const t=$("#hb_url_download_wrap"),o=$("#hb_url_progress"),r=$("#hb_url_progress_text");t.length&&t.show();try{r.text(je(e))}catch{r.text("正在下载...")}if(e?.totalBytes){const a=Number(e?.percent);Number.isFinite(a)&&(o.attr("max","100"),o.get(0)?.removeAttribute?.("value"),o.val(Math.max(0,Math.min(100,a))))}else o.get(0)?.removeAttribute?.("value")}function Ft(){try{J?.abort()}catch{}}async function Dt(){const e=B(),t=x();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const o=E(t.character),r=o.projects.find(u=>u.source==="url");if(!r)throw new Error("当前角色卡没有 URL 项目");if(Y.urlDownloadPopupInFlight)throw new Error("当前已有自动下载弹窗进行中，请稍后再试");J&&!J.signal.aborted&&J.abort();const a=F(t.character);a&&O(a);const n=r.fixRootRelativeUrls,i=r.homePage,c=new AbortController;J=c,Ue(!0),$("#hb_url_progress").attr("max","100"),$("#hb_url_progress").val(0),$("#hb_url_progress_text").text(`准备下载：${r.zipName} | ${r.zipUrl}`),$("#hb_bind_url_btn").prop("disabled",!0),$("#hb_download_url_btn").prop("disabled",!0);try{const u=await te(r.zipUrl,{signal:c.signal,onProgress:Mt});if(c.signal.aborted)throw new Error("已取消下载");P("下载完成，正在解压并写入 VFS 缓存...");const d=await Z(U,u.arrayBuffer,{fixRootRelativeUrls:n,preferredHomePage:i});A.add(d.projectId),await M();const s={projects:o.projects.map(l=>l.source==="url"?{...l,zipSha256:d.projectId,homePage:d.homePage}:l)};await k(t.chid,s),P(`已下载并导入缓存。
projectId(sha256)：${d.projectId}
入口：${d.homePage}
文件数：${d.fileCount}

提示：在消息中插入占位符即可渲染`),e?.reloadCurrentChat&&await e.reloadCurrentChat()}finally{J===c&&(J=null),Ue(!1),$("#hb_bind_url_btn").prop("disabled",!1),$("#hb_download_url_btn").prop("disabled",!1),I()}}async function Zt(e,t){const o=x();if(!o)throw new Error("当前不在单角色聊天/未选中角色");oe(t);const r=F(o.character);r&&O(r);const a=L(),n=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=n,G();const i=String($("#hb_homepage").val()??"").trim()||void 0;P("正在解压并写入 VFS 缓存...");const c=await Z(U,t,{fixRootRelativeUrls:n,preferredHomePage:i});A.add(c.projectId),await M(),P("正在编码 base64 并写入角色卡扩展字段...");const u=await Se(t),d=E(o.character),s=ne($("#hb_placeholder").val()),l=ae(d.projects,s),h=String($("#hb_new_title").val()??"").trim(),f=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,p={source:"embedded",id:re(),title:h||void 0,placeholder:l,homePage:c.homePage,showTitleInChat:f,fixRootRelativeUrls:n,zipName:e,zipSha256:c.projectId,zipBase64:u},m={projects:[...d.projects,p]};await k(o.chid,m);const w=$("#hb_placeholder");w.length&&document.activeElement!==w.get(0)&&w.val(""),I(),$("#hb_new_title").val(""),P(`已添加项目（嵌入模式）。
占位符：${l}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}

提示：导出该角色卡(json/png)会包含该项目的 zipBase64`)}async function Ot(e,t){const o=x();if(!o)throw new Error("当前不在单角色聊天/未选中角色");const r=F(o.character);r&&O(r);const a=L(),n=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=n,G();const i=String($("#hb_homepage").val()??"").trim()||void 0;P("正在解压并写入 VFS 缓存...");const c=await Z(U,t,{fixRootRelativeUrls:n,preferredHomePage:i});A.add(c.projectId),await M();const u=E(o.character),d=ne($("#hb_placeholder").val()),s=ae(u.projects,d),l=String($("#hb_new_title").val()??"").trim(),h=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,f={source:"local",id:re(),title:l||void 0,placeholder:s,homePage:c.homePage,showTitleInChat:h,fixRootRelativeUrls:n,zipName:e,zipSha256:c.projectId},p={projects:[...u.projects,f]};await k(o.chid,p);const m=$("#hb_placeholder");m.length&&document.activeElement!==m.get(0)&&m.val(""),I(),$("#hb_new_title").val(""),P(`已添加项目（本地缓存模式，不嵌入角色卡）。
占位符：${s}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}

提示：导出角色卡时不会包含该 zip；若浏览器缓存被清理，需要在本机重新导入 zip。`)}async function Gt({allow:e=!0,ensureCached:t=!0,reloadChat:o=!0}={}){const r=B(),a=x();if(!a)throw new Error("当前不在单角色聊天/未选中角色");const n=F(a.character);e&&n&&O(n);const c=E(a.character).projects.filter(p=>p.source==="embedded"),u=c.length;if(u===0)return{totalEmbedded:0,migrated:0,importedCount:0,cancelled:!1};let d=0,s=!1;if(t){const p=c.filter(m=>ue(m));if(p.length>0){P(`发现 ${p.length} 个嵌入项目未缓存，正在导入缓存...`);const m=await Ce(a.chid,p);if(d=m.importedCount,s=m.cancelled,s)return P("已取消迁移（未修改角色卡）"),{totalEmbedded:u,migrated:0,importedCount:d,cancelled:!0}}}const l=E(a.character);let h=0;const f=l.projects.map(p=>p.source!=="embedded"?p:(h++,{source:"local",id:p.id,title:p.title,placeholder:p.placeholder,homePage:p.homePage,showTitleInChat:p.showTitleInChat,fixRootRelativeUrls:p.fixRootRelativeUrls,zipName:p.zipName,zipSha256:p.zipSha256}));return await k(a.chid,{projects:f}),o&&r?.reloadCurrentChat&&await r.reloadCurrentChat(),I(),{totalEmbedded:u,migrated:h,importedCount:d,cancelled:!1}}function pe(e,t,o){const r=String(t??"").trim(),a=String(o??"").trim();if(r){const n=e.findIndex(i=>i.id===r);if(n<0)throw new Error(`找不到目标项目：${r}`);return n}if(a){const n=[];for(let i=0;i<e.length;i++)e[i]?.zipSha256===a&&n.push(i);if(n.length===0)throw new Error(`找不到使用该 zipSha256 的项目：${a}`);if(n.length>1)throw new Error("存在多个项目使用相同 zipSha256，请传入 targetProjectId 精确指定目标项目");return n[0]}throw new Error("缺少目标项目标识，请提供 targetProjectId 或 targetZipSha256")}async function Ke(e){const t=B(),{active:o,card:r}=D(),a=pe(r.projects,e?.targetProjectId,e?.targetZipSha256),n=r.projects[a],i=String(e?.source??n.source).trim(),c=i==="embedded"||i==="url"||i==="local"?i:"";if(!c)throw new Error(`非法 source：${i}`);const u=e?.title!==void 0?String(e.title??"").trim()||void 0:n.title,d=e?.placeholder!==void 0?String(e.placeholder??"").trim():n.placeholder,s=e?.homePage!==void 0?String(e.homePage??"").trim():n.homePage,l=typeof e?.showTitleInChat=="boolean"?!!e.showTitleInChat:!!n.showTitleInChat,h=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!n.fixRootRelativeUrls,f=e?.zipName!==void 0?String(e.zipName??"").trim():n.zipName,p=e?.zipSha256!==void 0?String(e.zipSha256??"").trim():String(n.zipSha256??"").trim();if(!d)throw new Error("placeholder 不能为空");if(!s)throw new Error("homePage 不能为空");if(!f)throw new Error("zipName 不能为空");if(r.projects.some((y,j)=>j!==a&&y.placeholder===d))throw new Error(`占位符已被其它项目占用：${d}`);let w;if(c==="url"){const y=e?.zipUrl!==void 0?String(e.zipUrl??"").trim():n.source==="url"?n.zipUrl:"";if(!y)throw new Error("source=url 时 zipUrl 不能为空");w={source:"url",id:n.id,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p||"",zipUrl:y}}else if(c==="embedded"){const y=e?.zipBase64!==void 0?String(e.zipBase64??"").trim():n.source==="embedded"?n.zipBase64:"";if(!y)throw new Error("source=embedded 时 zipBase64 不能为空");if(!p)throw new Error("source=embedded 时 zipSha256 不能为空");if(e?.zipBase64!==void 0){const j=await V(y);oe(j)}w={source:"embedded",id:n.id,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p,zipBase64:y}}else{if(!p)throw new Error("source=local 时 zipSha256 不能为空");w={source:"local",id:n.id,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p}}const g=[...r.projects];return g[a]=w,await k(o.chid,{projects:g}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),I(),H(),{targetProjectId:n.id,project:w}}function Vt(e){if(e instanceof Uint8Array){const r=new Uint8Array(e.byteLength);return r.set(e),r.buffer}const t=new Uint8Array(e),o=new Uint8Array(t.byteLength);return o.set(t),o.buffer}async function Qe(e){if(e?.zipArrayBuffer instanceof ArrayBuffer||e?.zipArrayBuffer instanceof Uint8Array)return Vt(e.zipArrayBuffer);const t=String(e?.importZipBase64??e?.zipBase64??"").trim();if(t)return await V(t);throw new Error("缺少 zip 数据，请提供 zipArrayBuffer 或 zipBase64")}async function qt(e){const{card:t}=D(),o=pe(t.projects,e?.targetProjectId,e?.targetZipSha256),r=t.projects[o],a=await Qe(e),n=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!r.fixRootRelativeUrls,i=String(e?.preferredHomePage??e?.homePage??r.homePage??"").trim()||void 0;P("正在导入新 zip 并写入 VFS 缓存...");const c=await Z(U,a,{fixRootRelativeUrls:n,preferredHomePage:i});A.add(c.projectId),await M();const u=String(e?.source??r.source).trim(),d=u==="embedded"||u==="url"||u==="local"?u:"";if(!d)throw new Error(`非法 source：${u}`);const s={targetProjectId:r.id,source:d,zipName:e?.zipName!==void 0?String(e.zipName??"").trim():r.zipName,homePage:c.homePage,zipSha256:c.projectId,fixRootRelativeUrls:n,reloadChat:e?.reloadChat};if(d==="url"&&e?.zipUrl!==void 0&&(s.zipUrl=String(e.zipUrl??"").trim()),d==="embedded"){if(!(e?.persistEmbeddedToCard!==!1))throw new Error("source=embedded 时必须写入 zipBase64；若不希望写入角色卡，请将 source 设为 local");oe(a),s.zipBase64=e?.zipBase64!==void 0?String(e.zipBase64??"").trim():await Se(a)}const l=await Ke(s);return P(`已覆盖项目 zip。
项目：${l.project.title||l.project.zipName}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}`),{targetProjectId:l.targetProjectId,project:l.project,imported:c}}async function Jt(e){const t=e?.zipArrayBuffer instanceof ArrayBuffer||e?.zipArrayBuffer instanceof Uint8Array,o=String(e?.importZipBase64??"").trim().length>0;return t||o?await qt({...e,zipBase64:void 0}):await Ke(e)}function le(e){return e.source==="embedded"?{...e,source:"embedded",zipBase64:String(e.zipBase64??"")}:e.source==="url"?{...e,source:"url",zipUrl:String(e.zipUrl??"")}:{...e,source:"local"}}function Yt(e={}){const{card:t}=D(),o=t.projects.map(le),r=!!e?.includeAll,a=String(e?.targetProjectId??"").trim(),n=String(e?.targetZipSha256??"").trim();if(r||!a&&!n)return{projects:o};const i=pe(t.projects,a,n);return{projects:o,project:le(t.projects[i])}}async function Xt(e){const t=B(),{active:o,card:r}=D(),a=pe(r.projects,e?.targetProjectId,e?.targetZipSha256),n=r.projects[a],i=r.projects.filter((c,u)=>u!==a);return await k(o.chid,{projects:i}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),I(),H(),P(`已删除项目：${n.title||n.zipName}`),{deletedProjectId:n.id,deletedProject:le(n),remainingCount:i.length}}async function Kt(e){const t=B(),{active:o,card:r}=D(),a=L(),n=e?.zipArrayBuffer instanceof ArrayBuffer||e?.zipArrayBuffer instanceof Uint8Array,i=String(e?.importZipBase64??"").trim().length>0,c=n||i,u=c?"local":String(e?.zipUrl??"").trim()?"url":String(e?.zipBase64??"").trim()?"embedded":"local",d=String(e?.source??u).trim(),s=d==="embedded"||d==="url"||d==="local"?d:"";if(!s)throw new Error(`非法 source：${d}`);const h=ne(e?.placeholder??"")||a.placeholder,f=ae(r.projects,h);let p=re();for(;r.projects.some(T=>T.id===p);)p=re();const m=String(e?.title??"").trim()||void 0,w=typeof e?.showTitleInChat=="boolean"?!!e.showTitleInChat:!1,g=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!a.defaultFixRootRelativeUrls,y=String(e?.zipUrl??"").trim();let j=String(e?.zipName??"").trim(),S=String(e?.homePage??"").trim(),b=String(e?.zipSha256??"").trim(),_=String(e?.zipBase64??"").trim(),v;if(c){const T=await Qe(e),R=String(e?.preferredHomePage??e?.homePage??"").trim()||void 0;P("正在导入新 zip 并创建项目...");const N=await Z(U,T,{fixRootRelativeUrls:g,preferredHomePage:R});if(A.add(N.projectId),await M(),v={projectId:N.projectId,homePage:N.homePage,fileCount:N.fileCount,cacheName:N.cacheName},b=N.projectId,S=N.homePage,s==="embedded"){if(!(e?.persistEmbeddedToCard!==!1))throw new Error("source=embedded 时必须写入 zipBase64；若不希望写入角色卡，请将 source 设为 local");oe(T),_||(_=await Se(T))}}if(s==="url"&&!y)throw new Error("source=url 时 zipUrl 不能为空");j||(s==="url"?j=y?Me(y):"webzip.zip":j="webzip.zip"),S||(S="index.html");let C;if(s==="embedded"){if(!_)throw new Error("source=embedded 时 zipBase64 不能为空（可改传 zipArrayBuffer/importZipBase64 自动导入）");if(!b)throw new Error("source=embedded 时 zipSha256 不能为空（可改传 zipArrayBuffer/importZipBase64 自动生成）");if(!c){const T=await V(_);oe(T)}C={source:"embedded",id:p,title:m,placeholder:f,homePage:S,showTitleInChat:w,fixRootRelativeUrls:g,zipName:j,zipSha256:b,zipBase64:_}}else if(s==="url")C={source:"url",id:p,title:m,placeholder:f,homePage:S,showTitleInChat:w,fixRootRelativeUrls:g,zipName:j,zipSha256:b||"",zipUrl:y};else{if(!b)throw new Error("source=local 时 zipSha256 不能为空（可改传 zipArrayBuffer/importZipBase64 自动导入）");C={source:"local",id:p,title:m,placeholder:f,homePage:S,showTitleInChat:w,fixRootRelativeUrls:g,zipName:j,zipSha256:b}}const z=[...r.projects,C];return await k(o.chid,{projects:z}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),I(),H(),P(`已创建项目：${C.title||C.zipName}
项目ID：${C.id}
占位符：${C.placeholder}`),{project:le(C),imported:v}}async function Qt({allow:e=!0,reloadChat:t=!0}={}){const o=B(),r=x();if(!r)throw new Error("当前不在单角色聊天/未选中角色");const a=E(r.character),n=a.projects.filter(d=>d.source==="embedded");if(n.length===0)throw new Error("当前角色卡没有可导入的嵌入项目");const i=F(r.character);e&&i&&O(i);const c=[...a.projects];let u=!1;for(const d of n){if(d.zipSha256&&A.has(d.zipSha256))continue;P(`正在从角色卡导入：${d.title||d.zipName} ...`);const s=await V(d.zipBase64),l=await Z(U,s,{fixRootRelativeUrls:d.fixRootRelativeUrls,preferredHomePage:d.homePage});if(A.add(l.projectId),await M(),l.projectId!==d.zipSha256){console.warn("[Higanbana] zipSha256 mismatch",{embedded:d.zipSha256,computed:l.projectId});const h=c.findIndex(f=>f.id===d.id);if(h>=0){const f=c[h];f&&f.source==="embedded"&&(c[h]={...f,zipSha256:l.projectId,homePage:l.homePage},u=!0)}}}u&&await k(r.chid,{projects:c}),P(`已导入到缓存。
已导入项目数：${n.length}`),t&&o?.reloadCurrentChat&&await o.reloadCurrentChat()}function D(){const e=x();if(!e)throw new Error("当前不在单角色聊天/未选中角色");const t=E(e.character);return{active:e,card:t}}function ie(e,t){const o=String(t??"").trim();if(!o)throw new Error("项目 id 为空");const r=e.projects.find(a=>a.id===o);if(!r)throw new Error("找不到项目（可能已被删除）");return r}function er(e){const{card:t}=D(),o=ie(t,e);if(!o.zipSha256)throw new Error("尚未下载/导入到本地缓存");if(!A.has(o.zipSha256))throw new Error("尚未导入到本地缓存");const r=de(U,o.zipSha256,o.homePage);window.open(r,"_blank","noopener,noreferrer")}async function tr(e){const{card:t}=D(),o=ie(t,e);if(o.source!=="embedded")throw new Error("当前项目不是嵌入模式，无法导出 zip");const r=await V(o.zipBase64),a=new Blob([r],{type:"application/zip"});We(a,o.zipName||"webzip.zip")}async function rr(e){const{active:t,card:o}=D(),r=ie(o,e);if(r.source!=="embedded")throw new Error("当前项目不是嵌入模式");if(!ue(r))return{importedCount:0,cancelled:!1};const a=F(t.character);a&&O(a);const n=await Ce(t.chid,[r]);return n.cancelled||(await B()?.reloadCurrentChat?.(),I()),n}async function or(e){const{active:t,card:o}=D(),r=ie(o,e);if(r.source!=="url")throw new Error("当前项目不是 URL 模式");const a=F(t.character);a&&O(a);const n=await Wt(r);if(!n)return!1;const c={projects:E(t.character).projects.map(u=>u.id===r.id?{...u,zipSha256:n.projectId,homePage:n.homePage}:u)};return await k(t.chid,c),await B()?.reloadCurrentChat?.(),I(),!0}async function nr(e){const t=B(),{active:o,card:r}=D(),a=ie(r,e),n=r.projects.filter(i=>i.id!==a.id);await k(o.chid,n.length?{projects:n}:null),await t?.reloadCurrentChat?.(),I()}async function ar(){const{active:e}=D();await k(e.chid,null),I()}async function ir(e){const t=x();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const o=$t(e);if(!o)throw new Error("请输入合法的 http/https zip URL");const r=F(t.character);r&&O(r);const a=!!$("#hb_fix_root_relative").prop("checked"),n=String($("#hb_homepage").val()??"").trim()||"index.html",i=Me(o),c=E(t.character),u=ne($("#hb_placeholder").val()),d=ae(c.projects,u),s=String($("#hb_new_title").val()??"").trim(),l=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,h={source:"url",id:re(),title:s||void 0,placeholder:d,homePage:n,showTitleInChat:l,fixRootRelativeUrls:a,zipName:i,zipSha256:"",zipUrl:o},f={projects:[...c.projects,h]};return await k(t.chid,f),{zipUrl:o,placeholder:d,homePage:n}}function cr(e){try{if(!e||typeof e!="object")return"";for(const t of Object.keys(e))if(String(t).toLowerCase()==="x-csrf-token"){const o=e[t];return typeof o=="string"?o:String(o||"")}}catch{}return""}function sr(e){return Number.isFinite(e)?Math.max(80,Math.min(e,1e4)):0}function lr(e,t){const o=String(e||"").trim();if(!o)return;const r=sr(Number(t));if(!r)return;const a=document.querySelectorAll("iframe");for(const n of a){const i=n;i?.name===o&&(i.style.height=`${r}px`)}}function Re(e){const t=String(e??"").trim();if(!t)return"";try{const r=new URL(t,window.location.origin).pathname.match(/\/vfs\/([^/]+)\//);return r?.[1]?decodeURIComponent(r[1]):""}catch{return""}}function ge(e){if(!e)return{projectId:"",zipSha256:""};try{const t=document.querySelectorAll("iframe.hb-iframe");for(const o of t){const r=o;if(r.contentWindow!==e)continue;const a=r.closest(".hb-embed"),n=String(a?.dataset?.hbProjectId??"").trim(),i=String(r?.dataset?.hbVfsHomeUrl??r.src??"").trim(),c=Re(i);return{projectId:n,zipSha256:c}}}catch{}try{const t=String(e?.location?.href??"");return{projectId:"",zipSha256:Re(t)}}catch{return{projectId:"",zipSha256:""}}}async function dr(e,t){const o=String(e?.id||""),r={__hb:"higanbana",v:1,kind:"res",id:o,ok:!1};if(!o)return{...r,error:"Missing id"};if(e.op==="getCsrfToken")try{const n=B()?.getRequestHeaders?.(),i=cr(n);if(i)return{...r,ok:!0,data:i};const u=await(await fetch("/csrf-token",{method:"GET",credentials:"include"})).json().catch(()=>null),d=u&&typeof u=="object"?String(u.token||""):"";return{...r,ok:!0,data:d}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="getProject")try{const a=e?.payload&&typeof e.payload=="object"?e.payload:{},n=ge(t),i=!!a.includeAll,c=String(a.targetProjectId??"").trim(),u=String(a.targetZipSha256??"").trim(),d=Yt({...a,includeAll:i,targetProjectId:i?c||void 0:c||n.projectId||void 0,targetZipSha256:i?u||void 0:u||n.zipSha256||void 0});return{...r,ok:!0,data:d}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="createProject")try{const a=e?.payload&&typeof e.payload=="object"?e.payload:{},n=await Kt(a);return{...r,ok:!0,data:n}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="deleteProject")try{const a=e?.payload&&typeof e.payload=="object"?e.payload:{},n=ge(t),i=String(a.targetProjectId??"").trim(),c=String(a.targetZipSha256??"").trim(),u=await Xt({...a,targetProjectId:i||n.projectId||void 0,targetZipSha256:c||n.zipSha256||void 0});return{...r,ok:!0,data:u}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="updateProject")try{const a=e?.payload&&typeof e.payload=="object"?e.payload:{},n=ge(t),i=String(a.targetProjectId??"").trim(),c=String(a.targetZipSha256??"").trim(),u=await Jt({...a,targetProjectId:i||n.projectId||void 0,targetZipSha256:c||n.zipSha256||void 0});return{...r,ok:!0,data:u}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="callSTAPI"){const a=String(e?.payload?.endpoint||""),n=e?.payload?.params??{};if(!a||!a.includes("."))return{...r,error:"Invalid endpoint"};const i=globalThis.ST_API;if(!i)return{...r,error:"ST_API not available"};const c=a.split(".");if(c.length!==2)return{...r,error:"Invalid endpoint format"};const[u,d]=c,s=i?.[u]?.[d];if(typeof s!="function")return{...r,error:`ST_API.${u}.${d} is not available`};try{const l=await s(n);return{...r,ok:!0,data:l}}catch(l){return{...r,error:l?.message?String(l.message):String(l)}}}return{...r,error:`Unsupported op: ${String(e?.op||"")}`}}function ur(){const e=globalThis;if(e.__HB_HTML_BRIDGE_SERVER__)return;e.__HB_HTML_BRIDGE_SERVER__={v:1};const t=new Map,o=300*1e3;let r=null;try{r=new BroadcastChannel(tt)}catch{r=null}const a=i=>{try{r?.postMessage(i)}catch{}},n=async(i,c,u)=>{if(!i||typeof i!="object")return;if(i.type==="HB_IFRAME_HEIGHT"){lr(String(i.iframeName||""),Number(i.height));return}if(i.__hb!=="higanbana"||i.v!==1||i.kind!=="req")return;const d=i,s=String(d.id||"");if((d.op==="updateProject"||d.op==="deleteProject")&&!c){const f=d?.payload&&typeof d.payload=="object"?d.payload:{},p=String(f.targetProjectId??"").trim(),m=String(f.targetZipSha256??"").trim(),w=!!f.__hbAllowBroadcastZipTarget;if(!p&&!(w&&m))return}if(!s)return;const l=Date.now();for(const[f,p]of t)l-p>o&&t.delete(f);if(t.has(s))return;t.set(s,l);const h=await dr(d,c??null);if(a(h),c&&typeof c.postMessage=="function")try{const f=u&&u!=="null"?u:"*";c.postMessage(h,f)}catch{}};try{r&&(r.onmessage=i=>void n(i.data))}catch{}try{window.addEventListener("message",i=>void n(i.data,i.source,i.origin))}catch{}}function pr(e,t=15e3){return new Promise((o,r)=>{let a=!1;const n=f=>{a||(a=!0,u(),f?r(f):o())},i=setTimeout(()=>{n(new Error("Service Worker 激活超时（可能是非安全上下文或被浏览器策略禁止）"))},t),c=[],u=()=>{clearTimeout(i);for(const f of c)try{f()}catch{}},d=()=>{try{e.waiting?.postMessage?.({type:"HB_SKIP_WAITING"})}catch{}},s=()=>{try{e.active?.state==="activated"&&n()}catch{}},l=f=>{if(!f)return;if(f.state==="activated"){n();return}const p=()=>{d(),f.state==="activated"&&n()};f.addEventListener("statechange",p),c.push(()=>f.removeEventListener("statechange",p))},h=()=>{d(),l(e.installing),s()};e.addEventListener("updatefound",h),c.push(()=>e.removeEventListener("updatefound",h)),d(),l(e.installing||e.waiting||e.active),s()})}async function hr(){if(!("serviceWorker"in navigator))return console.warn("[Higanbana] Service Worker not supported"),null;try{const e=await navigator.serviceWorker.register(ot,{scope:U,type:"module"});return e.update().catch(()=>{}),await pr(e),e}catch(e){return console.warn("[Higanbana] sw register failed",e),null}}function fr(){Fe();const e=B();$("#hb_pick_zip_btn").on("click",()=>{document.getElementById("hb_bind_zip")?.click()}),$("#hb_bind_zip").on("change",()=>{const n=document.getElementById("hb_bind_zip")?.files?.[0];$("#hb_bind_zip_name").text(n?n.name:"（未选择文件）")}),$("#hb_fix_root_relative").on("change",()=>{const n=L();n.defaultFixRootRelativeUrls=!!$("#hb_fix_root_relative").prop("checked"),G()}),$("#hb_render_html_blocks").on("change",()=>{const n=L();n.renderHtmlCodeBlocks=!!$("#hb_render_html_blocks").prop("checked"),G(),H()}),$("#hb_render_html_blocks_blob").on("change",()=>{const n=L();n.renderHtmlCodeBlocksUseBlobUrl=!!$("#hb_render_html_blocks_blob").prop("checked"),G(),H()}),$("#hb_render_html_blocks_titlebar").on("change",()=>{const n=L();n.renderHtmlCodeBlocksShowTitleBar=!!$("#hb_render_html_blocks_titlebar").prop("checked"),G(),H()}),$("#hb_placeholder").on("input",()=>{const n=L();n.placeholder=String($("#hb_placeholder").val()??"").trim()||q.placeholder,G()}),$("#hb_copy_placeholder").on("click",async()=>{const n=String($("#hb_placeholder").val()??"").trim();if(!n){toastr.error("占位符为空");return}try{await navigator.clipboard.writeText(n),toastr.success("已复制占位符")}catch(i){console.warn("[Higanbana] copy failed",i),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_insert_placeholder").on("click",()=>{const n=String($("#hb_placeholder").val()??"").trim();if(!n){toastr.error("占位符为空");return}const i=$("#send_textarea");if(i.length===0){toastr.error("找不到输入框");return}const c=String(i.val()??"");i.val(c?`${c}
${n}`:n),i.trigger("input"),toastr.success("已插入占位符")});const t=new Map,o=new Set,r=(n,i=400)=>{const c=t.get(n);c&&clearTimeout(c);const u=window.setTimeout(()=>{t.delete(n),a(n).catch(d=>console.warn("[Higanbana] project auto save failed",d))},Math.max(0,i));t.set(n,u)},a=async n=>{if(!o.has(n)){o.add(n);try{const i=x();if(!i)return;const c=E(i.character),u=c.projects.findIndex(W=>W.id===n);if(u<0)return;const d=document.getElementById("hb_projects_list");if(!d)return;const s=String(n).replace(/\\/g,"\\\\").replace(/"/g,'\\"'),l=d.querySelector(`.hb-proj-title[data-project-id="${s}"]`),h=d.querySelector(`.hb-proj-placeholder[data-project-id="${s}"]`),f=d.querySelector(`.hb-proj-home[data-project-id="${s}"]`),p=d.querySelector(`.hb-proj-zip-url[data-project-id="${s}"]`),m=d.querySelector(`.hb-proj-fix[data-project-id="${s}"]`),w=d.querySelector(`.hb-proj-show-title[data-project-id="${s}"]`),g=c.projects[u],y=String(l?.value??"").trim(),j=y||void 0,S=String(h?.value??"").trim(),b=String(f?.value??"").trim(),_=!!m?.checked,v=w?!!w.checked:!!g.showTitleInChat,C=String(p?.value??"").trim();if(!S||!b||g.source==="url"&&!C)return;if(c.projects.some(W=>W.id!==n&&W.placeholder===S)){toastr.error("占位符重复，请为每个项目设置不同的占位符"),h&&(h.value=g.placeholder);return}if(!(g.title!==j||g.placeholder!==S||g.homePage!==b||g.fixRootRelativeUrls!==_||g.showTitleInChat!==v||g.source==="url"&&g.zipUrl!==C))return;const R=c.projects.map(W=>W.id!==n?W:W.source==="url"?{...W,title:j,placeholder:S,homePage:b,fixRootRelativeUrls:_,showTitleInChat:v,zipUrl:C}:{...W,title:j,placeholder:S,homePage:b,fixRootRelativeUrls:_,showTitleInChat:v});await k(i.chid,{projects:R}),g.showTitleInChat!==v&&kt(n,v);const N=d.querySelector(`.hb-project[data-project-id="${s}"] .hb-subpanel-title`);N&&(N.textContent=`${j||g.zipName}  ${S}`),P(`已保存项目设置：${j||g.zipName}`),H()}finally{o.delete(n)}}};$("#hb_projects_list").on("input",".hb-proj-title, .hb-proj-placeholder, .hb-proj-home, .hb-proj-zip-url",n=>{const i=String(n.target?.getAttribute?.("data-project-id")??"").trim();i&&r(i,500)}),$("#hb_projects_list").on("change",".hb-proj-fix, .hb-proj-show-title",n=>{const i=String(n.target?.getAttribute?.("data-project-id")??"").trim();i&&r(i,0)}),$("#hb_projects_list").on("click",'[data-hb-action="copy_placeholder"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=E(c.character).projects.find(s=>s.id===i);if(d)try{await navigator.clipboard.writeText(d.placeholder),toastr.success("已复制占位符")}catch(s){console.warn("[Higanbana] copy placeholder failed",s),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="copy_project_id"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{await navigator.clipboard.writeText(i),toastr.success("已复制项目 ID")}catch(c){console.warn("[Higanbana] copy project id failed",c);try{window.prompt("复制失败，请手动复制项目 ID：",i)}catch{}toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="insert_placeholder"]',n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=E(c.character).projects.find(h=>h.id===i);if(!d)return;const s=$("#send_textarea");if(s.length===0){toastr.error("找不到输入框");return}const l=String(s.val()??"");s.val(l?`${l}
${d.placeholder}`:d.placeholder),s.trigger("input"),toastr.success("已插入占位符")}),$("#hb_projects_list").on("click",'[data-hb-action="open_home"]',n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{er(i)}catch(c){toastr.error(c?.message??c)}}),$("#hb_projects_list").on("click",'[data-hb-action="export_zip"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{await tr(i)}catch(c){console.error("[Higanbana] export zip failed",c),toastr.error(`导出失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="import_cache"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{const c=await rr(i);if(c.cancelled){toastr.info("已取消导入");return}c.importedCount>0?toastr.success("已导入到本地缓存"):toastr.info("该项目已在本地缓存"),H()}catch(c){console.error("[Higanbana] import cache failed",c),toastr.error(`导入失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="download_apply"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{if(!await or(i))return;H(),toastr.success("已下载并应用")}catch(c){console.error("[Higanbana] download apply failed",c),toastr.error(`操作失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="delete_project"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=E(c.character).projects.find(h=>h.id===i);if(!d)return;const s=d.title||d.zipName;let l=!1;try{e?.Popup?.show?.confirm?l=await e.Popup.show.confirm("彼岸花",`确定删除项目：${s}？`):l=window.confirm(`确定删除项目：${s}？`)}catch{l=window.confirm(`确定删除项目：${s}？`)}if(l)try{await nr(i),H(),toastr.success("已删除项目")}catch(h){console.error("[Higanbana] delete project failed",h),toastr.error(`删除失败：${h?.message??h}`)}}),$("#hb_import_from_card").on("click",async()=>{try{toastr.info("开始导入，请稍候..."),await Qt({allow:!0,reloadChat:!0}),toastr.success("已导入并启用（可在消息中渲染占位符）"),I()}catch(n){console.error("[Higanbana] import from card failed",n),toastr.error(`导入失败：${n?.message??n}`)}}),$("#hb_migrate_embedded_to_local").on("click",async()=>{const n=x();if(!n)return;const c=E(n.character).projects.filter(s=>s.source==="embedded").length;if(c===0){toastr.info("当前角色卡没有可迁移的嵌入项目");return}const u=`确定将当前角色卡中的 ${c} 个“嵌入项目”迁移为“本地缓存模式”吗？

迁移后：
1) 角色卡将不再保存 zipBase64（体积会明显下降）
2) 若当前浏览器缓存被清理，需要在本机重新导入 zip
3) 迁移前会先尝试把未缓存项目导入到本地缓存
`;let d=!1;try{e?.Popup?.show?.confirm?d=await e.Popup.show.confirm("彼岸花",u):d=window.confirm(u)}catch{d=window.confirm(u)}if(d)try{const s=await Gt({allow:!0,ensureCached:!0,reloadChat:!0});if(s.cancelled){toastr.info("已取消迁移（未修改角色卡）");return}toastr.success(`迁移完成：${s.migrated}/${s.totalEmbedded}，预导入缓存：${s.importedCount}`)}catch(s){console.error("[Higanbana] migrate embedded->local failed",s),toastr.error(`迁移失败：${s?.message??s}`)}}),$("#hb_open_home").on("click",()=>{const n=x();if(!n)return;const c=E(n.character).projects[0];if(!c){toastr.error("当前角色卡未绑定任何 WebZip 项目");return}if(!c.zipSha256){toastr.error("尚未下载/导入 WebZip 到本地缓存");return}const u=de(U,c.zipSha256,c.homePage);window.open(u,"_blank","noopener,noreferrer")}),$("#hb_export_zip").on("click",async()=>{const n=x();if(!n)return;const c=E(n.character).projects.find(u=>u.source==="embedded");if(!c){toastr.error("当前角色卡没有可导出的嵌入项目");return}try{const u=await V(c.zipBase64),d=new Blob([u],{type:"application/zip"});We(d,c.zipName||"webzip.zip")}catch(u){console.error("[Higanbana] export zip failed",u),toastr.error(`导出失败：${u?.message??u}`)}}),$("#hb_unbind").on("click",async()=>{const n=B(),i=x();if(!i)return;const c=E(i.character);if(c.projects.length===0)return;const u=`确定解绑当前角色的所有 WebZip 项目？

${xt(c)}`;let d=!1;try{n?.Popup?.show?.confirm?d=await n.Popup.show.confirm("彼岸花",u):d=window.confirm(u)}catch{d=window.confirm(u)}if(d)try{await ar(),toastr.success("已解绑"),I()}catch(s){console.error("[Higanbana] unbind failed",s),toastr.error(`解绑失败：${s?.message??s}`)}}),$("#hb_bind_zip_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=$("#hb_bind_zip").get(0)?.files?.[0];if(!i){toastr.error("请先选择 zip 文件");return}try{await Zt(i.name,await i.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(c){console.error("[Higanbana] bind zip failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_bind_zip_local_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=$("#hb_bind_zip").get(0)?.files?.[0];if(!i){toastr.error("请先选择 zip 文件");return}try{await Ot(i.name,await i.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(c){console.error("[Higanbana] bind local zip failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_bind_url_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=String($("#hb_bind_url").val()??"").trim();try{const{zipUrl:c,placeholder:u,homePage:d}=await ir(i),s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&s.val(""),I(),$("#hb_new_title").val(""),P(`已添加项目（URL 模式）。
占位符：${u}
URL：${c}
入口：${d}
提示：进入聊天时会提示下载并导入缓存`),toastr.success("已添加 URL 项目")}catch(c){console.error("[Higanbana] bind url failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_download_url_btn").on("click",async()=>{try{await Dt()}catch(n){console.error("[Higanbana] download url apply failed",n),toastr.error(`操作失败：${n?.message??n}`)}}),$("#hb_cancel_url_download_btn").on("click",()=>{try{Ft()}catch{}})}let we=!1;async function mr(e,t){const o=t.map(r=>{const a=r.source==="url"?r.zipSha256||r.zipUrl:r.zipSha256;return`${r.id}:${r.source}:${a}`}).join("|");try{const r=await Ne(new TextEncoder().encode(o).buffer);return`AlertHiganbana_${e}_projects_${r}`}catch{return`AlertHiganbana_${e}_projects_${o.slice(0,80)}`}}function br(e){const o=(String(e??"").trim()||"x").replace(/[^a-zA-Z0-9_-]/g,"_");return o.startsWith("hb_")?o:`hb_${o}`}async function et(){const e=B(),t=x();if(!e||!t)return;const o=E(t.character);if(o.projects.length===0)return;const r=F(t.character);if(r&&!we){we=!0;try{const a=De(r),n=o.projects.filter(h=>ue(h)),i=n.filter(h=>h.source!=="local"),c=n.filter(h=>h.source==="local");if(!(!a||n.length>0))return;const d=await mr(r,o.projects);try{if(e.accountStorage?.getItem?.(d))return;e.accountStorage?.setItem?.(d,"true")}catch{}let s=0,l=[];if(e.callGenericPopup&&e.POPUP_TYPE?.CONFIRM){const h=document.createElement("div"),f=document.createElement("h3");f.textContent="此角色卡包含 WebZip 前端项目。",h.appendChild(f);const p=document.createElement("h3");i.length>0?p.textContent=`发现 ${i.length} 个未缓存项目，是否下载并启用？`:c.length>0?p.textContent=`发现 ${c.length} 个“本地缓存模式”项目未命中缓存。`:p.textContent="是否启用它们？",h.appendChild(p);const m=document.createElement("div");if(m.className="m-b-1",m.style.opacity="0.85",m.textContent="你可以稍后在扩展栏的“彼岸花”面板里管理这些项目。",h.appendChild(m),c.length>0){const b=document.createElement("div");b.className="m-b-1",b.style.opacity="0.85",b.textContent="本地缓存模式不会把 zip 写入角色卡，因此无法自动下载恢复。请在本机重新导入本地 zip（可用“添加本地缓存项目（不嵌入）”）。",h.appendChild(b)}const w=new Map,g=i.length>0?i.map(b=>{const _=br(`miss_${b.id}`);w.set(_,b.id);const v=b.title||b.zipName,C=b.source==="embedded"?"嵌入":b.source==="url"?"URL":"本地缓存",z=`${v}  |  ${C}  |  ${b.placeholder}`,T=b.source==="url"?b.zipUrl:b.source==="embedded"?"嵌入于角色卡":"仅本地缓存（不嵌入角色卡）";return{id:_,label:z,type:"checkbox",defaultState:!0,tooltip:T}}):null,y=i.length>0?"下载选中并启用":"启用",j=a?"取消":"否",S=i.length>0?["下载全部"]:null;if(s=await e.callGenericPopup(h,e.POPUP_TYPE.CONFIRM,"",{okButton:y,cancelButton:j,customButtons:S,customInputs:g,wide:!0}),!s)return;if(i.length>0)if(Number(s)>=2)l=[...i];else{const b=e.Popup?.util?.lastResult?.inputResults,_=new Set;for(const[v,C]of w)b?.get?.(v)&&_.add(C);l=i.filter(v=>_.has(v.id))}}else{if(!window.confirm(n.length>0?i.length>0?`此角色卡包含 WebZip 项目，且有 ${i.length} 个可自动下载的未缓存项目。是否启用并下载？`:"此角色卡包含本地缓存模式项目，但当前浏览器未命中缓存。是否先启用（稍后可在面板重新导入本地 zip）？":"此角色卡包含 WebZip 项目，是否启用？"))return;l=[...i]}O(r);try{if(l.length>0){toastr.info("开始下载/导入项目，请稍候...");const h=await Ce(t.chid,l);if(h.cancelled){toastr.info("已取消导入");return}h.importedCount>0&&toastr.success(`已导入 ${h.importedCount} 个项目`)}c.length>0&&toastr.info(`检测到 ${c.length} 个本地缓存模式项目未命中缓存，请在“彼岸花”面板重新导入本地 zip。`),await e.reloadCurrentChat?.(),I(),H()}catch(h){console.error("[Higanbana] import queue failed",h),toastr.error(`导入失败：${h?.message??h}`)}}finally{we=!1}}}let Ae=!1;function gr(){if(Ae)return;const e=B();if(!e?.eventSource||!e?.event_types)return;Ae=!0;const t=()=>setTimeout(()=>{I(),H(),et().catch(o=>console.warn("[Higanbana] webzip check failed",o))},0);e.event_types.CHAT_CHANGED&&e.eventSource.on(e.event_types.CHAT_CHANGED,t),e.event_types.CHARACTER_DELETED&&e.eventSource.on(e.event_types.CHARACTER_DELETED,t)}async function wr(){ur();const e=await hr();await M(),await Pt(),zt(),fr(),Lt(),gr(),I(),Ye(),et().catch(t=>console.warn("[Higanbana] webzip check failed",t)),P(`彼岸花：已加载。
Service Worker：${e?"已注册":"不可用（将无法渲染 WebZip）"}
提示：在本面板可把 zip 绑定到当前角色卡，导出角色卡时会一并导出。`)}function ke(){const e=B();return e?.eventSource&&e?.event_types?.APP_READY?(e.eventSource.on(e.event_types.APP_READY,()=>{wr().catch(t=>{console.error("[Higanbana] init failed",t),toastr.error(`彼岸花初始化失败：${t?.message??t}`)})}),!0):!1}function yr(){jQuery(()=>{if(ke())return;const e=setInterval(()=>{ke()&&clearInterval(e)},250)})}yr();
