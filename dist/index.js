import{H as Ge,i as he}from"./hbHtmlRuntime.B7drXapj.chunk.js";const ye="st-higanbana-vfs-",z=new Set;async function L(){try{const e=await caches.keys();z.clear();for(const t of e)t.startsWith(ye)&&z.add(t.slice(ye.length))}catch(e){console.warn("[Higanbana] caches.keys failed",e)}}function pe(e){return!!e&&z.has(e)}function B(){const e=globalThis.SillyTavern;return e?.getContext?e.getContext():null}function x(){const e=B();if(!e)return null;const t=Number(e.characterId);if(!Number.isFinite(t)||t<0)return null;const r=e.characters?.[t];return r?{chid:t,character:r}:null}function Ze(e){return String(e?.name??e?.data?.name??"").trim()||"(未命名角色)"}function N(e){return String(e?.avatar??"").trim()}function qe(e){try{if(!e||typeof e!="object")return"";for(const t of Object.keys(e))if(String(t).toLowerCase()==="x-csrf-token"){const r=e[t];return typeof r=="string"?r:String(r||"")}}catch{}return""}function Ve(e){return Number.isFinite(e)?Math.max(80,Math.min(e,1e4)):0}function Je(e,t){const r=String(e||"").trim();if(!r)return;const n=Ve(Number(t));if(!n)return;const a=document.querySelectorAll("iframe");for(const o of a){const c=o;c?.name===r&&(c.style.height=`${n}px`)}}async function Ye(e){const t=String(e?.id||""),r={__hb:"higanbana",v:1,kind:"res",id:t,ok:!1};if(!t)return{...r,error:"Missing id"};if(e.op==="getCsrfToken")try{const a=B()?.getRequestHeaders?.(),o=qe(a);if(o)return{...r,ok:!0,data:o};const i=await(await fetch("/csrf-token",{method:"GET",credentials:"include"})).json().catch(()=>null),u=i&&typeof i=="object"?String(i.token||""):"";return{...r,ok:!0,data:u}}catch(n){return{...r,error:n?.message?String(n.message):String(n)}}if(e.op==="callSTAPI"){const n=String(e?.payload?.endpoint||""),a=e?.payload?.params??{};if(!n||!n.includes("."))return{...r,error:"Invalid endpoint"};const o=globalThis.ST_API;if(!o)return{...r,error:"ST_API not available"};const c=n.split(".");if(c.length!==2)return{...r,error:"Invalid endpoint format"};const[i,u]=c,d=o?.[i]?.[u];if(typeof d!="function")return{...r,error:`ST_API.${i}.${u} is not available`};try{const s=await d(a);return{...r,ok:!0,data:s}}catch(s){return{...r,error:s?.message?String(s.message):String(s)}}}return{...r,error:`Unsupported op: ${String(e?.op||"")}`}}function Xe(){const e=globalThis;if(e.__HB_HTML_BRIDGE_SERVER__)return;e.__HB_HTML_BRIDGE_SERVER__={v:1};let t=null;try{t=new BroadcastChannel(Ge)}catch{t=null}const r=a=>{try{t?.postMessage(a)}catch{}},n=async(a,o,c)=>{if(!a||typeof a!="object")return;if(a.type==="HB_IFRAME_HEIGHT"){Je(String(a.iframeName||""),Number(a.height));return}if(a.__hb!=="higanbana"||a.v!==1||a.kind!=="req")return;const u=await Ye(a);if(r(u),o&&typeof o.postMessage=="function")try{const d=c&&c!=="null"?c:"*";o.postMessage(u,d)}catch{}};try{t&&(t.onmessage=a=>void n(a.data))}catch{}try{window.addEventListener("message",a=>void n(a.data,a.source,a.origin))}catch{}}function j(e){const t={projects:[]},r=e?.data?.extensions?.higanbana;if(!r||typeof r!="object")return t;const n=r.projects;if(!Array.isArray(n))return t;const a=[];for(const o of n){if(!o||typeof o!="object")continue;const c=String(o.source??"").trim(),i=String(o.id??"").trim(),u=String(o.title??"").trim()||void 0,d=String(o.placeholder??"").trim(),s=String(o.homePage??"").trim(),l=typeof o.showTitleInChat=="boolean"?!!o.showTitleInChat:!1,p=!!o.fixRootRelativeUrls,b=String(o.zipName??"").trim(),h=String(o.zipSha256??"").trim();if(!(!i||!d||!s||!b)){if(c==="embedded"){const f=String(o.zipBase64??"").trim();if(!f||!h)continue;a.push({source:"embedded",id:i,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:b,zipSha256:h,zipBase64:f});continue}if(c==="local"){if(!h)continue;a.push({source:"local",id:i,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:b,zipSha256:h});continue}if(c==="url"){const f=String(o.zipUrl??"").trim();if(!f)continue;a.push({source:"url",id:i,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:p,zipName:b,zipSha256:h||"",zipUrl:f})}}}return{projects:a}}async function I(e,t){const r=B();if(!r?.writeExtensionField)throw new Error("writeExtensionField 不可用（酒馆版本过旧或上下文缺失）");await r.writeExtensionField(e,"higanbana",t)}const Ke="st-higanbana-vfs-";function Qe(e){return String(e).split("/").map(t=>encodeURIComponent(t)).join("/")}function ne(e,t,r){return`${e}vfs/${encodeURIComponent(t)}/${Qe(r)}`}function et(e,t){return`${new URL(e).pathname}vfs/${encodeURIComponent(t)}/`}function tt(e){return`${Ke}${e}`}function ke(e){const t=String(e).toLowerCase();return t.endsWith(".html")||t.endsWith(".htm")?"text/html; charset=utf-8":t.endsWith(".css")?"text/css; charset=utf-8":t.endsWith(".js")||t.endsWith(".mjs")||t.endsWith(".cjs")?"application/javascript; charset=utf-8":t.endsWith(".json")||t.endsWith(".map")?"application/json; charset=utf-8":t.endsWith(".txt")?"text/plain; charset=utf-8":t.endsWith(".svg")?"image/svg+xml":t.endsWith(".png")?"image/png":t.endsWith(".jpg")||t.endsWith(".jpeg")?"image/jpeg":t.endsWith(".gif")?"image/gif":t.endsWith(".webp")?"image/webp":t.endsWith(".avif")?"image/avif":t.endsWith(".ico")?"image/x-icon":t.endsWith(".woff2")?"font/woff2":t.endsWith(".woff")?"font/woff":t.endsWith(".ttf")?"font/ttf":t.endsWith(".otf")?"font/otf":t.endsWith(".eot")?"application/vnd.ms-fontobject":t.endsWith(".wasm")?"application/wasm":"application/octet-stream"}function rt(e){const t=ke(e);return t.startsWith("text/")||t.includes("javascript")||t.includes("json")||t.includes("svg+xml")}function nt(e){return new Promise((t,r)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onload=()=>t(),n.onerror=()=>r(new Error(`加载脚本失败: ${e}`)),document.head.appendChild(n)})}async function ot(){const e=globalThis;if(e.JSZip)return e.JSZip;if(await nt("/lib/jszip.min.js"),!e.JSZip)throw new Error("JSZip 未能加载（/lib/jszip.min.js）");return e.JSZip}function at(e){const t=e.filter(Boolean);if(t.length===0)return{prefix:"",stripped:[]};const r=new Set(t.map(c=>c.split("/")[0]).filter(Boolean));if(r.size!==1)return{prefix:"",stripped:t};const a=`${[...r][0]}/`;return t.some(c=>c.startsWith(a))?{prefix:a,stripped:t.map(c=>c.startsWith(a)?c.slice(a.length):c)}:{prefix:"",stripped:t}}function it(e){let t=String(e??"").replace(/\\/g,"/").replace(/^\.\//,"").replace(/^\/+/,"");const r=t.split("/").filter(Boolean);return r.some(n=>n==="..")?null:(t=r.join("/"),t||null)}function Pe(e){return String(e).split(/[?#]/,1)[0]}function ct(e){const t=new Set,r=new Set;for(const n of e){t.add(n);const a=n.split("/").filter(Boolean);for(let o=1;o<a.length;o++)r.add(a.slice(0,o).join("/")+"/")}return{fileSet:t,dirSet:r}}function Y(e,t){const r=Pe(e);return r?!!(t.fileSet.has(r)||t.dirSet.has(r.endsWith("/")?r:`${r}/`)):!1}function st(e,t,r,n){let a=e;return r&&(a=a.replace(/<base\b([^>]*?)\bhref\s*=\s*(["'])\/\2([^>]*?)>/gi,(o,c,i,u)=>`<base${c}href=${i}${t}${i}${u}>`),a=a.replace(/(<\s*(?:script|img|source|video|audio)\b[^>]*\bsrc\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(o,c,i,u)=>Y(u,n)?`${c}${t}${u}${i}`:o),a=a.replace(/(<\s*link\b[^>]*\bhref\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(o,c,i,u)=>Y(u,n)?`${c}${t}${u}${i}`:o)),a}function lt(e,t,r,n){if(!r)return e;let a=String(e);return a=a.replace(/url\(\s*(["'])?\/(?!\/)([^"')]+)\1\s*\)/gi,(o,c="",i)=>Y(i,n)?`url(${c}${t}${i}${c})`:o),a=a.replace(/@import\s+(?:url\(\s*)?(["'])?\/(?!\/)([^"')\s]+)\1\s*\)?/gi,(o,c="",i)=>Y(i,n)?o.toLowerCase().includes("url(")?`@import url(${c}${t}${i}${c})`:`@import ${c}${t}${i}${c}`:o),a}function dt(e){return!e||/\s/.test(e)?!1:e.endsWith("/")?!0:(e.split("/").filter(Boolean).pop()||"").includes(".")}function ut(e,t,r,n){if(!r)return e;let a=String(e);return a=a.replace(/(["'`])\/(?!\/)([^"'`]*?)\1/g,(o,c,i)=>{const u=Pe(i);return!dt(u)||!Y(i,n)?o:`${c}${t}${i}${c}`}),a=a.replace(/(__webpack_require__\.p\s*=\s*)(["'])\/\2/g,(o,c,i)=>`${c}${i}${t}${i}`),a=a.replace(/(__webpack_public_path__\s*=\s*)(["'])\/\2/g,(o,c,i)=>`${c}${i}${t}${i}`),a}async function Ue(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(r=>r.toString(16).padStart(2,"0")).join("")}let J=null,te=!1,ht=0;const X=new Map;function pt(e){const t=[...X.values()];X.clear();for(const r of t)r.reject(e)}function ft(){if(te)return null;if(J)return J;if(typeof Worker>"u")return te=!0,null;try{const e=new Worker(new URL("/assets/base64.worker-D8NWWtcD.js",import.meta.url),{type:"module"});e.onmessage=r=>{const n=r.data;if(!n||typeof n!="object")return;const a=Number(n.id);if(!Number.isFinite(a))return;const o=X.get(a);if(o){if(X.delete(a),n.ok){"base64"in n?o.resolve(n.base64):"arrayBuffer"in n?o.resolve(n.arrayBuffer):o.reject(new Error("Base64 worker 返回了无效结果"));return}o.reject(new Error(n.error||"Base64 worker 执行失败"))}};const t=r=>{console.warn("[Higanbana] Base64 Worker 不可用，回退到主线程编解码",r),te=!0;try{e.terminate()}catch{}J===e&&(J=null),pt(new Error("Base64 Worker 已失效"))};return e.onerror=t,e.onmessageerror=t,J=e,e}catch(e){return console.warn("[Higanbana] 创建 Base64 Worker 失败，回退到主线程编解码",e),te=!0,null}}function Ae(e){const t=ft();return t?new Promise((r,n)=>{const a=++ht;X.set(a,{resolve:r,reject:n}),t.postMessage({...e,id:a})}):Promise.reject(new Error("Base64 Worker 不可用"))}function mt(e){const t=new Uint8Array(e),r=32768,n=[];for(let a=0;a<t.length;a+=r){const o=t.subarray(a,a+r);n.push(String.fromCharCode(...o))}return btoa(n.join(""))}function bt(e){const t=atob(e),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r.buffer}async function gt(e){try{return await Ae({type:"arrayBufferToBase64",arrayBuffer:e})}catch{return mt(e)}}async function K(e){try{return await Ae({type:"base64ToArrayBuffer",base64:e})}catch{return bt(e)}}function q(e){const t=Number(e);if(!Number.isFinite(t)||t<0)return"0 B";const r=["B","KB","MB","GB","TB"];let n=t,a=0;for(;n>=1024&&a<r.length-1;)n/=1024,a++;const o=n>=100?0:n>=10?1:2;return`${n.toFixed(o)} ${r[a]}`}function wt(e){if(e===null)return"—";const t=Number(e);return!Number.isFinite(t)||t<=0?"—":`${q(t)}/s`}function yt(e){if(e===null)return"—";const t=Number(e);return Number.isFinite(t)?`${Math.max(0,Math.min(t,100)).toFixed(1)}%`:"—"}function ce(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}async function Q(e,t={}){const r=Math.max(30,Number(t.progressThrottleMs??120)),n=t.onProgress,a=ce(),o=await fetch(e,{method:"GET",signal:t.signal});if(!o.ok)throw new Error(`下载失败: ${o.status} ${o.statusText}`);const c=o.headers.get("content-type"),i=o.url||e,u=o.headers.get("content-length"),d=u?Number(u):NaN,s=Number.isFinite(d)&&d>0?d:null,p=o.body?.getReader?.();if(!p){const m=await o.arrayBuffer(),y=Math.max(0,ce()-a),v=m.byteLength,k=s??v,P=k?v/k*100:null,M=y>0?v/y*1e3:null;return n?.({loadedBytes:v,totalBytes:k,percent:P,speedBps:M,elapsedMs:y}),{arrayBuffer:m,totalBytes:k,contentType:c,finalUrl:i}}const b=[];let h=0,f=0,g=0,w=null;const _=(m=!1)=>{if(!n)return;const y=ce(),v=Math.max(0,y-a);if(!m&&f&&y-f<r)return;if(f){const P=y-f;P>0&&(w=(h-g)/P*1e3)}f=y,g=h;const k=s?h/s*100:null;n({loadedBytes:h,totalBytes:s,percent:k,speedBps:w,elapsedMs:v})};_(!0);try{for(;;){const{done:m,value:y}=await p.read();if(m)break;y&&(b.push(y),h+=y.byteLength,_(!1))}}finally{try{p.releaseLock()}catch{}}_(!0);const S=new Uint8Array(h);let C=0;for(const m of b)S.set(m,C),C+=m.byteLength;return{arrayBuffer:S.buffer,totalBytes:s??h,contentType:c,finalUrl:i}}async function D(e,t,r){const n=await ot(),a=await Ue(t),o=tt(a),c=await caches.open(o),i=et(e,a),u=await n.loadAsync(t),l=Object.values(u.files||{}).filter(m=>m&&!m.dir).map(m=>({entry:m,path:it(m.name)})).filter(m=>!!m.path);if(l.length===0)throw new Error("zip 内没有可导入的文件");const{stripped:p}=at(l.map(m=>m.path)),b=l.map((m,y)=>({entry:m.entry,path:p[y]})).filter(m=>!!m.path),h=b.map(m=>String(m.path)),f=ct(h),g=b.map(m=>m.path).filter(m=>/\.(html?|HTML?)$/i.test(m)).sort((m,y)=>m.localeCompare(y)),w=r.preferredHomePage?.trim(),_=w?g.includes(w):!1,S=g.some(m=>m.toLowerCase()==="index.html");let C=w&&_?w:"";C||(S?C=g.find(m=>m.toLowerCase()==="index.html"):g.length>0?C=g[0]:C="index.html");for(let m=0;m<b.length;m++){const{entry:y,path:v}=b[m],k=ke(v);let P;if(rt(v)){let E=await y.async("string");k.startsWith("text/html")?(E=st(E,i,r.fixRootRelativeUrls,f),P=E):k.startsWith("text/css")?P=lt(E,i,r.fixRootRelativeUrls,f):k.includes("javascript")?P=ut(E,i,r.fixRootRelativeUrls,f):P=E}else{const E=await y.async("uint8array"),we=new Uint8Array(E.byteLength);we.set(E),P=new Blob([we],{type:k})}const M=ne(e,a,v);await c.put(new Request(M,{method:"GET"}),new Response(P,{headers:{"Content-Type":k}})),m%75===0&&await new Promise(E=>setTimeout(E,0))}return{projectId:a,homePage:C,htmlFiles:g,fileCount:b.length,cacheName:o}}const R=String(import.meta.url).replace(/[^/]*$/,""),_t=`${R}sw.js`,se="higanbana",O=Object.freeze({placeholder:"{{WEB_HOME}}",defaultFixRootRelativeUrls:!0,renderHtmlCodeBlocks:!1,renderHtmlCodeBlocksUseBlobUrl:!1,renderHtmlCodeBlocksShowTitleBar:!1,allowedCharacterAvatars:[]});function T(){const e=B();if(!e)return structuredClone(O);e.extensionSettings[se]=e.extensionSettings[se]||{};const t=e.extensionSettings[se];return(typeof t.placeholder!="string"||!t.placeholder.trim())&&(t.placeholder=O.placeholder),typeof t.defaultFixRootRelativeUrls!="boolean"&&(t.defaultFixRootRelativeUrls=O.defaultFixRootRelativeUrls),typeof t.renderHtmlCodeBlocks!="boolean"&&(t.renderHtmlCodeBlocks=O.renderHtmlCodeBlocks),typeof t.renderHtmlCodeBlocksUseBlobUrl!="boolean"&&(t.renderHtmlCodeBlocksUseBlobUrl=O.renderHtmlCodeBlocksUseBlobUrl),typeof t.renderHtmlCodeBlocksShowTitleBar!="boolean"&&(t.renderHtmlCodeBlocksShowTitleBar=O.renderHtmlCodeBlocksShowTitleBar),Array.isArray(t.allowedCharacterAvatars)?t.allowedCharacterAvatars=t.allowedCharacterAvatars.map(r=>String(r).trim()).filter(r=>r.length>0):t.allowedCharacterAvatars=[],t}function F(){B()?.saveSettingsDebounced?.()}function Re(e){return T().allowedCharacterAvatars.includes(e)}function W(e){const t=T();t.allowedCharacterAvatars.includes(e)||(t.allowedCharacterAvatars.push(e),F())}const _e=new WeakMap;function vt(e){try{const t=e.contentDocument;if(!t)return null;const r=t.body,n=t.documentElement;if(!r||!n)return null;const a=r.scrollHeight||0,o=n.scrollHeight||0,c=r.offsetHeight||0,i=n.offsetHeight||0,u=Math.max(a,o,c,i);return!Number.isFinite(u)||u<=0?null:u}catch{return null}}function re(e){const t=vt(e);if(!t)return;const r=Math.max(80,Math.min(t,1e4));e.style.height=`${r}px`}function ze(e){_e.get(e)?.ro?.disconnect?.();const r={};_e.set(e,r);const n=()=>{re(e),setTimeout(()=>re(e),50),setTimeout(()=>re(e),250);try{const a=e.contentDocument;if(!a?.documentElement)return;const o=new ResizeObserver(()=>re(e));o.observe(a.documentElement),a.body&&o.observe(a.body),r.ro=o}catch{}};n(),e.addEventListener("load",n)}function $t(e){const t=x();if(!t)return{kind:"stub",title:"彼岸花：无法渲染",reason:"当前不在单角色聊天/未选中角色。"};const r=e.title||e.zipName,n=N(t.character);if(n&&!Re(n))return{kind:"stub",title:`彼岸花：未启用（${r}）`,reason:e.source==="url"?"该角色卡绑定了 WebZip URL，但尚未允许/下载。切换到该角色时会弹窗询问，或在面板/弹窗中下载并导入缓存。":e.source==="embedded"?"该角色卡包含嵌入 WebZip，但尚未允许/导入。切换到该角色时会弹窗询问，或在面板点“导入所有嵌入项目到本地缓存”。":"该角色卡绑定了本地缓存项目。请先允许该角色，并确保当前浏览器已导入对应 zip。"};const a=e.zipSha256;return a?pe(a)?{kind:"iframe",src:ne(R,a,e.homePage),title:`彼岸花：${r} · ${e.homePage}`}:{kind:"stub",title:`彼岸花：未导入缓存（${r}）`,reason:e.source==="url"?"请下载并导入缓存后即可渲染。":e.source==="embedded"?"请先导入到本地缓存（面板中可操作），再刷新聊天即可渲染。":"这是“本地缓存模式”项目，当前浏览器未找到缓存。请在扩展面板重新导入本地 zip 并绑定。"}:{kind:"stub",title:`彼岸花：未下载（${r}）`,reason:e.source==="url"?"请在面板/弹窗中下载并导入缓存后即可渲染。":"缺少 projectId，无法渲染。"}}function Te(e,t,r,n={}){const a=document.createElement("div");a.className="hb-embed",a.dataset.hbEmbed="1",a.classList.add(r.kind==="stub"?"hb-embed-stub":"hb-embed-iframe"),n.projectId&&(a.dataset.hbProjectId=n.projectId),n.showTitleInChat===!0||a.classList.add("hb-embed-no-title");const c=document.createElement("div");c.className="hb-embed-header";const i=document.createElement("div");i.className="hb-embed-title",i.textContent=r.title;const u=document.createElement("div");if(u.className="hb-embed-actions",r.kind==="iframe"){const p=document.createElement("a");p.href=n.openInNewTabUrl||r.src,p.target="_blank",p.rel="noopener noreferrer",p.textContent="新标签页打开",u.appendChild(p)}c.appendChild(i),c.appendChild(u),a.appendChild(c);const d=document.createElement("div");if(d.className="hb-embed-body",r.kind==="stub"){const p=document.createElement("div");return p.style.padding="10px",p.style.opacity="0.9",p.textContent=r.reason,d.appendChild(p),a.appendChild(d),a}const s=document.createElement("iframe");s.className="hb-iframe",s.loading="lazy",s.referrerPolicy="no-referrer",s.name=`hb-${e}-${t}`,s.setAttribute("sandbox","allow-scripts allow-same-origin");const l=!!n.projectId||n.useBlobUrlInChat===!0;try{s.dataset=s.dataset||{},s.dataset.hbVfsHomeUrl=r.src,s.dataset.hbUseBlobUrl=l?"1":"0"}catch{}return l?(s.removeAttribute("src"),s.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',Ie(s,r.src)):(s.removeAttribute("srcdoc"),s.src=r.src),ze(s),d.appendChild(s),a.appendChild(d),a}const ve=new Map;function Ct(e){const t=String(e??"").trim();return`<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      *{box-sizing:border-box}
      html,body{margin:0;padding:0;width:100%}
      #inner{display:block;width:100%;border:0;height:260px}
      .loading{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:12px;opacity:.85}
    </style>
  </head>
  <body>
    <div class="loading" id="loading">正在加载…</div>
    <iframe id="inner" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer"></iframe>
    <script>
      const VFS_URL = ${JSON.stringify(t)};
      const inner = document.getElementById('inner');
      const loading = document.getElementById('loading');
      const clamp = (h) => Math.max(80, Math.min(Number(h) || 0, 10000));
      const setHeight = (h) => {
        const px = clamp(h);
        if (!px) return;
        inner.style.height = px + 'px';
      };

      try { inner.name = String(window.name || ''); } catch {}
      try { inner.src = VFS_URL; } catch {}

      inner.addEventListener('load', () => {
        try { if (loading) loading.style.display = 'none'; } catch {}
      });

      window.addEventListener('message', (ev) => {
        const data = ev && ev.data;
        if (!data || typeof data !== 'object') return;

        // Height message from inner
        if (ev.source === inner.contentWindow && data.type === 'HB_IFRAME_HEIGHT') {
          setHeight(data.height);
          return;
        }

        // Bridge messages between inner <-> parent (for ST_API / CSRF proxy)
        if (data.__hb === 'higanbana' && data.v === 1) {
          try {
            if (ev.source === inner.contentWindow) {
              window.parent && window.parent.postMessage(data, '*');
              return;
            }
            if (ev.source === window.parent) {
              inner.contentWindow && inner.contentWindow.postMessage(data, '*');
            }
          } catch {
            // ignore
          }
        }
      });
    <\/script>
  </body>
</html>`}async function xt(e){const t=String(e??"").trim();if(!t)throw new Error("vfsHomeUrl is required");const r=ve.get(t);if(r)return await r.promise;const n={promise:(async()=>{const a=Ct(t),o=URL.createObjectURL(new Blob([a],{type:"text/html"}));return n.url=o,o})()};return ve.set(t,n),await n.promise}async function Ie(e,t){try{const r=String(t??"").trim();if(!r)return;e.dataset=e.dataset||{},e.dataset.hbVfsHomeUrl=r,e.dataset.hbUseBlobUrl="1";const n=await xt(r);if(!e.isConnected)return;const a=String(e.dataset?.hbVfsHomeUrl??"");if(!(String(e.dataset?.hbUseBlobUrl??"")==="1")||a!==r)return;e.removeAttribute("srcdoc"),e.src=n}catch(r){console.warn("[Higanbana] blob render failed, fallback to VFS",{vfsHomeUrl:t,err:r});try{if(!e.isConnected)return;e.removeAttribute("srcdoc"),e.src=String(t??"")}catch{}}}function St(e,t){if(!e)return;const r=document.querySelectorAll(".hb-embed[data-hb-project-id]");for(const n of r)String(n.dataset?.hbProjectId??"")===e&&(t?n.classList.remove("hb-embed-no-title"):n.classList.add("hb-embed-no-title"))}function He(){const e=document.querySelectorAll(".hb-embed.hb-embed-iframe[data-hb-project-id]");for(const t of e){const r=t.querySelector("iframe.hb-iframe");if(!r)continue;const n=String(r.src||"");if(n.startsWith("blob:"))continue;const a=t.querySelector(".hb-embed-actions a"),o=String(a?.href||r.dataset?.hbVfsHomeUrl||n||"").trim();o&&(r.removeAttribute("src"),r.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',Ie(r,o))}}function jt(e){const t=String(e??"").toLowerCase();return t.includes("<html")||t.includes("<head")||t.includes("<body")||t.includes("<!doctype html")}function fe(e){const r=String(e??"").trim(),n=r.toLowerCase();return r?n.includes("<!doctype")||n.includes("<html")?r:`<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><body>${r}</body>`:'<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'}function Et(e){let t=2166136261;for(let r=0;r<e.length;r++)t^=e.charCodeAt(r),t=Math.imul(t,16777619);return(t>>>0).toString(16)}function $e(e,t){const r=he(fe(t),{origin:window.location.origin,forceBaseHref:!0}),n=Et(r),a=String(e.dataset?.hbHtmlHash??""),o=String(e.dataset?.hbHtmlBlobUrl??"");if(o&&a===n)return o;if(o)try{URL.revokeObjectURL(o)}catch{}const c=URL.createObjectURL(new Blob([r],{type:"text/html"}));return e.dataset.hbHtmlHash=n,e.dataset.hbHtmlBlobUrl=c,c}function Ne(e,t){const r=T(),n=!!r.renderHtmlCodeBlocks,a=!!r.renderHtmlCodeBlocksUseBlobUrl,o=!!r.renderHtmlCodeBlocksShowTitleBar,c=a||o,i=Array.from(e.querySelectorAll(".hb-html-render"));if(!n){for(const s of i){const l=String(s.dataset?.hbHtmlBlobUrl??"");if(l)try{URL.revokeObjectURL(l)}catch{}const p=s.querySelector("pre");p&&s.parentNode&&(p.classList.remove("hb-html-code-hidden"),s.parentNode.insertBefore(p,s)),s.remove()}return}const u=Array.from(e.querySelectorAll("pre > code"));if(u.length===0)return;for(const s of i)s.querySelectorAll(".hb-embed").forEach(l=>l.remove()),s.querySelectorAll("iframe.hb-html-iframe").forEach(l=>l.remove());let d=e.querySelectorAll(".hb-embed").length;for(const s of u){const l=s.closest("pre");if(!l)continue;const p=s.textContent||"";if(!jt(p))continue;const b=l.closest(".hb-html-render"),h=b||document.createElement("div");if(!b){h.className="hb-html-render",h.dataset.hbHtmlRender="1";const _=l.parentNode;if(!_)continue;_.insertBefore(h,l),h.appendChild(l)}if(l.classList.add("hb-html-code-hidden"),!c){const _=String(h.dataset?.hbHtmlBlobUrl??"");if(_)try{URL.revokeObjectURL(_)}catch{}try{delete h.dataset.hbHtmlBlobUrl,delete h.dataset.hbHtmlHash}catch{}}const f=a?$e(h,p):"";if(o){const _=he(fe(p),{origin:window.location.origin,forceBaseHref:!1}),S={kind:"iframe",src:a&&f?f:"about:blank",title:"HTML 代码块"},C=Te(t,d++,S,{showTitleInChat:!0,openInNewTabUrl:a&&f?f:"#"}),m=h.querySelector(".hb-embed");if(m&&m.remove(),h.appendChild(C),!a){const y=C.querySelector("iframe.hb-iframe");y&&(y.removeAttribute("src"),y.srcdoc=_);const v=C.querySelector(".hb-embed-actions a");v&&String(v.dataset?.hbHtmlLazyOpenBound??"")!=="1"&&(v.dataset.hbHtmlLazyOpenBound="1",v.href="#",v.addEventListener("click",k=>{try{k.preventDefault();const P=$e(h,p);window.open(P,"_blank","noopener,noreferrer")}catch{}}))}continue}const g=h.querySelector(".hb-embed");g&&g.remove();let w=h.querySelector("iframe.hb-html-iframe");w||(w=document.createElement("iframe"),w.className="hb-html-iframe",w.loading="lazy",w.referrerPolicy="no-referrer",w.name=`hb-html-${t}`,w.setAttribute("sandbox","allow-scripts allow-same-origin"),ze(w),h.appendChild(w)),a&&f?(w.removeAttribute("srcdoc"),w.src=f):(w.removeAttribute("src"),w.srcdoc=he(fe(p),{origin:window.location.origin,forceBaseHref:!1}))}}function Bt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Le(e,t){const r=x();if(!r)return;const n=j(r.character);if(n.projects.length===0)return;const a=new Map;for(const f of n.projects){const g=String(f.placeholder??"").trim();g&&(a.has(g)||a.set(g,f))}const o=Array.from(a.keys());if(o.length===0)return;const c=e.textContent||"";let i=!1;for(const f of o)if(c.includes(f)){i=!0;break}if(!i)return;o.sort((f,g)=>g.length-f.length);const u=o.map(Bt).join("|"),d=new RegExp(u,"g"),s=new RegExp(u),l=new Map;for(const f of o){const g=a.get(f);g&&l.set(f,$t(g))}let p=0;const b=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode(f){const g=f?.nodeValue||"";if(!g||!s.test(g))return NodeFilter.FILTER_REJECT;let w=f.parentNode;for(;w&&w!==e;){if(w.nodeType===1){const _=w.tagName;if(_==="CODE"||_==="PRE"||_==="TEXTAREA")return NodeFilter.FILTER_REJECT}w=w.parentNode}return NodeFilter.FILTER_ACCEPT}}),h=[];for(;b.nextNode();)h.push(b.currentNode);for(const f of h){const g=f.nodeValue||"";if(!s.test(g))continue;d.lastIndex=0;let w=0;const _=document.createDocumentFragment();for(const S of g.matchAll(d)){const C=Number(S.index??0),m=String(S[0]??"");C>w&&_.appendChild(document.createTextNode(g.slice(w,C)));const y=a.get(m),v=l.get(m);v?_.appendChild(Te(t,p++,v,{projectId:y?.id,showTitleInChat:y?.showTitleInChat,useBlobUrlInChat:!0,openInNewTabUrl:v.kind==="iframe"?v.src:void 0})):_.appendChild(document.createTextNode(m)),w=C+m.length}w<g.length&&_.appendChild(document.createTextNode(g.slice(w))),f.parentNode?.replaceChild(_,f)}}function le(e){const t=Number(e);if(!Number.isFinite(t))return;const r=$(`#chat .mes[mesid="${t}"]`);if(r.length===0)return;const n=r.find(".mes_text").get(0);n&&(Le(n,t),Ne(n,t),He())}function We(){const e=document.querySelectorAll("#chat .mes[mesid]");for(const t of e){const r=t.getAttribute("mesid"),n=Number(r);if(!Number.isFinite(n))continue;const a=t.querySelector(".mes_text");a&&(Le(a,n),Ne(a,n))}He()}let de=!1;function H(){de||(de=!0,setTimeout(()=>{de=!1,We()},0))}let Ce=!1;function kt(){if(Ce)return;const e=B();if(!e?.eventSource||!e?.event_types)return;Ce=!0;const{eventSource:t,event_types:r}=e,n=(...o)=>le(o?.[0]),a=(...o)=>{const c=Number(o?.[0]);Number.isFinite(c)&&(setTimeout(()=>le(c),0),setTimeout(()=>le(c),50))};t.on(r.USER_MESSAGE_RENDERED,n),t.on(r.CHARACTER_MESSAGE_RENDERED,n),r.MESSAGE_EDITED&&t.on(r.MESSAGE_EDITED,a),r.MESSAGE_UPDATED&&t.on(r.MESSAGE_UPDATED,a),r.MORE_MESSAGES_LOADED&&t.on(r.MORE_MESSAGES_LOADED,()=>H()),r.CHAT_CHANGED&&t.on(r.CHAT_CHANGED,()=>H())}function Pt(e,t=15e3){return new Promise((r,n)=>{let a=!1;const o=b=>{a||(a=!0,u(),b?n(b):r())},c=setTimeout(()=>{o(new Error("Service Worker 激活超时（可能是非安全上下文或被浏览器策略禁止）"))},t),i=[],u=()=>{clearTimeout(c);for(const b of i)try{b()}catch{}},d=()=>{try{e.waiting?.postMessage?.({type:"HB_SKIP_WAITING"})}catch{}},s=()=>{try{e.active?.state==="activated"&&o()}catch{}},l=b=>{if(!b)return;if(b.state==="activated"){o();return}const h=()=>{d(),b.state==="activated"&&o()};b.addEventListener("statechange",h),i.push(()=>b.removeEventListener("statechange",h))},p=()=>{d(),l(e.installing),s()};e.addEventListener("updatefound",p),i.push(()=>e.removeEventListener("updatefound",p)),d(),l(e.installing||e.waiting||e.active),s()})}async function Ut(){if(!("serviceWorker"in navigator))return console.warn("[Higanbana] Service Worker not supported"),null;try{const e=await navigator.serviceWorker.register(_t,{scope:R,type:"module"});return e.update().catch(()=>{}),await Pt(e),e}catch(e){return console.warn("[Higanbana] sw register failed",e),null}}const Z={urlDownloadPopupInFlight:!1};function me(e){const t=q(e.loadedBytes),r=e.totalBytes?q(e.totalBytes):"?",n=e.totalBytes?yt(e.percent):"—",a=wt(e.speedBps);return`下载：${t} / ${r}（${n}） | 速度：${a}`}function be(){try{if(typeof crypto<"u"&&"randomUUID"in crypto&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}const e=B();try{const t=e?.uuidv4;if(typeof t=="function")return String(t())}catch{}return`hb_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,10)}`}function oe(e){return String(e??"").trim()}function ae(e,t){const r=new Set(e.map(a=>a.placeholder));let n=oe(t);if(n||(n=`{{WEB_${e.length+1}}}`),!r.has(n))return n;for(let a=2;a<1e3;a++){const o=`_${a}`,c=n.endsWith("}}")?n.slice(0,-2)+o+"}}":n+o;if(!r.has(c))return c}return n}function Me(e,t){const r=document.createElement("a");r.href=URL.createObjectURL(e),r.setAttribute("download",t),document.body.appendChild(r),r.click(),URL.revokeObjectURL(r.href),document.body.removeChild(r)}function At(e){const t=String(e??"").trim();if(!t)return null;try{const r=new URL(t);return r.protocol!=="http:"&&r.protocol!=="https:"?null:r.toString()}catch{return null}}function Rt(e){try{const r=new URL(e).pathname.split("/").filter(Boolean).pop()||"webzip.zip";return r.endsWith(".zip")?r:`${r}.zip`}catch{return"webzip.zip"}}function zt(e){const t=e?.projects??[];if(t.length===0)return"（无）";const r=t.slice(0,3).map(a=>a.title||a.zipName).filter(Boolean),n=t.length>r.length?` +${t.length-r.length}`:"";return`项目数：${t.length}${r.length?` | ${r.join(" / ")}${n}`:""}`}function Tt(e,t){try{const r=localStorage.getItem(e);return r===null?t:r==="1"}catch{return t}}function It(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Fe(){const e=document.getElementById("higanbana_settings");if(!e)return;const t=Array.from(e.querySelectorAll(".hb-subpanel"));for(const r of t){const n=String(r.dataset.id??"").trim();if(!n)continue;const a=r.querySelector(".hb-subpanel-header"),o=r.querySelector(".hb-subpanel-indicator"),c=r.querySelector(".hb-subpanel-body");if(!a||!o||!c||a.dataset?.hbBound==="1")continue;a.dataset.hbBound="1";const i=`higanbana.subpanel.open.${n}`,u=a.getAttribute("aria-expanded")==="true",d=s=>{a.setAttribute("aria-expanded",s?"true":"false"),o.textContent=s?"−":"+",c.style.display=s?"block":"none"};d(Tt(i,u)),a.addEventListener("click",()=>{const l=!(a.getAttribute("aria-expanded")==="true");d(l),It(i,l)})}}function xe(e){const t=document.getElementById("hb_projects_list");if(!t)return;if(t.innerHTML="",e.length===0){const n=document.createElement("div");n.className="hb-subhint",n.textContent="（暂无项目）",t.appendChild(n);return}const r=document.createDocumentFragment();for(const n of e){const a=document.createElement("section");a.className="hb-subpanel hb-project",a.dataset.id=`project_${n.id}`,a.dataset.projectId=n.id;const o=document.createElement("button");o.className="hb-subpanel-header",o.type="button",o.setAttribute("aria-expanded","false");const c=document.createElement("div");c.className="hb-subpanel-title",c.textContent=`${n.title||n.zipName}  ${n.placeholder}`;const i=document.createElement("div");i.className="hb-subpanel-indicator",i.textContent="+",o.appendChild(c),o.appendChild(i),a.appendChild(o);const u=document.createElement("div");u.className="hb-subpanel-body",u.style.display="none";const d=s=>{const l=document.createElement("div");l.className="hb-row";const p=document.createElement("label");return p.className="hb-label",p.textContent=s,l.appendChild(p),l};{const s=d("标题"),l=document.createElement("input");l.className="text_pole hb-proj-title",l.type="text",l.spellcheck=!1,l.value=n.title||"",l.dataset.projectId=n.id,s.appendChild(l),u.appendChild(s)}{const s=d("占位符"),l=document.createElement("input");l.className="text_pole hb-proj-placeholder",l.type="text",l.spellcheck=!1,l.value=n.placeholder,l.dataset.projectId=n.id,s.appendChild(l);const p=document.createElement("div");p.className="hb-actions";const b=document.createElement("button");b.className="menu_button",b.type="button",b.dataset.hbAction="copy_placeholder",b.dataset.projectId=n.id,b.textContent="复制";const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="insert_placeholder",h.dataset.projectId=n.id,h.textContent="插入到输入框",p.appendChild(b),p.appendChild(h),s.appendChild(p),u.appendChild(s)}{const s=d("入口 HTML"),l=document.createElement("input");l.className="text_pole hb-proj-home",l.type="text",l.spellcheck=!1,l.value=n.homePage,l.dataset.projectId=n.id,s.appendChild(l),u.appendChild(s)}{const s=d("修复 root 相对路径（/xxx）"),l=document.createElement("input");l.className="hb-proj-fix",l.type="checkbox",l.checked=!!n.fixRootRelativeUrls,l.dataset.projectId=n.id,s.appendChild(l),u.appendChild(s)}{const s=d("消息列表显示标题"),l=document.createElement("input");l.className="hb-proj-show-title",l.type="checkbox",l.checked=!!n.showTitleInChat,l.dataset.projectId=n.id,s.appendChild(l),u.appendChild(s)}{const s=d("操作"),l=document.createElement("div");if(l.className="hb-actions",n.source==="embedded"){const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="import_cache",h.dataset.projectId=n.id,h.textContent="导入到缓存",l.appendChild(h);const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="export_zip",f.dataset.projectId=n.id,f.textContent="导出 zip",l.appendChild(f)}else if(n.source==="url"){const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="download_apply",h.dataset.projectId=n.id,h.textContent="下载并应用",l.appendChild(h)}else{const h=document.createElement("button");h.className="menu_button",h.type="button",h.disabled=!0,h.title="仅使用本地缓存。若缓存被清理，请在“新增项目”中重新导入 zip。",h.textContent="本地缓存模式",l.appendChild(h)}const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="open_home",p.dataset.projectId=n.id,p.textContent="打开首页",l.appendChild(p);const b=document.createElement("button");b.className="menu_button",b.type="button",b.dataset.hbAction="delete_project",b.dataset.projectId=n.id,b.textContent="删除项目",l.appendChild(b),s.appendChild(l),u.appendChild(s)}a.appendChild(u),r.appendChild(a)}t.appendChild(r),Fe()}async function Ht(){$("#higanbana_settings").remove();const e=await fetch(`${R}settings.html`,{cache:"no-store"});if(!e.ok)throw new Error(`加载 settings.html 失败: ${e.status}`);const t=await e.text();$("#extensions_settings").append(t)}function Nt(){const e=T();$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_render_html_blocks").prop("checked",!!e.renderHtmlCodeBlocks),$("#hb_render_html_blocks_blob").prop("checked",!!e.renderHtmlCodeBlocksUseBlobUrl),$("#hb_render_html_blocks_titlebar").prop("checked",!!e.renderHtmlCodeBlocksShowTitleBar);const t=$("#hb_homepage");t.length&&!String(t.val()??"").trim()&&t.val("index.html")}function A(){const e=T(),t=x();if(!t){$("#hb_char_info").text("（未选中角色）"),$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_homepage").val(String($("#hb_homepage").val()??"").trim()||"index.html"),xe([]),$("#hb_import_from_card").prop("disabled",!0),$("#hb_migrate_embedded_to_local").prop("disabled",!0),$("#hb_unbind").prop("disabled",!0),$("#hb_pick_zip_btn").prop("disabled",!0),$("#hb_bind_zip").prop("disabled",!0),$("#hb_bind_zip_btn").prop("disabled",!0),$("#hb_bind_zip_local_btn").prop("disabled",!0),$("#hb_bind_url").prop("disabled",!0),$("#hb_bind_url_btn").prop("disabled",!0);return}const{chid:r,character:n}=t,a=Ze(n),o=N(n);$("#hb_char_info").text([`名称：${a}`,`chid：${r}`,o?`avatar：${o}`:""].filter(Boolean).join(`
`));const c=j(n);xe(c.projects);const i=c.projects.length>0;$("#hb_import_from_card").prop("disabled",!c.projects.some(l=>l.source==="embedded")),$("#hb_migrate_embedded_to_local").prop("disabled",!c.projects.some(l=>l.source==="embedded")),$("#hb_unbind").prop("disabled",!i),$("#hb_pick_zip_btn").prop("disabled",!1),$("#hb_bind_zip").prop("disabled",!1),$("#hb_bind_zip_btn").prop("disabled",!1),$("#hb_bind_zip_local_btn").prop("disabled",!1),$("#hb_bind_url").prop("disabled",!1),$("#hb_bind_url_btn").prop("disabled",!1);const u=$("#hb_fix_root_relative");u.length&&document.activeElement!==u.get(0)&&u.prop("checked",!!e.defaultFixRootRelativeUrls);const d=$("#hb_homepage");d.length&&document.activeElement!==d.get(0)&&!String(d.val()??"").trim()&&d.val("index.html");const s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&!String(s.val()??"").trim()&&s.val(ae(c.projects,`{{WEB_${c.projects.length+1}}}`))}function U(e){$("#hb_status").text(e)}function ie(e){return e.source==="url"?e.zipSha256?!pe(e.zipSha256):!0:!pe(e.zipSha256)}function De(e){const t=document.createElement("div"),r=document.createElement("h3");r.textContent=e,t.appendChild(r);const n=document.createElement("progress");n.max=100,n.value=0,n.style.width="100%",n.style.height="12px",t.appendChild(n);const a=document.createElement("div");return a.style.marginTop="8px",a.style.opacity="0.9",a.style.whiteSpace="nowrap",a.style.overflowX="auto",a.style.overflowY="hidden",t.appendChild(a),{root:t,titleEl:r,progress:n,text:a}}async function ge(e,t){const r=B();if(!r)throw new Error("上下文缺失");const n=t.filter(b=>ie(b));if(n.length===0)return{importedCount:0,cancelled:!1};if(!r.callGenericPopup||!r.POPUP_TYPE){let b=0;for(const h of n){const f=x();if(!f||Number(f.chid)!==Number(e))break;const g=h.title||h.zipName;U(`正在导入：${g} ...`);let w;if(h.source==="url")w=(await Q(h.zipUrl)).arrayBuffer;else if(h.source==="embedded")w=await K(h.zipBase64);else{U(`项目“${g}”为本地缓存模式，无法自动恢复缓存，请在面板重新导入本地 zip。`);continue}const _=await D(R,w,{fixRootRelativeUrls:h.fixRootRelativeUrls,preferredHomePage:h.homePage});z.add(_.projectId),await L();const C=j(f.character).projects.map(m=>m.id===h.id?{...m,zipSha256:_.projectId,homePage:_.homePage}:m);await I(e,{projects:C}),b++}return{importedCount:b,cancelled:!1}}if(Z.urlDownloadPopupInFlight)throw new Error("当前已有下载弹窗进行中，请稍后再试");Z.urlDownloadPopupInFlight=!0;const a=new AbortController;let o=!1,c=!1,i=0;const{root:u,titleEl:d,progress:s,text:l}=De("彼岸花：准备导入...");l.style.whiteSpace="pre-wrap",l.style.overflowX="hidden";const p=b=>{try{l.textContent=me(b)}catch{l.textContent="正在下载..."}if(b?.totalBytes){const h=Number(b?.percent);Number.isFinite(h)&&(s.max=100,s.value=Math.max(0,Math.min(100,h)))}else s.removeAttribute("value")};try{await r.callGenericPopup(u,r.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消",onClosing:()=>(o||(c=!0,a.abort()),!0),onOpen:async b=>{try{for(let h=0;h<n.length;h++){const f=n[h];if(a.signal.aborted)break;const g=x();if(!g||Number(g.chid)!==Number(e))break;const w=f.title||f.zipName;d.textContent=`彼岸花：正在导入（${h+1}/${n.length}）${w}`;let _;if(f.source==="url")l.textContent=`准备下载：${f.zipName}
${f.zipUrl}`,s.max=100,s.value=0,_=(await Q(f.zipUrl,{signal:a.signal,onProgress:p})).arrayBuffer,s.value=100,l.textContent=`下载完成（${q(_.byteLength)}），正在解压并写入缓存...`;else if(f.source==="embedded")s.removeAttribute("value"),l.textContent=`正在从角色卡导入并解压：${f.zipName}`,_=await K(f.zipBase64);else{l.textContent=`项目“${w}”为本地缓存模式，无法自动恢复缓存。请在面板重新导入本地 zip。`;continue}const S=await D(R,_,{fixRootRelativeUrls:f.fixRootRelativeUrls,preferredHomePage:f.homePage});z.add(S.projectId),await L();const m=j(g.character).projects.map(y=>y.id===f.id?{...y,zipSha256:S.projectId,homePage:S.homePage}:y);await I(e,{projects:m}),i++}o=!0;try{await b.completeAffirmative?.()}catch{}}catch(h){o=!0;try{await b.completeCancelled?.()}catch{}throw h}}})}finally{Z.urlDownloadPopupInFlight=!1}return{importedCount:i,cancelled:c}}async function Lt(e){const t=B();if(!t)return null;if(!t.callGenericPopup||!t.POPUP_TYPE){const d=await Q(e.zipUrl),s=await D(R,d.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});return z.add(s.projectId),await L(),{projectId:s.projectId,homePage:s.homePage,fileCount:s.fileCount}}if(Z.urlDownloadPopupInFlight)return null;Z.urlDownloadPopupInFlight=!0;const r=new AbortController;let n=!1,a=null;const{root:o,progress:c,text:i}=De("彼岸花：正在下载 WebZip...");i.textContent=`准备下载：${e.zipName} | ${e.zipUrl}`;const u=d=>{if(i.textContent=me(d),d.totalBytes){const s=Number(d.percent);Number.isFinite(s)&&(c.max=100,c.value=Math.max(0,Math.min(100,s)))}else c.removeAttribute("value")};try{await t.callGenericPopup(o,t.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消下载",onClosing:()=>(n||r.abort(),!0),onOpen:async d=>{try{const s=await Q(e.zipUrl,{signal:r.signal,onProgress:u});c.max=100,c.value=100,i.textContent=`下载完成（${q(s.arrayBuffer.byteLength)}），正在解压并写入缓存...`;const l=await D(R,s.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});z.add(l.projectId),await L(),a={projectId:l.projectId,homePage:l.homePage,fileCount:l.fileCount},n=!0;try{await d.completeAffirmative()}catch{}}catch(s){r.signal.aborted||s?.name==="AbortError"?toastr.info("已取消下载"):(console.error("[Higanbana] url download failed",s),toastr.error(`下载失败：${s?.message??s}`)),n=!0;try{await d.completeCancelled?.()}catch{}}}})}finally{Z.urlDownloadPopupInFlight=!1}return a}let G=null;const Se=20*1024*1024;function Wt(e){const t=Number(e?.byteLength??0);if(!Number.isFinite(t)||t<=Se)return;const r=Math.round(Se/1024/1024);throw new Error(`当前 zip 大小为 ${q(t)}，超过嵌入上限（${r} MB）。请改用“添加本地缓存项目（不嵌入）”或 URL 模式。`)}function je(e){const t=$("#hb_url_download_wrap"),r=$("#hb_cancel_url_download_btn");e?(t.show(),r.show()):(t.hide(),r.hide())}function Mt(e){const t=$("#hb_url_download_wrap"),r=$("#hb_url_progress"),n=$("#hb_url_progress_text");t.length&&t.show();try{n.text(me(e))}catch{n.text("正在下载...")}if(e?.totalBytes){const a=Number(e?.percent);Number.isFinite(a)&&(r.attr("max","100"),r.get(0)?.removeAttribute?.("value"),r.val(Math.max(0,Math.min(100,a))))}else r.get(0)?.removeAttribute?.("value")}function Ft(){try{G?.abort()}catch{}}async function Dt(){const e=B(),t=x();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const r=j(t.character),n=r.projects.find(u=>u.source==="url");if(!n)throw new Error("当前角色卡没有 URL 项目");if(Z.urlDownloadPopupInFlight)throw new Error("当前已有自动下载弹窗进行中，请稍后再试");G&&!G.signal.aborted&&G.abort();const a=N(t.character);a&&W(a);const o=n.fixRootRelativeUrls,c=n.homePage,i=new AbortController;G=i,je(!0),$("#hb_url_progress").attr("max","100"),$("#hb_url_progress").val(0),$("#hb_url_progress_text").text(`准备下载：${n.zipName} | ${n.zipUrl}`),$("#hb_bind_url_btn").prop("disabled",!0),$("#hb_download_url_btn").prop("disabled",!0);try{const u=await Q(n.zipUrl,{signal:i.signal,onProgress:Mt});if(i.signal.aborted)throw new Error("已取消下载");U("下载完成，正在解压并写入 VFS 缓存...");const d=await D(R,u.arrayBuffer,{fixRootRelativeUrls:o,preferredHomePage:c});z.add(d.projectId),await L();const s={projects:r.projects.map(l=>l.source==="url"?{...l,zipSha256:d.projectId,homePage:d.homePage}:l)};await I(t.chid,s),U(`已下载并导入缓存。
projectId(sha256)：${d.projectId}
入口：${d.homePage}
文件数：${d.fileCount}

提示：在消息中插入占位符即可渲染`),e?.reloadCurrentChat&&await e.reloadCurrentChat()}finally{G===i&&(G=null),je(!1),$("#hb_bind_url_btn").prop("disabled",!1),$("#hb_download_url_btn").prop("disabled",!1),A()}}async function Ot(e,t){const r=x();if(!r)throw new Error("当前不在单角色聊天/未选中角色");Wt(t);const n=N(r.character);n&&W(n);const a=T(),o=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=o,F();const c=String($("#hb_homepage").val()??"").trim()||void 0;U("正在解压并写入 VFS 缓存...");const i=await D(R,t,{fixRootRelativeUrls:o,preferredHomePage:c});z.add(i.projectId),await L(),U("正在编码 base64 并写入角色卡扩展字段...");const u=await gt(t),d=j(r.character),s=oe($("#hb_placeholder").val()),l=ae(d.projects,s),p=String($("#hb_new_title").val()??"").trim(),b=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,h={source:"embedded",id:be(),title:p||void 0,placeholder:l,homePage:i.homePage,showTitleInChat:b,fixRootRelativeUrls:o,zipName:e,zipSha256:i.projectId,zipBase64:u},f={projects:[...d.projects,h]};await I(r.chid,f);const g=$("#hb_placeholder");g.length&&document.activeElement!==g.get(0)&&g.val(""),A(),$("#hb_new_title").val(""),U(`已添加项目（嵌入模式）。
占位符：${l}
projectId(sha256)：${i.projectId}
入口：${i.homePage}
文件数：${i.fileCount}

提示：导出该角色卡(json/png)会包含该项目的 zipBase64`)}async function Gt(e,t){const r=x();if(!r)throw new Error("当前不在单角色聊天/未选中角色");const n=N(r.character);n&&W(n);const a=T(),o=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=o,F();const c=String($("#hb_homepage").val()??"").trim()||void 0;U("正在解压并写入 VFS 缓存...");const i=await D(R,t,{fixRootRelativeUrls:o,preferredHomePage:c});z.add(i.projectId),await L();const u=j(r.character),d=oe($("#hb_placeholder").val()),s=ae(u.projects,d),l=String($("#hb_new_title").val()??"").trim(),p=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,b={source:"local",id:be(),title:l||void 0,placeholder:s,homePage:i.homePage,showTitleInChat:p,fixRootRelativeUrls:o,zipName:e,zipSha256:i.projectId},h={projects:[...u.projects,b]};await I(r.chid,h);const f=$("#hb_placeholder");f.length&&document.activeElement!==f.get(0)&&f.val(""),A(),$("#hb_new_title").val(""),U(`已添加项目（本地缓存模式，不嵌入角色卡）。
占位符：${s}
projectId(sha256)：${i.projectId}
入口：${i.homePage}
文件数：${i.fileCount}

提示：导出角色卡时不会包含该 zip；若浏览器缓存被清理，需要在本机重新导入 zip。`)}async function Zt({allow:e=!0,ensureCached:t=!0,reloadChat:r=!0}={}){const n=B(),a=x();if(!a)throw new Error("当前不在单角色聊天/未选中角色");const o=N(a.character);e&&o&&W(o);const i=j(a.character).projects.filter(h=>h.source==="embedded"),u=i.length;if(u===0)return{totalEmbedded:0,migrated:0,importedCount:0,cancelled:!1};let d=0,s=!1;if(t){const h=i.filter(f=>ie(f));if(h.length>0){U(`发现 ${h.length} 个嵌入项目未缓存，正在导入缓存...`);const f=await ge(a.chid,h);if(d=f.importedCount,s=f.cancelled,s)return U("已取消迁移（未修改角色卡）"),{totalEmbedded:u,migrated:0,importedCount:d,cancelled:!0}}}const l=j(a.character);let p=0;const b=l.projects.map(h=>h.source!=="embedded"?h:(p++,{source:"local",id:h.id,title:h.title,placeholder:h.placeholder,homePage:h.homePage,showTitleInChat:h.showTitleInChat,fixRootRelativeUrls:h.fixRootRelativeUrls,zipName:h.zipName,zipSha256:h.zipSha256}));return await I(a.chid,{projects:b}),r&&n?.reloadCurrentChat&&await n.reloadCurrentChat(),A(),{totalEmbedded:u,migrated:p,importedCount:d,cancelled:!1}}async function qt({allow:e=!0,reloadChat:t=!0}={}){const r=B(),n=x();if(!n)throw new Error("当前不在单角色聊天/未选中角色");const a=j(n.character),o=a.projects.filter(d=>d.source==="embedded");if(o.length===0)throw new Error("当前角色卡没有可导入的嵌入项目");const c=N(n.character);e&&c&&W(c);const i=[...a.projects];let u=!1;for(const d of o){if(d.zipSha256&&z.has(d.zipSha256))continue;U(`正在从角色卡导入：${d.title||d.zipName} ...`);const s=await K(d.zipBase64),l=await D(R,s,{fixRootRelativeUrls:d.fixRootRelativeUrls,preferredHomePage:d.homePage});if(z.add(l.projectId),await L(),l.projectId!==d.zipSha256){console.warn("[Higanbana] zipSha256 mismatch",{embedded:d.zipSha256,computed:l.projectId});const p=i.findIndex(b=>b.id===d.id);if(p>=0){const b=i[p];b&&b.source==="embedded"&&(i[p]={...b,zipSha256:l.projectId,homePage:l.homePage},u=!0)}}}u&&await I(n.chid,{projects:i}),U(`已导入到缓存。
已导入项目数：${o.length}`),t&&r?.reloadCurrentChat&&await r.reloadCurrentChat()}function V(){const e=x();if(!e)throw new Error("当前不在单角色聊天/未选中角色");const t=j(e.character);return{active:e,card:t}}function ee(e,t){const r=String(t??"").trim();if(!r)throw new Error("项目 id 为空");const n=e.projects.find(a=>a.id===r);if(!n)throw new Error("找不到项目（可能已被删除）");return n}function Vt(e){const{card:t}=V(),r=ee(t,e);if(!r.zipSha256)throw new Error("尚未下载/导入到本地缓存");if(!z.has(r.zipSha256))throw new Error("尚未导入到本地缓存");const n=ne(R,r.zipSha256,r.homePage);window.open(n,"_blank","noopener,noreferrer")}async function Jt(e){const{card:t}=V(),r=ee(t,e);if(r.source!=="embedded")throw new Error("当前项目不是嵌入模式，无法导出 zip");const n=await K(r.zipBase64),a=new Blob([n],{type:"application/zip"});Me(a,r.zipName||"webzip.zip")}async function Yt(e){const{active:t,card:r}=V(),n=ee(r,e);if(n.source!=="embedded")throw new Error("当前项目不是嵌入模式");if(!ie(n))return{importedCount:0,cancelled:!1};const a=N(t.character);a&&W(a);const o=await ge(t.chid,[n]);return o.cancelled||(await B()?.reloadCurrentChat?.(),A()),o}async function Xt(e){const{active:t,card:r}=V(),n=ee(r,e);if(n.source!=="url")throw new Error("当前项目不是 URL 模式");const a=N(t.character);a&&W(a);const o=await Lt(n);if(!o)return!1;const i={projects:j(t.character).projects.map(u=>u.id===n.id?{...u,zipSha256:o.projectId,homePage:o.homePage}:u)};return await I(t.chid,i),await B()?.reloadCurrentChat?.(),A(),!0}async function Kt(e){const t=B(),{active:r,card:n}=V(),a=ee(n,e),o=n.projects.filter(c=>c.id!==a.id);await I(r.chid,o.length?{projects:o}:null),await t?.reloadCurrentChat?.(),A()}async function Qt(){const{active:e}=V();await I(e.chid,null),A()}async function er(e){const t=x();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const r=At(e);if(!r)throw new Error("请输入合法的 http/https zip URL");const n=N(t.character);n&&W(n);const a=!!$("#hb_fix_root_relative").prop("checked"),o=String($("#hb_homepage").val()??"").trim()||"index.html",c=Rt(r),i=j(t.character),u=oe($("#hb_placeholder").val()),d=ae(i.projects,u),s=String($("#hb_new_title").val()??"").trim(),l=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,p={source:"url",id:be(),title:s||void 0,placeholder:d,homePage:o,showTitleInChat:l,fixRootRelativeUrls:a,zipName:c,zipSha256:"",zipUrl:r},b={projects:[...i.projects,p]};return await I(t.chid,b),{zipUrl:r,placeholder:d,homePage:o}}function tr(){Fe();const e=B();$("#hb_pick_zip_btn").on("click",()=>{document.getElementById("hb_bind_zip")?.click()}),$("#hb_bind_zip").on("change",()=>{const o=document.getElementById("hb_bind_zip")?.files?.[0];$("#hb_bind_zip_name").text(o?o.name:"（未选择文件）")}),$("#hb_fix_root_relative").on("change",()=>{const o=T();o.defaultFixRootRelativeUrls=!!$("#hb_fix_root_relative").prop("checked"),F()}),$("#hb_render_html_blocks").on("change",()=>{const o=T();o.renderHtmlCodeBlocks=!!$("#hb_render_html_blocks").prop("checked"),F(),H()}),$("#hb_render_html_blocks_blob").on("change",()=>{const o=T();o.renderHtmlCodeBlocksUseBlobUrl=!!$("#hb_render_html_blocks_blob").prop("checked"),F(),H()}),$("#hb_render_html_blocks_titlebar").on("change",()=>{const o=T();o.renderHtmlCodeBlocksShowTitleBar=!!$("#hb_render_html_blocks_titlebar").prop("checked"),F(),H()}),$("#hb_placeholder").on("input",()=>{const o=T();o.placeholder=String($("#hb_placeholder").val()??"").trim()||O.placeholder,F()}),$("#hb_copy_placeholder").on("click",async()=>{const o=String($("#hb_placeholder").val()??"").trim();if(!o){toastr.error("占位符为空");return}try{await navigator.clipboard.writeText(o),toastr.success("已复制占位符")}catch(c){console.warn("[Higanbana] copy failed",c),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_insert_placeholder").on("click",()=>{const o=String($("#hb_placeholder").val()??"").trim();if(!o){toastr.error("占位符为空");return}const c=$("#send_textarea");if(c.length===0){toastr.error("找不到输入框");return}const i=String(c.val()??"");c.val(i?`${i}
${o}`:o),c.trigger("input"),toastr.success("已插入占位符")});const t=new Map,r=new Set,n=(o,c=400)=>{const i=t.get(o);i&&clearTimeout(i);const u=window.setTimeout(()=>{t.delete(o),a(o).catch(d=>console.warn("[Higanbana] project auto save failed",d))},Math.max(0,c));t.set(o,u)},a=async o=>{if(!r.has(o)){r.add(o);try{const c=x();if(!c)return;const i=j(c.character),u=i.projects.findIndex(E=>E.id===o);if(u<0)return;const d=document.getElementById("hb_projects_list");if(!d)return;const s=String(o).replace(/\\/g,"\\\\").replace(/"/g,'\\"'),l=d.querySelector(`.hb-proj-title[data-project-id="${s}"]`),p=d.querySelector(`.hb-proj-placeholder[data-project-id="${s}"]`),b=d.querySelector(`.hb-proj-home[data-project-id="${s}"]`),h=d.querySelector(`.hb-proj-fix[data-project-id="${s}"]`),f=d.querySelector(`.hb-proj-show-title[data-project-id="${s}"]`),g=i.projects[u],w=String(l?.value??"").trim(),_=w||void 0,S=String(p?.value??"").trim(),C=String(b?.value??"").trim(),m=!!h?.checked,y=f?!!f.checked:!!g.showTitleInChat;if(!S||!C)return;if(i.projects.some(E=>E.id!==o&&E.placeholder===S)){toastr.error("占位符重复，请为每个项目设置不同的占位符"),p&&(p.value=g.placeholder);return}if(!(g.title!==_||g.placeholder!==S||g.homePage!==C||g.fixRootRelativeUrls!==m||g.showTitleInChat!==y))return;const P=i.projects.map(E=>E.id===o?{...E,title:_,placeholder:S,homePage:C,fixRootRelativeUrls:m,showTitleInChat:y}:E);await I(c.chid,{projects:P}),g.showTitleInChat!==y&&St(o,y);const M=d.querySelector(`.hb-project[data-project-id="${s}"] .hb-subpanel-title`);M&&(M.textContent=`${_||g.zipName}  ${S}`),U(`已保存项目设置：${_||g.zipName}`),H()}finally{r.delete(o)}}};$("#hb_projects_list").on("input",".hb-proj-title, .hb-proj-placeholder, .hb-proj-home",o=>{const c=String(o.target?.getAttribute?.("data-project-id")??"").trim();c&&n(c,500)}),$("#hb_projects_list").on("change",".hb-proj-fix, .hb-proj-show-title",o=>{const c=String(o.target?.getAttribute?.("data-project-id")??"").trim();c&&n(c,0)}),$("#hb_projects_list").on("click",'[data-hb-action="copy_placeholder"]',async o=>{const c=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!c)return;const i=x();if(!i)return;const d=j(i.character).projects.find(s=>s.id===c);if(d)try{await navigator.clipboard.writeText(d.placeholder),toastr.success("已复制占位符")}catch(s){console.warn("[Higanbana] copy placeholder failed",s),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="insert_placeholder"]',o=>{const c=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!c)return;const i=x();if(!i)return;const d=j(i.character).projects.find(p=>p.id===c);if(!d)return;const s=$("#send_textarea");if(s.length===0){toastr.error("找不到输入框");return}const l=String(s.val()??"");s.val(l?`${l}
${d.placeholder}`:d.placeholder),s.trigger("input"),toastr.success("已插入占位符")}),$("#hb_projects_list").on("click",'[data-hb-action="open_home"]',o=>{const c=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(c)try{Vt(c)}catch(i){toastr.error(i?.message??i)}}),$("#hb_projects_list").on("click",'[data-hb-action="export_zip"]',async o=>{const c=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(c)try{await Jt(c)}catch(i){console.error("[Higanbana] export zip failed",i),toastr.error(`导出失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="import_cache"]',async o=>{const c=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(c)try{const i=await Yt(c);if(i.cancelled){toastr.info("已取消导入");return}i.importedCount>0?toastr.success("已导入到本地缓存"):toastr.info("该项目已在本地缓存"),H()}catch(i){console.error("[Higanbana] import cache failed",i),toastr.error(`导入失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="download_apply"]',async o=>{const c=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(c)try{if(!await Xt(c))return;H(),toastr.success("已下载并应用")}catch(i){console.error("[Higanbana] download apply failed",i),toastr.error(`操作失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="delete_project"]',async o=>{const c=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!c)return;const i=x();if(!i)return;const d=j(i.character).projects.find(p=>p.id===c);if(!d)return;const s=d.title||d.zipName;let l=!1;try{e?.Popup?.show?.confirm?l=await e.Popup.show.confirm("彼岸花",`确定删除项目：${s}？`):l=window.confirm(`确定删除项目：${s}？`)}catch{l=window.confirm(`确定删除项目：${s}？`)}if(l)try{await Kt(c),H(),toastr.success("已删除项目")}catch(p){console.error("[Higanbana] delete project failed",p),toastr.error(`删除失败：${p?.message??p}`)}}),$("#hb_import_from_card").on("click",async()=>{try{toastr.info("开始导入，请稍候..."),await qt({allow:!0,reloadChat:!0}),toastr.success("已导入并启用（可在消息中渲染占位符）"),A()}catch(o){console.error("[Higanbana] import from card failed",o),toastr.error(`导入失败：${o?.message??o}`)}}),$("#hb_migrate_embedded_to_local").on("click",async()=>{const o=x();if(!o)return;const i=j(o.character).projects.filter(s=>s.source==="embedded").length;if(i===0){toastr.info("当前角色卡没有可迁移的嵌入项目");return}const u=`确定将当前角色卡中的 ${i} 个“嵌入项目”迁移为“本地缓存模式”吗？

迁移后：
1) 角色卡将不再保存 zipBase64（体积会明显下降）
2) 若当前浏览器缓存被清理，需要在本机重新导入 zip
3) 迁移前会先尝试把未缓存项目导入到本地缓存
`;let d=!1;try{e?.Popup?.show?.confirm?d=await e.Popup.show.confirm("彼岸花",u):d=window.confirm(u)}catch{d=window.confirm(u)}if(d)try{const s=await Zt({allow:!0,ensureCached:!0,reloadChat:!0});if(s.cancelled){toastr.info("已取消迁移（未修改角色卡）");return}toastr.success(`迁移完成：${s.migrated}/${s.totalEmbedded}，预导入缓存：${s.importedCount}`)}catch(s){console.error("[Higanbana] migrate embedded->local failed",s),toastr.error(`迁移失败：${s?.message??s}`)}}),$("#hb_open_home").on("click",()=>{const o=x();if(!o)return;const i=j(o.character).projects[0];if(!i){toastr.error("当前角色卡未绑定任何 WebZip 项目");return}if(!i.zipSha256){toastr.error("尚未下载/导入 WebZip 到本地缓存");return}const u=ne(R,i.zipSha256,i.homePage);window.open(u,"_blank","noopener,noreferrer")}),$("#hb_export_zip").on("click",async()=>{const o=x();if(!o)return;const i=j(o.character).projects.find(u=>u.source==="embedded");if(!i){toastr.error("当前角色卡没有可导出的嵌入项目");return}try{const u=await K(i.zipBase64),d=new Blob([u],{type:"application/zip"});Me(d,i.zipName||"webzip.zip")}catch(u){console.error("[Higanbana] export zip failed",u),toastr.error(`导出失败：${u?.message??u}`)}}),$("#hb_unbind").on("click",async()=>{const o=B(),c=x();if(!c)return;const i=j(c.character);if(i.projects.length===0)return;const u=`确定解绑当前角色的所有 WebZip 项目？

${zt(i)}`;let d=!1;try{o?.Popup?.show?.confirm?d=await o.Popup.show.confirm("彼岸花",u):d=window.confirm(u)}catch{d=window.confirm(u)}if(d)try{await Qt(),toastr.success("已解绑"),A()}catch(s){console.error("[Higanbana] unbind failed",s),toastr.error(`解绑失败：${s?.message??s}`)}}),$("#hb_bind_zip_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const c=$("#hb_bind_zip").get(0)?.files?.[0];if(!c){toastr.error("请先选择 zip 文件");return}try{await Ot(c.name,await c.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(i){console.error("[Higanbana] bind zip failed",i),toastr.error(`绑定失败：${i?.message??i}`)}}),$("#hb_bind_zip_local_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const c=$("#hb_bind_zip").get(0)?.files?.[0];if(!c){toastr.error("请先选择 zip 文件");return}try{await Gt(c.name,await c.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(i){console.error("[Higanbana] bind local zip failed",i),toastr.error(`绑定失败：${i?.message??i}`)}}),$("#hb_bind_url_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const c=String($("#hb_bind_url").val()??"").trim();try{const{zipUrl:i,placeholder:u,homePage:d}=await er(c),s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&s.val(""),A(),$("#hb_new_title").val(""),U(`已添加项目（URL 模式）。
占位符：${u}
URL：${i}
入口：${d}
提示：进入聊天时会提示下载并导入缓存`),toastr.success("已添加 URL 项目")}catch(i){console.error("[Higanbana] bind url failed",i),toastr.error(`绑定失败：${i?.message??i}`)}}),$("#hb_download_url_btn").on("click",async()=>{try{await Dt()}catch(o){console.error("[Higanbana] download url apply failed",o),toastr.error(`操作失败：${o?.message??o}`)}}),$("#hb_cancel_url_download_btn").on("click",()=>{try{Ft()}catch{}})}let ue=!1;async function rr(e,t){const r=t.map(n=>{const a=n.source==="url"?n.zipSha256||n.zipUrl:n.zipSha256;return`${n.id}:${n.source}:${a}`}).join("|");try{const n=await Ue(new TextEncoder().encode(r).buffer);return`AlertHiganbana_${e}_projects_${n}`}catch{return`AlertHiganbana_${e}_projects_${r.slice(0,80)}`}}function nr(e){const r=(String(e??"").trim()||"x").replace(/[^a-zA-Z0-9_-]/g,"_");return r.startsWith("hb_")?r:`hb_${r}`}async function Oe(){const e=B(),t=x();if(!e||!t)return;const r=j(t.character);if(r.projects.length===0)return;const n=N(t.character);if(n&&!ue){ue=!0;try{const a=Re(n),o=r.projects.filter(p=>ie(p)),c=o.filter(p=>p.source!=="local"),i=o.filter(p=>p.source==="local");if(!(!a||o.length>0))return;const d=await rr(n,r.projects);try{if(e.accountStorage?.getItem?.(d))return;e.accountStorage?.setItem?.(d,"true")}catch{}let s=0,l=[];if(e.callGenericPopup&&e.POPUP_TYPE?.CONFIRM){const p=document.createElement("div"),b=document.createElement("h3");b.textContent="此角色卡包含 WebZip 前端项目。",p.appendChild(b);const h=document.createElement("h3");c.length>0?h.textContent=`发现 ${c.length} 个未缓存项目，是否下载并启用？`:i.length>0?h.textContent=`发现 ${i.length} 个“本地缓存模式”项目未命中缓存。`:h.textContent="是否启用它们？",p.appendChild(h);const f=document.createElement("div");if(f.className="m-b-1",f.style.opacity="0.85",f.textContent="你可以稍后在扩展栏的“彼岸花”面板里管理这些项目。",p.appendChild(f),i.length>0){const m=document.createElement("div");m.className="m-b-1",m.style.opacity="0.85",m.textContent="本地缓存模式不会把 zip 写入角色卡，因此无法自动下载恢复。请在本机重新导入本地 zip（可用“添加本地缓存项目（不嵌入）”）。",p.appendChild(m)}const g=new Map,w=c.length>0?c.map(m=>{const y=nr(`miss_${m.id}`);g.set(y,m.id);const v=m.title||m.zipName,k=m.source==="embedded"?"嵌入":m.source==="url"?"URL":"本地缓存",P=`${v}  |  ${k}  |  ${m.placeholder}`,M=m.source==="url"?m.zipUrl:m.source==="embedded"?"嵌入于角色卡":"仅本地缓存（不嵌入角色卡）";return{id:y,label:P,type:"checkbox",defaultState:!0,tooltip:M}}):null,_=c.length>0?"下载选中并启用":"启用",S=a?"取消":"否",C=c.length>0?["下载全部"]:null;if(s=await e.callGenericPopup(p,e.POPUP_TYPE.CONFIRM,"",{okButton:_,cancelButton:S,customButtons:C,customInputs:w,wide:!0}),!s)return;if(c.length>0)if(Number(s)>=2)l=[...c];else{const m=e.Popup?.util?.lastResult?.inputResults,y=new Set;for(const[v,k]of g)m?.get?.(v)&&y.add(k);l=c.filter(v=>y.has(v.id))}}else{if(!window.confirm(o.length>0?c.length>0?`此角色卡包含 WebZip 项目，且有 ${c.length} 个可自动下载的未缓存项目。是否启用并下载？`:"此角色卡包含本地缓存模式项目，但当前浏览器未命中缓存。是否先启用（稍后可在面板重新导入本地 zip）？":"此角色卡包含 WebZip 项目，是否启用？"))return;l=[...c]}W(n);try{if(l.length>0){toastr.info("开始下载/导入项目，请稍候...");const p=await ge(t.chid,l);if(p.cancelled){toastr.info("已取消导入");return}p.importedCount>0&&toastr.success(`已导入 ${p.importedCount} 个项目`)}i.length>0&&toastr.info(`检测到 ${i.length} 个本地缓存模式项目未命中缓存，请在“彼岸花”面板重新导入本地 zip。`),await e.reloadCurrentChat?.(),A(),H()}catch(p){console.error("[Higanbana] import queue failed",p),toastr.error(`导入失败：${p?.message??p}`)}}finally{ue=!1}}}let Ee=!1;function or(){if(Ee)return;const e=B();if(!e?.eventSource||!e?.event_types)return;Ee=!0;const t=()=>setTimeout(()=>{A(),H(),Oe().catch(r=>console.warn("[Higanbana] webzip check failed",r))},0);e.event_types.CHAT_CHANGED&&e.eventSource.on(e.event_types.CHAT_CHANGED,t),e.event_types.CHARACTER_DELETED&&e.eventSource.on(e.event_types.CHARACTER_DELETED,t)}async function ar(){Xe();const e=await Ut();await L(),await Ht(),Nt(),tr(),kt(),or(),A(),We(),Oe().catch(t=>console.warn("[Higanbana] webzip check failed",t)),U(`彼岸花：已加载。
Service Worker：${e?"已注册":"不可用（将无法渲染 WebZip）"}
提示：在本面板可把 zip 绑定到当前角色卡，导出角色卡时会一并导出。`)}function Be(){const e=B();return e?.eventSource&&e?.event_types?.APP_READY?(e.eventSource.on(e.event_types.APP_READY,()=>{ar().catch(t=>{console.error("[Higanbana] init failed",t),toastr.error(`彼岸花初始化失败：${t?.message??t}`)})}),!0):!1}function ir(){jQuery(()=>{if(Be())return;const e=setInterval(()=>{Be()&&clearInterval(e)},250)})}ir();
