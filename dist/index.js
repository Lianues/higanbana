import{H as Fe,i as ie}from"./hbHtmlRuntime.B7drXapj.chunk.js";const fe="st-higanbana-vfs-",R=new Set;async function L(){try{const e=await caches.keys();R.clear();for(const t of e)t.startsWith(fe)&&R.add(t.slice(fe.length))}catch(e){console.warn("[Higanbana] caches.keys failed",e)}}function ce(e){return!!e&&R.has(e)}function E(){const e=globalThis.SillyTavern;return e?.getContext?e.getContext():null}function j(){const e=E();if(!e)return null;const t=Number(e.characterId);if(!Number.isFinite(t)||t<0)return null;const r=e.characters?.[t];return r?{chid:t,character:r}:null}function Me(e){return String(e?.name??e?.data?.name??"").trim()||"(未命名角色)"}function N(e){return String(e?.avatar??"").trim()}function We(e){try{if(!e||typeof e!="object")return"";for(const t of Object.keys(e))if(String(t).toLowerCase()==="x-csrf-token"){const r=e[t];return typeof r=="string"?r:String(r||"")}}catch{}return""}function De(e){return Number.isFinite(e)?Math.max(80,Math.min(e,1e4)):0}function Oe(e,t){const r=String(e||"").trim();if(!r)return;const n=De(Number(t));if(!n)return;const a=document.querySelectorAll("iframe");for(const o of a){const s=o;s?.name===r&&(s.style.height=`${n}px`)}}async function Ge(e){const t=String(e?.id||""),r={__hb:"higanbana",v:1,kind:"res",id:t,ok:!1};if(!t)return{...r,error:"Missing id"};if(e.op==="getCsrfToken")try{const a=E()?.getRequestHeaders?.(),o=We(a);if(o)return{...r,ok:!0,data:o};const i=await(await fetch("/csrf-token",{method:"GET",credentials:"include"})).json().catch(()=>null),u=i&&typeof i=="object"?String(i.token||""):"";return{...r,ok:!0,data:u}}catch(n){return{...r,error:n?.message?String(n.message):String(n)}}if(e.op==="callSTAPI"){const n=String(e?.payload?.endpoint||""),a=e?.payload?.params??{};if(!n||!n.includes("."))return{...r,error:"Invalid endpoint"};const o=globalThis.ST_API;if(!o)return{...r,error:"ST_API not available"};const s=n.split(".");if(s.length!==2)return{...r,error:"Invalid endpoint format"};const[i,u]=s,d=o?.[i]?.[u];if(typeof d!="function")return{...r,error:`ST_API.${i}.${u} is not available`};try{const c=await d(a);return{...r,ok:!0,data:c}}catch(c){return{...r,error:c?.message?String(c.message):String(c)}}}return{...r,error:`Unsupported op: ${String(e?.op||"")}`}}function qe(){const e=globalThis;if(e.__HB_HTML_BRIDGE_SERVER__)return;e.__HB_HTML_BRIDGE_SERVER__={v:1};let t=null;try{t=new BroadcastChannel(Fe)}catch{t=null}const r=a=>{try{t?.postMessage(a)}catch{}},n=async(a,o,s)=>{if(!a||typeof a!="object")return;if(a.type==="HB_IFRAME_HEIGHT"){Oe(String(a.iframeName||""),Number(a.height));return}if(a.__hb!=="higanbana"||a.v!==1||a.kind!=="req")return;const u=await Ge(a);if(r(u),o&&typeof o.postMessage=="function")try{const d=s&&s!=="null"?s:"*";o.postMessage(u,d)}catch{}};try{t&&(t.onmessage=a=>void n(a.data))}catch{}try{window.addEventListener("message",a=>void n(a.data,a.source,a.origin))}catch{}}function B(e){const t={projects:[]},r=e?.data?.extensions?.higanbana;if(!r||typeof r!="object")return t;const n=r.projects;if(!Array.isArray(n))return t;const a=[];for(const o of n){if(!o||typeof o!="object")continue;const s=String(o.source??"").trim(),i=String(o.id??"").trim(),u=String(o.title??"").trim()||void 0,d=String(o.placeholder??"").trim(),c=String(o.homePage??"").trim(),l=typeof o.showTitleInChat=="boolean"?!!o.showTitleInChat:!1,p=!!o.fixRootRelativeUrls,f=String(o.zipName??"").trim(),h=String(o.zipSha256??"").trim();if(!(!i||!d||!c||!f)){if(s==="embedded"){const m=String(o.zipBase64??"").trim();if(!m||!h)continue;a.push({source:"embedded",id:i,title:u,placeholder:d,homePage:c,showTitleInChat:l,fixRootRelativeUrls:p,zipName:f,zipSha256:h,zipBase64:m});continue}if(s==="url"){const m=String(o.zipUrl??"").trim();if(!m)continue;a.push({source:"url",id:i,title:u,placeholder:d,homePage:c,showTitleInChat:l,fixRootRelativeUrls:p,zipName:f,zipSha256:h||"",zipUrl:m})}}}return{projects:a}}async function z(e,t){const r=E();if(!r?.writeExtensionField)throw new Error("writeExtensionField 不可用（酒馆版本过旧或上下文缺失）");await r.writeExtensionField(e,"higanbana",t)}const Ze="st-higanbana-vfs-";function Ve(e){return String(e).split("/").map(t=>encodeURIComponent(t)).join("/")}function ee(e,t,r){return`${e}vfs/${encodeURIComponent(t)}/${Ve(r)}`}function Je(e,t){return`${new URL(e).pathname}vfs/${encodeURIComponent(t)}/`}function Ye(e){return`${Ze}${e}`}function Ce(e){const t=String(e).toLowerCase();return t.endsWith(".html")||t.endsWith(".htm")?"text/html; charset=utf-8":t.endsWith(".css")?"text/css; charset=utf-8":t.endsWith(".js")||t.endsWith(".mjs")||t.endsWith(".cjs")?"application/javascript; charset=utf-8":t.endsWith(".json")||t.endsWith(".map")?"application/json; charset=utf-8":t.endsWith(".txt")?"text/plain; charset=utf-8":t.endsWith(".svg")?"image/svg+xml":t.endsWith(".png")?"image/png":t.endsWith(".jpg")||t.endsWith(".jpeg")?"image/jpeg":t.endsWith(".gif")?"image/gif":t.endsWith(".webp")?"image/webp":t.endsWith(".avif")?"image/avif":t.endsWith(".ico")?"image/x-icon":t.endsWith(".woff2")?"font/woff2":t.endsWith(".woff")?"font/woff":t.endsWith(".ttf")?"font/ttf":t.endsWith(".otf")?"font/otf":t.endsWith(".eot")?"application/vnd.ms-fontobject":t.endsWith(".wasm")?"application/wasm":"application/octet-stream"}function Xe(e){const t=Ce(e);return t.startsWith("text/")||t.includes("javascript")||t.includes("json")||t.includes("svg+xml")}function Ke(e){return new Promise((t,r)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onload=()=>t(),n.onerror=()=>r(new Error(`加载脚本失败: ${e}`)),document.head.appendChild(n)})}async function Qe(){const e=globalThis;if(e.JSZip)return e.JSZip;if(await Ke("/lib/jszip.min.js"),!e.JSZip)throw new Error("JSZip 未能加载（/lib/jszip.min.js）");return e.JSZip}function et(e){const t=e.filter(Boolean);if(t.length===0)return{prefix:"",stripped:[]};const r=new Set(t.map(s=>s.split("/")[0]).filter(Boolean));if(r.size!==1)return{prefix:"",stripped:t};const a=`${[...r][0]}/`;return t.some(s=>s.startsWith(a))?{prefix:a,stripped:t.map(s=>s.startsWith(a)?s.slice(a.length):s)}:{prefix:"",stripped:t}}function tt(e){let t=String(e??"").replace(/\\/g,"/").replace(/^\.\//,"").replace(/^\/+/,"");const r=t.split("/").filter(Boolean);return r.some(n=>n==="..")?null:(t=r.join("/"),t||null)}function xe(e){return String(e).split(/[?#]/,1)[0]}function rt(e){const t=new Set,r=new Set;for(const n of e){t.add(n);const a=n.split("/").filter(Boolean);for(let o=1;o<a.length;o++)r.add(a.slice(0,o).join("/")+"/")}return{fileSet:t,dirSet:r}}function V(e,t){const r=xe(e);return r?!!(t.fileSet.has(r)||t.dirSet.has(r.endsWith("/")?r:`${r}/`)):!1}function nt(e,t,r,n){let a=e;return r&&(a=a.replace(/<base\b([^>]*?)\bhref\s*=\s*(["'])\/\2([^>]*?)>/gi,(o,s,i,u)=>`<base${s}href=${i}${t}${i}${u}>`),a=a.replace(/(<\s*(?:script|img|source|video|audio)\b[^>]*\bsrc\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(o,s,i,u)=>V(u,n)?`${s}${t}${u}${i}`:o),a=a.replace(/(<\s*link\b[^>]*\bhref\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(o,s,i,u)=>V(u,n)?`${s}${t}${u}${i}`:o)),a}function ot(e,t,r,n){if(!r)return e;let a=String(e);return a=a.replace(/url\(\s*(["'])?\/(?!\/)([^"')]+)\1\s*\)/gi,(o,s="",i)=>V(i,n)?`url(${s}${t}${i}${s})`:o),a=a.replace(/@import\s+(?:url\(\s*)?(["'])?\/(?!\/)([^"')\s]+)\1\s*\)?/gi,(o,s="",i)=>V(i,n)?o.toLowerCase().includes("url(")?`@import url(${s}${t}${i}${s})`:`@import ${s}${t}${i}${s}`:o),a}function at(e){return!e||/\s/.test(e)?!1:e.endsWith("/")?!0:(e.split("/").filter(Boolean).pop()||"").includes(".")}function it(e,t,r,n){if(!r)return e;let a=String(e);return a=a.replace(/(["'`])\/(?!\/)([^"'`]*?)\1/g,(o,s,i)=>{const u=xe(i);return!at(u)||!V(i,n)?o:`${s}${t}${i}${s}`}),a=a.replace(/(__webpack_require__\.p\s*=\s*)(["'])\/\2/g,(o,s,i)=>`${s}${i}${t}${i}`),a=a.replace(/(__webpack_public_path__\s*=\s*)(["'])\/\2/g,(o,s,i)=>`${s}${i}${t}${i}`),a}async function Se(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(r=>r.toString(16).padStart(2,"0")).join("")}function ct(e){const t=new Uint8Array(e),r=32768;let n="";for(let a=0;a<t.length;a+=r){const o=t.subarray(a,a+r);n+=String.fromCharCode(...o)}return btoa(n)}function J(e){const t=atob(e),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r.buffer}function Y(e){const t=Number(e);if(!Number.isFinite(t)||t<0)return"0 B";const r=["B","KB","MB","GB","TB"];let n=t,a=0;for(;n>=1024&&a<r.length-1;)n/=1024,a++;const o=n>=100?0:n>=10?1:2;return`${n.toFixed(o)} ${r[a]}`}function st(e){if(e===null)return"—";const t=Number(e);return!Number.isFinite(t)||t<=0?"—":`${Y(t)}/s`}function lt(e){if(e===null)return"—";const t=Number(e);return Number.isFinite(t)?`${Math.max(0,Math.min(t,100)).toFixed(1)}%`:"—"}function te(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}async function X(e,t={}){const r=Math.max(30,Number(t.progressThrottleMs??120)),n=t.onProgress,a=te(),o=await fetch(e,{method:"GET",signal:t.signal});if(!o.ok)throw new Error(`下载失败: ${o.status} ${o.statusText}`);const s=o.headers.get("content-type"),i=o.url||e,u=o.headers.get("content-length"),d=u?Number(u):NaN,c=Number.isFinite(d)&&d>0?d:null,p=o.body?.getReader?.();if(!p){const b=await o.arrayBuffer(),y=Math.max(0,te()-a),x=b.byteLength,k=c??x,P=k?x/k*100:null,q=y>0?x/y*1e3:null;return n?.({loadedBytes:x,totalBytes:k,percent:P,speedBps:q,elapsedMs:y}),{arrayBuffer:b,totalBytes:k,contentType:s,finalUrl:i}}const f=[];let h=0,m=0,g=0,w=null;const _=(b=!1)=>{if(!n)return;const y=te(),x=Math.max(0,y-a);if(!b&&m&&y-m<r)return;if(m){const P=y-m;P>0&&(w=(h-g)/P*1e3)}m=y,g=h;const k=c?h/c*100:null;n({loadedBytes:h,totalBytes:c,percent:k,speedBps:w,elapsedMs:x})};_(!0);try{for(;;){const{done:b,value:y}=await p.read();if(b)break;y&&(f.push(y),h+=y.byteLength,_(!1))}}finally{try{p.releaseLock()}catch{}}_(!0);const v=new Uint8Array(h);let C=0;for(const b of f)v.set(b,C),C+=b.byteLength;return{arrayBuffer:v.buffer,totalBytes:c??h,contentType:s,finalUrl:i}}async function O(e,t,r){const n=await Qe(),a=await Se(t),o=Ye(a),s=await caches.open(o),i=Je(e,a),u=await n.loadAsync(t),l=Object.values(u.files||{}).filter(b=>b&&!b.dir).map(b=>({entry:b,path:tt(b.name)})).filter(b=>!!b.path);if(l.length===0)throw new Error("zip 内没有可导入的文件");const{stripped:p}=et(l.map(b=>b.path)),f=l.map((b,y)=>({entry:b.entry,path:p[y]})).filter(b=>!!b.path),h=f.map(b=>String(b.path)),m=rt(h),g=f.map(b=>b.path).filter(b=>/\.(html?|HTML?)$/i.test(b)).sort((b,y)=>b.localeCompare(y)),w=r.preferredHomePage?.trim(),_=w?g.includes(w):!1,v=g.some(b=>b.toLowerCase()==="index.html");let C=w&&_?w:"";C||(v?C=g.find(b=>b.toLowerCase()==="index.html"):g.length>0?C=g[0]:C="index.html");for(let b=0;b<f.length;b++){const{entry:y,path:x}=f[b],k=Ce(x);let P;if(Xe(x)){let S=await y.async("string");k.startsWith("text/html")?(S=nt(S,i,r.fixRootRelativeUrls,m),P=S):k.startsWith("text/css")?P=ot(S,i,r.fixRootRelativeUrls,m):k.includes("javascript")?P=it(S,i,r.fixRootRelativeUrls,m):P=S}else{const S=await y.async("uint8array"),pe=new Uint8Array(S.byteLength);pe.set(S),P=new Blob([pe],{type:k})}const q=ee(e,a,x);await s.put(new Request(q,{method:"GET"}),new Response(P,{headers:{"Content-Type":k}})),b%75===0&&await new Promise(S=>setTimeout(S,0))}return{projectId:a,homePage:C,htmlFiles:g,fileCount:f.length,cacheName:o}}const U=String(import.meta.url).replace(/[^/]*$/,""),dt=`${U}sw.js`,re="higanbana",F=Object.freeze({placeholder:"{{WEB_HOME}}",defaultFixRootRelativeUrls:!0,renderHtmlCodeBlocks:!1,renderHtmlCodeBlocksUseBlobUrl:!1,renderHtmlCodeBlocksShowTitleBar:!1,allowedCharacterAvatars:[]});function I(){const e=E();if(!e)return structuredClone(F);e.extensionSettings[re]=e.extensionSettings[re]||{};const t=e.extensionSettings[re];return(typeof t.placeholder!="string"||!t.placeholder.trim())&&(t.placeholder=F.placeholder),typeof t.defaultFixRootRelativeUrls!="boolean"&&(t.defaultFixRootRelativeUrls=F.defaultFixRootRelativeUrls),typeof t.renderHtmlCodeBlocks!="boolean"&&(t.renderHtmlCodeBlocks=F.renderHtmlCodeBlocks),typeof t.renderHtmlCodeBlocksUseBlobUrl!="boolean"&&(t.renderHtmlCodeBlocksUseBlobUrl=F.renderHtmlCodeBlocksUseBlobUrl),typeof t.renderHtmlCodeBlocksShowTitleBar!="boolean"&&(t.renderHtmlCodeBlocksShowTitleBar=F.renderHtmlCodeBlocksShowTitleBar),Array.isArray(t.allowedCharacterAvatars)?t.allowedCharacterAvatars=t.allowedCharacterAvatars.map(r=>String(r).trim()).filter(r=>r.length>0):t.allowedCharacterAvatars=[],t}function W(){E()?.saveSettingsDebounced?.()}function je(e){return I().allowedCharacterAvatars.includes(e)}function G(e){const t=I();t.allowedCharacterAvatars.includes(e)||(t.allowedCharacterAvatars.push(e),W())}const me=new WeakMap;function ut(e){try{const t=e.contentDocument;if(!t)return null;const r=t.body,n=t.documentElement;if(!r||!n)return null;const a=r.scrollHeight||0,o=n.scrollHeight||0,s=r.offsetHeight||0,i=n.offsetHeight||0,u=Math.max(a,o,s,i);return!Number.isFinite(u)||u<=0?null:u}catch{return null}}function Q(e){const t=ut(e);if(!t)return;const r=Math.max(80,Math.min(t,1e4));e.style.height=`${r}px`}function Ee(e){me.get(e)?.ro?.disconnect?.();const r={};me.set(e,r);const n=()=>{Q(e),setTimeout(()=>Q(e),50),setTimeout(()=>Q(e),250);try{const a=e.contentDocument;if(!a?.documentElement)return;const o=new ResizeObserver(()=>Q(e));o.observe(a.documentElement),a.body&&o.observe(a.body),r.ro=o}catch{}};n(),e.addEventListener("load",n)}function ht(e){const t=j();if(!t)return{kind:"stub",title:"彼岸花：无法渲染",reason:"当前不在单角色聊天/未选中角色。"};const r=e.title||e.zipName,n=N(t.character);if(n&&!je(n))return{kind:"stub",title:`彼岸花：未启用（${r}）`,reason:e.source==="url"?"该角色卡绑定了 WebZip URL，但尚未允许/下载。切换到该角色时会弹窗询问，或在面板/弹窗中下载并导入缓存。":"该角色卡包含嵌入 WebZip，但尚未允许/导入。切换到该角色时会弹窗询问，或在面板点“导入所有嵌入项目到本地缓存”。"};const a=e.zipSha256;return a?ce(a)?{kind:"iframe",src:ee(U,a,e.homePage),title:`彼岸花：${r} · ${e.homePage}`}:{kind:"stub",title:`彼岸花：未导入缓存（${r}）`,reason:e.source==="url"?"请下载并导入缓存后即可渲染。":"请先导入到本地缓存（面板中可操作），再刷新聊天即可渲染。"}:{kind:"stub",title:`彼岸花：未下载（${r}）`,reason:e.source==="url"?"请在面板/弹窗中下载并导入缓存后即可渲染。":"缺少 projectId，无法渲染。"}}function Be(e,t,r,n={}){const a=document.createElement("div");a.className="hb-embed",a.dataset.hbEmbed="1",a.classList.add(r.kind==="stub"?"hb-embed-stub":"hb-embed-iframe"),n.projectId&&(a.dataset.hbProjectId=n.projectId),n.showTitleInChat===!0||a.classList.add("hb-embed-no-title");const s=document.createElement("div");s.className="hb-embed-header";const i=document.createElement("div");i.className="hb-embed-title",i.textContent=r.title;const u=document.createElement("div");if(u.className="hb-embed-actions",r.kind==="iframe"){const p=document.createElement("a");p.href=n.openInNewTabUrl||r.src,p.target="_blank",p.rel="noopener noreferrer",p.textContent="新标签页打开",u.appendChild(p)}s.appendChild(i),s.appendChild(u),a.appendChild(s);const d=document.createElement("div");if(d.className="hb-embed-body",r.kind==="stub"){const p=document.createElement("div");return p.style.padding="10px",p.style.opacity="0.9",p.textContent=r.reason,d.appendChild(p),a.appendChild(d),a}const c=document.createElement("iframe");c.className="hb-iframe",c.loading="lazy",c.referrerPolicy="no-referrer",c.name=`hb-${e}-${t}`,c.setAttribute("sandbox","allow-scripts allow-same-origin");const l=!!n.projectId||n.useBlobUrlInChat===!0;try{c.dataset=c.dataset||{},c.dataset.hbVfsHomeUrl=r.src,c.dataset.hbUseBlobUrl=l?"1":"0"}catch{}return l?(c.removeAttribute("src"),c.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',ke(c,r.src)):(c.removeAttribute("srcdoc"),c.src=r.src),Ee(c),d.appendChild(c),a.appendChild(d),a}const be=new Map;function pt(e){const t=String(e??"").trim();return`<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      *{box-sizing:border-box}
      html,body{margin:0;padding:0;width:100%}
      #inner{display:block;width:100%;border:0;height:260px}
      .loading{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:12px;opacity:.85}
    </style>
  </head>
  <body>
    <div class="loading" id="loading">正在加载…</div>
    <iframe id="inner" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer"></iframe>
    <script>
      const VFS_URL = ${JSON.stringify(t)};
      const inner = document.getElementById('inner');
      const loading = document.getElementById('loading');
      const clamp = (h) => Math.max(80, Math.min(Number(h) || 0, 10000));
      const setHeight = (h) => {
        const px = clamp(h);
        if (!px) return;
        inner.style.height = px + 'px';
      };

      try { inner.name = String(window.name || ''); } catch {}
      try { inner.src = VFS_URL; } catch {}

      inner.addEventListener('load', () => {
        try { if (loading) loading.style.display = 'none'; } catch {}
      });

      window.addEventListener('message', (ev) => {
        const data = ev && ev.data;
        if (!data || typeof data !== 'object') return;

        // Height message from inner
        if (ev.source === inner.contentWindow && data.type === 'HB_IFRAME_HEIGHT') {
          setHeight(data.height);
          return;
        }

        // Bridge messages between inner <-> parent (for ST_API / CSRF proxy)
        if (data.__hb === 'higanbana' && data.v === 1) {
          try {
            if (ev.source === inner.contentWindow) {
              window.parent && window.parent.postMessage(data, '*');
              return;
            }
            if (ev.source === window.parent) {
              inner.contentWindow && inner.contentWindow.postMessage(data, '*');
            }
          } catch {
            // ignore
          }
        }
      });
    <\/script>
  </body>
</html>`}async function ft(e){const t=String(e??"").trim();if(!t)throw new Error("vfsHomeUrl is required");const r=be.get(t);if(r)return await r.promise;const n={promise:(async()=>{const a=pt(t),o=URL.createObjectURL(new Blob([a],{type:"text/html"}));return n.url=o,o})()};return be.set(t,n),await n.promise}async function ke(e,t){try{const r=String(t??"").trim();if(!r)return;e.dataset=e.dataset||{},e.dataset.hbVfsHomeUrl=r,e.dataset.hbUseBlobUrl="1";const n=await ft(r);if(!e.isConnected)return;const a=String(e.dataset?.hbVfsHomeUrl??"");if(!(String(e.dataset?.hbUseBlobUrl??"")==="1")||a!==r)return;e.removeAttribute("srcdoc"),e.src=n}catch(r){console.warn("[Higanbana] blob render failed, fallback to VFS",{vfsHomeUrl:t,err:r});try{if(!e.isConnected)return;e.removeAttribute("srcdoc"),e.src=String(t??"")}catch{}}}function mt(e,t){if(!e)return;const r=document.querySelectorAll(".hb-embed[data-hb-project-id]");for(const n of r)String(n.dataset?.hbProjectId??"")===e&&(t?n.classList.remove("hb-embed-no-title"):n.classList.add("hb-embed-no-title"))}function Pe(){const e=document.querySelectorAll(".hb-embed.hb-embed-iframe[data-hb-project-id]");for(const t of e){const r=t.querySelector("iframe.hb-iframe");if(!r)continue;const n=String(r.src||"");if(n.startsWith("blob:"))continue;const a=t.querySelector(".hb-embed-actions a"),o=String(a?.href||r.dataset?.hbVfsHomeUrl||n||"").trim();o&&(r.removeAttribute("src"),r.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',ke(r,o))}}function bt(e){const t=String(e??"").toLowerCase();return t.includes("<html")||t.includes("<head")||t.includes("<body")||t.includes("<!doctype html")}function se(e){const r=String(e??"").trim(),n=r.toLowerCase();return r?n.includes("<!doctype")||n.includes("<html")?r:`<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><body>${r}</body>`:'<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'}function gt(e){let t=2166136261;for(let r=0;r<e.length;r++)t^=e.charCodeAt(r),t=Math.imul(t,16777619);return(t>>>0).toString(16)}function ge(e,t){const r=ie(se(t),{origin:window.location.origin,forceBaseHref:!0}),n=gt(r),a=String(e.dataset?.hbHtmlHash??""),o=String(e.dataset?.hbHtmlBlobUrl??"");if(o&&a===n)return o;if(o)try{URL.revokeObjectURL(o)}catch{}const s=URL.createObjectURL(new Blob([r],{type:"text/html"}));return e.dataset.hbHtmlHash=n,e.dataset.hbHtmlBlobUrl=s,s}function Ue(e,t){const r=I(),n=!!r.renderHtmlCodeBlocks,a=!!r.renderHtmlCodeBlocksUseBlobUrl,o=!!r.renderHtmlCodeBlocksShowTitleBar,s=a||o,i=Array.from(e.querySelectorAll(".hb-html-render"));if(!n){for(const c of i){const l=String(c.dataset?.hbHtmlBlobUrl??"");if(l)try{URL.revokeObjectURL(l)}catch{}const p=c.querySelector("pre");p&&c.parentNode&&(p.classList.remove("hb-html-code-hidden"),c.parentNode.insertBefore(p,c)),c.remove()}return}const u=Array.from(e.querySelectorAll("pre > code"));if(u.length===0)return;for(const c of i)c.querySelectorAll(".hb-embed").forEach(l=>l.remove()),c.querySelectorAll("iframe.hb-html-iframe").forEach(l=>l.remove());let d=e.querySelectorAll(".hb-embed").length;for(const c of u){const l=c.closest("pre");if(!l)continue;const p=c.textContent||"";if(!bt(p))continue;const f=l.closest(".hb-html-render"),h=f||document.createElement("div");if(!f){h.className="hb-html-render",h.dataset.hbHtmlRender="1";const _=l.parentNode;if(!_)continue;_.insertBefore(h,l),h.appendChild(l)}if(l.classList.add("hb-html-code-hidden"),!s){const _=String(h.dataset?.hbHtmlBlobUrl??"");if(_)try{URL.revokeObjectURL(_)}catch{}try{delete h.dataset.hbHtmlBlobUrl,delete h.dataset.hbHtmlHash}catch{}}const m=a?ge(h,p):"";if(o){const _=ie(se(p),{origin:window.location.origin,forceBaseHref:!1}),v={kind:"iframe",src:a&&m?m:"about:blank",title:"HTML 代码块"},C=Be(t,d++,v,{showTitleInChat:!0,openInNewTabUrl:a&&m?m:"#"}),b=h.querySelector(".hb-embed");if(b&&b.remove(),h.appendChild(C),!a){const y=C.querySelector("iframe.hb-iframe");y&&(y.removeAttribute("src"),y.srcdoc=_);const x=C.querySelector(".hb-embed-actions a");x&&String(x.dataset?.hbHtmlLazyOpenBound??"")!=="1"&&(x.dataset.hbHtmlLazyOpenBound="1",x.href="#",x.addEventListener("click",k=>{try{k.preventDefault();const P=ge(h,p);window.open(P,"_blank","noopener,noreferrer")}catch{}}))}continue}const g=h.querySelector(".hb-embed");g&&g.remove();let w=h.querySelector("iframe.hb-html-iframe");w||(w=document.createElement("iframe"),w.className="hb-html-iframe",w.loading="lazy",w.referrerPolicy="no-referrer",w.name=`hb-html-${t}`,w.setAttribute("sandbox","allow-scripts allow-same-origin"),Ee(w),h.appendChild(w)),a&&m?(w.removeAttribute("srcdoc"),w.src=m):(w.removeAttribute("src"),w.srcdoc=ie(se(p),{origin:window.location.origin,forceBaseHref:!1}))}}function wt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ae(e,t){const r=j();if(!r)return;const n=B(r.character);if(n.projects.length===0)return;const a=new Map;for(const m of n.projects){const g=String(m.placeholder??"").trim();g&&(a.has(g)||a.set(g,m))}const o=Array.from(a.keys());if(o.length===0)return;const s=e.textContent||"";let i=!1;for(const m of o)if(s.includes(m)){i=!0;break}if(!i)return;o.sort((m,g)=>g.length-m.length);const u=o.map(wt).join("|"),d=new RegExp(u,"g"),c=new RegExp(u),l=new Map;for(const m of o){const g=a.get(m);g&&l.set(m,ht(g))}let p=0;const f=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode(m){const g=m?.nodeValue||"";if(!g||!c.test(g))return NodeFilter.FILTER_REJECT;let w=m.parentNode;for(;w&&w!==e;){if(w.nodeType===1){const _=w.tagName;if(_==="CODE"||_==="PRE"||_==="TEXTAREA")return NodeFilter.FILTER_REJECT}w=w.parentNode}return NodeFilter.FILTER_ACCEPT}}),h=[];for(;f.nextNode();)h.push(f.currentNode);for(const m of h){const g=m.nodeValue||"";if(!c.test(g))continue;d.lastIndex=0;let w=0;const _=document.createDocumentFragment();for(const v of g.matchAll(d)){const C=Number(v.index??0),b=String(v[0]??"");C>w&&_.appendChild(document.createTextNode(g.slice(w,C)));const y=a.get(b),x=l.get(b);x?_.appendChild(Be(t,p++,x,{projectId:y?.id,showTitleInChat:y?.showTitleInChat,useBlobUrlInChat:!0,openInNewTabUrl:x.kind==="iframe"?x.src:void 0})):_.appendChild(document.createTextNode(b)),w=C+b.length}w<g.length&&_.appendChild(document.createTextNode(g.slice(w))),m.parentNode?.replaceChild(_,m)}}function ne(e){const t=Number(e);if(!Number.isFinite(t))return;const r=$(`#chat .mes[mesid="${t}"]`);if(r.length===0)return;const n=r.find(".mes_text").get(0);n&&(Ae(n,t),Ue(n,t),Pe())}function Re(){const e=document.querySelectorAll("#chat .mes[mesid]");for(const t of e){const r=t.getAttribute("mesid"),n=Number(r);if(!Number.isFinite(n))continue;const a=t.querySelector(".mes_text");a&&(Ae(a,n),Ue(a,n))}Pe()}let oe=!1;function H(){oe||(oe=!0,setTimeout(()=>{oe=!1,Re()},0))}let we=!1;function yt(){if(we)return;const e=E();if(!e?.eventSource||!e?.event_types)return;we=!0;const{eventSource:t,event_types:r}=e,n=(...o)=>ne(o?.[0]),a=(...o)=>{const s=Number(o?.[0]);Number.isFinite(s)&&(setTimeout(()=>ne(s),0),setTimeout(()=>ne(s),50))};t.on(r.USER_MESSAGE_RENDERED,n),t.on(r.CHARACTER_MESSAGE_RENDERED,n),r.MESSAGE_EDITED&&t.on(r.MESSAGE_EDITED,a),r.MESSAGE_UPDATED&&t.on(r.MESSAGE_UPDATED,a),r.MORE_MESSAGES_LOADED&&t.on(r.MORE_MESSAGES_LOADED,()=>H()),r.CHAT_CHANGED&&t.on(r.CHAT_CHANGED,()=>H())}function _t(e,t=15e3){return new Promise((r,n)=>{let a=!1;const o=f=>{a||(a=!0,u(),f?n(f):r())},s=setTimeout(()=>{o(new Error("Service Worker 激活超时（可能是非安全上下文或被浏览器策略禁止）"))},t),i=[],u=()=>{clearTimeout(s);for(const f of i)try{f()}catch{}},d=()=>{try{e.waiting?.postMessage?.({type:"HB_SKIP_WAITING"})}catch{}},c=()=>{try{e.active?.state==="activated"&&o()}catch{}},l=f=>{if(!f)return;if(f.state==="activated"){o();return}const h=()=>{d(),f.state==="activated"&&o()};f.addEventListener("statechange",h),i.push(()=>f.removeEventListener("statechange",h))},p=()=>{d(),l(e.installing),c()};e.addEventListener("updatefound",p),i.push(()=>e.removeEventListener("updatefound",p)),d(),l(e.installing||e.waiting||e.active),c()})}async function vt(){if(!("serviceWorker"in navigator))return console.warn("[Higanbana] Service Worker not supported"),null;try{const e=await navigator.serviceWorker.register(dt,{scope:U,type:"module"});return e.update().catch(()=>{}),await _t(e),e}catch(e){return console.warn("[Higanbana] sw register failed",e),null}}const D={urlDownloadPopupInFlight:!1};function le(e){const t=Y(e.loadedBytes),r=e.totalBytes?Y(e.totalBytes):"?",n=e.totalBytes?lt(e.percent):"—",a=st(e.speedBps);return`下载：${t} / ${r}（${n}） | 速度：${a}`}function He(){try{if(typeof crypto<"u"&&"randomUUID"in crypto&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}const e=E();try{const t=e?.uuidv4;if(typeof t=="function")return String(t())}catch{}return`hb_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,10)}`}function de(e){return String(e??"").trim()}function ue(e,t){const r=new Set(e.map(a=>a.placeholder));let n=de(t);if(n||(n=`{{WEB_${e.length+1}}}`),!r.has(n))return n;for(let a=2;a<1e3;a++){const o=`_${a}`,s=n.endsWith("}}")?n.slice(0,-2)+o+"}}":n+o;if(!r.has(s))return s}return n}function Ie(e,t){const r=document.createElement("a");r.href=URL.createObjectURL(e),r.setAttribute("download",t),document.body.appendChild(r),r.click(),URL.revokeObjectURL(r.href),document.body.removeChild(r)}function $t(e){const t=String(e??"").trim();if(!t)return null;try{const r=new URL(t);return r.protocol!=="http:"&&r.protocol!=="https:"?null:r.toString()}catch{return null}}function Ct(e){try{const r=new URL(e).pathname.split("/").filter(Boolean).pop()||"webzip.zip";return r.endsWith(".zip")?r:`${r}.zip`}catch{return"webzip.zip"}}function xt(e){const t=e?.projects??[];if(t.length===0)return"（无）";const r=t.slice(0,3).map(a=>a.title||a.zipName).filter(Boolean),n=t.length>r.length?` +${t.length-r.length}`:"";return`项目数：${t.length}${r.length?` | ${r.join(" / ")}${n}`:""}`}function St(e,t){try{const r=localStorage.getItem(e);return r===null?t:r==="1"}catch{return t}}function jt(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Te(){const e=document.getElementById("higanbana_settings");if(!e)return;const t=Array.from(e.querySelectorAll(".hb-subpanel"));for(const r of t){const n=String(r.dataset.id??"").trim();if(!n)continue;const a=r.querySelector(".hb-subpanel-header"),o=r.querySelector(".hb-subpanel-indicator"),s=r.querySelector(".hb-subpanel-body");if(!a||!o||!s||a.dataset?.hbBound==="1")continue;a.dataset.hbBound="1";const i=`higanbana.subpanel.open.${n}`,u=a.getAttribute("aria-expanded")==="true",d=c=>{a.setAttribute("aria-expanded",c?"true":"false"),o.textContent=c?"−":"+",s.style.display=c?"block":"none"};d(St(i,u)),a.addEventListener("click",()=>{const l=!(a.getAttribute("aria-expanded")==="true");d(l),jt(i,l)})}}function ye(e){const t=document.getElementById("hb_projects_list");if(!t)return;if(t.innerHTML="",e.length===0){const n=document.createElement("div");n.className="hb-subhint",n.textContent="（暂无项目）",t.appendChild(n);return}const r=document.createDocumentFragment();for(const n of e){const a=document.createElement("section");a.className="hb-subpanel hb-project",a.dataset.id=`project_${n.id}`,a.dataset.projectId=n.id;const o=document.createElement("button");o.className="hb-subpanel-header",o.type="button",o.setAttribute("aria-expanded","false");const s=document.createElement("div");s.className="hb-subpanel-title",s.textContent=`${n.title||n.zipName}  ${n.placeholder}`;const i=document.createElement("div");i.className="hb-subpanel-indicator",i.textContent="+",o.appendChild(s),o.appendChild(i),a.appendChild(o);const u=document.createElement("div");u.className="hb-subpanel-body",u.style.display="none";const d=c=>{const l=document.createElement("div");l.className="hb-row";const p=document.createElement("label");return p.className="hb-label",p.textContent=c,l.appendChild(p),l};{const c=d("标题"),l=document.createElement("input");l.className="text_pole hb-proj-title",l.type="text",l.spellcheck=!1,l.value=n.title||"",l.dataset.projectId=n.id,c.appendChild(l),u.appendChild(c)}{const c=d("占位符"),l=document.createElement("input");l.className="text_pole hb-proj-placeholder",l.type="text",l.spellcheck=!1,l.value=n.placeholder,l.dataset.projectId=n.id,c.appendChild(l);const p=document.createElement("div");p.className="hb-actions";const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="copy_placeholder",f.dataset.projectId=n.id,f.textContent="复制";const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="insert_placeholder",h.dataset.projectId=n.id,h.textContent="插入到输入框",p.appendChild(f),p.appendChild(h),c.appendChild(p),u.appendChild(c)}{const c=d("入口 HTML"),l=document.createElement("input");l.className="text_pole hb-proj-home",l.type="text",l.spellcheck=!1,l.value=n.homePage,l.dataset.projectId=n.id,c.appendChild(l),u.appendChild(c)}{const c=d("修复 root 相对路径（/xxx）"),l=document.createElement("input");l.className="hb-proj-fix",l.type="checkbox",l.checked=!!n.fixRootRelativeUrls,l.dataset.projectId=n.id,c.appendChild(l),u.appendChild(c)}{const c=d("消息列表显示标题"),l=document.createElement("input");l.className="hb-proj-show-title",l.type="checkbox",l.checked=!!n.showTitleInChat,l.dataset.projectId=n.id,c.appendChild(l),u.appendChild(c)}{const c=d("操作"),l=document.createElement("div");if(l.className="hb-actions",n.source==="embedded"){const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="import_cache",h.dataset.projectId=n.id,h.textContent="导入到缓存",l.appendChild(h);const m=document.createElement("button");m.className="menu_button",m.type="button",m.dataset.hbAction="export_zip",m.dataset.projectId=n.id,m.textContent="导出 zip",l.appendChild(m)}else{const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="download_apply",h.dataset.projectId=n.id,h.textContent="下载并应用",l.appendChild(h)}const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="open_home",p.dataset.projectId=n.id,p.textContent="打开首页",l.appendChild(p);const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="delete_project",f.dataset.projectId=n.id,f.textContent="删除项目",l.appendChild(f),c.appendChild(l),u.appendChild(c)}a.appendChild(u),r.appendChild(a)}t.appendChild(r),Te()}async function Et(){$("#higanbana_settings").remove();const e=await fetch(`${U}settings.html`,{cache:"no-store"});if(!e.ok)throw new Error(`加载 settings.html 失败: ${e.status}`);const t=await e.text();$("#extensions_settings").append(t)}function Bt(){const e=I();$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_render_html_blocks").prop("checked",!!e.renderHtmlCodeBlocks),$("#hb_render_html_blocks_blob").prop("checked",!!e.renderHtmlCodeBlocksUseBlobUrl),$("#hb_render_html_blocks_titlebar").prop("checked",!!e.renderHtmlCodeBlocksShowTitleBar);const t=$("#hb_homepage");t.length&&!String(t.val()??"").trim()&&t.val("index.html")}function A(){const e=I(),t=j();if(!t){$("#hb_char_info").text("（未选中角色）"),$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_homepage").val(String($("#hb_homepage").val()??"").trim()||"index.html"),ye([]),$("#hb_import_from_card").prop("disabled",!0),$("#hb_unbind").prop("disabled",!0),$("#hb_pick_zip_btn").prop("disabled",!0),$("#hb_bind_zip").prop("disabled",!0),$("#hb_bind_zip_btn").prop("disabled",!0),$("#hb_bind_url").prop("disabled",!0),$("#hb_bind_url_btn").prop("disabled",!0);return}const{chid:r,character:n}=t,a=Me(n),o=N(n);$("#hb_char_info").text([`名称：${a}`,`chid：${r}`,o?`avatar：${o}`:""].filter(Boolean).join(`
`));const s=B(n);ye(s.projects);const i=s.projects.length>0;$("#hb_import_from_card").prop("disabled",!s.projects.some(l=>l.source==="embedded")),$("#hb_unbind").prop("disabled",!i),$("#hb_pick_zip_btn").prop("disabled",!1),$("#hb_bind_zip").prop("disabled",!1),$("#hb_bind_zip_btn").prop("disabled",!1),$("#hb_bind_url").prop("disabled",!1),$("#hb_bind_url_btn").prop("disabled",!1);const u=$("#hb_fix_root_relative");u.length&&document.activeElement!==u.get(0)&&u.prop("checked",!!e.defaultFixRootRelativeUrls);const d=$("#hb_homepage");d.length&&document.activeElement!==d.get(0)&&!String(d.val()??"").trim()&&d.val("index.html");const c=$("#hb_placeholder");c.length&&document.activeElement!==c.get(0)&&!String(c.val()??"").trim()&&c.val(ue(s.projects,`{{WEB_${s.projects.length+1}}}`))}function T(e){$("#hb_status").text(e)}function he(e){return e.source==="url"?e.zipSha256?!ce(e.zipSha256):!0:!ce(e.zipSha256)}function ze(e){const t=document.createElement("div"),r=document.createElement("h3");r.textContent=e,t.appendChild(r);const n=document.createElement("progress");n.max=100,n.value=0,n.style.width="100%",n.style.height="12px",t.appendChild(n);const a=document.createElement("div");return a.style.marginTop="8px",a.style.opacity="0.9",a.style.whiteSpace="nowrap",a.style.overflowX="auto",a.style.overflowY="hidden",t.appendChild(a),{root:t,titleEl:r,progress:n,text:a}}async function Ne(e,t){const r=E();if(!r)throw new Error("上下文缺失");const n=t.filter(f=>he(f));if(n.length===0)return{importedCount:0,cancelled:!1};if(!r.callGenericPopup||!r.POPUP_TYPE){let f=0;for(const h of n){const m=j();if(!m||Number(m.chid)!==Number(e))break;const g=h.title||h.zipName;T(`正在导入：${g} ...`);let w;h.source==="url"?w=(await X(h.zipUrl)).arrayBuffer:w=J(h.zipBase64);const _=await O(U,w,{fixRootRelativeUrls:h.fixRootRelativeUrls,preferredHomePage:h.homePage});R.add(_.projectId),await L();const C=B(m.character).projects.map(b=>b.id===h.id?{...b,zipSha256:_.projectId,homePage:_.homePage}:b);await z(e,{projects:C}),f++}return{importedCount:f,cancelled:!1}}if(D.urlDownloadPopupInFlight)throw new Error("当前已有下载弹窗进行中，请稍后再试");D.urlDownloadPopupInFlight=!0;const a=new AbortController;let o=!1,s=!1,i=0;const{root:u,titleEl:d,progress:c,text:l}=ze("彼岸花：准备导入...");l.style.whiteSpace="pre-wrap",l.style.overflowX="hidden";const p=f=>{try{l.textContent=le(f)}catch{l.textContent="正在下载..."}if(f?.totalBytes){const h=Number(f?.percent);Number.isFinite(h)&&(c.max=100,c.value=Math.max(0,Math.min(100,h)))}else c.removeAttribute("value")};try{await r.callGenericPopup(u,r.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消",onClosing:()=>(o||(s=!0,a.abort()),!0),onOpen:async f=>{try{for(let h=0;h<n.length;h++){const m=n[h];if(a.signal.aborted)break;const g=j();if(!g||Number(g.chid)!==Number(e))break;const w=m.title||m.zipName;d.textContent=`彼岸花：正在导入（${h+1}/${n.length}）${w}`;let _;m.source==="url"?(l.textContent=`准备下载：${m.zipName}
${m.zipUrl}`,c.max=100,c.value=0,_=(await X(m.zipUrl,{signal:a.signal,onProgress:p})).arrayBuffer,c.value=100,l.textContent=`下载完成（${Y(_.byteLength)}），正在解压并写入缓存...`):(c.removeAttribute("value"),l.textContent=`正在从角色卡导入并解压：${m.zipName}`,_=J(m.zipBase64));const v=await O(U,_,{fixRootRelativeUrls:m.fixRootRelativeUrls,preferredHomePage:m.homePage});R.add(v.projectId),await L();const b=B(g.character).projects.map(y=>y.id===m.id?{...y,zipSha256:v.projectId,homePage:v.homePage}:y);await z(e,{projects:b}),i++}o=!0;try{await f.completeAffirmative?.()}catch{}}catch(h){o=!0;try{await f.completeCancelled?.()}catch{}throw h}}})}finally{D.urlDownloadPopupInFlight=!1}return{importedCount:i,cancelled:s}}async function kt(e){const t=E();if(!t)return null;if(!t.callGenericPopup||!t.POPUP_TYPE){const d=await X(e.zipUrl),c=await O(U,d.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});return R.add(c.projectId),await L(),{projectId:c.projectId,homePage:c.homePage,fileCount:c.fileCount}}if(D.urlDownloadPopupInFlight)return null;D.urlDownloadPopupInFlight=!0;const r=new AbortController;let n=!1,a=null;const{root:o,progress:s,text:i}=ze("彼岸花：正在下载 WebZip...");i.textContent=`准备下载：${e.zipName} | ${e.zipUrl}`;const u=d=>{if(i.textContent=le(d),d.totalBytes){const c=Number(d.percent);Number.isFinite(c)&&(s.max=100,s.value=Math.max(0,Math.min(100,c)))}else s.removeAttribute("value")};try{await t.callGenericPopup(o,t.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消下载",onClosing:()=>(n||r.abort(),!0),onOpen:async d=>{try{const c=await X(e.zipUrl,{signal:r.signal,onProgress:u});s.max=100,s.value=100,i.textContent=`下载完成（${Y(c.arrayBuffer.byteLength)}），正在解压并写入缓存...`;const l=await O(U,c.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});R.add(l.projectId),await L(),a={projectId:l.projectId,homePage:l.homePage,fileCount:l.fileCount},n=!0;try{await d.completeAffirmative()}catch{}}catch(c){r.signal.aborted||c?.name==="AbortError"?toastr.info("已取消下载"):(console.error("[Higanbana] url download failed",c),toastr.error(`下载失败：${c?.message??c}`)),n=!0;try{await d.completeCancelled?.()}catch{}}}})}finally{D.urlDownloadPopupInFlight=!1}return a}let M=null;function _e(e){const t=$("#hb_url_download_wrap"),r=$("#hb_cancel_url_download_btn");e?(t.show(),r.show()):(t.hide(),r.hide())}function Pt(e){const t=$("#hb_url_download_wrap"),r=$("#hb_url_progress"),n=$("#hb_url_progress_text");t.length&&t.show();try{n.text(le(e))}catch{n.text("正在下载...")}if(e?.totalBytes){const a=Number(e?.percent);Number.isFinite(a)&&(r.attr("max","100"),r.get(0)?.removeAttribute?.("value"),r.val(Math.max(0,Math.min(100,a))))}else r.get(0)?.removeAttribute?.("value")}function Ut(){try{M?.abort()}catch{}}async function At(){const e=E(),t=j();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const r=B(t.character),n=r.projects.find(u=>u.source==="url");if(!n)throw new Error("当前角色卡没有 URL 项目");if(D.urlDownloadPopupInFlight)throw new Error("当前已有自动下载弹窗进行中，请稍后再试");M&&!M.signal.aborted&&M.abort();const a=N(t.character);a&&G(a);const o=n.fixRootRelativeUrls,s=n.homePage,i=new AbortController;M=i,_e(!0),$("#hb_url_progress").attr("max","100"),$("#hb_url_progress").val(0),$("#hb_url_progress_text").text(`准备下载：${n.zipName} | ${n.zipUrl}`),$("#hb_bind_url_btn").prop("disabled",!0),$("#hb_download_url_btn").prop("disabled",!0);try{const u=await X(n.zipUrl,{signal:i.signal,onProgress:Pt});if(i.signal.aborted)throw new Error("已取消下载");T("下载完成，正在解压并写入 VFS 缓存...");const d=await O(U,u.arrayBuffer,{fixRootRelativeUrls:o,preferredHomePage:s});R.add(d.projectId),await L();const c={projects:r.projects.map(l=>l.source==="url"?{...l,zipSha256:d.projectId,homePage:d.homePage}:l)};await z(t.chid,c),T(`已下载并导入缓存。
projectId(sha256)：${d.projectId}
入口：${d.homePage}
文件数：${d.fileCount}

提示：在消息中插入占位符即可渲染`),e?.reloadCurrentChat&&await e.reloadCurrentChat()}finally{M===i&&(M=null),_e(!1),$("#hb_bind_url_btn").prop("disabled",!1),$("#hb_download_url_btn").prop("disabled",!1),A()}}async function Rt(e,t){const r=j();if(!r)throw new Error("当前不在单角色聊天/未选中角色");const n=N(r.character);n&&G(n);const a=I(),o=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=o,W();const s=String($("#hb_homepage").val()??"").trim()||void 0;T("正在解压并写入 VFS 缓存...");const i=await O(U,t,{fixRootRelativeUrls:o,preferredHomePage:s});R.add(i.projectId),await L(),T("正在编码 base64 并写入角色卡扩展字段...");const u=ct(t),d=B(r.character),c=de($("#hb_placeholder").val()),l=ue(d.projects,c),p=String($("#hb_new_title").val()??"").trim(),f=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,h={source:"embedded",id:He(),title:p||void 0,placeholder:l,homePage:i.homePage,showTitleInChat:f,fixRootRelativeUrls:o,zipName:e,zipSha256:i.projectId,zipBase64:u},m={projects:[...d.projects,h]};await z(r.chid,m);const g=$("#hb_placeholder");g.length&&document.activeElement!==g.get(0)&&g.val(""),A(),$("#hb_new_title").val(""),T(`已添加项目（嵌入模式）。
占位符：${l}
projectId(sha256)：${i.projectId}
入口：${i.homePage}
文件数：${i.fileCount}

提示：导出该角色卡(json/png)会包含该项目的 zipBase64`)}async function Ht({allow:e=!0,reloadChat:t=!0}={}){const r=E(),n=j();if(!n)throw new Error("当前不在单角色聊天/未选中角色");const a=B(n.character),o=a.projects.filter(d=>d.source==="embedded");if(o.length===0)throw new Error("当前角色卡没有可导入的嵌入项目");const s=N(n.character);e&&s&&G(s);const i=[...a.projects];let u=!1;for(const d of o){if(d.zipSha256&&R.has(d.zipSha256))continue;T(`正在从角色卡导入：${d.title||d.zipName} ...`);const c=J(d.zipBase64),l=await O(U,c,{fixRootRelativeUrls:d.fixRootRelativeUrls,preferredHomePage:d.homePage});if(R.add(l.projectId),await L(),l.projectId!==d.zipSha256){console.warn("[Higanbana] zipSha256 mismatch",{embedded:d.zipSha256,computed:l.projectId});const p=i.findIndex(f=>f.id===d.id);if(p>=0){const f=i[p];f&&f.source==="embedded"&&(i[p]={...f,zipSha256:l.projectId,homePage:l.homePage},u=!0)}}}u&&await z(n.chid,{projects:i}),T(`已导入到缓存。
已导入项目数：${o.length}`),t&&r?.reloadCurrentChat&&await r.reloadCurrentChat()}function Z(){const e=j();if(!e)throw new Error("当前不在单角色聊天/未选中角色");const t=B(e.character);return{active:e,card:t}}function K(e,t){const r=String(t??"").trim();if(!r)throw new Error("项目 id 为空");const n=e.projects.find(a=>a.id===r);if(!n)throw new Error("找不到项目（可能已被删除）");return n}function It(e){const{card:t}=Z(),r=K(t,e);if(!r.zipSha256)throw new Error("尚未下载/导入到本地缓存");if(!R.has(r.zipSha256))throw new Error("尚未导入到本地缓存");const n=ee(U,r.zipSha256,r.homePage);window.open(n,"_blank","noopener,noreferrer")}function Tt(e){const{card:t}=Z(),r=K(t,e);if(r.source!=="embedded")throw new Error("当前项目不是嵌入模式，无法导出 zip");const n=J(r.zipBase64),a=new Blob([n],{type:"application/zip"});Ie(a,r.zipName||"webzip.zip")}async function zt(e){const{active:t,card:r}=Z(),n=K(r,e);if(n.source!=="embedded")throw new Error("当前项目不是嵌入模式");if(!he(n))return{importedCount:0,cancelled:!1};const a=N(t.character);a&&G(a);const o=await Ne(t.chid,[n]);return o.cancelled||(await E()?.reloadCurrentChat?.(),A()),o}async function Nt(e){const{active:t,card:r}=Z(),n=K(r,e);if(n.source!=="url")throw new Error("当前项目不是 URL 模式");const a=N(t.character);a&&G(a);const o=await kt(n);if(!o)return!1;const i={projects:B(t.character).projects.map(u=>u.id===n.id?{...u,zipSha256:o.projectId,homePage:o.homePage}:u)};return await z(t.chid,i),await E()?.reloadCurrentChat?.(),A(),!0}async function Lt(e){const t=E(),{active:r,card:n}=Z(),a=K(n,e),o=n.projects.filter(s=>s.id!==a.id);await z(r.chid,o.length?{projects:o}:null),await t?.reloadCurrentChat?.(),A()}async function Ft(){const{active:e}=Z();await z(e.chid,null),A()}async function Mt(e){const t=j();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const r=$t(e);if(!r)throw new Error("请输入合法的 http/https zip URL");const n=N(t.character);n&&G(n);const a=!!$("#hb_fix_root_relative").prop("checked"),o=String($("#hb_homepage").val()??"").trim()||"index.html",s=Ct(r),i=B(t.character),u=de($("#hb_placeholder").val()),d=ue(i.projects,u),c=String($("#hb_new_title").val()??"").trim(),l=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,p={source:"url",id:He(),title:c||void 0,placeholder:d,homePage:o,showTitleInChat:l,fixRootRelativeUrls:a,zipName:s,zipSha256:"",zipUrl:r},f={projects:[...i.projects,p]};return await z(t.chid,f),{zipUrl:r,placeholder:d,homePage:o}}function Wt(){Te();const e=E();$("#hb_pick_zip_btn").on("click",()=>{document.getElementById("hb_bind_zip")?.click()}),$("#hb_bind_zip").on("change",()=>{const o=document.getElementById("hb_bind_zip")?.files?.[0];$("#hb_bind_zip_name").text(o?o.name:"（未选择文件）")}),$("#hb_fix_root_relative").on("change",()=>{const o=I();o.defaultFixRootRelativeUrls=!!$("#hb_fix_root_relative").prop("checked"),W()}),$("#hb_render_html_blocks").on("change",()=>{const o=I();o.renderHtmlCodeBlocks=!!$("#hb_render_html_blocks").prop("checked"),W(),H()}),$("#hb_render_html_blocks_blob").on("change",()=>{const o=I();o.renderHtmlCodeBlocksUseBlobUrl=!!$("#hb_render_html_blocks_blob").prop("checked"),W(),H()}),$("#hb_render_html_blocks_titlebar").on("change",()=>{const o=I();o.renderHtmlCodeBlocksShowTitleBar=!!$("#hb_render_html_blocks_titlebar").prop("checked"),W(),H()}),$("#hb_placeholder").on("input",()=>{const o=I();o.placeholder=String($("#hb_placeholder").val()??"").trim()||F.placeholder,W()}),$("#hb_copy_placeholder").on("click",async()=>{const o=String($("#hb_placeholder").val()??"").trim();if(!o){toastr.error("占位符为空");return}try{await navigator.clipboard.writeText(o),toastr.success("已复制占位符")}catch(s){console.warn("[Higanbana] copy failed",s),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_insert_placeholder").on("click",()=>{const o=String($("#hb_placeholder").val()??"").trim();if(!o){toastr.error("占位符为空");return}const s=$("#send_textarea");if(s.length===0){toastr.error("找不到输入框");return}const i=String(s.val()??"");s.val(i?`${i}
${o}`:o),s.trigger("input"),toastr.success("已插入占位符")});const t=new Map,r=new Set,n=(o,s=400)=>{const i=t.get(o);i&&clearTimeout(i);const u=window.setTimeout(()=>{t.delete(o),a(o).catch(d=>console.warn("[Higanbana] project auto save failed",d))},Math.max(0,s));t.set(o,u)},a=async o=>{if(!r.has(o)){r.add(o);try{const s=j();if(!s)return;const i=B(s.character),u=i.projects.findIndex(S=>S.id===o);if(u<0)return;const d=document.getElementById("hb_projects_list");if(!d)return;const c=String(o).replace(/\\/g,"\\\\").replace(/"/g,'\\"'),l=d.querySelector(`.hb-proj-title[data-project-id="${c}"]`),p=d.querySelector(`.hb-proj-placeholder[data-project-id="${c}"]`),f=d.querySelector(`.hb-proj-home[data-project-id="${c}"]`),h=d.querySelector(`.hb-proj-fix[data-project-id="${c}"]`),m=d.querySelector(`.hb-proj-show-title[data-project-id="${c}"]`),g=i.projects[u],w=String(l?.value??"").trim(),_=w||void 0,v=String(p?.value??"").trim(),C=String(f?.value??"").trim(),b=!!h?.checked,y=m?!!m.checked:!!g.showTitleInChat;if(!v||!C)return;if(i.projects.some(S=>S.id!==o&&S.placeholder===v)){toastr.error("占位符重复，请为每个项目设置不同的占位符"),p&&(p.value=g.placeholder);return}if(!(g.title!==_||g.placeholder!==v||g.homePage!==C||g.fixRootRelativeUrls!==b||g.showTitleInChat!==y))return;const P=i.projects.map(S=>S.id===o?{...S,title:_,placeholder:v,homePage:C,fixRootRelativeUrls:b,showTitleInChat:y}:S);await z(s.chid,{projects:P}),g.showTitleInChat!==y&&mt(o,y);const q=d.querySelector(`.hb-project[data-project-id="${c}"] .hb-subpanel-title`);q&&(q.textContent=`${_||g.zipName}  ${v}`),T(`已保存项目设置：${_||g.zipName}`),H()}finally{r.delete(o)}}};$("#hb_projects_list").on("input",".hb-proj-title, .hb-proj-placeholder, .hb-proj-home",o=>{const s=String(o.target?.getAttribute?.("data-project-id")??"").trim();s&&n(s,500)}),$("#hb_projects_list").on("change",".hb-proj-fix, .hb-proj-show-title",o=>{const s=String(o.target?.getAttribute?.("data-project-id")??"").trim();s&&n(s,0)}),$("#hb_projects_list").on("click",'[data-hb-action="copy_placeholder"]',async o=>{const s=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!s)return;const i=j();if(!i)return;const d=B(i.character).projects.find(c=>c.id===s);if(d)try{await navigator.clipboard.writeText(d.placeholder),toastr.success("已复制占位符")}catch(c){console.warn("[Higanbana] copy placeholder failed",c),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="insert_placeholder"]',o=>{const s=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!s)return;const i=j();if(!i)return;const d=B(i.character).projects.find(p=>p.id===s);if(!d)return;const c=$("#send_textarea");if(c.length===0){toastr.error("找不到输入框");return}const l=String(c.val()??"");c.val(l?`${l}
${d.placeholder}`:d.placeholder),c.trigger("input"),toastr.success("已插入占位符")}),$("#hb_projects_list").on("click",'[data-hb-action="open_home"]',o=>{const s=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(s)try{It(s)}catch(i){toastr.error(i?.message??i)}}),$("#hb_projects_list").on("click",'[data-hb-action="export_zip"]',o=>{const s=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(s)try{Tt(s)}catch(i){console.error("[Higanbana] export zip failed",i),toastr.error(`导出失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="import_cache"]',async o=>{const s=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(s)try{const i=await zt(s);if(i.cancelled){toastr.info("已取消导入");return}i.importedCount>0?toastr.success("已导入到本地缓存"):toastr.info("该项目已在本地缓存"),H()}catch(i){console.error("[Higanbana] import cache failed",i),toastr.error(`导入失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="download_apply"]',async o=>{const s=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(s)try{if(!await Nt(s))return;H(),toastr.success("已下载并应用")}catch(i){console.error("[Higanbana] download apply failed",i),toastr.error(`操作失败：${i?.message??i}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="delete_project"]',async o=>{const s=String(o.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!s)return;const i=j();if(!i)return;const d=B(i.character).projects.find(p=>p.id===s);if(!d)return;const c=d.title||d.zipName;let l=!1;try{e?.Popup?.show?.confirm?l=await e.Popup.show.confirm("彼岸花",`确定删除项目：${c}？`):l=window.confirm(`确定删除项目：${c}？`)}catch{l=window.confirm(`确定删除项目：${c}？`)}if(l)try{await Lt(s),H(),toastr.success("已删除项目")}catch(p){console.error("[Higanbana] delete project failed",p),toastr.error(`删除失败：${p?.message??p}`)}}),$("#hb_import_from_card").on("click",async()=>{try{toastr.info("开始导入，请稍候..."),await Ht({allow:!0,reloadChat:!0}),toastr.success("已导入并启用（可在消息中渲染占位符）"),A()}catch(o){console.error("[Higanbana] import from card failed",o),toastr.error(`导入失败：${o?.message??o}`)}}),$("#hb_open_home").on("click",()=>{const o=j();if(!o)return;const i=B(o.character).projects[0];if(!i){toastr.error("当前角色卡未绑定任何 WebZip 项目");return}if(!i.zipSha256){toastr.error("尚未下载/导入 WebZip 到本地缓存");return}const u=ee(U,i.zipSha256,i.homePage);window.open(u,"_blank","noopener,noreferrer")}),$("#hb_export_zip").on("click",()=>{const o=j();if(!o)return;const i=B(o.character).projects.find(u=>u.source==="embedded");if(!i){toastr.error("当前角色卡没有可导出的嵌入项目");return}try{const u=J(i.zipBase64),d=new Blob([u],{type:"application/zip"});Ie(d,i.zipName||"webzip.zip")}catch(u){console.error("[Higanbana] export zip failed",u),toastr.error(`导出失败：${u?.message??u}`)}}),$("#hb_unbind").on("click",async()=>{const o=E(),s=j();if(!s)return;const i=B(s.character);if(i.projects.length===0)return;const u=`确定解绑当前角色的所有 WebZip 项目？

${xt(i)}`;let d=!1;try{o?.Popup?.show?.confirm?d=await o.Popup.show.confirm("彼岸花",u):d=window.confirm(u)}catch{d=window.confirm(u)}if(d)try{await Ft(),toastr.success("已解绑"),A()}catch(c){console.error("[Higanbana] unbind failed",c),toastr.error(`解绑失败：${c?.message??c}`)}}),$("#hb_bind_zip_btn").on("click",async()=>{if(!j()){toastr.error("当前不在单角色聊天/未选中角色");return}const s=$("#hb_bind_zip").get(0)?.files?.[0];if(!s){toastr.error("请先选择 zip 文件");return}try{await Rt(s.name,await s.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(i){console.error("[Higanbana] bind zip failed",i),toastr.error(`绑定失败：${i?.message??i}`)}}),$("#hb_bind_url_btn").on("click",async()=>{if(!j()){toastr.error("当前不在单角色聊天/未选中角色");return}const s=String($("#hb_bind_url").val()??"").trim();try{const{zipUrl:i,placeholder:u,homePage:d}=await Mt(s),c=$("#hb_placeholder");c.length&&document.activeElement!==c.get(0)&&c.val(""),A(),$("#hb_new_title").val(""),T(`已添加项目（URL 模式）。
占位符：${u}
URL：${i}
入口：${d}
提示：进入聊天时会提示下载并导入缓存`),toastr.success("已添加 URL 项目")}catch(i){console.error("[Higanbana] bind url failed",i),toastr.error(`绑定失败：${i?.message??i}`)}}),$("#hb_download_url_btn").on("click",async()=>{try{await At()}catch(o){console.error("[Higanbana] download url apply failed",o),toastr.error(`操作失败：${o?.message??o}`)}}),$("#hb_cancel_url_download_btn").on("click",()=>{try{Ut()}catch{}})}let ae=!1;async function Dt(e,t){const r=t.map(n=>{const a=n.source==="url"?n.zipSha256||n.zipUrl:n.zipSha256;return`${n.id}:${n.source}:${a}`}).join("|");try{const n=await Se(new TextEncoder().encode(r).buffer);return`AlertHiganbana_${e}_projects_${n}`}catch{return`AlertHiganbana_${e}_projects_${r.slice(0,80)}`}}function Ot(e){const r=(String(e??"").trim()||"x").replace(/[^a-zA-Z0-9_-]/g,"_");return r.startsWith("hb_")?r:`hb_${r}`}async function Le(){const e=E(),t=j();if(!e||!t)return;const r=B(t.character);if(r.projects.length===0)return;const n=N(t.character);if(n&&!ae){ae=!0;try{const a=je(n),o=r.projects.filter(c=>he(c));if(!(!a||o.length>0))return;const i=await Dt(n,r.projects);try{if(e.accountStorage?.getItem?.(i))return;e.accountStorage?.setItem?.(i,"true")}catch{}let u=0,d=[];if(e.callGenericPopup&&e.POPUP_TYPE?.CONFIRM){const c=document.createElement("div"),l=document.createElement("h3");l.textContent="此角色卡包含 WebZip 前端项目。",c.appendChild(l);const p=document.createElement("h3");p.textContent=o.length>0?`发现 ${o.length} 个未缓存项目，是否下载并启用？`:"是否启用它们？",c.appendChild(p);const f=document.createElement("div");f.className="m-b-1",f.style.opacity="0.85",f.textContent="你可以稍后在扩展栏的“彼岸花”面板里管理这些项目。",c.appendChild(f);const h=new Map,m=o.length>0?o.map(v=>{const C=Ot(`miss_${v.id}`);h.set(C,v.id);const y=`${v.title||v.zipName}  |  ${v.source==="embedded"?"嵌入":"URL"}  |  ${v.placeholder}`,x=v.source==="url"?v.zipUrl:"嵌入于角色卡";return{id:C,label:y,type:"checkbox",defaultState:!0,tooltip:x}}):null,g=o.length>0?"下载选中并启用":"启用",w=a?"取消":"否",_=o.length>0?["下载全部"]:null;if(u=await e.callGenericPopup(c,e.POPUP_TYPE.CONFIRM,"",{okButton:g,cancelButton:w,customButtons:_,customInputs:m,wide:!0}),!u)return;if(o.length>0)if(Number(u)>=2)d=[...o];else{const v=e.Popup?.util?.lastResult?.inputResults,C=new Set;for(const[b,y]of h)v?.get?.(b)&&C.add(y);d=o.filter(b=>C.has(b.id))}}else{if(!window.confirm(o.length>0?`此角色卡包含 WebZip 项目，且有 ${o.length} 个未缓存项目。是否启用并下载全部？`:"此角色卡包含 WebZip 项目，是否启用？"))return;d=[...o]}G(n);try{if(d.length>0){toastr.info("开始下载/导入项目，请稍候...");const c=await Ne(t.chid,d);if(c.cancelled){toastr.info("已取消导入");return}c.importedCount>0&&toastr.success(`已导入 ${c.importedCount} 个项目`)}await e.reloadCurrentChat?.(),A(),H()}catch(c){console.error("[Higanbana] import queue failed",c),toastr.error(`导入失败：${c?.message??c}`)}}finally{ae=!1}}}let ve=!1;function Gt(){if(ve)return;const e=E();if(!e?.eventSource||!e?.event_types)return;ve=!0;const t=()=>setTimeout(()=>{A(),H(),Le().catch(r=>console.warn("[Higanbana] webzip check failed",r))},0);e.event_types.CHAT_CHANGED&&e.eventSource.on(e.event_types.CHAT_CHANGED,t),e.event_types.CHARACTER_DELETED&&e.eventSource.on(e.event_types.CHARACTER_DELETED,t)}async function qt(){qe();const e=await vt();await L(),await Et(),Bt(),Wt(),yt(),Gt(),A(),Re(),Le().catch(t=>console.warn("[Higanbana] webzip check failed",t)),T(`彼岸花：已加载。
Service Worker：${e?"已注册":"不可用（将无法渲染 WebZip）"}
提示：在本面板可把 zip 绑定到当前角色卡，导出角色卡时会一并导出。`)}function $e(){const e=E();return e?.eventSource&&e?.event_types?.APP_READY?(e.eventSource.on(e.event_types.APP_READY,()=>{qt().catch(t=>{console.error("[Higanbana] init failed",t),toastr.error(`彼岸花初始化失败：${t?.message??t}`)})}),!0):!1}function Zt(){jQuery(()=>{if($e())return;const e=setInterval(()=>{$e()&&clearInterval(e)},250)})}Zt();
