import{i as we,H as et}from"./hbHtmlRuntime.aTxSbyDU.chunk.js";const Ce="st-higanbana-vfs-",k=new Set;async function L(){try{const e=await caches.keys();k.clear();for(const t of e)t.startsWith(Ce)&&k.add(t.slice(Ce.length))}catch(e){console.warn("[Higanbana] caches.keys failed",e)}}function ye(e){return!!e&&k.has(e)}function B(){const e=globalThis.SillyTavern;return e?.getContext?e.getContext():null}function x(){const e=B();if(!e)return null;const t=Number(e.characterId);if(!Number.isFinite(t)||t<0)return null;const o=e.characters?.[t];return o?{chid:t,character:o}:null}function tt(e){return String(e?.name??e?.data?.name??"").trim()||"(未命名角色)"}function W(e){return String(e?.avatar??"").trim()}function P(e){const t={projects:[]},o=e?.data?.extensions?.higanbana;if(!o||typeof o!="object")return t;const r=o.projects;if(!Array.isArray(r))return t;const a=[];for(const n of r){if(!n||typeof n!="object")continue;const i=String(n.source??"").trim(),c=String(n.id??"").trim(),u=String(n.title??"").trim()||void 0,d=String(n.placeholder??"").trim(),s=String(n.homePage??"").trim(),l=typeof n.showTitleInChat=="boolean"?!!n.showTitleInChat:!1,h=!!n.fixRootRelativeUrls,f=String(n.zipName??"").trim(),p=String(n.zipSha256??"").trim();if(!(!c||!d||!s||!f)){if(i==="embedded"){const m=String(n.zipBase64??"").trim();if(!m||!p)continue;a.push({source:"embedded",id:c,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p,zipBase64:m});continue}if(i==="local"){if(!p)continue;a.push({source:"local",id:c,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p});continue}if(i==="url"){const m=String(n.zipUrl??"").trim();if(!m)continue;a.push({source:"url",id:c,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p||"",zipUrl:m})}}}return{projects:a}}async function T(e,t){const o=B();if(!o?.writeExtensionField)throw new Error("writeExtensionField 不可用（酒馆版本过旧或上下文缺失）");await o.writeExtensionField(e,"higanbana",t)}const A=String(import.meta.url).replace(/[^/]*$/,""),rt=`${A}sw.js`,J={urlDownloadPopupInFlight:!1},ot="st-higanbana-vfs-";function nt(e){return String(e).split("/").map(t=>encodeURIComponent(t)).join("/")}function le(e,t,o){return`${e}vfs/${encodeURIComponent(t)}/${nt(o)}`}function at(e,t){return`${new URL(e).pathname}vfs/${encodeURIComponent(t)}/`}function it(e){return`${ot}${e}`}function ke(e){const t=String(e).toLowerCase();return t.endsWith(".html")||t.endsWith(".htm")?"text/html; charset=utf-8":t.endsWith(".css")?"text/css; charset=utf-8":t.endsWith(".js")||t.endsWith(".mjs")||t.endsWith(".cjs")?"application/javascript; charset=utf-8":t.endsWith(".json")||t.endsWith(".map")?"application/json; charset=utf-8":t.endsWith(".txt")?"text/plain; charset=utf-8":t.endsWith(".svg")?"image/svg+xml":t.endsWith(".png")?"image/png":t.endsWith(".jpg")||t.endsWith(".jpeg")?"image/jpeg":t.endsWith(".gif")?"image/gif":t.endsWith(".webp")?"image/webp":t.endsWith(".avif")?"image/avif":t.endsWith(".ico")?"image/x-icon":t.endsWith(".woff2")?"font/woff2":t.endsWith(".woff")?"font/woff":t.endsWith(".ttf")?"font/ttf":t.endsWith(".otf")?"font/otf":t.endsWith(".eot")?"application/vnd.ms-fontobject":t.endsWith(".wasm")?"application/wasm":"application/octet-stream"}function ct(e){const t=ke(e);return t.startsWith("text/")||t.includes("javascript")||t.includes("json")||t.includes("svg+xml")}function st(e){return new Promise((t,o)=>{const r=document.createElement("script");r.src=e,r.async=!0,r.onload=()=>t(),r.onerror=()=>o(new Error(`加载脚本失败: ${e}`)),document.head.appendChild(r)})}async function lt(){const e=globalThis;if(e.JSZip)return e.JSZip;if(await st("/lib/jszip.min.js"),!e.JSZip)throw new Error("JSZip 未能加载（/lib/jszip.min.js）");return e.JSZip}function dt(e){const t=e.filter(Boolean);if(t.length===0)return{prefix:"",stripped:[]};const o=new Set(t.map(i=>i.split("/")[0]).filter(Boolean));if(o.size!==1)return{prefix:"",stripped:t};const a=`${[...o][0]}/`;return t.some(i=>i.startsWith(a))?{prefix:a,stripped:t.map(i=>i.startsWith(a)?i.slice(a.length):i)}:{prefix:"",stripped:t}}function ut(e){let t=String(e??"").replace(/\\/g,"/").replace(/^\.\//,"").replace(/^\/+/,"");const o=t.split("/").filter(Boolean);return o.some(r=>r==="..")?null:(t=o.join("/"),t||null)}function Te(e){return String(e).split(/[?#]/,1)[0]}function pt(e){const t=new Set,o=new Set;for(const r of e){t.add(r);const a=r.split("/").filter(Boolean);for(let n=1;n<a.length;n++)o.add(a.slice(0,n).join("/")+"/")}return{fileSet:t,dirSet:o}}function K(e,t){const o=Te(e);return o?!!(t.fileSet.has(o)||t.dirSet.has(o.endsWith("/")?o:`${o}/`)):!1}function ht(e,t,o,r){let a=e;return o&&(a=a.replace(/<base\b([^>]*?)\bhref\s*=\s*(["'])\/\2([^>]*?)>/gi,(n,i,c,u)=>`<base${i}href=${c}${t}${c}${u}>`),a=a.replace(/(<\s*(?:script|img|source|video|audio)\b[^>]*\bsrc\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(n,i,c,u)=>K(u,r)?`${i}${t}${u}${c}`:n),a=a.replace(/(<\s*link\b[^>]*\bhref\s*=\s*(["']))\/(?!\/)([^"']+)\2/gi,(n,i,c,u)=>K(u,r)?`${i}${t}${u}${c}`:n)),a}function ft(e,t,o,r){if(!o)return e;let a=String(e);return a=a.replace(/url\(\s*(["'])?\/(?!\/)([^"')]+)\1\s*\)/gi,(n,i="",c)=>K(c,r)?`url(${i}${t}${c}${i})`:n),a=a.replace(/@import\s+(?:url\(\s*)?(["'])?\/(?!\/)([^"')\s]+)\1\s*\)?/gi,(n,i="",c)=>K(c,r)?n.toLowerCase().includes("url(")?`@import url(${i}${t}${c}${i})`:`@import ${i}${t}${c}${i}`:n),a}function mt(e){return!e||/\s/.test(e)?!1:e.endsWith("/")?!0:(e.split("/").filter(Boolean).pop()||"").includes(".")}function bt(e,t,o,r){if(!o)return e;let a=String(e);return a=a.replace(/(["'`])\/(?!\/)([^"'`]*?)\1/g,(n,i,c)=>{const u=Te(c);return!mt(u)||!K(c,r)?n:`${i}${t}${c}${i}`}),a=a.replace(/(__webpack_require__\.p\s*=\s*)(["'])\/\2/g,(n,i,c)=>`${i}${c}${t}${c}`),a=a.replace(/(__webpack_public_path__\s*=\s*)(["'])\/\2/g,(n,i,c)=>`${i}${c}${t}${c}`),a}async function He(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(o=>o.toString(16).padStart(2,"0")).join("")}let X=null,ie=!1,gt=0;const Q=new Map;function wt(e){const t=[...Q.values()];Q.clear();for(const o of t)o.reject(e)}function yt(){if(ie)return null;if(X)return X;if(typeof Worker>"u")return ie=!0,null;try{const e=new Worker(new URL("/assets/base64.worker-D8NWWtcD.js",import.meta.url),{type:"module"});e.onmessage=o=>{const r=o.data;if(!r||typeof r!="object")return;const a=Number(r.id);if(!Number.isFinite(a))return;const n=Q.get(a);if(n){if(Q.delete(a),r.ok){"base64"in r?n.resolve(r.base64):"arrayBuffer"in r?n.resolve(r.arrayBuffer):n.reject(new Error("Base64 worker 返回了无效结果"));return}n.reject(new Error(r.error||"Base64 worker 执行失败"))}};const t=o=>{console.warn("[Higanbana] Base64 Worker 不可用，回退到主线程编解码",o),ie=!0;try{e.terminate()}catch{}X===e&&(X=null),wt(new Error("Base64 Worker 已失效"))};return e.onerror=t,e.onmessageerror=t,X=e,e}catch(e){return console.warn("[Higanbana] 创建 Base64 Worker 失败，回退到主线程编解码",e),ie=!0,null}}function Ne(e){const t=yt();return t?new Promise((o,r)=>{const a=++gt;Q.set(a,{resolve:o,reject:r}),t.postMessage({...e,id:a})}):Promise.reject(new Error("Base64 Worker 不可用"))}function _t(e){const t=new Uint8Array(e),o=32768,r=[];for(let a=0;a<t.length;a+=o){const n=t.subarray(a,a+o);r.push(String.fromCharCode(...n))}return btoa(r.join(""))}function vt(e){const t=atob(e),o=new Uint8Array(t.length);for(let r=0;r<t.length;r++)o[r]=t.charCodeAt(r);return o.buffer}async function ve(e){try{return await Ne({type:"arrayBufferToBase64",arrayBuffer:e})}catch{return _t(e)}}async function G(e){try{return await Ne({type:"base64ToArrayBuffer",base64:e})}catch{return vt(e)}}function Y(e){const t=Number(e);if(!Number.isFinite(t)||t<0)return"0 B";const o=["B","KB","MB","GB","TB"];let r=t,a=0;for(;r>=1024&&a<o.length-1;)r/=1024,a++;const n=r>=100?0:r>=10?1:2;return`${r.toFixed(n)} ${o[a]}`}function St(e){if(e===null)return"—";const t=Number(e);return!Number.isFinite(t)||t<=0?"—":`${Y(t)}/s`}function jt(e){if(e===null)return"—";const t=Number(e);return Number.isFinite(t)?`${Math.max(0,Math.min(t,100)).toFixed(1)}%`:"—"}function pe(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}async function ee(e,t={}){const o=Math.max(30,Number(t.progressThrottleMs??120)),r=t.onProgress,a=pe(),n=await fetch(e,{method:"GET",signal:t.signal});if(!n.ok)throw new Error(`下载失败: ${n.status} ${n.statusText}`);const i=n.headers.get("content-type"),c=n.url||e,u=n.headers.get("content-length"),d=u?Number(u):NaN,s=Number.isFinite(d)&&d>0?d:null,h=n.body?.getReader?.();if(!h){const b=await n.arrayBuffer(),_=Math.max(0,pe()-a),j=b.byteLength,C=s??j,I=C?j/C*100:null,U=_>0?j/_*1e3:null;return r?.({loadedBytes:j,totalBytes:C,percent:I,speedBps:U,elapsedMs:_}),{arrayBuffer:b,totalBytes:C,contentType:i,finalUrl:c}}const f=[];let p=0,m=0,g=0,w=null;const y=(b=!1)=>{if(!r)return;const _=pe(),j=Math.max(0,_-a);if(!b&&m&&_-m<o)return;if(m){const I=_-m;I>0&&(w=(p-g)/I*1e3)}m=_,g=p;const C=s?p/s*100:null;r({loadedBytes:p,totalBytes:s,percent:C,speedBps:w,elapsedMs:j})};y(!0);try{for(;;){const{done:b,value:_}=await h.read();if(b)break;_&&(f.push(_),p+=_.byteLength,y(!1))}}finally{try{h.releaseLock()}catch{}}y(!0);const v=new Uint8Array(p);let S=0;for(const b of f)v.set(b,S),S+=b.byteLength;return{arrayBuffer:v.buffer,totalBytes:s??p,contentType:i,finalUrl:c}}async function D(e,t,o){const r=await lt(),a=await He(t),n=it(a),i=await caches.open(n),c=at(e,a),u=await r.loadAsync(t),l=Object.values(u.files||{}).filter(b=>b&&!b.dir).map(b=>({entry:b,path:ut(b.name)})).filter(b=>!!b.path);if(l.length===0)throw new Error("zip 内没有可导入的文件");const{stripped:h}=dt(l.map(b=>b.path)),f=l.map((b,_)=>({entry:b.entry,path:h[_]})).filter(b=>!!b.path),p=f.map(b=>String(b.path)),m=pt(p),g=f.map(b=>b.path).filter(b=>/\.(html?|HTML?)$/i.test(b)).sort((b,_)=>b.localeCompare(_)),w=o.preferredHomePage?.trim(),y=w?g.includes(w):!1,v=g.some(b=>b.toLowerCase()==="index.html");let S=w&&y?w:"";S||(v?S=g.find(b=>b.toLowerCase()==="index.html"):g.length>0?S=g[0]:S="index.html");for(let b=0;b<f.length;b++){const{entry:_,path:j}=f[b],C=ke(j);let I;if(ct(j)){let E=await _.async("string");C.startsWith("text/html")?(E=ht(E,c,o.fixRootRelativeUrls,m),I=E):C.startsWith("text/css")?I=ft(E,c,o.fixRootRelativeUrls,m):C.includes("javascript")?I=bt(E,c,o.fixRootRelativeUrls,m):I=E}else{const E=await _.async("uint8array"),F=new Uint8Array(E.byteLength);F.set(E),I=new Blob([F],{type:C})}const U=le(e,a,j);await i.put(new Request(U,{method:"GET"}),new Response(I,{headers:{"Content-Type":C}})),b%75===0&&await new Promise(E=>setTimeout(E,0))}return{projectId:a,homePage:S,htmlFiles:g,fileCount:f.length,cacheName:n}}function Se(e){const t=Y(e.loadedBytes),o=e.totalBytes?Y(e.totalBytes):"?",r=e.totalBytes?jt(e.percent):"—",a=St(e.speedBps);return`下载：${t} / ${o}（${r}） | 速度：${a}`}const he="higanbana",V=Object.freeze({placeholder:"{{WEB_HOME}}",defaultFixRootRelativeUrls:!0,renderHtmlCodeBlocks:!1,renderHtmlCodeBlocksUseBlobUrl:!1,renderHtmlCodeBlocksShowTitleBar:!1,allowedCharacterAvatars:[]});function N(){const e=B();if(!e)return structuredClone(V);e.extensionSettings[he]=e.extensionSettings[he]||{};const t=e.extensionSettings[he];return(typeof t.placeholder!="string"||!t.placeholder.trim())&&(t.placeholder=V.placeholder),typeof t.defaultFixRootRelativeUrls!="boolean"&&(t.defaultFixRootRelativeUrls=V.defaultFixRootRelativeUrls),typeof t.renderHtmlCodeBlocks!="boolean"&&(t.renderHtmlCodeBlocks=V.renderHtmlCodeBlocks),typeof t.renderHtmlCodeBlocksUseBlobUrl!="boolean"&&(t.renderHtmlCodeBlocksUseBlobUrl=V.renderHtmlCodeBlocksUseBlobUrl),typeof t.renderHtmlCodeBlocksShowTitleBar!="boolean"&&(t.renderHtmlCodeBlocksShowTitleBar=V.renderHtmlCodeBlocksShowTitleBar),Array.isArray(t.allowedCharacterAvatars)?t.allowedCharacterAvatars=t.allowedCharacterAvatars.map(o=>String(o).trim()).filter(o=>o.length>0):t.allowedCharacterAvatars=[],t}function O(){B()?.saveSettingsDebounced?.()}function te(){try{if(typeof crypto<"u"&&"randomUUID"in crypto&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}const e=B();try{const t=e?.uuidv4;if(typeof t=="function")return String(t())}catch{}return`hb_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,10)}`}function oe(e){return String(e??"").trim()}function ne(e,t){const o=new Set(e.map(a=>a.placeholder));let r=oe(t);if(r||(r=`{{WEB_${e.length+1}}}`),!o.has(r))return r;for(let a=2;a<1e3;a++){const n=`_${a}`,i=r.endsWith("}}")?r.slice(0,-2)+n+"}}":r+n;if(!o.has(i))return i}return r}function Le(e,t){const o=document.createElement("a");o.href=URL.createObjectURL(e),o.setAttribute("download",t),document.body.appendChild(o),o.click(),URL.revokeObjectURL(o.href),document.body.removeChild(o)}function Ct(e){const t=String(e??"").trim();if(!t)return null;try{const o=new URL(t);return o.protocol!=="http:"&&o.protocol!=="https:"?null:o.toString()}catch{return null}}function We(e){try{const o=new URL(e).pathname.split("/").filter(Boolean).pop()||"webzip.zip";return o.endsWith(".zip")?o:`${o}.zip`}catch{return"webzip.zip"}}function $t(e){const t=e?.projects??[];if(t.length===0)return"（无）";const o=t.slice(0,3).map(a=>a.title||a.zipName).filter(Boolean),r=t.length>o.length?` +${t.length-o.length}`:"";return`项目数：${t.length}${o.length?` | ${o.join(" / ")}${r}`:""}`}function xt(e,t){try{const o=localStorage.getItem(e);return o===null?t:o==="1"}catch{return t}}function Bt(e,t){try{localStorage.setItem(e,t?"1":"0")}catch{}}function Me(){const e=document.getElementById("higanbana_settings");if(!e)return;const t=Array.from(e.querySelectorAll(".hb-subpanel"));for(const o of t){const r=String(o.dataset.id??"").trim();if(!r)continue;const a=o.querySelector(".hb-subpanel-header"),n=o.querySelector(".hb-subpanel-indicator"),i=o.querySelector(".hb-subpanel-body");if(!a||!n||!i||a.dataset?.hbBound==="1")continue;a.dataset.hbBound="1";const c=`higanbana.subpanel.open.${r}`,u=a.getAttribute("aria-expanded")==="true",d=s=>{a.setAttribute("aria-expanded",s?"true":"false"),n.textContent=s?"−":"+",i.style.display=s?"block":"none"};d(xt(c,u)),a.addEventListener("click",()=>{const l=!(a.getAttribute("aria-expanded")==="true");d(l),Bt(c,l)})}}function $e(e){const t=document.getElementById("hb_projects_list");if(!t)return;if(t.innerHTML="",e.length===0){const r=document.createElement("div");r.className="hb-subhint",r.textContent="（暂无项目）",t.appendChild(r);return}const o=document.createDocumentFragment();for(const r of e){const a=document.createElement("section");a.className="hb-subpanel hb-project",a.dataset.id=`project_${r.id}`,a.dataset.projectId=r.id;const n=document.createElement("button");n.className="hb-subpanel-header",n.type="button",n.setAttribute("aria-expanded","false");const i=document.createElement("div");i.className="hb-subpanel-title",i.textContent=`${r.title||r.zipName}  ${r.placeholder}`;const c=document.createElement("div");c.className="hb-subpanel-indicator",c.textContent="+",n.appendChild(i),n.appendChild(c),a.appendChild(n);const u=document.createElement("div");u.className="hb-subpanel-body",u.style.display="none";const d=s=>{const l=document.createElement("div");l.className="hb-row";const h=document.createElement("label");return h.className="hb-label",h.textContent=s,l.appendChild(h),l};{const s=d("标题"),l=document.createElement("input");l.className="text_pole hb-proj-title",l.type="text",l.spellcheck=!1,l.value=r.title||"",l.dataset.projectId=r.id,s.appendChild(l),u.appendChild(s)}{const s=d("项目 ID"),l=document.createElement("input");l.className="text_pole hb-proj-id",l.type="text",l.readOnly=!0,l.spellcheck=!1,l.value=r.id,l.dataset.projectId=r.id,s.appendChild(l);const h=document.createElement("div");h.className="hb-actions";const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="copy_project_id",f.dataset.projectId=r.id,f.textContent="复制 ID",h.appendChild(f),s.appendChild(h),u.appendChild(s)}{const s=d("占位符"),l=document.createElement("input");l.className="text_pole hb-proj-placeholder",l.type="text",l.spellcheck=!1,l.value=r.placeholder,l.dataset.projectId=r.id,s.appendChild(l);const h=document.createElement("div");h.className="hb-actions";const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="copy_placeholder",f.dataset.projectId=r.id,f.textContent="复制";const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="insert_placeholder",p.dataset.projectId=r.id,p.textContent="插入到输入框",h.appendChild(f),h.appendChild(p),s.appendChild(h),u.appendChild(s)}{const s=d("入口 HTML"),l=document.createElement("input");l.className="text_pole hb-proj-home",l.type="text",l.spellcheck=!1,l.value=r.homePage,l.dataset.projectId=r.id,s.appendChild(l),u.appendChild(s)}{const s=d("修复 root 相对路径（/xxx）"),l=document.createElement("input");l.className="hb-proj-fix",l.type="checkbox",l.checked=!!r.fixRootRelativeUrls,l.dataset.projectId=r.id,s.appendChild(l),u.appendChild(s)}{const s=d("消息列表显示标题"),l=document.createElement("input");l.className="hb-proj-show-title",l.type="checkbox",l.checked=!!r.showTitleInChat,l.dataset.projectId=r.id,s.appendChild(l),u.appendChild(s)}{const s=d("操作"),l=document.createElement("div");if(l.className="hb-actions",r.source==="embedded"){const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="import_cache",p.dataset.projectId=r.id,p.textContent="导入到缓存",l.appendChild(p);const m=document.createElement("button");m.className="menu_button",m.type="button",m.dataset.hbAction="export_zip",m.dataset.projectId=r.id,m.textContent="导出 zip",l.appendChild(m)}else if(r.source==="url"){const p=document.createElement("button");p.className="menu_button",p.type="button",p.dataset.hbAction="download_apply",p.dataset.projectId=r.id,p.textContent="下载并应用",l.appendChild(p)}else{const p=document.createElement("button");p.className="menu_button",p.type="button",p.disabled=!0,p.title="仅使用本地缓存。若缓存被清理，请在“新增项目”中重新导入 zip。",p.textContent="本地缓存模式",l.appendChild(p)}const h=document.createElement("button");h.className="menu_button",h.type="button",h.dataset.hbAction="open_home",h.dataset.projectId=r.id,h.textContent="打开首页",l.appendChild(h);const f=document.createElement("button");f.className="menu_button",f.type="button",f.dataset.hbAction="delete_project",f.dataset.projectId=r.id,f.textContent="删除项目",l.appendChild(f),s.appendChild(l),u.appendChild(s)}a.appendChild(u),o.appendChild(a)}t.appendChild(o),Me()}async function Et(){$("#higanbana_settings").remove();const e=await fetch(`${A}settings.html`,{cache:"no-store"});if(!e.ok)throw new Error(`加载 settings.html 失败: ${e.status}`);const t=await e.text();$("#extensions_settings").append(t)}function Pt(){const e=N();$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_render_html_blocks").prop("checked",!!e.renderHtmlCodeBlocks),$("#hb_render_html_blocks_blob").prop("checked",!!e.renderHtmlCodeBlocksUseBlobUrl),$("#hb_render_html_blocks_titlebar").prop("checked",!!e.renderHtmlCodeBlocksShowTitleBar);const t=$("#hb_homepage");t.length&&!String(t.val()??"").trim()&&t.val("index.html")}function R(){const e=N(),t=x();if(!t){$("#hb_char_info").text("（未选中角色）"),$("#hb_fix_root_relative").prop("checked",!!e.defaultFixRootRelativeUrls),$("#hb_homepage").val(String($("#hb_homepage").val()??"").trim()||"index.html"),$e([]),$("#hb_import_from_card").prop("disabled",!0),$("#hb_migrate_embedded_to_local").prop("disabled",!0),$("#hb_unbind").prop("disabled",!0),$("#hb_pick_zip_btn").prop("disabled",!0),$("#hb_bind_zip").prop("disabled",!0),$("#hb_bind_zip_btn").prop("disabled",!0),$("#hb_bind_zip_local_btn").prop("disabled",!0),$("#hb_bind_url").prop("disabled",!0),$("#hb_bind_url_btn").prop("disabled",!0);return}const{chid:o,character:r}=t,a=tt(r),n=W(r);$("#hb_char_info").text([`名称：${a}`,`chid：${o}`,n?`avatar：${n}`:""].filter(Boolean).join(`
`));const i=P(r);$e(i.projects);const c=i.projects.length>0;$("#hb_import_from_card").prop("disabled",!i.projects.some(l=>l.source==="embedded")),$("#hb_migrate_embedded_to_local").prop("disabled",!i.projects.some(l=>l.source==="embedded")),$("#hb_unbind").prop("disabled",!c),$("#hb_pick_zip_btn").prop("disabled",!1),$("#hb_bind_zip").prop("disabled",!1),$("#hb_bind_zip_btn").prop("disabled",!1),$("#hb_bind_zip_local_btn").prop("disabled",!1),$("#hb_bind_url").prop("disabled",!1),$("#hb_bind_url_btn").prop("disabled",!1);const u=$("#hb_fix_root_relative");u.length&&document.activeElement!==u.get(0)&&u.prop("checked",!!e.defaultFixRootRelativeUrls);const d=$("#hb_homepage");d.length&&document.activeElement!==d.get(0)&&!String(d.val()??"").trim()&&d.val("index.html");const s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&!String(s.val()??"").trim()&&s.val(ne(i.projects,`{{WEB_${i.projects.length+1}}}`))}function Fe(e){return N().allowedCharacterAvatars.includes(e)}function Z(e){const t=N();t.allowedCharacterAvatars.includes(e)||(t.allowedCharacterAvatars.push(e),O())}const xe=new WeakMap;function zt(e){try{const t=e.contentDocument;if(!t)return null;const o=t.body,r=t.documentElement;if(!o||!r)return null;const a=o.scrollHeight||0,n=r.scrollHeight||0,i=o.offsetHeight||0,c=r.offsetHeight||0,u=Math.max(a,n,i,c);return!Number.isFinite(u)||u<=0?null:u}catch{return null}}function ce(e){const t=zt(e);if(!t)return;const o=Math.max(80,Math.min(t,1e4));e.style.height=`${o}px`}function De(e){xe.get(e)?.ro?.disconnect?.();const o={};xe.set(e,o);const r=()=>{ce(e),setTimeout(()=>ce(e),50),setTimeout(()=>ce(e),250);try{const a=e.contentDocument;if(!a?.documentElement)return;const n=new ResizeObserver(()=>ce(e));n.observe(a.documentElement),a.body&&n.observe(a.body),o.ro=n}catch{}};r(),e.addEventListener("load",r)}function It(e){const t=x();if(!t)return{kind:"stub",title:"彼岸花：无法渲染",reason:"当前不在单角色聊天/未选中角色。"};const o=e.title||e.zipName,r=W(t.character);if(r&&!Fe(r))return{kind:"stub",title:`彼岸花：未启用（${o}）`,reason:e.source==="url"?"该角色卡绑定了 WebZip URL，但尚未允许/下载。切换到该角色时会弹窗询问，或在面板/弹窗中下载并导入缓存。":e.source==="embedded"?"该角色卡包含嵌入 WebZip，但尚未允许/导入。切换到该角色时会弹窗询问，或在面板点“导入所有嵌入项目到本地缓存”。":"该角色卡绑定了本地缓存项目。请先允许该角色，并确保当前浏览器已导入对应 zip。"};const a=e.zipSha256;return a?ye(a)?{kind:"iframe",src:le(A,a,e.homePage),title:`彼岸花：${o} · ${e.homePage}`}:{kind:"stub",title:`彼岸花：未导入缓存（${o}）`,reason:e.source==="url"?"请下载并导入缓存后即可渲染。":e.source==="embedded"?"请先导入到本地缓存（面板中可操作），再刷新聊天即可渲染。":"这是“本地缓存模式”项目，当前浏览器未找到缓存。请在扩展面板重新导入本地 zip 并绑定。"}:{kind:"stub",title:`彼岸花：未下载（${o}）`,reason:e.source==="url"?"请在面板/弹窗中下载并导入缓存后即可渲染。":"缺少 projectId，无法渲染。"}}function Ze(e,t,o,r={}){const a=document.createElement("div");a.className="hb-embed",a.dataset.hbEmbed="1",a.classList.add(o.kind==="stub"?"hb-embed-stub":"hb-embed-iframe"),r.projectId&&(a.dataset.hbProjectId=r.projectId),r.showTitleInChat===!0||a.classList.add("hb-embed-no-title");const i=document.createElement("div");i.className="hb-embed-header";const c=document.createElement("div");c.className="hb-embed-title",c.textContent=o.title;const u=document.createElement("div");if(u.className="hb-embed-actions",o.kind==="iframe"){const h=document.createElement("a");h.href=r.openInNewTabUrl||o.src,h.target="_blank",h.rel="noopener noreferrer",h.textContent="新标签页打开",u.appendChild(h)}i.appendChild(c),i.appendChild(u),a.appendChild(i);const d=document.createElement("div");if(d.className="hb-embed-body",o.kind==="stub"){const h=document.createElement("div");return h.style.padding="10px",h.style.opacity="0.9",h.textContent=o.reason,d.appendChild(h),a.appendChild(d),a}const s=document.createElement("iframe");s.className="hb-iframe",s.loading="lazy",s.referrerPolicy="no-referrer",s.name=`hb-${e}-${t}`,s.setAttribute("sandbox","allow-scripts allow-same-origin");const l=!!r.projectId||r.useBlobUrlInChat===!0;try{s.dataset=s.dataset||{},s.dataset.hbVfsHomeUrl=o.src,s.dataset.hbUseBlobUrl=l?"1":"0"}catch{}return l?(s.removeAttribute("src"),s.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',Oe(s,o.src)):(s.removeAttribute("srcdoc"),s.src=o.src),De(s),d.appendChild(s),a.appendChild(d),a}const Be=new Map;function Rt(e){const t=String(e??"").trim();return`<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      *{box-sizing:border-box}
      html,body{margin:0;padding:0;width:100%}
      #inner{display:block;width:100%;border:0;height:260px}
      .loading{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:12px;opacity:.85}
    </style>
  </head>
  <body>
    <div class="loading" id="loading">正在加载…</div>
    <iframe id="inner" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer"></iframe>
    <script>
      const VFS_URL = ${JSON.stringify(t)};
      const inner = document.getElementById('inner');
      const loading = document.getElementById('loading');
      const clamp = (h) => Math.max(80, Math.min(Number(h) || 0, 10000));
      const setHeight = (h) => {
        const px = clamp(h);
        if (!px) return;
        inner.style.height = px + 'px';
      };

      try { inner.name = String(window.name || ''); } catch {}
      try { inner.src = VFS_URL; } catch {}

      inner.addEventListener('load', () => {
        try { if (loading) loading.style.display = 'none'; } catch {}
      });

      window.addEventListener('message', (ev) => {
        const data = ev && ev.data;
        if (!data || typeof data !== 'object') return;

        // Height message from inner
        if (ev.source === inner.contentWindow && data.type === 'HB_IFRAME_HEIGHT') {
          setHeight(data.height);
          return;
        }

        // Bridge messages between inner <-> parent (for ST_API / CSRF proxy)
        if (data.__hb === 'higanbana' && data.v === 1) {
          try {
            if (ev.source === inner.contentWindow) {
              window.parent && window.parent.postMessage(data, '*');
              return;
            }
            if (ev.source === window.parent) {
              inner.contentWindow && inner.contentWindow.postMessage(data, '*');
            }
          } catch {
            // ignore
          }
        }
      });
    <\/script>
  </body>
</html>`}async function Ut(e){const t=String(e??"").trim();if(!t)throw new Error("vfsHomeUrl is required");const o=Be.get(t);if(o)return await o.promise;const r={promise:(async()=>{const a=Rt(t),n=URL.createObjectURL(new Blob([a],{type:"text/html"}));return r.url=n,n})()};return Be.set(t,r),await r.promise}async function Oe(e,t){try{const o=String(t??"").trim();if(!o)return;e.dataset=e.dataset||{},e.dataset.hbVfsHomeUrl=o,e.dataset.hbUseBlobUrl="1";const r=await Ut(o);if(!e.isConnected)return;const a=String(e.dataset?.hbVfsHomeUrl??"");if(!(String(e.dataset?.hbUseBlobUrl??"")==="1")||a!==o)return;e.removeAttribute("srcdoc"),e.src=r}catch(o){console.warn("[Higanbana] blob render failed, fallback to VFS",{vfsHomeUrl:t,err:o});try{if(!e.isConnected)return;e.removeAttribute("srcdoc"),e.src=String(t??"")}catch{}}}function At(e,t){if(!e)return;const o=document.querySelectorAll(".hb-embed[data-hb-project-id]");for(const r of o)String(r.dataset?.hbProjectId??"")===e&&(t?r.classList.remove("hb-embed-no-title"):r.classList.add("hb-embed-no-title"))}function Ge(){const e=document.querySelectorAll(".hb-embed.hb-embed-iframe[data-hb-project-id]");for(const t of e){const o=t.querySelector("iframe.hb-iframe");if(!o)continue;const r=String(o.src||"");if(r.startsWith("blob:"))continue;const a=t.querySelector(".hb-embed-actions a"),n=String(a?.href||o.dataset?.hbVfsHomeUrl||r||"").trim();n&&(o.removeAttribute("src"),o.srcdoc='<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:16px;opacity:.85}</style><div>正在加载…</div>',Oe(o,n))}}function kt(e){const t=String(e??"").toLowerCase();return t.includes("<html")||t.includes("<head")||t.includes("<body")||t.includes("<!doctype html")}function _e(e){const o=String(e??"").trim(),r=o.toLowerCase();return o?r.includes("<!doctype")||r.includes("<html")?o:`<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><body>${o}</body>`:'<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'}function Tt(e){let t=2166136261;for(let o=0;o<e.length;o++)t^=e.charCodeAt(o),t=Math.imul(t,16777619);return(t>>>0).toString(16)}function Ee(e,t){const o=we(_e(t),{origin:window.location.origin,forceBaseHref:!0}),r=Tt(o),a=String(e.dataset?.hbHtmlHash??""),n=String(e.dataset?.hbHtmlBlobUrl??"");if(n&&a===r)return n;if(n)try{URL.revokeObjectURL(n)}catch{}const i=URL.createObjectURL(new Blob([o],{type:"text/html"}));return e.dataset.hbHtmlHash=r,e.dataset.hbHtmlBlobUrl=i,i}function Ve(e,t){const o=N(),r=!!o.renderHtmlCodeBlocks,a=!!o.renderHtmlCodeBlocksUseBlobUrl,n=!!o.renderHtmlCodeBlocksShowTitleBar,i=a||n,c=Array.from(e.querySelectorAll(".hb-html-render"));if(!r){for(const s of c){const l=String(s.dataset?.hbHtmlBlobUrl??"");if(l)try{URL.revokeObjectURL(l)}catch{}const h=s.querySelector("pre");h&&s.parentNode&&(h.classList.remove("hb-html-code-hidden"),s.parentNode.insertBefore(h,s)),s.remove()}return}const u=Array.from(e.querySelectorAll("pre > code"));if(u.length===0)return;for(const s of c)s.querySelectorAll(".hb-embed").forEach(l=>l.remove()),s.querySelectorAll("iframe.hb-html-iframe").forEach(l=>l.remove());let d=e.querySelectorAll(".hb-embed").length;for(const s of u){const l=s.closest("pre");if(!l)continue;const h=s.textContent||"";if(!kt(h))continue;const f=l.closest(".hb-html-render"),p=f||document.createElement("div");if(!f){p.className="hb-html-render",p.dataset.hbHtmlRender="1";const y=l.parentNode;if(!y)continue;y.insertBefore(p,l),p.appendChild(l)}if(l.classList.add("hb-html-code-hidden"),!i){const y=String(p.dataset?.hbHtmlBlobUrl??"");if(y)try{URL.revokeObjectURL(y)}catch{}try{delete p.dataset.hbHtmlBlobUrl,delete p.dataset.hbHtmlHash}catch{}}const m=a?Ee(p,h):"";if(n){const y=we(_e(h),{origin:window.location.origin,forceBaseHref:!1}),v={kind:"iframe",src:a&&m?m:"about:blank",title:"HTML 代码块"},S=Ze(t,d++,v,{showTitleInChat:!0,openInNewTabUrl:a&&m?m:"#"}),b=p.querySelector(".hb-embed");if(b&&b.remove(),p.appendChild(S),!a){const _=S.querySelector("iframe.hb-iframe");_&&(_.removeAttribute("src"),_.srcdoc=y);const j=S.querySelector(".hb-embed-actions a");j&&String(j.dataset?.hbHtmlLazyOpenBound??"")!=="1"&&(j.dataset.hbHtmlLazyOpenBound="1",j.href="#",j.addEventListener("click",C=>{try{C.preventDefault();const I=Ee(p,h);window.open(I,"_blank","noopener,noreferrer")}catch{}}))}continue}const g=p.querySelector(".hb-embed");g&&g.remove();let w=p.querySelector("iframe.hb-html-iframe");w||(w=document.createElement("iframe"),w.className="hb-html-iframe",w.loading="lazy",w.referrerPolicy="no-referrer",w.name=`hb-html-${t}`,w.setAttribute("sandbox","allow-scripts allow-same-origin"),De(w),p.appendChild(w)),a&&m?(w.removeAttribute("srcdoc"),w.src=m):(w.removeAttribute("src"),w.srcdoc=we(_e(h),{origin:window.location.origin,forceBaseHref:!1}))}}function Ht(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function qe(e,t){const o=x();if(!o)return;const r=P(o.character);if(r.projects.length===0)return;const a=new Map;for(const m of r.projects){const g=String(m.placeholder??"").trim();g&&(a.has(g)||a.set(g,m))}const n=Array.from(a.keys());if(n.length===0)return;const i=e.textContent||"";let c=!1;for(const m of n)if(i.includes(m)){c=!0;break}if(!c)return;n.sort((m,g)=>g.length-m.length);const u=n.map(Ht).join("|"),d=new RegExp(u,"g"),s=new RegExp(u),l=new Map;for(const m of n){const g=a.get(m);g&&l.set(m,It(g))}let h=0;const f=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode(m){const g=m?.nodeValue||"";if(!g||!s.test(g))return NodeFilter.FILTER_REJECT;let w=m.parentNode;for(;w&&w!==e;){if(w.nodeType===1){const y=w.tagName;if(y==="CODE"||y==="PRE"||y==="TEXTAREA")return NodeFilter.FILTER_REJECT}w=w.parentNode}return NodeFilter.FILTER_ACCEPT}}),p=[];for(;f.nextNode();)p.push(f.currentNode);for(const m of p){const g=m.nodeValue||"";if(!s.test(g))continue;d.lastIndex=0;let w=0;const y=document.createDocumentFragment();for(const v of g.matchAll(d)){const S=Number(v.index??0),b=String(v[0]??"");S>w&&y.appendChild(document.createTextNode(g.slice(w,S)));const _=a.get(b),j=l.get(b);j?y.appendChild(Ze(t,h++,j,{projectId:_?.id,showTitleInChat:_?.showTitleInChat,useBlobUrlInChat:!0,openInNewTabUrl:j.kind==="iframe"?j.src:void 0})):y.appendChild(document.createTextNode(b)),w=S+b.length}w<g.length&&y.appendChild(document.createTextNode(g.slice(w))),m.parentNode?.replaceChild(y,m)}}function fe(e){const t=Number(e);if(!Number.isFinite(t))return;const o=$(`#chat .mes[mesid="${t}"]`);if(o.length===0)return;const r=o.find(".mes_text").get(0);r&&(qe(r,t),Ve(r,t),Ge())}function Je(){const e=document.querySelectorAll("#chat .mes[mesid]");for(const t of e){const o=t.getAttribute("mesid"),r=Number(o);if(!Number.isFinite(r))continue;const a=t.querySelector(".mes_text");a&&(qe(a,r),Ve(a,r))}Ge()}let me=!1;function H(){me||(me=!0,setTimeout(()=>{me=!1,Je()},0))}let Pe=!1;function Nt(){if(Pe)return;const e=B();if(!e?.eventSource||!e?.event_types)return;Pe=!0;const{eventSource:t,event_types:o}=e,r=(...n)=>fe(n?.[0]),a=(...n)=>{const i=Number(n?.[0]);Number.isFinite(i)&&(setTimeout(()=>fe(i),0),setTimeout(()=>fe(i),50))};t.on(o.USER_MESSAGE_RENDERED,r),t.on(o.CHARACTER_MESSAGE_RENDERED,r),o.MESSAGE_EDITED&&t.on(o.MESSAGE_EDITED,a),o.MESSAGE_UPDATED&&t.on(o.MESSAGE_UPDATED,a),o.MORE_MESSAGES_LOADED&&t.on(o.MORE_MESSAGES_LOADED,()=>H()),o.CHAT_CHANGED&&t.on(o.CHAT_CHANGED,()=>H())}function z(e){$("#hb_status").text(e)}function de(e){return e.source==="url"?e.zipSha256?!ye(e.zipSha256):!0:!ye(e.zipSha256)}function Ye(e){const t=document.createElement("div"),o=document.createElement("h3");o.textContent=e,t.appendChild(o);const r=document.createElement("progress");r.max=100,r.value=0,r.style.width="100%",r.style.height="12px",t.appendChild(r);const a=document.createElement("div");return a.style.marginTop="8px",a.style.opacity="0.9",a.style.whiteSpace="nowrap",a.style.overflowX="auto",a.style.overflowY="hidden",t.appendChild(a),{root:t,titleEl:o,progress:r,text:a}}async function je(e,t){const o=B();if(!o)throw new Error("上下文缺失");const r=t.filter(f=>de(f));if(r.length===0)return{importedCount:0,cancelled:!1};if(!o.callGenericPopup||!o.POPUP_TYPE){let f=0;for(const p of r){const m=x();if(!m||Number(m.chid)!==Number(e))break;const g=p.title||p.zipName;z(`正在导入：${g} ...`);let w;if(p.source==="url")w=(await ee(p.zipUrl)).arrayBuffer;else if(p.source==="embedded")w=await G(p.zipBase64);else{z(`项目“${g}”为本地缓存模式，无法自动恢复缓存，请在面板重新导入本地 zip。`);continue}const y=await D(A,w,{fixRootRelativeUrls:p.fixRootRelativeUrls,preferredHomePage:p.homePage});k.add(y.projectId),await L();const S=P(m.character).projects.map(b=>b.id===p.id?{...b,zipSha256:y.projectId,homePage:y.homePage}:b);await T(e,{projects:S}),f++}return{importedCount:f,cancelled:!1}}if(J.urlDownloadPopupInFlight)throw new Error("当前已有下载弹窗进行中，请稍后再试");J.urlDownloadPopupInFlight=!0;const a=new AbortController;let n=!1,i=!1,c=0;const{root:u,titleEl:d,progress:s,text:l}=Ye("彼岸花：准备导入...");l.style.whiteSpace="pre-wrap",l.style.overflowX="hidden";const h=f=>{try{l.textContent=Se(f)}catch{l.textContent="正在下载..."}if(f?.totalBytes){const p=Number(f?.percent);Number.isFinite(p)&&(s.max=100,s.value=Math.max(0,Math.min(100,p)))}else s.removeAttribute("value")};try{await o.callGenericPopup(u,o.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消",onClosing:()=>(n||(i=!0,a.abort()),!0),onOpen:async f=>{try{for(let p=0;p<r.length;p++){const m=r[p];if(a.signal.aborted)break;const g=x();if(!g||Number(g.chid)!==Number(e))break;const w=m.title||m.zipName;d.textContent=`彼岸花：正在导入（${p+1}/${r.length}）${w}`;let y;if(m.source==="url")l.textContent=`准备下载：${m.zipName}
${m.zipUrl}`,s.max=100,s.value=0,y=(await ee(m.zipUrl,{signal:a.signal,onProgress:h})).arrayBuffer,s.value=100,l.textContent=`下载完成（${Y(y.byteLength)}），正在解压并写入缓存...`;else if(m.source==="embedded")s.removeAttribute("value"),l.textContent=`正在从角色卡导入并解压：${m.zipName}`,y=await G(m.zipBase64);else{l.textContent=`项目“${w}”为本地缓存模式，无法自动恢复缓存。请在面板重新导入本地 zip。`;continue}const v=await D(A,y,{fixRootRelativeUrls:m.fixRootRelativeUrls,preferredHomePage:m.homePage});k.add(v.projectId),await L();const b=P(g.character).projects.map(_=>_.id===m.id?{..._,zipSha256:v.projectId,homePage:v.homePage}:_);await T(e,{projects:b}),c++}n=!0;try{await f.completeAffirmative?.()}catch{}}catch(p){n=!0;try{await f.completeCancelled?.()}catch{}throw p}}})}finally{J.urlDownloadPopupInFlight=!1}return{importedCount:c,cancelled:i}}async function Lt(e){const t=B();if(!t)return null;if(!t.callGenericPopup||!t.POPUP_TYPE){const d=await ee(e.zipUrl),s=await D(A,d.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});return k.add(s.projectId),await L(),{projectId:s.projectId,homePage:s.homePage,fileCount:s.fileCount}}if(J.urlDownloadPopupInFlight)return null;J.urlDownloadPopupInFlight=!0;const o=new AbortController;let r=!1,a=null;const{root:n,progress:i,text:c}=Ye("彼岸花：正在下载 WebZip...");c.textContent=`准备下载：${e.zipName} | ${e.zipUrl}`;const u=d=>{if(c.textContent=Se(d),d.totalBytes){const s=Number(d.percent);Number.isFinite(s)&&(i.max=100,i.value=Math.max(0,Math.min(100,s)))}else i.removeAttribute("value")};try{await t.callGenericPopup(n,t.POPUP_TYPE.TEXT,"",{okButton:!1,cancelButton:"取消下载",onClosing:()=>(r||o.abort(),!0),onOpen:async d=>{try{const s=await ee(e.zipUrl,{signal:o.signal,onProgress:u});i.max=100,i.value=100,c.textContent=`下载完成（${Y(s.arrayBuffer.byteLength)}），正在解压并写入缓存...`;const l=await D(A,s.arrayBuffer,{fixRootRelativeUrls:e.fixRootRelativeUrls,preferredHomePage:e.homePage});k.add(l.projectId),await L(),a={projectId:l.projectId,homePage:l.homePage,fileCount:l.fileCount},r=!0;try{await d.completeAffirmative()}catch{}}catch(s){o.signal.aborted||s?.name==="AbortError"?toastr.info("已取消下载"):(console.error("[Higanbana] url download failed",s),toastr.error(`下载失败：${s?.message??s}`)),r=!0;try{await d.completeCancelled?.()}catch{}}}})}finally{J.urlDownloadPopupInFlight=!1}return a}let q=null;const ze=20*1024*1024;function re(e){const t=Number(e?.byteLength??0);if(!Number.isFinite(t)||t<=ze)return;const o=Math.round(ze/1024/1024);throw new Error(`当前 zip 大小为 ${Y(t)}，超过嵌入上限（${o} MB）。请改用“添加本地缓存项目（不嵌入）”或 URL 模式。`)}function Ie(e){const t=$("#hb_url_download_wrap"),o=$("#hb_cancel_url_download_btn");e?(t.show(),o.show()):(t.hide(),o.hide())}function Wt(e){const t=$("#hb_url_download_wrap"),o=$("#hb_url_progress"),r=$("#hb_url_progress_text");t.length&&t.show();try{r.text(Se(e))}catch{r.text("正在下载...")}if(e?.totalBytes){const a=Number(e?.percent);Number.isFinite(a)&&(o.attr("max","100"),o.get(0)?.removeAttribute?.("value"),o.val(Math.max(0,Math.min(100,a))))}else o.get(0)?.removeAttribute?.("value")}function Mt(){try{q?.abort()}catch{}}async function Ft(){const e=B(),t=x();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const o=P(t.character),r=o.projects.find(u=>u.source==="url");if(!r)throw new Error("当前角色卡没有 URL 项目");if(J.urlDownloadPopupInFlight)throw new Error("当前已有自动下载弹窗进行中，请稍后再试");q&&!q.signal.aborted&&q.abort();const a=W(t.character);a&&Z(a);const n=r.fixRootRelativeUrls,i=r.homePage,c=new AbortController;q=c,Ie(!0),$("#hb_url_progress").attr("max","100"),$("#hb_url_progress").val(0),$("#hb_url_progress_text").text(`准备下载：${r.zipName} | ${r.zipUrl}`),$("#hb_bind_url_btn").prop("disabled",!0),$("#hb_download_url_btn").prop("disabled",!0);try{const u=await ee(r.zipUrl,{signal:c.signal,onProgress:Wt});if(c.signal.aborted)throw new Error("已取消下载");z("下载完成，正在解压并写入 VFS 缓存...");const d=await D(A,u.arrayBuffer,{fixRootRelativeUrls:n,preferredHomePage:i});k.add(d.projectId),await L();const s={projects:o.projects.map(l=>l.source==="url"?{...l,zipSha256:d.projectId,homePage:d.homePage}:l)};await T(t.chid,s),z(`已下载并导入缓存。
projectId(sha256)：${d.projectId}
入口：${d.homePage}
文件数：${d.fileCount}

提示：在消息中插入占位符即可渲染`),e?.reloadCurrentChat&&await e.reloadCurrentChat()}finally{q===c&&(q=null),Ie(!1),$("#hb_bind_url_btn").prop("disabled",!1),$("#hb_download_url_btn").prop("disabled",!1),R()}}async function Dt(e,t){const o=x();if(!o)throw new Error("当前不在单角色聊天/未选中角色");re(t);const r=W(o.character);r&&Z(r);const a=N(),n=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=n,O();const i=String($("#hb_homepage").val()??"").trim()||void 0;z("正在解压并写入 VFS 缓存...");const c=await D(A,t,{fixRootRelativeUrls:n,preferredHomePage:i});k.add(c.projectId),await L(),z("正在编码 base64 并写入角色卡扩展字段...");const u=await ve(t),d=P(o.character),s=oe($("#hb_placeholder").val()),l=ne(d.projects,s),h=String($("#hb_new_title").val()??"").trim(),f=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,p={source:"embedded",id:te(),title:h||void 0,placeholder:l,homePage:c.homePage,showTitleInChat:f,fixRootRelativeUrls:n,zipName:e,zipSha256:c.projectId,zipBase64:u},m={projects:[...d.projects,p]};await T(o.chid,m);const g=$("#hb_placeholder");g.length&&document.activeElement!==g.get(0)&&g.val(""),R(),$("#hb_new_title").val(""),z(`已添加项目（嵌入模式）。
占位符：${l}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}

提示：导出该角色卡(json/png)会包含该项目的 zipBase64`)}async function Zt(e,t){const o=x();if(!o)throw new Error("当前不在单角色聊天/未选中角色");const r=W(o.character);r&&Z(r);const a=N(),n=!!$("#hb_fix_root_relative").prop("checked");a.defaultFixRootRelativeUrls=n,O();const i=String($("#hb_homepage").val()??"").trim()||void 0;z("正在解压并写入 VFS 缓存...");const c=await D(A,t,{fixRootRelativeUrls:n,preferredHomePage:i});k.add(c.projectId),await L();const u=P(o.character),d=oe($("#hb_placeholder").val()),s=ne(u.projects,d),l=String($("#hb_new_title").val()??"").trim(),h=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,f={source:"local",id:te(),title:l||void 0,placeholder:s,homePage:c.homePage,showTitleInChat:h,fixRootRelativeUrls:n,zipName:e,zipSha256:c.projectId},p={projects:[...u.projects,f]};await T(o.chid,p);const m=$("#hb_placeholder");m.length&&document.activeElement!==m.get(0)&&m.val(""),R(),$("#hb_new_title").val(""),z(`已添加项目（本地缓存模式，不嵌入角色卡）。
占位符：${s}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}

提示：导出角色卡时不会包含该 zip；若浏览器缓存被清理，需要在本机重新导入 zip。`)}async function Ot({allow:e=!0,ensureCached:t=!0,reloadChat:o=!0}={}){const r=B(),a=x();if(!a)throw new Error("当前不在单角色聊天/未选中角色");const n=W(a.character);e&&n&&Z(n);const c=P(a.character).projects.filter(p=>p.source==="embedded"),u=c.length;if(u===0)return{totalEmbedded:0,migrated:0,importedCount:0,cancelled:!1};let d=0,s=!1;if(t){const p=c.filter(m=>de(m));if(p.length>0){z(`发现 ${p.length} 个嵌入项目未缓存，正在导入缓存...`);const m=await je(a.chid,p);if(d=m.importedCount,s=m.cancelled,s)return z("已取消迁移（未修改角色卡）"),{totalEmbedded:u,migrated:0,importedCount:d,cancelled:!0}}}const l=P(a.character);let h=0;const f=l.projects.map(p=>p.source!=="embedded"?p:(h++,{source:"local",id:p.id,title:p.title,placeholder:p.placeholder,homePage:p.homePage,showTitleInChat:p.showTitleInChat,fixRootRelativeUrls:p.fixRootRelativeUrls,zipName:p.zipName,zipSha256:p.zipSha256}));return await T(a.chid,{projects:f}),o&&r?.reloadCurrentChat&&await r.reloadCurrentChat(),R(),{totalEmbedded:u,migrated:h,importedCount:d,cancelled:!1}}function ue(e,t,o){const r=String(t??"").trim(),a=String(o??"").trim();if(r){const n=e.findIndex(i=>i.id===r);if(n<0)throw new Error(`找不到目标项目：${r}`);return n}if(a){const n=[];for(let i=0;i<e.length;i++)e[i]?.zipSha256===a&&n.push(i);if(n.length===0)throw new Error(`找不到使用该 zipSha256 的项目：${a}`);if(n.length>1)throw new Error("存在多个项目使用相同 zipSha256，请传入 targetProjectId 精确指定目标项目");return n[0]}throw new Error("缺少目标项目标识，请提供 targetProjectId 或 targetZipSha256")}async function Xe(e){const t=B(),{active:o,card:r}=M(),a=ue(r.projects,e?.targetProjectId,e?.targetZipSha256),n=r.projects[a],i=String(e?.source??n.source).trim(),c=i==="embedded"||i==="url"||i==="local"?i:"";if(!c)throw new Error(`非法 source：${i}`);const u=e?.title!==void 0?String(e.title??"").trim()||void 0:n.title,d=e?.placeholder!==void 0?String(e.placeholder??"").trim():n.placeholder,s=e?.homePage!==void 0?String(e.homePage??"").trim():n.homePage,l=typeof e?.showTitleInChat=="boolean"?!!e.showTitleInChat:!!n.showTitleInChat,h=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!n.fixRootRelativeUrls,f=e?.zipName!==void 0?String(e.zipName??"").trim():n.zipName,p=e?.zipSha256!==void 0?String(e.zipSha256??"").trim():String(n.zipSha256??"").trim();if(!d)throw new Error("placeholder 不能为空");if(!s)throw new Error("homePage 不能为空");if(!f)throw new Error("zipName 不能为空");if(r.projects.some((y,v)=>v!==a&&y.placeholder===d))throw new Error(`占位符已被其它项目占用：${d}`);let g;if(c==="url"){const y=e?.zipUrl!==void 0?String(e.zipUrl??"").trim():n.source==="url"?n.zipUrl:"";if(!y)throw new Error("source=url 时 zipUrl 不能为空");g={source:"url",id:n.id,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p||"",zipUrl:y}}else if(c==="embedded"){const y=e?.zipBase64!==void 0?String(e.zipBase64??"").trim():n.source==="embedded"?n.zipBase64:"";if(!y)throw new Error("source=embedded 时 zipBase64 不能为空");if(!p)throw new Error("source=embedded 时 zipSha256 不能为空");if(e?.zipBase64!==void 0){const v=await G(y);re(v)}g={source:"embedded",id:n.id,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p,zipBase64:y}}else{if(!p)throw new Error("source=local 时 zipSha256 不能为空");g={source:"local",id:n.id,title:u,placeholder:d,homePage:s,showTitleInChat:l,fixRootRelativeUrls:h,zipName:f,zipSha256:p}}const w=[...r.projects];return w[a]=g,await T(o.chid,{projects:w}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),R(),H(),{targetProjectId:n.id,project:g}}function Gt(e){if(e instanceof Uint8Array){const r=new Uint8Array(e.byteLength);return r.set(e),r.buffer}const t=new Uint8Array(e),o=new Uint8Array(t.byteLength);return o.set(t),o.buffer}async function Ke(e){if(e?.zipArrayBuffer instanceof ArrayBuffer||e?.zipArrayBuffer instanceof Uint8Array)return Gt(e.zipArrayBuffer);const t=String(e?.importZipBase64??e?.zipBase64??"").trim();if(t)return await G(t);throw new Error("缺少 zip 数据，请提供 zipArrayBuffer 或 zipBase64")}async function Vt(e){const{card:t}=M(),o=ue(t.projects,e?.targetProjectId,e?.targetZipSha256),r=t.projects[o],a=await Ke(e),n=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!r.fixRootRelativeUrls,i=String(e?.preferredHomePage??e?.homePage??r.homePage??"").trim()||void 0;z("正在导入新 zip 并写入 VFS 缓存...");const c=await D(A,a,{fixRootRelativeUrls:n,preferredHomePage:i});k.add(c.projectId),await L();const u=String(e?.source??r.source).trim(),d=u==="embedded"||u==="url"||u==="local"?u:"";if(!d)throw new Error(`非法 source：${u}`);const s={targetProjectId:r.id,source:d,zipName:e?.zipName!==void 0?String(e.zipName??"").trim():r.zipName,homePage:c.homePage,zipSha256:c.projectId,fixRootRelativeUrls:n,reloadChat:e?.reloadChat};if(d==="url"&&e?.zipUrl!==void 0&&(s.zipUrl=String(e.zipUrl??"").trim()),d==="embedded"){if(!(e?.persistEmbeddedToCard!==!1))throw new Error("source=embedded 时必须写入 zipBase64；若不希望写入角色卡，请将 source 设为 local");re(a),s.zipBase64=e?.zipBase64!==void 0?String(e.zipBase64??"").trim():await ve(a)}const l=await Xe(s);return z(`已覆盖项目 zip。
项目：${l.project.title||l.project.zipName}
projectId(sha256)：${c.projectId}
入口：${c.homePage}
文件数：${c.fileCount}`),{targetProjectId:l.targetProjectId,project:l.project,imported:c}}async function qt(e){const t=e?.zipArrayBuffer instanceof ArrayBuffer||e?.zipArrayBuffer instanceof Uint8Array,o=String(e?.importZipBase64??"").trim().length>0;return t||o?await Vt({...e,zipBase64:void 0}):await Xe(e)}function se(e){return e.source==="embedded"?{...e,source:"embedded",zipBase64:String(e.zipBase64??"")}:e.source==="url"?{...e,source:"url",zipUrl:String(e.zipUrl??"")}:{...e,source:"local"}}function Jt(e={}){const{card:t}=M(),o=t.projects.map(se),r=!!e?.includeAll,a=String(e?.targetProjectId??"").trim(),n=String(e?.targetZipSha256??"").trim();if(r||!a&&!n)return{projects:o};const i=ue(t.projects,a,n);return{projects:o,project:se(t.projects[i])}}async function Yt(e){const t=B(),{active:o,card:r}=M(),a=ue(r.projects,e?.targetProjectId,e?.targetZipSha256),n=r.projects[a],i=r.projects.filter((c,u)=>u!==a);return await T(o.chid,{projects:i}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),R(),H(),z(`已删除项目：${n.title||n.zipName}`),{deletedProjectId:n.id,deletedProject:se(n),remainingCount:i.length}}async function Xt(e){const t=B(),{active:o,card:r}=M(),a=N(),n=e?.zipArrayBuffer instanceof ArrayBuffer||e?.zipArrayBuffer instanceof Uint8Array,i=String(e?.importZipBase64??"").trim().length>0,c=n||i,u=c?"local":String(e?.zipUrl??"").trim()?"url":String(e?.zipBase64??"").trim()?"embedded":"local",d=String(e?.source??u).trim(),s=d==="embedded"||d==="url"||d==="local"?d:"";if(!s)throw new Error(`非法 source：${d}`);const h=oe(e?.placeholder??"")||a.placeholder,f=ne(r.projects,h);let p=te();for(;r.projects.some(U=>U.id===p);)p=te();const m=String(e?.title??"").trim()||void 0,g=typeof e?.showTitleInChat=="boolean"?!!e.showTitleInChat:!1,w=typeof e?.fixRootRelativeUrls=="boolean"?!!e.fixRootRelativeUrls:!!a.defaultFixRootRelativeUrls,y=String(e?.zipUrl??"").trim();let v=String(e?.zipName??"").trim(),S=String(e?.homePage??"").trim(),b=String(e?.zipSha256??"").trim(),_=String(e?.zipBase64??"").trim(),j;if(c){const U=await Ke(e),E=String(e?.preferredHomePage??e?.homePage??"").trim()||void 0;z("正在导入新 zip 并创建项目...");const F=await D(A,U,{fixRootRelativeUrls:w,preferredHomePage:E});if(k.add(F.projectId),await L(),j={projectId:F.projectId,homePage:F.homePage,fileCount:F.fileCount,cacheName:F.cacheName},b=F.projectId,S=F.homePage,s==="embedded"){if(!(e?.persistEmbeddedToCard!==!1))throw new Error("source=embedded 时必须写入 zipBase64；若不希望写入角色卡，请将 source 设为 local");re(U),_||(_=await ve(U))}}if(s==="url"&&!y)throw new Error("source=url 时 zipUrl 不能为空");v||(s==="url"?v=y?We(y):"webzip.zip":v="webzip.zip"),S||(S="index.html");let C;if(s==="embedded"){if(!_)throw new Error("source=embedded 时 zipBase64 不能为空（可改传 zipArrayBuffer/importZipBase64 自动导入）");if(!b)throw new Error("source=embedded 时 zipSha256 不能为空（可改传 zipArrayBuffer/importZipBase64 自动生成）");if(!c){const U=await G(_);re(U)}C={source:"embedded",id:p,title:m,placeholder:f,homePage:S,showTitleInChat:g,fixRootRelativeUrls:w,zipName:v,zipSha256:b,zipBase64:_}}else if(s==="url")C={source:"url",id:p,title:m,placeholder:f,homePage:S,showTitleInChat:g,fixRootRelativeUrls:w,zipName:v,zipSha256:b||"",zipUrl:y};else{if(!b)throw new Error("source=local 时 zipSha256 不能为空（可改传 zipArrayBuffer/importZipBase64 自动导入）");C={source:"local",id:p,title:m,placeholder:f,homePage:S,showTitleInChat:g,fixRootRelativeUrls:w,zipName:v,zipSha256:b}}const I=[...r.projects,C];return await T(o.chid,{projects:I}),e?.reloadChat!==!1&&t?.reloadCurrentChat&&await t.reloadCurrentChat(),R(),H(),z(`已创建项目：${C.title||C.zipName}
项目ID：${C.id}
占位符：${C.placeholder}`),{project:se(C),imported:j}}async function Kt({allow:e=!0,reloadChat:t=!0}={}){const o=B(),r=x();if(!r)throw new Error("当前不在单角色聊天/未选中角色");const a=P(r.character),n=a.projects.filter(d=>d.source==="embedded");if(n.length===0)throw new Error("当前角色卡没有可导入的嵌入项目");const i=W(r.character);e&&i&&Z(i);const c=[...a.projects];let u=!1;for(const d of n){if(d.zipSha256&&k.has(d.zipSha256))continue;z(`正在从角色卡导入：${d.title||d.zipName} ...`);const s=await G(d.zipBase64),l=await D(A,s,{fixRootRelativeUrls:d.fixRootRelativeUrls,preferredHomePage:d.homePage});if(k.add(l.projectId),await L(),l.projectId!==d.zipSha256){console.warn("[Higanbana] zipSha256 mismatch",{embedded:d.zipSha256,computed:l.projectId});const h=c.findIndex(f=>f.id===d.id);if(h>=0){const f=c[h];f&&f.source==="embedded"&&(c[h]={...f,zipSha256:l.projectId,homePage:l.homePage},u=!0)}}}u&&await T(r.chid,{projects:c}),z(`已导入到缓存。
已导入项目数：${n.length}`),t&&o?.reloadCurrentChat&&await o.reloadCurrentChat()}function M(){const e=x();if(!e)throw new Error("当前不在单角色聊天/未选中角色");const t=P(e.character);return{active:e,card:t}}function ae(e,t){const o=String(t??"").trim();if(!o)throw new Error("项目 id 为空");const r=e.projects.find(a=>a.id===o);if(!r)throw new Error("找不到项目（可能已被删除）");return r}function Qt(e){const{card:t}=M(),o=ae(t,e);if(!o.zipSha256)throw new Error("尚未下载/导入到本地缓存");if(!k.has(o.zipSha256))throw new Error("尚未导入到本地缓存");const r=le(A,o.zipSha256,o.homePage);window.open(r,"_blank","noopener,noreferrer")}async function er(e){const{card:t}=M(),o=ae(t,e);if(o.source!=="embedded")throw new Error("当前项目不是嵌入模式，无法导出 zip");const r=await G(o.zipBase64),a=new Blob([r],{type:"application/zip"});Le(a,o.zipName||"webzip.zip")}async function tr(e){const{active:t,card:o}=M(),r=ae(o,e);if(r.source!=="embedded")throw new Error("当前项目不是嵌入模式");if(!de(r))return{importedCount:0,cancelled:!1};const a=W(t.character);a&&Z(a);const n=await je(t.chid,[r]);return n.cancelled||(await B()?.reloadCurrentChat?.(),R()),n}async function rr(e){const{active:t,card:o}=M(),r=ae(o,e);if(r.source!=="url")throw new Error("当前项目不是 URL 模式");const a=W(t.character);a&&Z(a);const n=await Lt(r);if(!n)return!1;const c={projects:P(t.character).projects.map(u=>u.id===r.id?{...u,zipSha256:n.projectId,homePage:n.homePage}:u)};return await T(t.chid,c),await B()?.reloadCurrentChat?.(),R(),!0}async function or(e){const t=B(),{active:o,card:r}=M(),a=ae(r,e),n=r.projects.filter(i=>i.id!==a.id);await T(o.chid,n.length?{projects:n}:null),await t?.reloadCurrentChat?.(),R()}async function nr(){const{active:e}=M();await T(e.chid,null),R()}async function ar(e){const t=x();if(!t)throw new Error("当前不在单角色聊天/未选中角色");const o=Ct(e);if(!o)throw new Error("请输入合法的 http/https zip URL");const r=W(t.character);r&&Z(r);const a=!!$("#hb_fix_root_relative").prop("checked"),n=String($("#hb_homepage").val()??"").trim()||"index.html",i=We(o),c=P(t.character),u=oe($("#hb_placeholder").val()),d=ne(c.projects,u),s=String($("#hb_new_title").val()??"").trim(),l=$("#hb_new_show_title").length?!!$("#hb_new_show_title").prop("checked"):!1,h={source:"url",id:te(),title:s||void 0,placeholder:d,homePage:n,showTitleInChat:l,fixRootRelativeUrls:a,zipName:i,zipSha256:"",zipUrl:o},f={projects:[...c.projects,h]};return await T(t.chid,f),{zipUrl:o,placeholder:d,homePage:n}}function ir(e){try{if(!e||typeof e!="object")return"";for(const t of Object.keys(e))if(String(t).toLowerCase()==="x-csrf-token"){const o=e[t];return typeof o=="string"?o:String(o||"")}}catch{}return""}function cr(e){return Number.isFinite(e)?Math.max(80,Math.min(e,1e4)):0}function sr(e,t){const o=String(e||"").trim();if(!o)return;const r=cr(Number(t));if(!r)return;const a=document.querySelectorAll("iframe");for(const n of a){const i=n;i?.name===o&&(i.style.height=`${r}px`)}}function Re(e){const t=String(e??"").trim();if(!t)return"";try{const r=new URL(t,window.location.origin).pathname.match(/\/vfs\/([^/]+)\//);return r?.[1]?decodeURIComponent(r[1]):""}catch{return""}}function be(e){if(!e)return{projectId:"",zipSha256:""};try{const t=document.querySelectorAll("iframe.hb-iframe");for(const o of t){const r=o;if(r.contentWindow!==e)continue;const a=r.closest(".hb-embed"),n=String(a?.dataset?.hbProjectId??"").trim(),i=String(r?.dataset?.hbVfsHomeUrl??r.src??"").trim(),c=Re(i);return{projectId:n,zipSha256:c}}}catch{}try{const t=String(e?.location?.href??"");return{projectId:"",zipSha256:Re(t)}}catch{return{projectId:"",zipSha256:""}}}async function lr(e,t){const o=String(e?.id||""),r={__hb:"higanbana",v:1,kind:"res",id:o,ok:!1};if(!o)return{...r,error:"Missing id"};if(e.op==="getCsrfToken")try{const n=B()?.getRequestHeaders?.(),i=ir(n);if(i)return{...r,ok:!0,data:i};const u=await(await fetch("/csrf-token",{method:"GET",credentials:"include"})).json().catch(()=>null),d=u&&typeof u=="object"?String(u.token||""):"";return{...r,ok:!0,data:d}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="getProject")try{const a=e?.payload&&typeof e.payload=="object"?e.payload:{},n=be(t),i=!!a.includeAll,c=String(a.targetProjectId??"").trim(),u=String(a.targetZipSha256??"").trim(),d=Jt({...a,includeAll:i,targetProjectId:i?c||void 0:c||n.projectId||void 0,targetZipSha256:i?u||void 0:u||n.zipSha256||void 0});return{...r,ok:!0,data:d}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="createProject")try{const a=e?.payload&&typeof e.payload=="object"?e.payload:{},n=await Xt(a);return{...r,ok:!0,data:n}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="deleteProject")try{const a=e?.payload&&typeof e.payload=="object"?e.payload:{},n=be(t),i=String(a.targetProjectId??"").trim(),c=String(a.targetZipSha256??"").trim(),u=await Yt({...a,targetProjectId:i||n.projectId||void 0,targetZipSha256:c||n.zipSha256||void 0});return{...r,ok:!0,data:u}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="updateProject")try{const a=e?.payload&&typeof e.payload=="object"?e.payload:{},n=be(t),i=String(a.targetProjectId??"").trim(),c=String(a.targetZipSha256??"").trim(),u=await qt({...a,targetProjectId:i||n.projectId||void 0,targetZipSha256:c||n.zipSha256||void 0});return{...r,ok:!0,data:u}}catch(a){return{...r,error:a?.message?String(a.message):String(a)}}if(e.op==="callSTAPI"){const a=String(e?.payload?.endpoint||""),n=e?.payload?.params??{};if(!a||!a.includes("."))return{...r,error:"Invalid endpoint"};const i=globalThis.ST_API;if(!i)return{...r,error:"ST_API not available"};const c=a.split(".");if(c.length!==2)return{...r,error:"Invalid endpoint format"};const[u,d]=c,s=i?.[u]?.[d];if(typeof s!="function")return{...r,error:`ST_API.${u}.${d} is not available`};try{const l=await s(n);return{...r,ok:!0,data:l}}catch(l){return{...r,error:l?.message?String(l.message):String(l)}}}return{...r,error:`Unsupported op: ${String(e?.op||"")}`}}function dr(){const e=globalThis;if(e.__HB_HTML_BRIDGE_SERVER__)return;e.__HB_HTML_BRIDGE_SERVER__={v:1};const t=new Map,o=300*1e3;let r=null;try{r=new BroadcastChannel(et)}catch{r=null}const a=i=>{try{r?.postMessage(i)}catch{}},n=async(i,c,u)=>{if(!i||typeof i!="object")return;if(i.type==="HB_IFRAME_HEIGHT"){sr(String(i.iframeName||""),Number(i.height));return}if(i.__hb!=="higanbana"||i.v!==1||i.kind!=="req")return;const d=i,s=String(d.id||"");if((d.op==="updateProject"||d.op==="deleteProject")&&!c){const f=d?.payload&&typeof d.payload=="object"?d.payload:{},p=String(f.targetProjectId??"").trim(),m=String(f.targetZipSha256??"").trim(),g=!!f.__hbAllowBroadcastZipTarget;if(!p&&!(g&&m))return}if(!s)return;const l=Date.now();for(const[f,p]of t)l-p>o&&t.delete(f);if(t.has(s))return;t.set(s,l);const h=await lr(d,c??null);if(a(h),c&&typeof c.postMessage=="function")try{const f=u&&u!=="null"?u:"*";c.postMessage(h,f)}catch{}};try{r&&(r.onmessage=i=>void n(i.data))}catch{}try{window.addEventListener("message",i=>void n(i.data,i.source,i.origin))}catch{}}function ur(e,t=15e3){return new Promise((o,r)=>{let a=!1;const n=f=>{a||(a=!0,u(),f?r(f):o())},i=setTimeout(()=>{n(new Error("Service Worker 激活超时（可能是非安全上下文或被浏览器策略禁止）"))},t),c=[],u=()=>{clearTimeout(i);for(const f of c)try{f()}catch{}},d=()=>{try{e.waiting?.postMessage?.({type:"HB_SKIP_WAITING"})}catch{}},s=()=>{try{e.active?.state==="activated"&&n()}catch{}},l=f=>{if(!f)return;if(f.state==="activated"){n();return}const p=()=>{d(),f.state==="activated"&&n()};f.addEventListener("statechange",p),c.push(()=>f.removeEventListener("statechange",p))},h=()=>{d(),l(e.installing),s()};e.addEventListener("updatefound",h),c.push(()=>e.removeEventListener("updatefound",h)),d(),l(e.installing||e.waiting||e.active),s()})}async function pr(){if(!("serviceWorker"in navigator))return console.warn("[Higanbana] Service Worker not supported"),null;try{const e=await navigator.serviceWorker.register(rt,{scope:A,type:"module"});return e.update().catch(()=>{}),await ur(e),e}catch(e){return console.warn("[Higanbana] sw register failed",e),null}}function hr(){Me();const e=B();$("#hb_pick_zip_btn").on("click",()=>{document.getElementById("hb_bind_zip")?.click()}),$("#hb_bind_zip").on("change",()=>{const n=document.getElementById("hb_bind_zip")?.files?.[0];$("#hb_bind_zip_name").text(n?n.name:"（未选择文件）")}),$("#hb_fix_root_relative").on("change",()=>{const n=N();n.defaultFixRootRelativeUrls=!!$("#hb_fix_root_relative").prop("checked"),O()}),$("#hb_render_html_blocks").on("change",()=>{const n=N();n.renderHtmlCodeBlocks=!!$("#hb_render_html_blocks").prop("checked"),O(),H()}),$("#hb_render_html_blocks_blob").on("change",()=>{const n=N();n.renderHtmlCodeBlocksUseBlobUrl=!!$("#hb_render_html_blocks_blob").prop("checked"),O(),H()}),$("#hb_render_html_blocks_titlebar").on("change",()=>{const n=N();n.renderHtmlCodeBlocksShowTitleBar=!!$("#hb_render_html_blocks_titlebar").prop("checked"),O(),H()}),$("#hb_placeholder").on("input",()=>{const n=N();n.placeholder=String($("#hb_placeholder").val()??"").trim()||V.placeholder,O()}),$("#hb_copy_placeholder").on("click",async()=>{const n=String($("#hb_placeholder").val()??"").trim();if(!n){toastr.error("占位符为空");return}try{await navigator.clipboard.writeText(n),toastr.success("已复制占位符")}catch(i){console.warn("[Higanbana] copy failed",i),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_insert_placeholder").on("click",()=>{const n=String($("#hb_placeholder").val()??"").trim();if(!n){toastr.error("占位符为空");return}const i=$("#send_textarea");if(i.length===0){toastr.error("找不到输入框");return}const c=String(i.val()??"");i.val(c?`${c}
${n}`:n),i.trigger("input"),toastr.success("已插入占位符")});const t=new Map,o=new Set,r=(n,i=400)=>{const c=t.get(n);c&&clearTimeout(c);const u=window.setTimeout(()=>{t.delete(n),a(n).catch(d=>console.warn("[Higanbana] project auto save failed",d))},Math.max(0,i));t.set(n,u)},a=async n=>{if(!o.has(n)){o.add(n);try{const i=x();if(!i)return;const c=P(i.character),u=c.projects.findIndex(E=>E.id===n);if(u<0)return;const d=document.getElementById("hb_projects_list");if(!d)return;const s=String(n).replace(/\\/g,"\\\\").replace(/"/g,'\\"'),l=d.querySelector(`.hb-proj-title[data-project-id="${s}"]`),h=d.querySelector(`.hb-proj-placeholder[data-project-id="${s}"]`),f=d.querySelector(`.hb-proj-home[data-project-id="${s}"]`),p=d.querySelector(`.hb-proj-fix[data-project-id="${s}"]`),m=d.querySelector(`.hb-proj-show-title[data-project-id="${s}"]`),g=c.projects[u],w=String(l?.value??"").trim(),y=w||void 0,v=String(h?.value??"").trim(),S=String(f?.value??"").trim(),b=!!p?.checked,_=m?!!m.checked:!!g.showTitleInChat;if(!v||!S)return;if(c.projects.some(E=>E.id!==n&&E.placeholder===v)){toastr.error("占位符重复，请为每个项目设置不同的占位符"),h&&(h.value=g.placeholder);return}if(!(g.title!==y||g.placeholder!==v||g.homePage!==S||g.fixRootRelativeUrls!==b||g.showTitleInChat!==_))return;const I=c.projects.map(E=>E.id===n?{...E,title:y,placeholder:v,homePage:S,fixRootRelativeUrls:b,showTitleInChat:_}:E);await T(i.chid,{projects:I}),g.showTitleInChat!==_&&At(n,_);const U=d.querySelector(`.hb-project[data-project-id="${s}"] .hb-subpanel-title`);U&&(U.textContent=`${y||g.zipName}  ${v}`),z(`已保存项目设置：${y||g.zipName}`),H()}finally{o.delete(n)}}};$("#hb_projects_list").on("input",".hb-proj-title, .hb-proj-placeholder, .hb-proj-home",n=>{const i=String(n.target?.getAttribute?.("data-project-id")??"").trim();i&&r(i,500)}),$("#hb_projects_list").on("change",".hb-proj-fix, .hb-proj-show-title",n=>{const i=String(n.target?.getAttribute?.("data-project-id")??"").trim();i&&r(i,0)}),$("#hb_projects_list").on("click",'[data-hb-action="copy_placeholder"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=P(c.character).projects.find(s=>s.id===i);if(d)try{await navigator.clipboard.writeText(d.placeholder),toastr.success("已复制占位符")}catch(s){console.warn("[Higanbana] copy placeholder failed",s),toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="copy_project_id"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{await navigator.clipboard.writeText(i),toastr.success("已复制项目 ID")}catch(c){console.warn("[Higanbana] copy project id failed",c);try{window.prompt("复制失败，请手动复制项目 ID：",i)}catch{}toastr.error("复制失败：浏览器未授予剪贴板权限")}}),$("#hb_projects_list").on("click",'[data-hb-action="insert_placeholder"]',n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=P(c.character).projects.find(h=>h.id===i);if(!d)return;const s=$("#send_textarea");if(s.length===0){toastr.error("找不到输入框");return}const l=String(s.val()??"");s.val(l?`${l}
${d.placeholder}`:d.placeholder),s.trigger("input"),toastr.success("已插入占位符")}),$("#hb_projects_list").on("click",'[data-hb-action="open_home"]',n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{Qt(i)}catch(c){toastr.error(c?.message??c)}}),$("#hb_projects_list").on("click",'[data-hb-action="export_zip"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{await er(i)}catch(c){console.error("[Higanbana] export zip failed",c),toastr.error(`导出失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="import_cache"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{const c=await tr(i);if(c.cancelled){toastr.info("已取消导入");return}c.importedCount>0?toastr.success("已导入到本地缓存"):toastr.info("该项目已在本地缓存"),H()}catch(c){console.error("[Higanbana] import cache failed",c),toastr.error(`导入失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="download_apply"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(i)try{if(!await rr(i))return;H(),toastr.success("已下载并应用")}catch(c){console.error("[Higanbana] download apply failed",c),toastr.error(`操作失败：${c?.message??c}`)}}),$("#hb_projects_list").on("click",'[data-hb-action="delete_project"]',async n=>{const i=String(n.currentTarget?.getAttribute?.("data-project-id")??"").trim();if(!i)return;const c=x();if(!c)return;const d=P(c.character).projects.find(h=>h.id===i);if(!d)return;const s=d.title||d.zipName;let l=!1;try{e?.Popup?.show?.confirm?l=await e.Popup.show.confirm("彼岸花",`确定删除项目：${s}？`):l=window.confirm(`确定删除项目：${s}？`)}catch{l=window.confirm(`确定删除项目：${s}？`)}if(l)try{await or(i),H(),toastr.success("已删除项目")}catch(h){console.error("[Higanbana] delete project failed",h),toastr.error(`删除失败：${h?.message??h}`)}}),$("#hb_import_from_card").on("click",async()=>{try{toastr.info("开始导入，请稍候..."),await Kt({allow:!0,reloadChat:!0}),toastr.success("已导入并启用（可在消息中渲染占位符）"),R()}catch(n){console.error("[Higanbana] import from card failed",n),toastr.error(`导入失败：${n?.message??n}`)}}),$("#hb_migrate_embedded_to_local").on("click",async()=>{const n=x();if(!n)return;const c=P(n.character).projects.filter(s=>s.source==="embedded").length;if(c===0){toastr.info("当前角色卡没有可迁移的嵌入项目");return}const u=`确定将当前角色卡中的 ${c} 个“嵌入项目”迁移为“本地缓存模式”吗？

迁移后：
1) 角色卡将不再保存 zipBase64（体积会明显下降）
2) 若当前浏览器缓存被清理，需要在本机重新导入 zip
3) 迁移前会先尝试把未缓存项目导入到本地缓存
`;let d=!1;try{e?.Popup?.show?.confirm?d=await e.Popup.show.confirm("彼岸花",u):d=window.confirm(u)}catch{d=window.confirm(u)}if(d)try{const s=await Ot({allow:!0,ensureCached:!0,reloadChat:!0});if(s.cancelled){toastr.info("已取消迁移（未修改角色卡）");return}toastr.success(`迁移完成：${s.migrated}/${s.totalEmbedded}，预导入缓存：${s.importedCount}`)}catch(s){console.error("[Higanbana] migrate embedded->local failed",s),toastr.error(`迁移失败：${s?.message??s}`)}}),$("#hb_open_home").on("click",()=>{const n=x();if(!n)return;const c=P(n.character).projects[0];if(!c){toastr.error("当前角色卡未绑定任何 WebZip 项目");return}if(!c.zipSha256){toastr.error("尚未下载/导入 WebZip 到本地缓存");return}const u=le(A,c.zipSha256,c.homePage);window.open(u,"_blank","noopener,noreferrer")}),$("#hb_export_zip").on("click",async()=>{const n=x();if(!n)return;const c=P(n.character).projects.find(u=>u.source==="embedded");if(!c){toastr.error("当前角色卡没有可导出的嵌入项目");return}try{const u=await G(c.zipBase64),d=new Blob([u],{type:"application/zip"});Le(d,c.zipName||"webzip.zip")}catch(u){console.error("[Higanbana] export zip failed",u),toastr.error(`导出失败：${u?.message??u}`)}}),$("#hb_unbind").on("click",async()=>{const n=B(),i=x();if(!i)return;const c=P(i.character);if(c.projects.length===0)return;const u=`确定解绑当前角色的所有 WebZip 项目？

${$t(c)}`;let d=!1;try{n?.Popup?.show?.confirm?d=await n.Popup.show.confirm("彼岸花",u):d=window.confirm(u)}catch{d=window.confirm(u)}if(d)try{await nr(),toastr.success("已解绑"),R()}catch(s){console.error("[Higanbana] unbind failed",s),toastr.error(`解绑失败：${s?.message??s}`)}}),$("#hb_bind_zip_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=$("#hb_bind_zip").get(0)?.files?.[0];if(!i){toastr.error("请先选择 zip 文件");return}try{await Dt(i.name,await i.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(c){console.error("[Higanbana] bind zip failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_bind_zip_local_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=$("#hb_bind_zip").get(0)?.files?.[0];if(!i){toastr.error("请先选择 zip 文件");return}try{await Zt(i.name,await i.arrayBuffer()),$("#hb_bind_zip").get(0).value="",$("#hb_bind_zip_name").text("（未选择文件）")}catch(c){console.error("[Higanbana] bind local zip failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_bind_url_btn").on("click",async()=>{if(!x()){toastr.error("当前不在单角色聊天/未选中角色");return}const i=String($("#hb_bind_url").val()??"").trim();try{const{zipUrl:c,placeholder:u,homePage:d}=await ar(i),s=$("#hb_placeholder");s.length&&document.activeElement!==s.get(0)&&s.val(""),R(),$("#hb_new_title").val(""),z(`已添加项目（URL 模式）。
占位符：${u}
URL：${c}
入口：${d}
提示：进入聊天时会提示下载并导入缓存`),toastr.success("已添加 URL 项目")}catch(c){console.error("[Higanbana] bind url failed",c),toastr.error(`绑定失败：${c?.message??c}`)}}),$("#hb_download_url_btn").on("click",async()=>{try{await Ft()}catch(n){console.error("[Higanbana] download url apply failed",n),toastr.error(`操作失败：${n?.message??n}`)}}),$("#hb_cancel_url_download_btn").on("click",()=>{try{Mt()}catch{}})}let ge=!1;async function fr(e,t){const o=t.map(r=>{const a=r.source==="url"?r.zipSha256||r.zipUrl:r.zipSha256;return`${r.id}:${r.source}:${a}`}).join("|");try{const r=await He(new TextEncoder().encode(o).buffer);return`AlertHiganbana_${e}_projects_${r}`}catch{return`AlertHiganbana_${e}_projects_${o.slice(0,80)}`}}function mr(e){const o=(String(e??"").trim()||"x").replace(/[^a-zA-Z0-9_-]/g,"_");return o.startsWith("hb_")?o:`hb_${o}`}async function Qe(){const e=B(),t=x();if(!e||!t)return;const o=P(t.character);if(o.projects.length===0)return;const r=W(t.character);if(r&&!ge){ge=!0;try{const a=Fe(r),n=o.projects.filter(h=>de(h)),i=n.filter(h=>h.source!=="local"),c=n.filter(h=>h.source==="local");if(!(!a||n.length>0))return;const d=await fr(r,o.projects);try{if(e.accountStorage?.getItem?.(d))return;e.accountStorage?.setItem?.(d,"true")}catch{}let s=0,l=[];if(e.callGenericPopup&&e.POPUP_TYPE?.CONFIRM){const h=document.createElement("div"),f=document.createElement("h3");f.textContent="此角色卡包含 WebZip 前端项目。",h.appendChild(f);const p=document.createElement("h3");i.length>0?p.textContent=`发现 ${i.length} 个未缓存项目，是否下载并启用？`:c.length>0?p.textContent=`发现 ${c.length} 个“本地缓存模式”项目未命中缓存。`:p.textContent="是否启用它们？",h.appendChild(p);const m=document.createElement("div");if(m.className="m-b-1",m.style.opacity="0.85",m.textContent="你可以稍后在扩展栏的“彼岸花”面板里管理这些项目。",h.appendChild(m),c.length>0){const b=document.createElement("div");b.className="m-b-1",b.style.opacity="0.85",b.textContent="本地缓存模式不会把 zip 写入角色卡，因此无法自动下载恢复。请在本机重新导入本地 zip（可用“添加本地缓存项目（不嵌入）”）。",h.appendChild(b)}const g=new Map,w=i.length>0?i.map(b=>{const _=mr(`miss_${b.id}`);g.set(_,b.id);const j=b.title||b.zipName,C=b.source==="embedded"?"嵌入":b.source==="url"?"URL":"本地缓存",I=`${j}  |  ${C}  |  ${b.placeholder}`,U=b.source==="url"?b.zipUrl:b.source==="embedded"?"嵌入于角色卡":"仅本地缓存（不嵌入角色卡）";return{id:_,label:I,type:"checkbox",defaultState:!0,tooltip:U}}):null,y=i.length>0?"下载选中并启用":"启用",v=a?"取消":"否",S=i.length>0?["下载全部"]:null;if(s=await e.callGenericPopup(h,e.POPUP_TYPE.CONFIRM,"",{okButton:y,cancelButton:v,customButtons:S,customInputs:w,wide:!0}),!s)return;if(i.length>0)if(Number(s)>=2)l=[...i];else{const b=e.Popup?.util?.lastResult?.inputResults,_=new Set;for(const[j,C]of g)b?.get?.(j)&&_.add(C);l=i.filter(j=>_.has(j.id))}}else{if(!window.confirm(n.length>0?i.length>0?`此角色卡包含 WebZip 项目，且有 ${i.length} 个可自动下载的未缓存项目。是否启用并下载？`:"此角色卡包含本地缓存模式项目，但当前浏览器未命中缓存。是否先启用（稍后可在面板重新导入本地 zip）？":"此角色卡包含 WebZip 项目，是否启用？"))return;l=[...i]}Z(r);try{if(l.length>0){toastr.info("开始下载/导入项目，请稍候...");const h=await je(t.chid,l);if(h.cancelled){toastr.info("已取消导入");return}h.importedCount>0&&toastr.success(`已导入 ${h.importedCount} 个项目`)}c.length>0&&toastr.info(`检测到 ${c.length} 个本地缓存模式项目未命中缓存，请在“彼岸花”面板重新导入本地 zip。`),await e.reloadCurrentChat?.(),R(),H()}catch(h){console.error("[Higanbana] import queue failed",h),toastr.error(`导入失败：${h?.message??h}`)}}finally{ge=!1}}}let Ue=!1;function br(){if(Ue)return;const e=B();if(!e?.eventSource||!e?.event_types)return;Ue=!0;const t=()=>setTimeout(()=>{R(),H(),Qe().catch(o=>console.warn("[Higanbana] webzip check failed",o))},0);e.event_types.CHAT_CHANGED&&e.eventSource.on(e.event_types.CHAT_CHANGED,t),e.event_types.CHARACTER_DELETED&&e.eventSource.on(e.event_types.CHARACTER_DELETED,t)}async function gr(){dr();const e=await pr();await L(),await Et(),Pt(),hr(),Nt(),br(),R(),Je(),Qe().catch(t=>console.warn("[Higanbana] webzip check failed",t)),z(`彼岸花：已加载。
Service Worker：${e?"已注册":"不可用（将无法渲染 WebZip）"}
提示：在本面板可把 zip 绑定到当前角色卡，导出角色卡时会一并导出。`)}function Ae(){const e=B();return e?.eventSource&&e?.event_types?.APP_READY?(e.eventSource.on(e.event_types.APP_READY,()=>{gr().catch(t=>{console.error("[Higanbana] init failed",t),toastr.error(`彼岸花初始化失败：${t?.message??t}`)})}),!0):!1}function wr(){jQuery(()=>{if(Ae())return;const e=setInterval(()=>{Ae()&&clearInterval(e)},250)})}wr();
